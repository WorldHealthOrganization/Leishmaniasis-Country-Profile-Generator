
<!--
	/****************************************************************************************************
 	 **********		   																		   **********
 	 **********                      Report App for DHIS2 Leishmaniasis 2017               	   **********
 	 **********		   																		   **********
	 ****************************************************************************************************/


	 	* @author  Ramon Jose Jimenez Pomareta 
		* @email ramon@pomareta.ch
 		* @version 1.0 
		* @date 26/04/2017


		* Some comments
			Since this App has to be made in only one file, all is here.
			When needed external js plugins, i.e. jquery-te and jquery-ui, I have stored a version in 
			https://github.com/Rjjp/plugins
			In order to share raw files, I have used https://rawgit.com/


		* Sections of the code. 
		1. CSS styles
		2. JavaScript
			jQuery-ui styles       
			JavaScript imports
			CONSTANTS
			STATIC CONTENT FUNCTIONS
			FUNCTIONS CALLING THE API 
			FILLING LOGICAL STRUCTURES (ARRAYS)
			AUXILIARY FUNCTIONS
			CHARTS FUNCTIONS
		3. HTML Code
-->
<style type="text/css">
/****************************************************************************************************
 **********		   																		   **********
 **********                                1. CSS STYLES                                   **********
 **********		   																		   **********
 ****************************************************************************************************/
@media print {
   .non-printable {
       display: none;
    }
    
}
@page 
    {
        size:  auto;   /* auto is the initial value */
        margin: 0mm;  /* this affects the margin in the printer settings */
    }

    html
    {
        background-color: #FFFFFF; 
        margin: 0px;  /* this affects the margin on the html before sending to printer */
    }

    body
    {
        border: solid 1px blue ;
        margin: 1mm 15mm 1mm 15mm; /* margin you want for the content */
    }


/* selectable */
 #selectable .ui-selecting { background: #FECA40; }
  #selectable .ui-selected { background: #F39814; color: white; }
  #selectable { list-style-type: none; margin: 0; padding: 0; width: 60%; }
  #selectable li { margin: 3px; padding: 0.4em; font-size: 1.4em; height: 18px; }


.section
{
	border-bottom: 1px solid #ccc;
	margin-bottom: 50px; 
	padding-bottom: 50px;
	width: 930px;
	font-size: 15px;
}


.head_logo{
	width:160px;
}


img.center {
    display: block;
    margin: 0 auto;
}

.center_text{
	text-align: center;
}
.align_to_right{
	text-align:right;
}

/* Organize content of div in equal-sized colons*/
.container {
  display: flex;
}
.container > div {
  flex: 1; /*grow*/
}

/* lines for tables */
tr.bottom_line td,th {
  border-bottom: 1px solid #cad5e5;	/* Info : Border from first row table doesn't come from here. Just same property. */
}

.footNoted {
  /*  color: red; */	
}
</style>
<!-- 

/****************************************************************************************************
 **********		   																		   **********
 **********                            		2. JavaScript                                  **********
 **********		   																		   **********
 ****************************************************************************************************/
	
/****************************************************************************************************
 **********                             JavaScript imports                                 **********
 ****************************************************************************************************/
 -->
<script type="text/javascript" src ="https://cdn.rawgit.com/Rjjp/plugins/master/jquery-te-1.4.0-oms.js"></script>
<script type="text/javascript" src ="https://cdn.rawgit.com/Rjjp/plugins/master/jquery-ui/jquery-ui.js">//TODO:use the cdn officiel</script>
<script type="text/javascript" src="//dhis2-cdn.org/v226/plugin/chart.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.js"></script>

<script type="text/javascript">

$( document ).ready( function() {

	/* Adds jQueryTE and jquery-ui css' */

	$('head').append('<link rel="stylesheet" href="https://rawgit.com/Rjjp/plugins/master/jquery-te-1.4.0.css" type="text/css" />');
 	$('head').append('<link rel="stylesheet" href="https://cdn.rawgit.com/Rjjp/plugins/master/jquery-ui/jquery-ui.css" type="text/css" />');


	/****************************************************************************************************
	 **********                               jQuery-ui styles                                 **********
	 ****************************************************************************************************/
	


	/****************************************************************************************************
 	 **********                      	       CONSTANTS            	              	       **********
	 ****************************************************************************************************/
	var API_URL = "../api/";
	var DATA_VALUE_SETS = "dataValueSets";
	var WHEN_UNDEFINED = "No data";
	var WHEN_NON_APPLICABLE = "N/A";
	var WHEN_DIV_0 = "-";
	var ERROR = "Error!";

	var BOTTOM_LINE_CLASS = "bottom_line";

	var VALUE_KEY = "value";
	var CC_KEY = "categoryOptionCombo";
	var DE_KEY = "dataElement";
	var PERIOD_KEY = "period";

	var LABELS_ON_ROWS = 0;
	var LABELS_ON_COLUMNS = 1;

	/* Texts on report */
	var PUBLISHED_TEXT = "Published in ";
	var VL_CHART_LEGEND = "VL ";
	var CL_CHART_LEGEND = "CL ";	
	var ACL_CHART_LEGEND = "ACL ";
	var ZCL_CHART_LEGEND = "ZCL ";
	var TREATMENT_TABLE_FIRST_COLUMNS = "TREATMENT OUTCOME";


	var MONTHS = [	"January",
					"February",
					"March",
					"April",
					"May",
					"June",
					"July",
					"August",
					"September",
					"October",
					"November",
					"December" ];

	var MONTHS_ABBREV = [	"JAN",
							"FEB",
							"MAR",
							"APR",
							"MAY",
							"JUN",
							"JUL",
							"AUG",
							"SEP",
							"OCT",
							"NOV",
							"DEC"];

	var COLORS = {
		green : 'rgba(153, 204, 0, 1)',
		soft_green : 'rgba(153, 204, 0, 0.2)',
		blue: 'rgba(51, 153, 255, 1)',
		soft_blue: 'rgba(51, 153, 255, 0.2)',
		violet :'rgba(153, 0, 255, 1)',
		soft_violet :'rgba(153, 0, 255, 0.2)'
	}

	/* Country General Information Texts */
	
	var CGI_LABELS = [	"Total population:",
						"Gender (%, F/M):",
						"GDP (PPP int $):",
						"Income status:",
						"Age group <15/> 14 years, %: ",
						"Life expectancy at birth in years (F/M):",
						"Number of 2nd sub-national administrative level<br>divisions, name:"
						];

	/* Epidemiology table constants */
	var FIRST_COLUMN = 0;
	var VL_COLUMN = 1;
	var CL_COLUMN = 2;
	var ACL_COLUMN = 3;
	var ZCL_COLUMN = 4;
	var PKDL_COLUMN = 5;
	var MCL_COLUMN = 6;

	var COLUMNS_LABELS = [ 	"VL",
							"CL",
							"ACL",
							"ZCL",
							"PKDL",
							"MCL"
							];


	var ENDEMICITY_ROW = 0;
	var NEW_ROW = 1;
	var RELAPSE_ROW = 2;
	var TOTAL_ROW = 3;
	var IMPORTED_ROW = 4;
	var SEX_ROW = 5;
	var AGE_ROW = 6;
	var INCD_ROW = 7;
	var THIRD_LEVEL_ROW = 8;
	var RISK_ROW = 9;
	var OUTBK_ROW = 10;
	var FOCI_ROW = 11;

	var rowTitles = [	"Endemicity status:",
						"Number of new cases (incidence):",
						"Number of relapse cases:",
						"Total number of cases:",
						"Imported cases (#, %):",
						"Gender distribution (%F):",
						"Age group distribution (%, <5/5-14/>14):",
						"Incidence rate (cases/10 000 population in endemic areas):",
						"Number of endemic 3rd sub-national administrative level divisions (n):",
						"Population at risk (%, n/total):",
						"Was there anz outbreak?",
						"Number of new foci:"
						];
	var LINES_BELOW_LABELS_EPI = [true,false,false,true,true,false,true,false,false,true,false,true];
	var array = create_2_dim_array(rowTitles.length, rowTitles, LABELS_ON_COLUMNS);

	/* Monthly distribution table constants */
	var VL_ROW = 0;
	var CL_ROW = 1;
	var VL_PREVIOUS_YEAR_ROW = 2;
	var CL_PREVIOUS_YEAR_ROW = 3;
	var ACL_ROW = 4;
	var ZCL_ROW = 5;
	var ACL_PREVIOUS_YEAR_ROW = 6;
	var ZCL_PREVIOUS_YEAR_ROW = 7;

	var rowMonthlyTitles = ["VL",
							"CL",
							"VL (previous year)",
							"CL (previous year)",
							"ACL",
							"ZCL",
							"ACL (previous year)",
							"ZCL (previous year)"
							];
	var LINES_BELOW_LABELS_MONTHLY = [true,true,true,true,true,true,true,true];

	var monthlyArray = create_2_dim_array(rowMonthlyTitles.length, rowMonthlyTitles, LABELS_ON_COLUMNS);

	/* Control and surveillance table */

	/* Country General Information Texts */
	
	var CAS_LABELS = [	"Year Leishmaniasis National Control<br>Programme (LNCP) was established:",
						"Type of surveillance:",
						"Is there a vector control programme?",
						"Type of insecticide used for IRS:",
						"Year latest national guidelines were published:",
						"Is leishmaniasis notifiable (mandatory reporting)?",
						"Is there a reservoir host control programme?",
						"Number of leishmaniasis health facilities:"
						];


	/* Diagnosis table */

	var SCREENED_ACTIVELY_ROW = 0;
	var SCREENED_PASSIVELY_ROW = 1;
	var VL_CASES_DIAGNOSED_ROW = 2;
	var POSITIVE_RDT_ROW = 3;
	var DIRECT_EXAM_DIAGNOSED_ROW = 4;
	var POSITIVE_DIRECT_EXAM_ROW = 5;
	var CLINICALLY_DIAGNOSED_ROW = 6;
	var HIV_COINFECTION_ROW = 7;

	var diagnosisLabels = [	"Number of people screened actively for:",
							"Number of people screened passively for:",
							"VL cases diagnosed by RDT<br>(%, RDT+/total VL cases):",
							"Proportion of positive RDT<br>(%, RDT+/total RDT):",
							"Cases diagnosed by direct exam<br>(parasitology) (%, # slides +/total cases):",
							"Proportion of positive slides<br>(%, # slides +/total slides):",
							"Cases diagnosed clinically<br>(%, # clinical cases/total cases): ",
							"Percentage of cases with HIV-VL coinfection:"
							];
	var LINES_BELOW_LABELS_DIAG = [false,true,false,true,false,false,true,true];

	var diagnosisArray = create_2_dim_array(diagnosisLabels.length, diagnosisLabels, LABELS_ON_COLUMNS);

	/* Treatment table */
	
	var RELAPSE_PROPORTION_ROW = 0;
	var INITIAL_CURE_RATE_ROW = 1;
	var FAILURE_RATE_ROW = 2;
	var CASE_FATALITY_ROW = 3;

	var treatmentLabels = [ "Proportion of relapse cases:",
							"Initial cure rate:",
							"Failure rate:",				
							"Case-fatality rate:"
							];
	var LINES_BELOW_LABELS_TREAT = [true, false, false, true];
	var treatmentArray = create_2_dim_array(treatmentLabels.length, treatmentLabels, LABELS_ON_COLUMNS);
	

	var DATASET = {
		CL : "tnek2LjfuIm",
		VL : "fdBM4sWSuPR",
		AZCL : "Uc3j0vpsfSB", 
		CL_MONTHLY : "pWGPGaE6knJ",
		VL_MONTHLY : "GW4lVTTLWfW",
		AZCL_MONTHLY : "YfnF9NPpP4c"

	};
	// DATA_ELEMENTS
	var DE = {
		CL_EPI_Type :   "EPw6gR9fDqt",
		VL_EPI_Type :	"IxbBQzytPgv",
		ACL_EPI_Type : 	"f1bBSpuIyzD",
		ZCL_EPI_Type : 	"Ta96pnXcAum",
		VL_LAB_RDT_tested_type : "rFy4bKMa977",
		VL_LAB_parasito_tested_type : "RrKpXTbayoB",
		VL_LAB_parasito_result_type : "Qc7ujS567UL",
		VL_LAB_clinical : "BAsexzzzJZC",
		VL_LAB_HIVstatus_Type : "NTo887FeHdI",
		PKDL_GEN_EPID_cases : "NdbsWSygpqz",
		PKDL_EPID_sex: "ipWXN3NeXac",
		PKDL_EPID_age : "rw4tu6PNGKO",
		PKDL_LAB_HIV: "sxjZutF1AMx",
		VL_TREATMENT_OUTCOME: "eh7Lbb7Rslc"

	};

	var DE_SCREEN_ACTIVE = {};
	DE_SCREEN_ACTIVE[VL_COLUMN] = "g6yIwTl0sHx";
	DE_SCREEN_ACTIVE[CL_COLUMN] = "c5Zvvh9AWB4";
	DE_SCREEN_ACTIVE[ACL_COLUMN] = "hqgnicLioSz";
	DE_SCREEN_ACTIVE[ZCL_COLUMN] = "NDNcasRLz01";

	var DE_SCREEN_PASSIVE = {};
	DE_SCREEN_PASSIVE[VL_COLUMN] = "MRFflirvoj4";
	DE_SCREEN_PASSIVE[CL_COLUMN] = "jdQau4rlj73";
	DE_SCREEN_PASSIVE[ACL_COLUMN] = "gZuua8o0gNS";
	DE_SCREEN_PASSIVE[ZCL_COLUMN] = "yEmHARyqLIk";

	var TYPE_NEW_CASES = "psVSPLclyFj";
	var TYPE_RELAPSE = "KPn9RHNrd8R";
	var TYPE_UNSPECIFIED = "IRW4YrOtk5q";

	var NEW_MALE = "GpQZH8hC7jY";
	var NEW_FEMALE = "TtoYCIVcBA3";
	var NEW_UNKNOWN = "FaYhAlKLX16";
	var REL_MALE = "UG7PsogfDYz";
	var REL_FEMALE = "OmkgX8Kkurn";
	var REL_UNKNOWN = "Ng311XPZTbv";
	var UNS_MALE = "aWWYWv6buzp";
	var UNS_FEMALE = "wGED4K5Bs37";
	var UNS_UNKNOWN = "zkKbIIarKWM";

	var FEMALE = "V2LdgcGgFQt";
	var MALE = "Z2hvpF7mhh7";
	var UNKNOWN_SEX = "jNbFhhnUsQv";

	var AGE_5 = "HDXcEOGT2s1";
	var AGE_5_14 = "DOJartWGuff";
	var AGE_14 = "vJEPLhdauF7";
	var AGE_UNKNOWN = "kek1YXjDq70";

	var NEW_UNDER_5 = "hKq5WASZw8q";
	var NEW_5_14 = "mTyLqDjpQ5b";
	var NEW_OVER_14 = "DDliBAHqwGV";
	var NEW_AGE_UNKNOWN = "dVuOzmU4xbI";
	var REL_UNDER_5 = "NlAMTGlJ7b3";
	var REL_5_14 = "a1GEE4dBKZ8";
	var REL_OVER_14 = "xxrYh49wmnD";
	var REL_AGE_UNKNOWN = "zuuSkk9CiNB";
	var UNS_UNDER_5 = "rZwYGlqR8GG";
	var UNS_5_14 = "P6R9XEaqQbz";
	var UNS_OVER_14 = "UQMTeRPY2U0";
	var UNS_AGE_UNKNOWN = "nIbrdHllMKh";

	var ORIGIN_AUTOC_NEW = "WynvvdELtqm";
	var ORIGIN_AUTOC_REL = "LUVeZjOsibr";
	var ORIGIN_AUTOC_UNS = "wYB0E3USJ7L";
	var ORIGIN_IMPORT_NEW = "pWZT12mjhUC";
	var ORIGIN_IMPORT_REL = "QO2kKL8ySPc";
	var ORIGIN_IMPORT_UNS = "A5TSwm9Wivn";
	var ORIGIN_UNKNOWN_NEW = "Lx8tyhhseZZ";
	var ORIGIN_UNKNOWN_REL = "lGFgLYweSNS";
	var ORIGIN_UNKNOWN_UNS = "EGvT9lj2BOy";

	/* Diagnosis DataElements */
	//o1smtpQE1tm
	var POSITIVE_NEW = "jRcT6HVKb2t";
	var POSITIVE_RELAPSE = "QKqVJ13mGZI";
	var POSITIVE_UNSP = "YXktM46YiXo";

	/* Treatment Category options*/

	var NEW_CURED = "UnXwCSYnnvT";
	var NEW_RELOUT = "HjLmlc308bk";
	var NEW_DEAD = "SWQatS9z4sL";
	var REL_CURED = "a6I7BzjrnmJ";
	var REL_RELOUT = "j7RGAw4zpVi";
	var REL_DEAD = "iML4aJx17bq";
	var UNS_CURED = "SZiY6xiTgy6";
	var UNS_RELOUT = "D08F1WAa6x6";
	var UNS_DEAD = "qAneJjz2lLH";
	

	var date = dhis2.report.date;
	var year = date.slice(0,4);

	var orgUnit = dhis2.report.organisationUnit;
	var country_name =orgUnit.name;

	var acl_and_zcl_activated = false;

	console.log(dhis2);
	console.log(dhis2.report);
	console.log(orgUnit);
	console.log(country_name);



	var editingElement;

	/*** TEST AREA ****/
	$("#editor").jqte();	

	$( "#selectable" ).selectable();

 dialog = $( "#dialog-editor" ).dialog({
      autoOpen: false,
      height: 350,
      width: 650,
      modal: true,
      buttons: {
        "Save changes": saveChanges,
		"Save changes and close": saveChangesAndClose,
        Cancel: function() {
          dialog.dialog( "close" );
        }
      },
      close: function() {
       
        //allFields.removeClass( "ui-state-error" );
      }
    });

	function saveChanges(){
		editingElement.innerHTML = $("#editor").jqteVal();
	}
	function saveChangesAndClose(){
		editingElement.innerHTML = $("#editor").jqteVal();
		dialog.dialog( "close" );
	}
	

	$(".editableElement").click(function(){
		dialog.dialog( "open" );	
		var test = this.innerHTML;
		editingElement = this;
		$("#editor").jqteVal(editingElement.innerHTML);

	});


	/**** END TEST AREA ****/




	var footNoteCounter = 0;
	
	/* HTML elements */
	var epiTable = 	$("#epiTable");
	var epiTableBody = 	$("#epiTableBody");
	var epiTableHead = 	$("#epiTableHead");

	var monthlyDistributionTableBody = $("#monthlyDistributionTableBody");
	var monthlyDistributionTableHead = $("#monthlyDistributionTableHead");

	var diagTableBody = $("#diagTableBody");
	var diagTableHead = $("#diagTableHead");

	var treatmentTableBody = $("#treatmentTableBody");
	var treatmentTableHead = $("#treatmentTableHead");

	var newCLCasesChartID = "NewCLCasesChart";
	var newVLCasesChartID = "NewVLCasesChart";
	
	var EPI_TABLE_TD_ID_PREFIX = "epiTable";
	var MONTHLY_TABLE_TD_ID_PREFIX = "monthlyTable";
	var DIAG_TABLE_TD_ID_PREFIX = "diagTable";

	var LEISH_COLUMN_DETAIL_PREFIX = "LeishDetail";

	var BUTTON_PREFIX = '_b_';



	
	/* Set charts*/
	$( "#a01" ).attr( "src", API_URL+"charts/Ox5bv6fKEWg/data?width=450&height=300&date=" + date );
	$( "#a02" ).attr( "src", API_URL+"charts/Ox5bv6fKEWg/data?width=450&height=300&date=" + date );
	$( "#a03" ).attr( "src", API_URL+"charts/Ox5bv6fKEWg/data?width=450&height=300&date=" + date );
	$( "#a04" ).attr( "src", API_URL+"charts/XGEAenGcRaB/data?width=450&height=300&date=" + date );

	//$( "#table1" ).load( API_URL+"reportTables/emMtuwdfwb1/data.html?date=" + date );

	$( "#b01" ).attr( "src", API_URL+"maps/uFcRuF2LsOo/data?width=450&date=" + date );
	$( "#b02" ).attr( "src", API_URL+"maps/xPc4t89kEXl/data?width=450&date=" + date );



	$( "#country_name" ).text(country_name);
	$( "#year" ).text(year);
	$( "#published_date").text(getDatePublished());



	var params = {
		dataSet: "", //i.e. DATASET.CL,
		period: year,
		orgUnit: orgUnit.id
		
		};


	var builtUrl;

	/************************************************
	Starting calls
	*/


	generateCheckboxes($("#leish_detail_checkboxes"), COLUMNS_LABELS, "ACL/ZCL PKDL Details:",LEISH_COLUMN_DETAIL_PREFIX);
	generateCheckboxes($("#monthlyCheckboxes"), rowMonthlyTitles, "Monthly distribution table:",MONTHLY_TABLE_TD_ID_PREFIX);

	fillTableHead(epiTableHead, '', COLUMNS_LABELS);
	fillTableHead(monthlyDistributionTableHead, '', MONTHS_ABBREV);
	fillTableHead(diagTableHead, '', COLUMNS_LABELS);
	fillTableHead(treatmentTableHead, TREATMENT_TABLE_FIRST_COLUMNS, COLUMNS_LABELS.slice(0,1));


	/****************************************************************************************************
 	 **********                    	     STATIC CONTENT FUNCTIONS         	           	       **********
	 ****************************************************************************************************/
	function fillTableHead(htmlObject, firstColumn, headObjects){
		var html = '<th>'+firstColumn+'</th>';
		
		for (var i=0; i<headObjects.length;i++){
			html +='<th class="editableElement">'+headObjects[i]+'</th>';
		}

		htmlObject.append(html);
	}

	function generateCheckboxes(htmlObject, labels, title, prefix){
		var html = '<legend>'+title+'</legend>';
		for (var i=0; i<labels.length; i++){
			html+='<input id="'+prefix+BUTTON_PREFIX+i+'" type="checkbox" class="'+prefix+'" checked="checked" />'
			html+='<label for="'+prefix+BUTTON_PREFIX+i+'">'+labels[i]+'</label>'
		}
		    
		htmlObject.append(html);
		$('input[type=checkbox]').checkboxradio();
	}


	/****************************************************************************************************
 	 **********                    	    FUNCTIONS CALLING THE API         	           	       **********
	 ****************************************************************************************************/
	function get_monthly_cases_for(dataset, row, year) {
		var params = {
			dataSet: dataset,
			period: [],
			orgUnit: orgUnit.id
		}

		for (var i=1;i<=12;i++){
			var monthNumber = numberToTwoDigits(i);
			params.period[i] = year + monthNumber;
		}

		builtUrl = buildAPIUrl(DATA_VALUE_SETS, params);
		return $.ajax({
			url: builtUrl
		}).then(function(data) {
			if(typeof row === 'number'){
				fillMonthlyArray(row, data.dataValues);
			} else if (row.length>1){
				fillMonthlyArrayACLZCL(row[0], row[1], data.dataValues);
			}
		});
	}

	function get_monthly_cases_for_cl_current_year() {
			return get_monthly_cases_for(DATASET.CL_MONTHLY, CL_ROW, year);
	}
	function get_monthly_cases_for_cl_previous_year() {
			return get_monthly_cases_for(DATASET.CL_MONTHLY, CL_PREVIOUS_YEAR_ROW, year-1);
	}
	function get_monthly_cases_for_vl_current_year() {
			return get_monthly_cases_for(DATASET.VL_MONTHLY, VL_ROW, year);
	}
	function get_monthly_cases_for_vl_previous_year() {
			return get_monthly_cases_for(DATASET.VL_MONTHLY, VL_PREVIOUS_YEAR_ROW, year-1);
	}
	function get_monthly_cases_for_azcl_current_year() {
			return get_monthly_cases_for(DATASET.AZCL_MONTHLY, [ACL_ROW, ZCL_ROW], year);
	}
	function get_monthly_cases_for_azcl_previous_year() {
			return get_monthly_cases_for(DATASET.AZCL_MONTHLY, [ACL_PREVIOUS_YEAR_ROW, ZCL_PREVIOUS_YEAR_ROW], year-1);
	}
	

	/* getting cl cases from API */
	function get_cl_cases() {

		params.dataSet = DATASET.CL;
		builtUrl = buildAPIUrl(DATA_VALUE_SETS, params);
		return $.ajax({
			url: builtUrl
		}).then(function(data) {
			//	decide_cl_or_aclzcl_mode(data.dataValues);
				fillArray(data.dataValues, CL_COLUMN, DE.CL_EPI_Type, ""); 
		});
	}


	/* getting cl cases from API */
	function get_azcl_cases() {

		params.dataSet = DATASET.AZCL;
		builtUrl = buildAPIUrl(DATA_VALUE_SETS, params);
		return $.ajax({
			url: builtUrl
		}).then(function(data) {
				set_aclzcl_mode_to_true_if_data(data.dataValues);
				fillArray(data.dataValues, ACL_COLUMN, DE.ACL_EPI_Type, ""); 
				fillArray(data.dataValues, ZCL_COLUMN, DE.ZCL_EPI_Type, ""); 
		});
	}


	/* getting vl cases from API */
	function get_vl_cases() {
		params.dataSet = DATASET.VL;
		builtUrl = buildAPIUrl(DATA_VALUE_SETS, params);
		return $.ajax({
			url: builtUrl
		}).then(function(data) {
				fillArray(data.dataValues, VL_COLUMN, DE.VL_EPI_Type, DE.VL_LAB_RDT_tested_type);
				fillArray(data.dataValues, PKDL_COLUMN, DE.VL_EPI_Type, DE.VL_LAB_RDT_tested_type);

		});
	}


	/****************************************************************************************************
 	 **********                      FILLING LOGICAL STRUCTURES (ARRAYS)               	       **********
	 ****************************************************************************************************/

	 /***

	 */
	function fillMonthlyArray(row, dataValues) {
		var new_cases_by_month = getValuesForKeyByMonth(dataValues,CC_KEY,TYPE_NEW_CASES, VALUE_KEY);
		var relapses_by_month = getValuesForKeyByMonth(dataValues,CC_KEY,TYPE_RELAPSE, VALUE_KEY);
		var unspecified_by_month = getValuesForKeyByMonth(dataValues,CC_KEY,TYPE_UNSPECIFIED, VALUE_KEY);

		var total_cases_by_month;
		var starting_column = monthlyArray[row].length;

		for (var i=starting_column; i<new_cases_by_month.length+starting_column; i++){
			total_cases_by_month = add([	new_cases_by_month[i-starting_column],
										relapses_by_month[i-starting_column],
										unspecified_by_month[i-starting_column] ]);
			monthlyArray[row][i] = total_cases_by_month;
		}
		
	}	 
	/***

	 */
	function fillMonthlyArrayACLZCL(aclRow, zclRow, dataValues) {
		var new_cases_by_month_acl = getValuesForKeyByMonth(dataValues,[CC_KEY, DE_KEY],[TYPE_NEW_CASES, DE.ACL_EPI_Type], VALUE_KEY);
		var relapses_by_month_acl = getValuesForKeyByMonth(dataValues,[CC_KEY, DE_KEY],[TYPE_RELAPSE, DE.ACL_EPI_Type], VALUE_KEY);
		var unspecified_by_month_acl = getValuesForKeyByMonth(dataValues,[CC_KEY, DE_KEY],[TYPE_UNSPECIFIED, DE.ACL_EPI_Type], VALUE_KEY);

		var new_cases_by_month_zcl = getValuesForKeyByMonth(dataValues,[CC_KEY, DE_KEY],[TYPE_NEW_CASES, DE.ZCL_EPI_Type], VALUE_KEY);
		var relapses_by_month_zcl = getValuesForKeyByMonth(dataValues,[CC_KEY, DE_KEY],[TYPE_RELAPSE, DE.ZCL_EPI_Type], VALUE_KEY);
		var unspecified_by_month_zcl = getValuesForKeyByMonth(dataValues,[CC_KEY, DE_KEY],[TYPE_UNSPECIFIED, DE.ZCL_EPI_Type], VALUE_KEY);

		var total_cases_by_month;
		var starting_column = monthlyArray[aclRow].length;

		for (var i=starting_column; i < new_cases_by_month_acl.length + starting_column; i++){
			total_cases_by_month = add([	new_cases_by_month_acl[i - starting_column],
										relapses_by_month_acl[i - starting_column],
										unspecified_by_month_acl[i - starting_column] ]);
			monthlyArray[aclRow][i] = total_cases_by_month;
		}
		for (var i=starting_column; i < new_cases_by_month_zcl.length + starting_column; i++){
			total_cases_by_month = add([	new_cases_by_month_zcl[i - starting_column],
										relapses_by_month_zcl[i - starting_column],
										unspecified_by_month_zcl[i - starting_column] ]);
			monthlyArray[zclRow][i] = total_cases_by_month;
		}
		
	}
	/*
		column :
		epiDE : Epidemiology Data getElement
		diagDE : diagnosis DataElement
	*/
	function fillArray(dataValues, column, epiDE, diagDE) {
		/* Edidemiology table */
	
		// type of cases
		var new_cases = getValueForKey(dataValues,[CC_KEY, DE_KEY],[TYPE_NEW_CASES,epiDE], VALUE_KEY);
		var relapse = getValueForKey(dataValues,[CC_KEY, DE_KEY],[TYPE_RELAPSE,epiDE], VALUE_KEY);
		var unspecified = getValueForKey(dataValues,[CC_KEY, DE_KEY],[TYPE_UNSPECIFIED,epiDE], VALUE_KEY);
		var total_cases_type = add([new_cases, relapse, unspecified]);
		
		array[NEW_ROW][column] = new_cases;
		array[RELAPSE_ROW][column] = relapse;
		array[TOTAL_ROW][column] = total_cases_type;

		// sex distribution 
		var new_unknown = getValueForKey(dataValues, CC_KEY, NEW_UNKNOWN, VALUE_KEY);
		var rel_unknown = getValueForKey(dataValues, CC_KEY, REL_UNKNOWN, VALUE_KEY);
		var uns_unknown = getValueForKey(dataValues, CC_KEY, UNS_UNKNOWN, VALUE_KEY);
		var unknown = add([new_unknown, rel_unknown, uns_unknown]);

		var new_male = getValueForKey(dataValues, CC_KEY, NEW_MALE, VALUE_KEY);
		var rel_male = getValueForKey(dataValues, CC_KEY, REL_MALE, VALUE_KEY);
		var uns_male = getValueForKey(dataValues, CC_KEY, UNS_MALE, VALUE_KEY);
		var male = add([new_male, rel_male, uns_male]);

		var new_female = getValueForKey(dataValues, CC_KEY, NEW_FEMALE, VALUE_KEY);
		var rel_female = getValueForKey(dataValues, CC_KEY, REL_FEMALE, VALUE_KEY);
		var uns_female = getValueForKey(dataValues, CC_KEY, UNS_FEMALE, VALUE_KEY);
		var female = add([new_female, rel_female, uns_female]);

		array[SEX_ROW][column] = percentageText(female, add([male, female, unknown]));
		
		//age distribution 
		var new_under_5 = getValueForKey(dataValues, CC_KEY, NEW_UNDER_5, VALUE_KEY);
		var rel_under_5 = getValueForKey(dataValues, CC_KEY, REL_UNDER_5, VALUE_KEY);
		var uns_under_5 = getValueForKey(dataValues, CC_KEY, UNS_UNDER_5, VALUE_KEY);
		var under_5 =  add([new_under_5, rel_under_5, uns_under_5]);

		var new_5_14 = getValueForKey(dataValues, CC_KEY, NEW_5_14, VALUE_KEY);
		var rel_5_14 = getValueForKey(dataValues, CC_KEY, REL_5_14, VALUE_KEY);
		var uns_5_14 = getValueForKey(dataValues, CC_KEY, UNS_5_14, VALUE_KEY);
		var _5_14 =  add([new_5_14, rel_5_14, uns_5_14]);

		var new_over_14 = getValueForKey(dataValues, CC_KEY, NEW_OVER_14, VALUE_KEY);
		var rel_over_14 = getValueForKey(dataValues, CC_KEY, REL_OVER_14, VALUE_KEY);
		var uns_over_14 = getValueForKey(dataValues, CC_KEY, UNS_OVER_14, VALUE_KEY);
		var over_14 =  add([new_over_14, rel_over_14, uns_over_14]);

		var new_age_unknown = getValueForKey(dataValues, CC_KEY, NEW_AGE_UNKNOWN, VALUE_KEY);
		var rel_age_unknown = getValueForKey(dataValues, CC_KEY, REL_AGE_UNKNOWN, VALUE_KEY);
		var uns_age_unknown = getValueForKey(dataValues, CC_KEY, UNS_AGE_UNKNOWN, VALUE_KEY);
		var age_unknown =  add([new_age_unknown, rel_age_unknown, uns_age_unknown]);

		var total_age_cases = add([under_5, _5_14, over_14, age_unknown]);

		array[AGE_ROW][column] = "(" +	percentageText(under_5, total_age_cases) + " / "
										+	percentageText(_5_14, total_age_cases) + " / "
										+	percentageText(over_14, total_age_cases) + ")";				

		//origin distribution
		var origin_autoc = add([
			getValueForKey(dataValues,CC_KEY, ORIGIN_AUTOC_NEW, VALUE_KEY),
			getValueForKey(dataValues,CC_KEY, ORIGIN_AUTOC_REL, VALUE_KEY),
			getValueForKey(dataValues,CC_KEY, ORIGIN_AUTOC_UNS, VALUE_KEY)
		]);
		var origin_imported = add([
			getValueForKey(dataValues,CC_KEY, ORIGIN_IMPORT_NEW, VALUE_KEY),
			getValueForKey(dataValues,CC_KEY, ORIGIN_IMPORT_REL, VALUE_KEY),
			getValueForKey(dataValues,CC_KEY, ORIGIN_IMPORT_UNS, VALUE_KEY)
		]);
		var origin_unknown = add([
			getValueForKey(dataValues,CC_KEY, ORIGIN_UNKNOWN_NEW, VALUE_KEY),
			getValueForKey(dataValues,CC_KEY, ORIGIN_UNKNOWN_REL, VALUE_KEY),
			getValueForKey(dataValues,CC_KEY, ORIGIN_UNKNOWN_UNS, VALUE_KEY)
		]);
		var total_origin_cases = add([origin_autoc, origin_imported, origin_unknown]);
		array[IMPORTED_ROW][column] = origin_imported 
									+ ", "
									+	percentageText(origin_imported, total_origin_cases);

		/* only PKDL TODO: place that if that's true */

		if (column === PKDL_COLUMN){
			var cases = getValueForKey(dataValues,DE_KEY,DE.PKDL_GEN_EPID_cases, VALUE_KEY);
			array[NEW_ROW][column] = cases;
			array[RELAPSE_ROW][column] = WHEN_NON_APPLICABLE;
			array[TOTAL_ROW][column] = cases;
			array[IMPORTED_ROW][column] = WHEN_NON_APPLICABLE; 

			var male = getValueForKey(dataValues, [CC_KEY,DE_KEY], [MALE, DE.PKDL_EPID_sex], VALUE_KEY);
			var female = getValueForKey(dataValues, [CC_KEY,DE_KEY], [FEMALE, DE.PKDL_EPID_sex], VALUE_KEY);
			array[SEX_ROW][column] = percentageText(female, add([male, female]));

			var age_5 = getValueForKey(dataValues,[CC_KEY,DE_KEY], [AGE_5, DE.PKDL_EPID_age], VALUE_KEY);
			var age_5_14 = getValueForKey(dataValues,[CC_KEY,DE_KEY], [AGE_5_14, DE.PKDL_EPID_age], VALUE_KEY);
			var age_14 = getValueForKey(dataValues,[CC_KEY,DE_KEY], [AGE_14, DE.PKDL_EPID_age], VALUE_KEY);
			var total_age_cases = add([age_5, age_5_14, age_14]);

			array[AGE_ROW][column] = "(" +	percentageText(age_5, total_age_cases) + " / "
											+	percentageText(age_5_14, total_age_cases) + " / "
											+	percentageText(age_14, total_age_cases) + ")";		

		}




		/* Diagnosis table */
		
		// active and passive screening
		if (column === PKDL_COLUMN) {
			diagnosisArray[SCREENED_ACTIVELY_ROW][column] = WHEN_NON_APPLICABLE;
			diagnosisArray[SCREENED_PASSIVELY_ROW][column] = WHEN_NON_APPLICABLE;
		} else {
			var screen_active = getValueForKey(dataValues, DE_KEY, DE_SCREEN_ACTIVE[column] , VALUE_KEY);
			var screen_passive = getValueForKey(dataValues, DE_KEY, DE_SCREEN_PASSIVE[column] , VALUE_KEY);
			diagnosisArray[SCREENED_ACTIVELY_ROW][column] = screen_active;
			diagnosisArray[SCREENED_PASSIVELY_ROW][column] = screen_passive;
		}
		

		if (column === VL_COLUMN) {
			// cases diagnosed by RDT and %positive RDT
			var new_rdt = getValueForKey(dataValues,[CC_KEY, DE_KEY],[TYPE_NEW_CASES,diagDE], VALUE_KEY);
			var unsp_rdt = getValueForKey(dataValues,[CC_KEY, DE_KEY],[TYPE_UNSPECIFIED,diagDE], VALUE_KEY);
			var total_rdt = add([new_rdt, unsp_rdt]);

			var positive_new_rdt = getValueForKey(dataValues, CC_KEY, POSITIVE_NEW,  VALUE_KEY);
			var positive_unsp_rdt = getValueForKey(dataValues, CC_KEY, POSITIVE_UNSP,  VALUE_KEY);
			var total_positive_rdt = add([positive_new_rdt, positive_unsp_rdt]);
			
			diagnosisArray[VL_CASES_DIAGNOSED_ROW][column] = percentageCasesAndTotal(total_positive_rdt, total_cases_type);
			diagnosisArray[POSITIVE_RDT_ROW][column] = percentageCasesAndTotal(total_positive_rdt, total_rdt);

			// percentage of cases with HIV-VL coinfection
			var hiv_coinf_new = getValueForKey(dataValues,[CC_KEY, DE_KEY],[POSITIVE_NEW, DE.VL_LAB_HIVstatus_Type], VALUE_KEY); 
			var hiv_coinf_rel = getValueForKey(dataValues,[CC_KEY, DE_KEY],[POSITIVE_RELAPSE, DE.VL_LAB_HIVstatus_Type], VALUE_KEY); 
			var hiv_coinf_uns = getValueForKey(dataValues,[CC_KEY, DE_KEY],[POSITIVE_UNSP, DE.VL_LAB_HIVstatus_Type], VALUE_KEY); 
			var hiv_coinf_total = add([hiv_coinf_new, hiv_coinf_rel, hiv_coinf_uns]);

			diagnosisArray[HIV_COINFECTION_ROW][column] = percentageCasesAndTotal(hiv_coinf_total, total_cases_type);


			/* Treatment table */
		
			var new_cured = getValueForKey(dataValues, CC_KEY, NEW_CURED, VALUE_KEY);
			var rel_cured = getValueForKey(dataValues, CC_KEY, REL_CURED, VALUE_KEY);
			var uns_cured = getValueForKey(dataValues, CC_KEY, UNS_CURED, VALUE_KEY);
			var total_cured = add([new_cured, rel_cured, uns_cured]);

			var new_fail = getValueForKey(dataValues, CC_KEY, NEW_RELOUT, VALUE_KEY);
			var rel_fail = getValueForKey(dataValues, CC_KEY, REL_RELOUT, VALUE_KEY);
			var uns_fail = getValueForKey(dataValues, CC_KEY, UNS_RELOUT, VALUE_KEY);
			var total_fail = add([new_fail, rel_fail, uns_fail]);

			var new_dead = getValueForKey(dataValues, CC_KEY, NEW_DEAD, VALUE_KEY);
			var rel_dead = getValueForKey(dataValues, CC_KEY, REL_DEAD, VALUE_KEY);
			var uns_dead = getValueForKey(dataValues, CC_KEY, UNS_DEAD, VALUE_KEY);
			var total_dead = add([new_dead, rel_dead, uns_dead]);

			treatmentArray[RELAPSE_PROPORTION_ROW][column] = percentageCasesAndTotal(relapse, total_cases_type);
			treatmentArray[INITIAL_CURE_RATE_ROW][column] = percentageCasesAndTotal(total_cured, total_cases_type);
			treatmentArray[FAILURE_RATE_ROW][column] = percentageCasesAndTotal(total_fail, total_cases_type);
			treatmentArray[CASE_FATALITY_ROW][column] = percentageCasesAndTotal(total_dead, total_cases_type);
			
		} else {
			diagnosisArray[VL_CASES_DIAGNOSED_ROW][column] = WHEN_NON_APPLICABLE;
			diagnosisArray[POSITIVE_RDT_ROW][column] = WHEN_NON_APPLICABLE;
			diagnosisArray[HIV_COINFECTION_ROW][column] = WHEN_NON_APPLICABLE;
		}

		// Direct exam
		var direct_exam_new = getValueForKey(dataValues,[CC_KEY, DE_KEY],[TYPE_NEW_CASES, DE.VL_LAB_parasito_tested_type], VALUE_KEY);
		var direct_exam_rel = getValueForKey(dataValues,[CC_KEY, DE_KEY],[TYPE_RELAPSE, DE.VL_LAB_parasito_tested_type], VALUE_KEY);
		var direct_exam_uns = getValueForKey(dataValues,[CC_KEY, DE_KEY],[TYPE_UNSPECIFIED, DE.VL_LAB_parasito_tested_type], VALUE_KEY);
		var direct_exam_total = add([direct_exam_new, direct_exam_rel, direct_exam_uns]);

		diagnosisArray[DIRECT_EXAM_DIAGNOSED_ROW][column] = percentageCasesAndTotal(direct_exam_total, total_cases_type);

		//Positive slides
		var positive_slides_new = getValueForKey(dataValues,[CC_KEY, DE_KEY],[POSITIVE_NEW, DE.VL_LAB_parasito_result_type], VALUE_KEY); 
		var positive_slides_rel = getValueForKey(dataValues,[CC_KEY, DE_KEY],[POSITIVE_RELAPSE, DE.VL_LAB_parasito_result_type], VALUE_KEY); 
		var positive_slides_uns = getValueForKey(dataValues,[CC_KEY, DE_KEY],[POSITIVE_UNSP, DE.VL_LAB_parasito_result_type], VALUE_KEY); 
		var positive_slides_total = add([positive_slides_new, positive_slides_rel, positive_slides_uns]);

		diagnosisArray[POSITIVE_DIRECT_EXAM_ROW][column] = percentageCasesAndTotal(positive_slides_new, positive_slides_total);

		//Cases diagnosed clinically
		var clinical_cases_new = getValueForKey(dataValues,[CC_KEY, DE_KEY],[TYPE_NEW_CASES, DE.VL_LAB_clinical], VALUE_KEY);
		var clinical_cases_rel = getValueForKey(dataValues,[CC_KEY, DE_KEY],[TYPE_RELAPSE, DE.VL_LAB_clinical], VALUE_KEY);
		var clinical_cases_uns = getValueForKey(dataValues,[CC_KEY, DE_KEY],[TYPE_UNSPECIFIED, DE.VL_LAB_clinical], VALUE_KEY);
		var clinical_cases_total = add([clinical_cases_new, clinical_cases_rel, clinical_cases_uns]);

		diagnosisArray[CLINICALLY_DIAGNOSED_ROW][column] = percentageCasesAndTotal(clinical_cases_total, total_cases_type);



	}
	

	// Code to execute after API calls have been done.
	// $.when(ajax1(), ajax2(), ajax3(), ajax4()).done(function(a1, a2, a3, a4){
	// http://stackoverflow.com/questions/3709597/wait-until-all-jquery-ajax-requests-are-done
	$.when(get_cl_cases(), get_vl_cases(), get_azcl_cases(),
		get_monthly_cases_for_cl_current_year(),
		get_monthly_cases_for_cl_previous_year(),
		get_monthly_cases_for_vl_current_year(),
		get_monthly_cases_for_vl_previous_year(),
		get_monthly_cases_for_azcl_current_year(),
		get_monthly_cases_for_azcl_previous_year()).done(function(cl, vl, m1,m2,m3,m4,m5,m6){
		// the code here will be executed when all four ajax requests resolve.
		// a1, a2, a3 and a4 are lists of length 3 containing the response text,
		// status, and jqXHR object for each of the four ajax calls respectively.
		writeTable(epiTableBody, array, EPI_TABLE_TD_ID_PREFIX, LINES_BELOW_LABELS_EPI);
		writeTable(monthlyDistributionTableBody, monthlyArray, MONTHLY_TABLE_TD_ID_PREFIX, LINES_BELOW_LABELS_MONTHLY);
		writeTable(diagTableBody, diagnosisArray, DIAG_TABLE_TD_ID_PREFIX, LINES_BELOW_LABELS_DIAG);
		writeTable(treatmentTableBody, treatmentArray, "", LINES_BELOW_LABELS_TREAT);

		setMonthlyCheckboxes();
		makeElementsFootnotables();

		generate_cl_vl_new_cases_charts();
	});






	/****************************************************************************************************
 	 **********                     		 AUXILIARY FUNCTIONS          	    		       **********
	 ****************************************************************************************************/

	 /*

	

	 */

	function set_aclzcl_mode_to_true_if_data(dataValues){
		if (dataValues !== undefined ){
			acl_and_zcl_activated = true;
		}
	}
	/* return a text about publishing date with the current month and year*/
	function getDatePublished(){
		var d = new Date();
    	var thisMonth = d.getMonth();
		var thisYear = d.getFullYear();
		return PUBLISHED_TEXT+" "+MONTHS[thisMonth]+" "+thisYear;
	}
	/*
		linesOnRows : An array with the number of the rows which must have a line below
	*/
	function writeTable(htmlObject, array, tdIdPrefix, linesOnRows) {
		// declare html variable (a string holder):
		var html = '';
		var count = 0;

		var lineClass = "";
		for (var i = 0; i < array.length; i++) {
			if (linesOnRows[i]){
				lineClass = BOTTOM_LINE_CLASS;
			} else {
				lineClass ="";
			}
			// add opening <tr> tag to the string:
			html += '<tr id="'+tdIdPrefix+i+'" class="'+lineClass+'">';
			for (var j = 0; j < array[i].length; j++) {
				// add <td> elements to the string:
				html += '<td>' + '<span class="footnotable editableElement" >' + array[i][j] + '</span>' + '</td>';
				count++;
			}
			// add closing </tr> tag to the string:
			html += '</tr>';
		}
		//append created html to the table body:
	
		htmlObject.append(html);
		// reset the count:
		count = 0;
	}	

	function makeElementsFootnotables(){
		$(".footnotable").mousedown(function(event) {
			if (event.which === 3){
				if ($(this).hasClass('footNoted')) {
					$(this).text($(this).html().substring(0,$(this).html().length - 11 - footNoteCounter.toString().length));
					footNoteCounter--;
				} else {
					footNoteCounter++;
					$(this).append("<sup>"+footNoteCounter+"</sup>");
				}

				event.preventDefault();
				$(this).toggleClass('footNoted');
			}
		});

		$('.footnotable').contextmenu(function() {
			return false;
		});
	}
	/*	Returns a url for the API

	*/
	function buildAPIUrl(page, params){
		return API_URL+page+"?"+$.param(params, true);
	}

	function numberToTwoDigits( number){
		return ("0" + number).slice(-2);
	}

	/* 	Searchs for a custom value for a customKey with a custom value through an array
			array : the array
			keyName : the name (or an array of) of the key to check
			keyValue : the target (or an array of) value of the keyName
			valueName : the name of the key of the value to return
	*/
	function getValueForKey(array, keyName, keyValue, valueName){
		var returnValue;
		if (array === undefined){
			return returnValue;
		}
		if (typeof keyName === 'string') {
			// one property check
			$.each( array, function( index, object ) {
				if(object[keyName]===keyValue){
					returnValue = object[valueName];
					return false;
				} 
			});
		} else if (keyName.length > 1 && keyValue.length > 1) {
			// two properties check  // not used
			$.each( array, function( index, object ) {
				if(object[keyName[0]]===keyValue[0] && object[keyName[1]]===keyValue[1]){
					returnValue = object[valueName];
					return false;
				} 
			});
		} else {
			console.log('ERROR in ' + arguments.callee.name);
			return 'ERROR in ' + arguments.callee.name ;
		}
		
		return returnValue;
	}

		/* 	Searchs for a custom value for a customKey with a custom value through an array
			array : the array
			keyName : the name (or an array of) of the key to check
			keyValue : the target (or an array of) alue of the keyName
			valueName : the name of the key of the value to return
	*/
	function getValuesForKeyByMonth(array, keyName, keyValue, valueName){
		var returnValue =  new Array(12); // Void array of size 12
		if (array === undefined){
			return returnValue;
		}

		var index, period;
		if (typeof keyName === 'string') {
			// one property check
			$.each( array, function( index, object ) {
				if(object[keyName]===keyValue){
					period = object[PERIOD_KEY];
					index = Number(period.slice(period.length-2, period.length)) - 1;
					returnValue[index] = object[valueName];
				} 
			});
		} else if (keyName.length > 1 && keyValue.length > 1) {
			// two properties check
			$.each( array, function( index, object ) {
				if(object[keyName[0]]===keyValue[0] && object[keyName[1]]===keyValue[1]){
					period = object[PERIOD_KEY];
					index = Number(period.slice(period.length-2, period.length)) - 1;
					returnValue[index] = object[valueName];
				} 
			});
		} else {
			console.log('ERROR in ' + arguments.callee.name);
			return 'ERROR in ' + arguments.callee.name ;
		}
		return returnValue;
	}

	/*	Returns a percentage with no decimals, the #cases and the total between parenthesis

	*/
	function percentageCasesAndTotal(numerator, denominator){
		return 	percentageText(numerator, denominator) + "  (" +
				numerator + " / " + denominator + ")";
	}

	/*	Returns a percentage with no decimals 

	*/
	function percentageText(numerator, denominator){
		if (denominator === 0 && numerator === 0){
			return WHEN_DIV_0;
		} else if (denominator === WHEN_UNDEFINED){
			return WHEN_UNDEFINED;
		} else if (denominator === 0){
			return ERROR;
		}
		return Math.round((numerator / (denominator))*100) + "%";
	}

	/* Returns the addition of the elements of the array if they are not 
	*/
	function add(arrayOfNumbers){
		var addition = 0;
		var counter = 0;
		for (var number of arrayOfNumbers) {
			if (typeof number !== "undefined" && number != WHEN_UNDEFINED){
				addition = addition + +number;
				counter++;
			} 
		}
		if (counter === 0){
			return WHEN_UNDEFINED;
		} else {
			return addition;
		}
	}

	/** Creates a 2 dimension array with labels.
		rowsNum: Length of first array dimension (number of rows)
		rowsTitles : labels for 
		mode : the place for labels in array. Options : LABELS_ON_COLUMNS or LABELS_ON_ROWS
	*/
	function  create_2_dim_array(rowsNum, rowsTitles, mode) {
		var array = []
		
		if(mode === LABELS_ON_ROWS) {
			array[0] = [];
			for(var i = 0; i<rowsTitles.length; i++){
				array[0][i] = rowsTitles[i];
			}
			for(var i = 1; i<rowsNum; i++){
				array[i] = [];
			}
		} else {
			for(var i = 0; i<rowsNum; i++){
				array[i] = [];
				array[i][0] = rowsTitles[i];
			}
		}
		return array;
	}

	function setMonthlyCheckboxes(){
		// checked by default, trigger click for desactivate and for fire behaviour.
		$('#'+MONTHLY_TABLE_TD_ID_PREFIX+BUTTON_PREFIX+VL_PREVIOUS_YEAR_ROW).trigger('click');//.prop('checked', false);
		$('#'+MONTHLY_TABLE_TD_ID_PREFIX+BUTTON_PREFIX+CL_PREVIOUS_YEAR_ROW).trigger('click');//.prop('checked', false);
		$('#'+MONTHLY_TABLE_TD_ID_PREFIX+BUTTON_PREFIX+ACL_PREVIOUS_YEAR_ROW).trigger('click');//.prop('checked', false);
		$('#'+MONTHLY_TABLE_TD_ID_PREFIX+BUTTON_PREFIX+ZCL_PREVIOUS_YEAR_ROW).trigger('click');//.prop('checked', false);

		//$('#'+LEISH_COLUMN_DETAIL_PREFIX+BUTTON_PREFIX+VL_COLUMN).trigger('click');
		//$('#'+LEISH_COLUMN_DETAIL_PREFIX+BUTTON_PREFIX+MCL_COLUMN).trigger('click');

		if(acl_and_zcl_activated){
			
			$('#'+MONTHLY_TABLE_TD_ID_PREFIX+BUTTON_PREFIX+CL_ROW).trigger('click');

			$('#'+LEISH_COLUMN_DETAIL_PREFIX+BUTTON_PREFIX+(CL_COLUMN-1)).trigger('click');
			$('#'+LEISH_COLUMN_DETAIL_PREFIX+BUTTON_PREFIX+(PKDL_COLUMN-1)).trigger('click');
		} else {
			$('#'+MONTHLY_TABLE_TD_ID_PREFIX+BUTTON_PREFIX+ACL_ROW).trigger('click');
			$('#'+MONTHLY_TABLE_TD_ID_PREFIX+BUTTON_PREFIX+ZCL_ROW).trigger('click');

			$('#'+LEISH_COLUMN_DETAIL_PREFIX+BUTTON_PREFIX+(ACL_COLUMN-1)).trigger('click');
			$('#'+LEISH_COLUMN_DETAIL_PREFIX+BUTTON_PREFIX+(ZCL_COLUMN-1)).trigger('click');
		}




		$(':checkbox').button( "refresh" );
	}

	/****************************************************************************************************
	 **********                               CHARTS functions                                 **********
	 ****************************************************************************************************/

	/* Retrieves the data of vl and cl or acl/zcl, configures the charts and generates them.
	*/
	function generate_cl_vl_new_cases_charts (){
	
		if (acl_and_zcl_activated) {
			var colors = [COLORS.blue, COLORS.blue, COLORS.green, COLORS.green];
			var labels = [ACL_CHART_LEGEND +year, ACL_CHART_LEGEND +(year-1), ZCL_CHART_LEGEND + year, ZCL_CHART_LEGEND  + (year-1)];
			
			var acl_current_year = monthlyArray[ACL_ROW].slice(1,monthlyArray[ACL_ROW].length);
			var zcl_current_year = monthlyArray[ZCL_ROW].slice(1,monthlyArray[ZCL_ROW].length);
			var acl_previous_year = monthlyArray[ACL_PREVIOUS_YEAR_ROW].slice(1,monthlyArray[ACL_PREVIOUS_YEAR_ROW].length);
			var zcl_previous_year = monthlyArray[ZCL_PREVIOUS_YEAR_ROW].slice(1,monthlyArray[ZCL_PREVIOUS_YEAR_ROW].length);

			var dataarrays = [acl_current_year, acl_previous_year, zcl_current_year, zcl_previous_year];


		} else {
			var colors = [COLORS.blue, COLORS.blue];
			var labels = [CL_CHART_LEGEND + year, CL_CHART_LEGEND + (year-1)];
			var cl_current_year = monthlyArray[CL_ROW].slice(1,monthlyArray[CL_ROW].length);
			var cl_previous_year = monthlyArray[CL_PREVIOUS_YEAR_ROW].slice(1,monthlyArray[CL_PREVIOUS_YEAR_ROW].length);
			var dataarrays = [cl_current_year, cl_previous_year];
		
		}
		lineChart(newCLCasesChartID, MONTHS_ABBREV, labels, dataarrays, colors, true);
		
		var vl_current_year = monthlyArray[VL_ROW].slice(1,monthlyArray[VL_ROW].length);
		var vl_previous_year = monthlyArray[VL_PREVIOUS_YEAR_ROW].slice(1,monthlyArray[VL_PREVIOUS_YEAR_ROW].length);
		var vl_data_arrays = [vl_current_year, vl_previous_year];
		var vl_colors = [COLORS.violet, COLORS.violet];
		var vl_labels = [VL_CHART_LEGEND + year, VL_CHART_LEGEND + (year-1)];

		lineChart(newVLCasesChartID, MONTHS_ABBREV, vl_labels, vl_data_arrays, vl_colors, true);

	}
	/* 	Generates an any-lines-number line graph. 
		htmlElementID: the id of the canvas/html element where put the graph
		x_labels: The labels for the x-axis  
		dataLabelArray: an array with the label of each data line
		dataArray: the data
		colorArray: an Array of rgba colors
		previousYearMode: true if wanted to put previous years in dotted colors.
						  currentYear data must be preceed the previousYear data
		Note: All the array must have same size !
	*/
	function lineChart(	htmlElementID, x_labels, dataLabelArray, dataArray, colorArray, previousYearMode){

		
		var theDataSets = [];
		var aDataSet = {};
		for (var i = 0; i<dataLabelArray.length; i++){
			aDataSet = {};
			aDataSet.label = dataLabelArray[i];
			aDataSet.fill = false;
			aDataSet.data = dataArray[i];
			aDataSet.backgroundColor = colorArray[i];
			aDataSet.borderColor = colorArray[i];
			aDataSet.borderWidth = 2;
			if (previousYearMode && i%2 == 1){
				// previousYearMode Enabled
				aDataSet.borderDash = [5];
				aDataSet.backgroundColor = aDataSet.backgroundColor.slice(0, -2)+"0.2)";
			}
			theDataSets[i] = aDataSet;
		}
		
		var ctx = document.getElementById(htmlElementID);
		var myChart = new Chart(ctx, {
		type: 'line',
		data: {
			labels: x_labels,
			datasets: theDataSets
			},
			options: {
				scales: {
					yAxes: [{
						ticks: {
							beginAtZero:true
						}
					}]
				},
				responsive: false
			}
		});
	}


	function setChartPlugin(chartPlugin){
	 	chartPlugin.url = "https://extranet-uat.who.int/dhis2-dev";
		chartPlugin.username = "ramon2";
		chartPlugin.password = "1234Abcd";

		return chartPlugin;
	}

	function setChartParams(columnDimension, dataId, dataName, orgUnitId, chatType, url, htmlElement){

		chartTestParams = {
		"columns": [
			{
			"dimension": columnDimension,
			"items": [
				{
				"id": dataId,
				"name": dataName
				}
			]
			}
		],
		
		"rows": [
			{
			"dimension": "pe",
			"items": []
			}
		],
		"filters": [
			{
			"dimension": "ou",
			"items": [
				{
				"id": orgUnit.id
				}
			]
			}
		],
		"type": chatType,
		"url": url,
		"el": htmlElement
		}
		var items = generateChartRowParams();
		chartTestParams["rows"][0]["items"] = items;
		return chartTestParams;
	}

	function generateChartRowParams(){
		var itemsArray = [];
		var rows = [{ 
      "dimension": "pe",
      "items": itemsArray}];
	  	var element = {};
		  for(var i = 0; i<MONTHS.length;i++){
			element = {};
			element.id = year+""+numberToTwoDigits(i+1);
			element.name = MONTHS_ABBREV[i];
			itemsArray[i] = element;
		  }
		  return itemsArray;
	}



		/****  **********  ******  ********  ******  ******   *****  *//***** ********  *****  *** *//****
	 ****  **                                TEST ZONE                                          **********
	 ** ********    ******** **** ********* ******* ************   *********** *********** ******* *******/


/*
	chartPlugin = setChartPlugin(chartPlugin);
	var chartTestParams = setChartParams("B9bBfRcF6jb", "aD1KD82UFB1", "New", orgUnit.id, "line", chartPlugin.url, "chart1");
	chartPlugin.load([chartTestParams]);
*/

	// Listener ACL/ZCL PKDL buttons
	$(":checkbox."+LEISH_COLUMN_DETAIL_PREFIX).change(function() {
		var index = Number(this.id.slice(this.id.length-1, this.id.length));
		$('#epiTable tr, #diagTable tr').each(function() {
			$(this).find("td,th").eq(index+1).toggle();
		});
	});
	
	// Listener monthly buttons
	$(":checkbox."+MONTHLY_TABLE_TD_ID_PREFIX).change(function() {
		var index = Number(this.id.slice(this.id.length-1, this.id.length));
		var startingid = this.id.slice(0, -1-BUTTON_PREFIX.length);
		$("#"+startingid+index).toggle();
		
	});
	
		
	
} );
</script>

<!--
	/****************************************************************************************************
     **********		   																		   **********
 	 **********            	  		  	      3. HTML CODE              	    			   **********
 	**********		   																		   **********
	 ****************************************************************************************************/
	-->
<div class="non-printable section"><hr>
Configuration Area - Wont be printed<br>
	Instructions : Right click to add a footnote number.<br>
					Left click to edit an element.

<fieldset id="leish_detail_checkboxes"></fieldset>
<fieldset id="monthlyCheckboxes"></fieldset>


<hr>

</div>
<div class="section">
    <img class="head_logo center" src="http://www.who.int/about/Logo-WHO.jpg" />
	<br>
	
	<div class="container">
	
		<div class="editableElement">Leishmaniasis</div>
		<div class="center_text editableElement" id="country_name"></div>
		<div class="align_to_right">
			<div class="editableElement" id="year"></div>
			<div class="editableElement" id="published_date"></div>
		</div>
	</div>
</div>

<div class="section">
	<h4 class="editableElement footnotable">Country General Information </h4>
	
</div>

<div class="section">
	<h4 class="editableElement footnotable">Epidemiology</h4>


	<table id="epiTable" class="display" cellspacing="0" width="100%">
			<thead>
				<tr id ="epiTableHead"></tr>
			</thead>
			<tbody id="epiTableBody"></tbody>
	</table>


</div>


<div class="section">
	<h4 class="editableElement footnotable" >Monthly distribution of new cases January-December</h4>

	<table id="monthlyDistributionTable" class="display" cellspacing="0" width="100%">
			<thead>
				<tr id ="monthlyDistributionTableHead"></tr>
			</thead>
			<tbody id="monthlyDistributionTableBody"></tbody>
	</table>

</div>


<div class="section">
	<img id="b01" style="margin-right: 20px">
	<img id="b02">

	<div id="dialog-editor">
		<textarea id="editor" title="Edit field"></textarea>
		
	</div>

</div>

<!--
<div id="chart1" width="450" height="300"></div>
-->
<canvas id="NewCLCasesChart" width="450" height="300" ></canvas>
<canvas id="NewVLCasesChart" width="450" height="300" ></canvas>


<div class="section">
	<h4 class="editableElement footnotable" >Diagnosis</h4>

	<table id="diagTable" class="display" cellspacing="0" width="100%">
			<thead>
				<tr id ="diagTableHead"></tr>
			</thead>
			<tbody id="diagTableBody"></tbody>
	</table>

</div>


<div class="section">
	<h4 class="editableElement footnotable" >Treatment and medicines</h4>

	<table id="treatmentTable" class="display" cellspacing="0" width="100%">
			<thead>
				<tr id ="treatmentTableHead"></tr>
			</thead>
			<tbody id="treatmentTableBody"></tbody>
	</table>

</div>
