
<!--
	/****************************************************************************************************
 	 **********		   																		   **********
 	 **********                      Report App for DHIS2 Leishmaniasis 2017               	   **********
 	 **********		   																		   **********
	 ****************************************************************************************************/


	 	* @author  Ramon Jose Jimenez Pomareta 
		* @email ramon@pomareta.ch
 		* @version 1.0 
		* @date 26/04/2017


		* Some comments
			Since this App has to be made in only one file, all is here.
			When needed external js plugins, i.e. jquery-te and jquery-ui, I have stored a version in 
			https://github.com/Rjjp/plugins
			In order to share raw files, I have used https://rawgit.com/


		* Sections of the code. 
		1. CSS styles
		2. JavaScript
			jQuery-ui styles       
			JavaScript imports
			CONSTANTS
			STATIC CONTENT FUNCTIONS
			FUNCTIONS CALLING THE API 
			FILLING LOGICAL STRUCTURES (ARRAYS)
			AUXILIARY FUNCTIONS
			CHARTS FUNCTIONS
		3. HTML Code
-->
<style type="text/css">
/****************************************************************************************************
 **********		   																		   **********
 **********                                1. CSS STYLES                                   **********
 **********		   																		   **********
 ****************************************************************************************************/
@media print {
   .non-printable {
       display: none;
    }
    
}
@page 
    {
        size:  auto;   /* auto is the initial value */
        margin: 0mm;  /* this affects the margin in the printer settings */
    }

    html
    {
        background-color: #FFFFFF; 
        margin: 0px;  /* this affects the margin on the html before sending to printer */
    }

    body
    {
        border: solid 1px blue ;
        margin: 1mm 15mm 1mm 15mm; /* margin you want for the content */
    }


/* selectable */
 #selectable .ui-selecting { background: #FECA40; }
  #selectable .ui-selected { background: #F39814; color: white; }
  #selectable { list-style-type: none; margin: 0; padding: 0; width: 60%; }
  #selectable li { margin: 3px; padding: 0.4em; font-size: 1.4em; height: 18px; }


.section
{
	border-bottom: 1px solid #ccc;
	margin-bottom: 50px; 
	padding-bottom: 50px;
	width: 930px;
	font-size: 15px;
}


.head_logo{
	width:160px;
}


img.center {
    display: block;
    margin: 0 auto;
}

.center_text{
	text-align: center;
}
.align_to_right{
	text-align:right;
}

/* Organize content of div in equal-sized colons*/
.container {
  display: flex;
}
.container > div {
  flex: 1; /*grow*/
}


.footNoted {
  /*  color: red; */	
}
</style>
<!-- 

/****************************************************************************************************
 **********		   																		   **********
 **********                            		2. JavaScript                                  **********
 **********		   																		   **********
 ****************************************************************************************************/
	
/****************************************************************************************************
 **********                             JavaScript imports                                 **********
 ****************************************************************************************************/
 -->
<script type="text/javascript" src ="https://cdn.rawgit.com/Rjjp/plugins/master/jquery-te-1.4.0-oms.js"></script>
<script type="text/javascript" src ="https://cdn.rawgit.com/Rjjp/plugins/master/jquery-ui/jquery-ui.js">//TODO:use the cdn officiel</script>
<script type="text/javascript" src="//dhis2-cdn.org/v226/plugin/chart.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.js"></script>

<script type="text/javascript">

$( document ).ready( function() {

	/* Adds jQueryTE and jquery-ui css' */

	$('head').append('<link rel="stylesheet" href="https://rawgit.com/Rjjp/plugins/master/jquery-te-1.4.0.css" type="text/css" />');
 	$('head').append('<link rel="stylesheet" href="https://cdn.rawgit.com/Rjjp/plugins/master/jquery-ui/jquery-ui.css" type="text/css" />');


	/****************************************************************************************************
	 **********                               jQuery-ui styles                                 **********
	 ****************************************************************************************************/
	


	/****************************************************************************************************
 	 **********                      	       CONSTANTS            	              	       **********
	 ****************************************************************************************************/
	var API_URL = "../api/";
	var DATA_VALUE_SETS = "dataValueSets";
	var WHEN_UNDEFINED = "No data";
	var WHEN_DIV_0 = "-";
	var ERROR = "Error!";

	var LABELS_ON_ROWS = 0;
	var LABELS_ON_COLUMNS = 1;

	var PUBLISHED_TEXT = "Published in ";

	var MONTHS = [	"January",
					"February",
					"March",
					"April",
					"May",
					"June",
					"July",
					"August",
					"September",
					"October",
					"November",
					"December" ];

	var MONTHS_ABBREV = [	"JAN",
							"FEB",
							"MAR",
							"APR",
							"MAY",
							"JUN",
							"JUL",
							"AUG",
							"SEP",
							"OCT",
							"NOV",
							"DEC"];

	var COLORS = {
		green : 'rgba(153, 204, 0, 1)',
		soft_green : 'rgba(153, 204, 0, 0.2)',
		blue: 'rgba(51, 153, 255, 1)',
		soft_blue: 'rgba(51, 153, 255, 0.2)',
		violet :'rgba(153, 0, 255, 1)',
		soft_violet :'rgba(153, 0, 255, 0.2)'
	}
	
	var DATASET = {
		CL : "tnek2LjfuIm",
		VL : "fdBM4sWSuPR",
		CL_MONTHLY : "pWGPGaE6knJ",
		VL_MONTHLY : "GW4lVTTLWfW",
		ACL_MONTHLY : "YfnF9NPpP4c"

	};
	var DATAELEMENT = {
		ACL_EPI_Type : "f1bBSpuIyzD",
		ZCL_EPI_Type : "Ta96pnXcAum"
	};

	var TYPE_NEW_CASES = "psVSPLclyFj";
	var TYPE_RELAPSE = "KPn9RHNrd8R";
	var TYPE_UNSPECIFIED = "IRW4YrOtk5q";

	var COMBO_MEN = "GpQZH8hC7jY";
	var COMBO_WOMEN = "TtoYCIVcBA3";

	var AGE_5 = "hKq5WASZw8q";
	var AGE_5_14 = "mTyLqDjpQ5b";
	var AGE_14 = "DDliBAHqwGV";
	var AGE_TOTAL = "OWKZMKxVCnh";

	var ORIGIN_AUTOC_NEW = "WynvvdELtqm";
	var ORIGIN_AUTOC_REL = "LUVeZjOsibr";
	var ORIGIN_AUTOC_UNS = "wYB0E3USJ7L";
	var ORIGIN_IMPORT_NEW = "pWZT12mjhUC";
	var ORIGIN_IMPORT_REL = "QO2kKL8ySPc";
	var ORIGIN_IMPORT_UNS = "A5TSwm9Wivn";
	var ORIGIN_UNKNOWN_NEW = "Lx8tyhhseZZ";
	var ORIGIN_UNKNOWN_REL = "lGFgLYweSNS";
	var ORIGIN_UNKNOWN_UNS = "EGvT9lj2BOy";

	/* Epidemiology table constants */
	var VL_COLUMN = 1;
	var CL_COLUMN = 2;
	var PKDL_COLUMN = 3;
	var MCL_COLUMN = 4;

	var ENDEMICITY_ROW = 0;
	var NEW_ROW = 1;
	var RELAPSE_ROW = 2;
	var TOTAL_ROW = 3;
	var IMPORTED_ROW = 4;
	var SEX_ROW = 5;
	var AGE_ROW = 6;
	var INCD_ROW = 7;
	var THIRD_LEVEL_ROW = 8;
	var RISK_ROW = 9;
	var OUTBK_ROW = 10;
	var FOCI_ROW = 11;
	var UNSP_ROW = 12;



	var date = dhis2.report.date;
	var year = date.slice(0,4);

	var orgUnit = dhis2.report.organisationUnit;
	var country_name =orgUnit.name;

	var acl_and_zcl_activated = false;

	console.log(dhis2);
	console.log(dhis2.report);
	console.log(orgUnit);
	console.log(country_name);

	/* Set Epidemiology table values
	*/
	$( "#vl_head" ).text("VL");
	$( "#cl_head" ).text("CL");
	$( "#pkdl_head" ).text("PKDL");
	$( "#mcl_head" ).text("MCL");


	var editingElement;

	/*** TEST AREA ****/
	$("#editor").jqte();	

	$( "#selectable" ).selectable();

 dialog = $( "#dialog-editor" ).dialog({
      autoOpen: false,
      height: 350,
      width: 650,
      modal: true,
      buttons: {
        "Save changes": saveChanges,
		"Save changes and close": saveChangesAndClose,
        Cancel: function() {
          dialog.dialog( "close" );
        }
      },
      close: function() {
       
        //allFields.removeClass( "ui-state-error" );
      }
    });

	function saveChanges(){
		editingElement.innerHTML = $("#editor").jqteVal();
	}
	function saveChangesAndClose(){
		editingElement.innerHTML = $("#editor").jqteVal();
		dialog.dialog( "close" );
	}
	

	$(".editableElement").click(function(){
		dialog.dialog( "open" );	
		var test = this.innerHTML;
		editingElement = this;
		$("#editor").jqteVal(editingElement.innerHTML);

	});


	/**** END TEST AREA ****/




	var footNoteCounter = 0;
	
	/* HTML elements */
	var table = 	$("#example");
	var tableBody = 	$("#tbody3");
	var monthlyDistributionTableBody = $("#monthlyDistributionTableBody");
	var monthlyDistributionTableHead = $("#monthlyDistributionTableHead");
	var newCLCasesChartID = "NewCLCasesChart";
	var newVLCasesChartID = "NewVLCasesChart";
	
	var EPI_TABLE_TD_ID_PREFIX = "epiTable";
	var MONTHLY_TABLE_TD_ID_PREFIX = "monthlyTable";
	var BUTTON_PREFIX = '_b_';

	var rowTitles = [	"Endemicity status:",
						"Number of new cases (incidence):",
						"Number of relapse cases:",
						"Total number of cases:",
						"Imported cases (#, %):",
						"Gender distribution (%F):",
						"Age group distribution (%, <5/5-14/>14):",
						"Incidence rate (cases/10 000 population in endemic areas):",
						"Number of endemic 3rd sub-national administrative level divisions (n):",
						"Population at risk (%, n/total):",
						"Was there anz outbreak?",
						"Number of new foci:",
						"(EXTRA) Unspecified cases:"
						]

	var array = create_2_dim_array(rowTitles.length, rowTitles, LABELS_ON_COLUMNS);

	/* Monthly distribution table constants */
	var VL_ROW = 0;
	var CL_ROW = 1;
	var VL_PREVIOUS_YEAR_ROW = 2;
	var CL_PREVIOUS_YEAR_ROW = 3;
	var ACL_ROW = 4;
	var ZCL_ROW = 5;
	var ACL_PREVIOUS_YEAR_ROW = 6;
	var ZCL_PREVIOUS_YEAR_ROW = 7;

	var rowMonthlyTitles = ["VL",
							"CL",
							"VL (previous year)",
							"CL (previous year)",
							"ACL",
							"ZCL",
							"ACL (previous year)",
							"ZCL (previous year)"
							];

	var monthlyArray = create_2_dim_array(rowMonthlyTitles.length, rowMonthlyTitles, LABELS_ON_COLUMNS);

	
	/* Set charts*/
	$( "#a01" ).attr( "src", API_URL+"charts/Ox5bv6fKEWg/data?width=450&height=300&date=" + date );
	$( "#a02" ).attr( "src", API_URL+"charts/Ox5bv6fKEWg/data?width=450&height=300&date=" + date );
	$( "#a03" ).attr( "src", API_URL+"charts/Ox5bv6fKEWg/data?width=450&height=300&date=" + date );
	$( "#a04" ).attr( "src", API_URL+"charts/XGEAenGcRaB/data?width=450&height=300&date=" + date );

	//$( "#table1" ).load( API_URL+"reportTables/emMtuwdfwb1/data.html?date=" + date );

	$( "#b01" ).attr( "src", API_URL+"maps/uFcRuF2LsOo/data?width=450&date=" + date );
	$( "#b02" ).attr( "src", API_URL+"maps/xPc4t89kEXl/data?width=450&date=" + date );



	$( "#country_name" ).text(country_name);
	$( "#year" ).text(year);
	$( "#published_date").text(getDatePublished());



	var params = {
		dataSet: "", //i.e. DATASET.CL,
		period: year,
		orgUnit: orgUnit.id
		
		};


	var builtUrl;

	/************************************************
	Starting calls
	*/

	generateMonthlyCheckboxes();
	fillMonthlyTableHead(monthlyDistributionTableHead);

	/****************************************************************************************************
 	 **********                    	     STATIC CONTENT FUNCTIONS         	           	       **********
	 ****************************************************************************************************/
	function fillMonthlyTableHead(htmlObject){
		var html = '<th></th>';
		
		for (var i=0; i<MONTHS_ABBREV.length;i++){
			html +='<th class="editableElement">'+MONTHS_ABBREV[i]+'</th>';
		}

		htmlObject.append(html);
	}

	function generateMonthlyCheckboxes(){
		var html = '<legend>Monthly distribution table: </legend>';
		for (var i=0; i<rowMonthlyTitles.length; i++){
			html+='<input id="'+MONTHLY_TABLE_TD_ID_PREFIX+BUTTON_PREFIX+i+'" type="checkbox" checked="checked" />'
			html+='<label for="'+MONTHLY_TABLE_TD_ID_PREFIX+BUTTON_PREFIX+i+'">'+rowMonthlyTitles[i]+'</label>'
		}
		    
		$( "#monthlyCheckboxes" ).append(html);

		$('input[type=checkbox]').checkboxradio();
	}

	/****************************************************************************************************
 	 **********                    	    FUNCTIONS CALLING THE API         	           	       **********
	 ****************************************************************************************************/
	function get_monthly_cases_for(dataset, row, year) {
		var params = {
			dataSet: dataset,
			period: [],
			orgUnit: orgUnit.id
		}

		for (var i=1;i<=12;i++){
			var monthNumber = numberToTwoDigits(i);
			params.period[i] = year + monthNumber;
		}

		builtUrl = buildAPIUrl(DATA_VALUE_SETS, params);
		return $.ajax({
			url: builtUrl
		}).then(function(data) {
			if(typeof row === 'number'){
				fillMonthlyArray(row, data.dataValues);
			} else if (row.length>1){
				fillMonthlyArrayACLZCL(row[0], row[1], data.dataValues);
			}
		});
	}

	function get_monthly_cases_for_cl_current_year() {
			return get_monthly_cases_for(DATASET.CL_MONTHLY, CL_ROW, year);
	}
	function get_monthly_cases_for_cl_previous_year() {
			return get_monthly_cases_for(DATASET.CL_MONTHLY, CL_PREVIOUS_YEAR_ROW, year-1);
	}
	function get_monthly_cases_for_vl_current_year() {
			return get_monthly_cases_for(DATASET.VL_MONTHLY, VL_ROW, year);
	}
	function get_monthly_cases_for_vl_previous_year() {
			return get_monthly_cases_for(DATASET.VL_MONTHLY, VL_PREVIOUS_YEAR_ROW, year-1);
	}
	function get_monthly_cases_for_azcl_current_year() {
			return get_monthly_cases_for(DATASET.ACL_MONTHLY, [ACL_ROW, ZCL_ROW], year);
	}
	function get_monthly_cases_for_azcl_previous_year() {
			return get_monthly_cases_for(DATASET.ACL_MONTHLY, [ACL_PREVIOUS_YEAR_ROW, ZCL_PREVIOUS_YEAR_ROW], year-1);
	}
	

	/* getting cl cases from API */
	function get_cl_cases() {

		params.dataSet = DATASET.CL;
		builtUrl = buildAPIUrl(DATA_VALUE_SETS, params);
		return $.ajax({
			url: builtUrl
		}).then(function(data) {
				decide_cl_or_aclzcl_mode(data.dataValues);
				fillArray(data.dataValues, CL_COLUMN);
		});
	}

	/* getting vl cases from API */
	function get_vl_cases() {
		params.dataSet = DATASET.VL;
		builtUrl = buildAPIUrl(DATA_VALUE_SETS, params);
		return $.ajax({
			url: builtUrl
		}).then(function(data) {
				fillArray(data.dataValues, VL_COLUMN);
		});
	}


	/****************************************************************************************************
 	 **********                      FILLING LOGICAL STRUCTURES (ARRAYS)               	       **********
	 ****************************************************************************************************/

	 /***

	 */
	function fillMonthlyArray(row, dataValues) {
		var new_cases_by_month = getValuesForKeyByMonth(dataValues,"categoryOptionCombo",TYPE_NEW_CASES,"value");
		var relapses_by_month = getValuesForKeyByMonth(dataValues,"categoryOptionCombo",TYPE_RELAPSE,"value");
		var unspecified_by_month = getValuesForKeyByMonth(dataValues,"categoryOptionCombo",TYPE_UNSPECIFIED,"value");

		var total_cases_by_month;
		var starting_column = monthlyArray[row].length;

		for (var i=starting_column; i<new_cases_by_month.length+starting_column; i++){
			total_cases_by_month = add([	new_cases_by_month[i-starting_column],
										relapses_by_month[i-starting_column],
										unspecified_by_month[i-starting_column] ]);
			monthlyArray[row][i] = total_cases_by_month;
		}
		
	}	 
	/***

	 */
	function fillMonthlyArrayACLZCL(aclRow, zclRow, dataValues) {
		var new_cases_by_month_acl = getValuesForKeyByMonth(dataValues,["categoryOptionCombo", "dataElement"],[TYPE_NEW_CASES, DATAELEMENT.ACL_EPI_Type],"value");
		var relapses_by_month_acl = getValuesForKeyByMonth(dataValues,["categoryOptionCombo", "dataElement"],[TYPE_RELAPSE, DATAELEMENT.ACL_EPI_Type],"value");
		var unspecified_by_month_acl = getValuesForKeyByMonth(dataValues,["categoryOptionCombo", "dataElement"],[TYPE_UNSPECIFIED, DATAELEMENT.ACL_EPI_Type],"value");

		var new_cases_by_month_zcl = getValuesForKeyByMonth(dataValues,["categoryOptionCombo", "dataElement"],[TYPE_NEW_CASES, DATAELEMENT.ZCL_EPI_Type],"value");
		var relapses_by_month_zcl = getValuesForKeyByMonth(dataValues,["categoryOptionCombo", "dataElement"],[TYPE_RELAPSE, DATAELEMENT.ZCL_EPI_Type],"value");
		var unspecified_by_month_zcl = getValuesForKeyByMonth(dataValues,["categoryOptionCombo", "dataElement"],[TYPE_UNSPECIFIED, DATAELEMENT.ZCL_EPI_Type],"value");

		var total_cases_by_month;
		var starting_column = monthlyArray[aclRow].length;

		for (var i=starting_column; i < new_cases_by_month_acl.length + starting_column; i++){
			total_cases_by_month = add([	new_cases_by_month_acl[i - starting_column],
										relapses_by_month_acl[i - starting_column],
										unspecified_by_month_acl[i - starting_column] ]);
			monthlyArray[aclRow][i] = total_cases_by_month;
		}
		for (var i=starting_column; i < new_cases_by_month_zcl.length + starting_column; i++){
			total_cases_by_month = add([	new_cases_by_month_zcl[i - starting_column],
										relapses_by_month_zcl[i - starting_column],
										unspecified_by_month_zcl[i - starting_column] ]);
			monthlyArray[zclRow][i] = total_cases_by_month;
		}
		
	}

	function fillArray(dataValues, column) {
		var new_cases = getValueForKey(dataValues,"categoryOptionCombo",TYPE_NEW_CASES,"value");
		array[NEW_ROW][column] = new_cases;
		var relapse = getValueForKey(dataValues,"categoryOptionCombo",TYPE_RELAPSE,"value");
		array[RELAPSE_ROW][column] = relapse;
		var unspecified = getValueForKey(dataValues,"categoryOptionCombo",TYPE_UNSPECIFIED,"value");
		array[UNSP_ROW][column] = unspecified;
		array[TOTAL_ROW][column] = add([new_cases, relapse, unspecified]);

		// sex distribution  TODO onlz news!
		var men = getValueForKey(dataValues,"categoryOptionCombo", COMBO_MEN,"value");
		var women = getValueForKey(dataValues,"categoryOptionCombo",COMBO_WOMEN,"value");
		array[SEX_ROW][column] = percentageText(women, add([men, women]));
		
		//age distribution TODO onlz news!
		// Todo Age Unknown	
		var age_5 = getValueForKey(dataValues,"categoryOptionCombo", AGE_5,"value");
		var age_5_14 = getValueForKey(dataValues,"categoryOptionCombo", AGE_5_14,"value");
		var age_14 = getValueForKey(dataValues,"categoryOptionCombo", AGE_14,"value");
		var total_age_cases = add([age_5, age_5_14, age_14]);

		array[AGE_ROW][column] = "(" +	percentageText(age_5, total_age_cases) + " / "
										+	percentageText(age_5_14, total_age_cases) + " / "
										+	percentageText(age_14, total_age_cases) + ")";
											

		//origin distribution
		var origin_autoc = add([
			getValueForKey(dataValues,"categoryOptionCombo", ORIGIN_AUTOC_NEW,"value"),
			getValueForKey(dataValues,"categoryOptionCombo", ORIGIN_AUTOC_REL,"value"),
			getValueForKey(dataValues,"categoryOptionCombo", ORIGIN_AUTOC_UNS,"value")
		]);
		var origin_imported = add([
			getValueForKey(dataValues,"categoryOptionCombo", ORIGIN_IMPORT_NEW,"value"),
			getValueForKey(dataValues,"categoryOptionCombo", ORIGIN_IMPORT_REL,"value"),
			getValueForKey(dataValues,"categoryOptionCombo", ORIGIN_IMPORT_UNS,"value")
		]);
		var origin_unknown = add([
			getValueForKey(dataValues,"categoryOptionCombo", ORIGIN_UNKNOWN_NEW,"value"),
			getValueForKey(dataValues,"categoryOptionCombo", ORIGIN_UNKNOWN_REL,"value"),
			getValueForKey(dataValues,"categoryOptionCombo", ORIGIN_UNKNOWN_UNS,"value")
		]);
		var total_origin_cases = add([origin_autoc, origin_imported, origin_unknown]);
		array[IMPORTED_ROW][column] = origin_imported 
									+ ", "
									+	percentageText(origin_imported, total_origin_cases);

	}
	

	// Code to execute after API calls have been done.
	// $.when(ajax1(), ajax2(), ajax3(), ajax4()).done(function(a1, a2, a3, a4){
	// http://stackoverflow.com/questions/3709597/wait-until-all-jquery-ajax-requests-are-done
	$.when(get_cl_cases(), get_vl_cases(), 
		get_monthly_cases_for_cl_current_year(),
		get_monthly_cases_for_cl_previous_year(),
		get_monthly_cases_for_vl_current_year(),
		get_monthly_cases_for_vl_previous_year(),
		get_monthly_cases_for_azcl_current_year(),
		get_monthly_cases_for_azcl_previous_year()).done(function(cl, vl, m1,m2,m3,m4,m5,m6){
		// the code here will be executed when all four ajax requests resolve.
		// a1, a2, a3 and a4 are lists of length 3 containing the response text,
		// status, and jqXHR object for each of the four ajax calls respectively.
		writeTable(tableBody, array, EPI_TABLE_TD_ID_PREFIX);
		writeTable(monthlyDistributionTableBody, monthlyArray, MONTHLY_TABLE_TD_ID_PREFIX);

		setMonthlyCheckboxes();
		makeElementsFootnotables();

		generate_cl_vl_new_cases_charts();
	});






	/****************************************************************************************************
 	 **********                     		 AUXILIARY FUNCTIONS          	    		       **********
	 ****************************************************************************************************/

	 /*

	

	 */

	function decide_cl_or_aclzcl_mode(dataValues){
		if (dataValues === undefined ){
			acl_and_zcl_activated = true;
		}
	}
	/* return a text about publishing date with the current month and year*/
	function getDatePublished(){
		var d = new Date();
    	var thisMonth = d.getMonth();
		var thisYear = d.getFullYear();
		return PUBLISHED_TEXT+" "+MONTHS[thisMonth]+" "+thisYear;
	}

	function writeTable(htmlObject, array, tdIdPrefix) {
		// declare html variable (a string holder):
		var html = '';
		var count = 0;
		for (var i = 0; i < array.length; i++) {
			// add opening <tr> tag to the string:
			html += '<tr id="'+tdIdPrefix+i+'">';
			for (var j = 0; j < array[i].length; j++) {
				// add <td> elements to the string:
				html += '<td>' + '<span class="footnotable editableElement" >' + array[i][j] + '</span>' + '</td>';
				count++;
			}
			// add closing </tr> tag to the string:
			html += '</tr>';
		}
		//append created html to the table body:
	
		htmlObject.append(html);
		// reset the count:
		count = 0;
	}	

	function makeElementsFootnotables(){
		$(".footnotable").mousedown(function(event) {
			if (event.which === 3){
				if ($(this).hasClass('footNoted')) {
					$(this).text($(this).html().substring(0,$(this).html().length - 11 - footNoteCounter.toString().length));
					footNoteCounter--;
				} else {
					footNoteCounter++;
					$(this).append("<sup>"+footNoteCounter+"</sup>");
				}

				event.preventDefault();
				$(this).toggleClass('footNoted');
			}
		});

		$('.footnotable').contextmenu(function() {
			return false;
		});
	}
	/*	Returns a url for the API

	*/
	function buildAPIUrl(page, params){
		return API_URL+page+"?"+$.param(params, true);
	}

	function numberToTwoDigits( number){
		return ("0" + number).slice(-2);
	}

	/* 	Searchs for a custom value for a customKey with a custom value through an array
			array : the array
			keyName : the name of the key to check
			keyValue : the target value of the keyName
			valueName : the name of the key of the value to return
	*/
	function getValueForKey(array, keyName, keyValue, valueName){
		var returnValue;
		if (array === undefined){
			return returnValue;
		}
		if (typeof keyName === 'string') {
			// one property check
			$.each( array, function( index, object ) {
				if(object[keyName]===keyValue){
					returnValue = object[valueName];
					return false;
				} 
			});
		} else if (keyName.length > 1 && keyValue.length > 1) {
			// two properties check  // not used
			$.each( array, function( index, object ) {
				if(object[keyName[0]]===keyValue[0] && object[keyName[1]]===keyValue[1]){
					returnValue = object[valueName];
					return false;
				} 
			});
		} else {
			return 'ERROR in getValueForKey';
		}
		
		return returnValue;
	}

		/* 	Searchs for a custom value for a customKey with a custom value through an array
			array : the array
			keyName : the name of the key to check
			keyValue : the target value of the keyName
			valueName : the name of the key of the value to return
	*/
	function getValuesForKeyByMonth(array, keyName, keyValue, valueName){
		var returnValue =  new Array(12); // Void array of size 12
		if (array === undefined){
			return returnValue;
		}

		var index, period;
		if (typeof keyName === 'string') {
			// one property check
			$.each( array, function( index, object ) {
				if(object[keyName]===keyValue){
					period = object["period"];
					index = Number(period.slice(period.length-2, period.length)) - 1;
					returnValue[index] = object[valueName];
				} 
			});
		} else if (keyName.length > 1 && keyValue.length > 1) {
			// two properties check
			$.each( array, function( index, object ) {
				if(object[keyName[0]]===keyValue[0] && object[keyName[1]]===keyValue[1]){
					period = object["period"];
					index = Number(period.slice(period.length-2, period.length)) - 1;
					returnValue[index] = object[valueName];
				} 
			});
		} else {
			return 'ERROR in getValueForKey';
		}
		return returnValue;
	}

	/*	Returns a percentage with no decimals 

	*/
	function percentageText(numerator, denominator){
		if (denominator === 0 && numerator === 0){
			return WHEN_DIV_0;
		} else if (denominator === WHEN_UNDEFINED){
			return WHEN_UNDEFINED;
		} else if (denominator === 0){
			return ERROR;
		}
		return Math.round((numerator / (denominator))*100) + "%";
	}

	/* Returns the addition of the elements of the array if they are not 
	*/
	function add(arrayOfNumbers){
		var addition = 0;
		var counter = 0;
		for (var number of arrayOfNumbers) {
			if (typeof number !== "undefined" && number != WHEN_UNDEFINED){
				addition = addition + +number;
				counter++;
			} 
		}
		if (counter === 0){
			return WHEN_UNDEFINED;
		} else {
			return addition;
		}
	}

	/** Creates a 2 dimension array with labels.
		rowsNum: Length of first array dimension (number of rows)
		rowsTitles : labels for 
		mode : the place for labels in array. Options : LABELS_ON_COLUMNS or LABELS_ON_ROWS
	*/
	function  create_2_dim_array(rowsNum, rowsTitles, mode) {
		var array = []
		
		if(mode === LABELS_ON_ROWS) {
			array[0] = [];
			for(var i = 0; i<rowsTitles.length; i++){
				array[0][i] = rowsTitles[i];
			}
			for(var i = 1; i<rowsNum; i++){
				array[i] = [];
			}
		} else {
			for(var i = 0; i<rowsNum; i++){
				array[i] = [];
				array[i][0] = rowsTitles[i];
			}
		}
		return array;
	}

	function setMonthlyCheckboxes(){
		// checked by default, trigger click for desactivate and for fire behaviour.
		$('#'+MONTHLY_TABLE_TD_ID_PREFIX+BUTTON_PREFIX+VL_PREVIOUS_YEAR_ROW).trigger('click');//.prop('checked', false);
		$('#'+MONTHLY_TABLE_TD_ID_PREFIX+BUTTON_PREFIX+CL_PREVIOUS_YEAR_ROW).trigger('click');//.prop('checked', false);
		$('#'+MONTHLY_TABLE_TD_ID_PREFIX+BUTTON_PREFIX+ACL_PREVIOUS_YEAR_ROW).trigger('click');//.prop('checked', false);
		$('#'+MONTHLY_TABLE_TD_ID_PREFIX+BUTTON_PREFIX+ZCL_PREVIOUS_YEAR_ROW).trigger('click');//.prop('checked', false);

		if(acl_and_zcl_activated){
			$('#'+MONTHLY_TABLE_TD_ID_PREFIX+BUTTON_PREFIX+CL_ROW).trigger('click');
		} else {
			$('#'+MONTHLY_TABLE_TD_ID_PREFIX+BUTTON_PREFIX+ACL_ROW).trigger('click');
			$('#'+MONTHLY_TABLE_TD_ID_PREFIX+BUTTON_PREFIX+ZCL_ROW).trigger('click');
		}

		$(':checkbox').button( "refresh" );
	}

	/****************************************************************************************************
	 **********                               CHARTS functions                                 **********
	 ****************************************************************************************************/

	/* Retrieves the data of vl and cl or acl/zcl, configures the charts and generates them.
	*/
	function generate_cl_vl_new_cases_charts (){
	
		if (acl_and_zcl_activated) {
			var colors = [COLORS.blue, COLORS.blue, COLORS.green, COLORS.green];
			var labels = ["ACL "+year, "ACL "+(year-1), "ZCL "+year, "ZCL " + (year-1)];
			
			var acl_current_year = monthlyArray[ACL_ROW].slice(1,monthlyArray[ACL_ROW].length);
			var zcl_current_year = monthlyArray[ZCL_ROW].slice(1,monthlyArray[ZCL_ROW].length);
			var acl_previous_year = monthlyArray[ACL_PREVIOUS_YEAR_ROW].slice(1,monthlyArray[ACL_PREVIOUS_YEAR_ROW].length);
			var zcl_previous_year = monthlyArray[ZCL_PREVIOUS_YEAR_ROW].slice(1,monthlyArray[ZCL_PREVIOUS_YEAR_ROW].length);

			var dataarrays = [acl_current_year, acl_previous_year, zcl_current_year, zcl_previous_year];


		} else {
			var colors = [COLORS.blue, COLORS.blue];
			var labels = ["CL "+year, "CL " + (year-1)];
			var cl_current_year = monthlyArray[CL_ROW].slice(1,monthlyArray[CL_ROW].length);
			var cl_previous_year = monthlyArray[CL_PREVIOUS_YEAR_ROW].slice(1,monthlyArray[CL_PREVIOUS_YEAR_ROW].length);
			var dataarrays = [cl_current_year, cl_previous_year];
		
		}
		lineChart(newCLCasesChartID, MONTHS_ABBREV, labels, dataarrays, colors, true);
		
		var vl_current_year = monthlyArray[VL_ROW].slice(1,monthlyArray[VL_ROW].length);
		var vl_previous_year = monthlyArray[VL_PREVIOUS_YEAR_ROW].slice(1,monthlyArray[VL_PREVIOUS_YEAR_ROW].length);
		var vl_data_arrays = [vl_current_year, vl_previous_year];
		var vl_colors = [COLORS.violet, COLORS.violet];
		var vl_labels = ["VL "+year, "VL " + (year-1)];

		lineChart(newVLCasesChartID, MONTHS_ABBREV, vl_labels, vl_data_arrays, vl_colors, true);

	}
	/* 	Generates an any-lines-number line graph. 
		htmlElementID: the id of the canvas/html element where put the graph
		x_labels: The labels for the x-axis  
		dataLabelArray: an array with the label of each data line
		dataArray: the data
		colorArray: an Array of rgba colors
		previousYearMode: true if wanted to put previous years in dotted colors.
						  currentYear data must be preceed the previousYear data
		Note: All the array must have same size !
	*/
	function lineChart(	htmlElementID, x_labels, dataLabelArray, dataArray, colorArray, previousYearMode){

		
		var theDataSets = [];
		var aDataSet = {};
		for (var i = 0; i<dataLabelArray.length; i++){
			aDataSet = {};
			aDataSet.label = dataLabelArray[i];
			aDataSet.fill = false;
			aDataSet.data = dataArray[i];
			aDataSet.backgroundColor = colorArray[i];
			aDataSet.borderColor = colorArray[i];
			aDataSet.borderWidth = 2;
			if (previousYearMode && i%2 == 1){
				// previousYearMode Enabled
				aDataSet.borderDash = [5];
				aDataSet.backgroundColor = aDataSet.backgroundColor.slice(0, -2)+"0.2)";
			}
			theDataSets[i] = aDataSet;
		}
		
		var ctx = document.getElementById(htmlElementID);
		var myChart = new Chart(ctx, {
		type: 'line',
		data: {
			labels: x_labels,
			datasets: theDataSets
			},
			options: {
				scales: {
					yAxes: [{
						ticks: {
							beginAtZero:true
						}
					}]
				},
				responsive: false
			}
		});
	}


	function setChartPlugin(chartPlugin){
	 	chartPlugin.url = "https://extranet-uat.who.int/dhis2-dev";
		chartPlugin.username = "ramon2";
		chartPlugin.password = "1234Abcd";

		return chartPlugin;
	}

	function setChartParams(columnDimension, dataId, dataName, orgUnitId, chatType, url, htmlElement){

		chartTestParams = {
		"columns": [
			{
			"dimension": columnDimension,
			"items": [
				{
				"id": dataId,
				"name": dataName
				}
			]
			}
		],
		
		"rows": [
			{
			"dimension": "pe",
			"items": []
			}
		],
		"filters": [
			{
			"dimension": "ou",
			"items": [
				{
				"id": orgUnit.id
				}
			]
			}
		],
		"type": chatType,
		"url": url,
		"el": htmlElement
		}
		var items = generateChartRowParams();
		chartTestParams["rows"][0]["items"] = items;
		return chartTestParams;
	}

	function generateChartRowParams(){
		var itemsArray = [];
		var rows = [{ 
      "dimension": "pe",
      "items": itemsArray}];
	  	var element = {};
		  for(var i = 0; i<MONTHS.length;i++){
			element = {};
			element.id = year+""+numberToTwoDigits(i+1);
			element.name = MONTHS_ABBREV[i];
			itemsArray[i] = element;
		  }
		  return itemsArray;
	}



		/****  **********  ******  ********  ******  ******   *****  *//***** ********  *****  *** *//****
	 ****  **                                TEST ZONE                                          **********
	 ** ********    ******** **** ********* ******* ************   *********** *********** ******* *******/


/*
	chartPlugin = setChartPlugin(chartPlugin);
	var chartTestParams = setChartParams("B9bBfRcF6jb", "aD1KD82UFB1", "New", orgUnit.id, "line", chartPlugin.url, "chart1");
	chartPlugin.load([chartTestParams]);
*/
	// aD1KD82UFB1 new

	
	$(":checkbox").change(function() {
		var index = Number(this.id.slice(this.id.length-1, this.id.length));
			console.log(this.id);

		if(this.checked) {
			//Do stuff
			$("#"+MONTHLY_TABLE_TD_ID_PREFIX+index).show();
		} else {
			$("#"+MONTHLY_TABLE_TD_ID_PREFIX+index).hide();
		}
	});
	
		
	
} );
</script>

<!--
	/****************************************************************************************************
     **********		   																		   **********
 	 **********            	  		  	      3. HTML CODE              	    			   **********
 	**********		   																		   **********
	 ****************************************************************************************************/
	-->
<div class="non-printable section"><hr>
Configuration Area - Wont be printed<br>
	Instructions : Right click to add a footnote number.<br>
					Left click to edit an element.

	<ol id="selectable">
	<li class="ui-widget-content">Item 1</li>
	<li class="ui-widget-content">Item 2</li>
	<li class="ui-widget-content">Item 3</li>
	<li class="ui-widget-content">Item 4</li>
	<li class="ui-widget-content">Item 5</li>
	<li class="ui-widget-content">Item 6</li>
	<li class="ui-widget-content">Item 7</li>
	</ol>



<fieldset id="monthlyCheckboxes">
  <!--  <legend>Monthly distribution table: </legend>
    
	<input id="mdtb0" type="checkbox" checked="checked" />
	<label for="mdtb0">CL</label>
	<input id="mdtb1" type="checkbox" checked="checked" />
	<label for="mdtb1">VL</label>
	<input id="mdtb2" type="checkbox" checked="checked" />
	<label for="mdtb2">CL Previous year</label>
	<input id="mdtb3" type="checkbox" checked="checked" />
	<label for="mdtb3">VL Previous year</label>
	<input id="mdtb4" type="checkbox" checked="checked" />
	<label for="mdtb4">ACL</label>
	<input id="mdtb5" type="checkbox" checked="checked" />
	<label for="mdtb5">ZCL</label>
	<input id="mdtb6" type="checkbox" checked="checked" />
	<label for="mdtb6">ACL Previous year</label>
	<input id="mdtb7" type="checkbox" checked="checked" />
	<label for="mdtb7">ZCL Previous year</label>
-->
</fieldset>


<hr>

</div>
<div class="section">
    <img class="head_logo center" src="http://www.who.int/about/Logo-WHO.jpg" />
	<br>
	
	<div class="container">
	
		<div class="editableElement">Leishmaniasis</div>
		<div class="center_text editableElement" id="country_name"></div>
		<div class="align_to_right">
			<div class="editableElement" id="year"></div>
			<div class="editableElement" id="published_date"></div>
		</div>
	</div>
</div>

<div class="section">
	<h4 class="editableElement footnotable">Country General Information </h4>
	
</div>

<div class="section">
	<h4 class="editableElement footnotable">Epidemiology</h4>


	<table id="example" class="display" cellspacing="0" width="100%">
			<thead>
				<tr>
					<th></th>
					<th><span class="footnotable editableElement" id="vl_head"></span></th>
					<th><span class="footnotable editableElement" id="cl_head"></span></th>
					<th><span class="footnotable editableElement" id="pkdl_head"></span></th>
					<th><span class="footnotable editableElement" id="mcl_head"></span></th>
				</tr>
			</thead>
			<tbody id="tbody3"></tbody>
	</table>


</div>


<div class="section">
	<h4 class="editableElement footnotable" >Monthly distribution of new cases January-December</h4>

	<table id="monthlyDistributionTable" class="display" cellspacing="0" width="100%">
			<thead>
				<tr id ="monthlyDistributionTableHead"></tr>
			</thead>
			<tbody id="monthlyDistributionTableBody"></tbody>
	</table>

</div>

<div class="section">
	<img id="a01">
	<img id="a02">
	<img id="a03">
	<img id="a04">
</div>



<div class="section">
	<img id="b01" style="margin-right: 20px">
	<img id="b02">

	<div id="dialog-editor">
		<textarea id="editor" title="Edit field"></textarea>
		
	</div>

</div>

<!--
<div id="chart1" width="450" height="300"></div>
-->
<canvas id="NewCLCasesChart" width="450" height="300" ></canvas>
<canvas id="NewVLCasesChart" width="450" height="300" ></canvas>


