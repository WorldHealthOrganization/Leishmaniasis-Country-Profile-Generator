<!--
	/****************************************************************************************************
 	 **********		   																		   **********
 	 **********                      Report App for DHIS2 Leishmaniasis 2017               	   **********
 	 **********		   																		   **********
	 ****************************************************************************************************/


	 	* @author  Ramon Jose Jimenez Pomareta 
		* @email ramon@pomareta.ch
 		* @version 1.0 
		* @date 26/04/2017


		* Some comments
			Since this App has to be made in only one file, all is here.
			When needed external js plugins, i.e. jquery-te and jquery-ui, I have stored a version in 
			https://github.com/Rjjp/plugins
			In order to share raw files, I have used https://rawgit.com/


		* Sections of the code. 
		1. CSS styles
		2. JavaScript    
			JavaScript imports
			CSS imports
			CONSTANTS
			STATIC CONTENT FUNCTIONS
			FUNCTIONS CALLING THE API 
			FILLING LOGICAL STRUCTURES (ARRAYS)
			AUXILIARY FUNCTIONS
			CHARTS FUNCTIONS
			FOOTNOTES FUNCTIONS
			EDITOR
			LISTENER
			ENTRY POINT
		3. HTML Code

-->

<!-- 

/****************************************************************************************************
 **********		   																		   **********
 **********                            		2. JavaScript                                  **********
 **********		   																		   **********
 ****************************************************************************************************/
	
/****************************************************************************************************
 **********                             JavaScript imports                                 **********
 ****************************************************************************************************/
 -->
 <script type="text/javascript" src ="js/pace.min.js"></script>
 <script
 src="https://code.jquery.com/jquery-2.2.4.js"
 integrity="sha256-iT6Q9iMJYuQiMWNd9lDyBUStIq/8PuOW33aOqmvFpqI="
 crossorigin="anonymous"></script>
 <script type="text/javascript" src ="js/jquery-te-1.4.0-oms.js"></script>
 <script type="text/javascript" src ="js/tools.js"></script>
 <script type="text/javascript" src ="js/largestRemainderRound.js"></script>
<script type="text/javascript" src ="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js">//TODO:use the cdn officiel</script>
<script type="text/javascript" src="../../../dhis-web-visualizer/chart.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.js"></script>

<script type="text/javascript" src="../../../dhis-web-commons/javascripts/dhis2/dhis2.util.js"></script>
<script type="text/javascript" src="../../../dhis-web-mapping/extjs/ext-all.js"></script>
<script type="text/javascript" src="../../../dhis-web-mapping/map.js"></script>

<script type="text/javascript" src="../../../dhis-web-commons/javascripts/dhis2/dhis2.storage.ss.js"></script>
<script type="text/javascript" src="../../../dhis-web-commons/javascripts/dhis2/dhis2.storage.ls.js"></script>
<script type="text/javascript" src="../../../dhis-web-commons/javascripts/dhis2/dhis2.storage.idb.js"></script>
<script type="text/javascript" src="../../../dhis-web-commons/javascripts/dhis2/dhis2.storage.memory.js"></script>
<script type="text/javascript" src="../../../dhis-web-commons/javascripts/dhis2/dhis2.storage.js"></script>

<script type="text/javascript" src="commons/api.js"></script>
<script type="text/javascript" src="commons/inputControl.js"></script>
<script type="text/javascript" src="commons/tools.js"></script>
<script type="text/javascript" src="commons/analytics_tools.js"></script>



<!--
<script type="text/javascript" src="https://dhis2-cdn.org/v222/openlayers/OpenLayers.js"></script>
<script type="text/javascript" src="https://maps.google.com/maps/api/js?sensor=false"></script>
-->

<script type="text/javascript">
	/*jshint esversion: 6 */

	/****************************************************************************************************
 	 **********                      	       CONSTANTS            	              	       **********
	 ****************************************************************************************************/
	var ANALYTICS = "analytics";
	var WHEN_UNDEFINED = "No data";
	var WHEN_NO_DATA = "No data";
	var WHEN_NON_APPLICABLE = "N/A";
	var WHEN_DIV_0 = "-";
	var ERROR = "Error!";

	var HISTORIC_DEFAULT_VALUE = 15;

	var BOTTOM_LINE_CLASS = "bottom_line";

	var VALUE_KEY = "value";
	var CC_KEY = "categoryOptionCombo";
	var DE_KEY = "dataElement";
	var CODE_KEY = "code";
	var NAME_KEY = "name";
	var PERIOD_KEY = "period";

	var LABELS_ON_ROWS = 0;
	var LABELS_ON_COLUMNS = 1;

	/* config subnational level */

	var WIDP_OU_SHIFT = 3;
	var NATIONAL_LEVEL = 0;
	var SUBLEVEL1 = 1;
	var SUBLEVEL2 = 2;
	var SUBLEVEL3 = 3;
	var LEVEL_CONFIG_LABELS = new Array(4);
	var LEVEL_REPORT_LABELS = new Array(4);
	var ENDEMIC_SUBN_LEVEL_LABELS = new Array(4);
	LEVEL_CONFIG_LABELS[NATIONAL_LEVEL] = "National level";
	LEVEL_CONFIG_LABELS[SUBLEVEL1] = "1st sub-national administrative level";
	LEVEL_CONFIG_LABELS[SUBLEVEL2] = "2nd sub-national administrative level";
	LEVEL_CONFIG_LABELS[SUBLEVEL3] = "3rd sub-national administrative level";
	LEVEL_REPORT_LABELS[NATIONAL_LEVEL] = "National level, name:";
	LEVEL_REPORT_LABELS[SUBLEVEL1] = "Number of 1st sub-national administrative level divisions, name:";
	LEVEL_REPORT_LABELS[SUBLEVEL2] = "Number of 2nd sub-national administrative level divisions, name:";
	LEVEL_REPORT_LABELS[SUBLEVEL3] = "Number of 3rd sub-national administrative level divisions, name:";
	ENDEMIC_SUBN_LEVEL_LABELS[NATIONAL_LEVEL] = "Endemic divisions. National level (n):";
	ENDEMIC_SUBN_LEVEL_LABELS[SUBLEVEL1] = "Number of endemic 1st sub-national administrative level divisions (n):";
	ENDEMIC_SUBN_LEVEL_LABELS[SUBLEVEL2] = "Number of endemic 2nd sub-national administrative level divisions (n):";
	ENDEMIC_SUBN_LEVEL_LABELS[SUBLEVEL3] = "Number of endemic 3rd sub-national administrative level divisions (n):";

	/* Texts on report */
	var PUBLISHED_TEXT = "Published in ";
	var VL_CHART_LEGEND = "VL ";
	var CL_CHART_LEGEND = "CL ";	
	var ACL_CHART_LEGEND = "ACL ";
	var ZCL_CHART_LEGEND = "ZCL ";
	var TOUTCOME_TABLE_FIRST_COLUMNS = "INITIAL TREATMENT OUTCOME FOR NEW CASES";

	var CHART_CHECKBOXES_LABELS = ["CL monthly", "AZCL monthly", "VL monthly", "CL yearly", "AZCL yearly", "VL yearly" ];

	var TWO_VALUES_SEPARATOR = " / ";

	var VL_CHART_CASES_LEGEND = "VL cases";
	var CL_CHART_CASES_LEGEND = "CL cases";
	var ACL_CHART_CASES_LEGEND = "ACL cases";
	var ZCL_CHART_CASES_LEGEND = "ZCL cases";
	var VL_CHART_INCIDENCE_LEGEND = "VL incidence rate";
	var CL_CHART_INCIDENCE_LEGEND = "CL incidence rate";
	var ACL_CHART_INCIDENCE_LEGEND = "ACL incidence rate";
	var ZCL_CHART_INCIDENCE_LEGEND = "ZCL incidence rate";

	var MONTHS = [	"January",
					"February",
					"March",
					"April",
					"May",
					"June",
					"July",
					"August",
					"September",
					"October",
					"November",
					"December" ];

	var MONTHS_ABBREV = [	"JAN",
							"FEB",
							"MAR",
							"APR",
							"MAY",
							"JUN",
							"JUL",
							"AUG",
							"SEP",
							"OCT",
							"NOV",
							"DEC"];

	var COLORS = {
		green : 'rgba(153, 204, 0, 1)',
		soft_green : 'rgba(153, 204, 0, 0.2)',
		blue: 'rgba(51, 153, 255, 1)',
		soft_blue: 'rgba(51, 153, 255, 0.2)',
		violet :'rgba(153, 0, 255, 1)',
		soft_violet :'rgba(153, 0, 255, 0.2)'
	};

	CL_CASES_CHART_TITLE = "Number of new CL cases reported by month in ";
	VL_CASES_CHART_TITLE = "Number of new (primary) VL cases reported by month in ";
	CL_CASES_CHART_Y_TITLE = "Number of new CL cases";
	VL_CASES_CHART_Y_TITLE = "Number of new (primary) VL cases";

	CL_INCIDENCE_CHART_TITLE = "Number of cases and incidence rate of CL";
	VL_INCIDENCE_CHART_TITLE = "Number of cases and incidence rate of VL";
	CL_INCIDENCE_CHART_Y1_TITLE = "Number of CL cases";
	VL_INCIDENCE_CHART_Y1_TITLE = "Number of VL cases";
	CL_INCIDENCE_CHART_Y2_TITLE = "Incidence rate (/10 000)";
	VL_INCIDENCE_CHART_Y2_TITLE = "Incidence rate (/10 000)";


	// For configure mixed charts
	var DATASID = {
			LEFT: "left",
			RIGHT: "right"
	};


	/* Country General Information Texts */
	// http://who-dev.essi.upc.edu:8083/issues/1498
	
	var CIG_ROW_POP = 0;
	var CIG_ROW_SEX = 1;
	var CIG_ROW_GDP = 2;
	var CIG_ROW_INCOME = 3;
	var CIG_ROW_AGEG = 4;
	var CIG_ROW_LIFE = 5;
	var CIG_ROW_DIVIS = 6;

	var CGI_LABELS = [	"Total population:",
						"Gender F/M (%):",
						"GDP (PPP int $):",
						"Income status:",
						"Age group <15 / â‰¥ 15 years (%): ",
						"Life expectancy at birth in years (F/M):",
						"Number of 2nd sub-national administrative level<br>divisions, name:"
						];

	var LINES_BELOW_LABELS_CGI = [true,true,true,false,true,true,true];
	var generalInformationArray = create_2_dim_array(CGI_LABELS.length, CGI_LABELS, LABELS_ON_COLUMNS);

	/* Epidemiology table constants */
	var FIRST_COLUMN = 0;
	var VL_COLUMN = 1;
	var CL_COLUMN = 2;
	var ACL_COLUMN = 3;
	var ZCL_COLUMN = 4;
	var PKDL_COLUMN = 5;
	var MCL_COLUMN = 6;

	var COLUMNS_LABELS = [ 	"VL",
							"CL",
							"ACL",
							"ZCL",
							"PKDL",
							"MCL"
							];
	var COLUMNS_LABELS_DESC = [ 	"visceral leishmaniasis",
									"cutaneous leishmaniasis",
									"anthroponotic cutaneous leishmaniasis",
									"zoonotic cutaneous leishmaniasis",
									"post-kala-azar dermal leishmaniasis",
									"mucocutaneous leishmaniasis"
									];


	var COUNTRY_ENDEMICITY_ROW = 0;
	var NEW_ROW = 1;
	var RELAPSE_ROW = 2;
	var TOTAL_ROW = 3;
	var IMPORTED_ROW = 4;
	var SEX_ROW = 5;
	var AGE_ROW = 6;
	var INCD_ROW = 7;
	var THIRD_LEVEL_ROW = 8;
	var RISK_ROW = 9;
	var OUTBK_ROW = 10;
	var FOCI_ROW = 11;

	var rowTitles = [	"Endemicity status:",
						"Number of new cases (incidence):",
						"Number of relapse cases:",
						"Total number of cases:",
						"Imported cases (#, %):",
						"Gender distribution (%F):",
						"Age group distribution (%, <5/5-14/>14):",
						"Incidence rate (cases/10 000 population in endemic areas):",
						ENDEMIC_SUBN_LEVEL_LABELS[defaultSubnationalLevel],
						"Population at risk (%, n/total):",
						"Was there any outbreak?",
						"Number of new foci:"
						];


	var LINES_BELOW_LABELS_EPI = [true,false,false,true,true,false,true,false,false,true,false,true];
	var array = create_2_dim_array(rowTitles.length, rowTitles, LABELS_ON_COLUMNS);

	var IMPORTED_DE = new Array(7);
	IMPORTED_DE[VL_COLUMN] = "fwoGVaxEDHW";  // VL_EPI_Type_Origin
	IMPORTED_DE[CL_COLUMN] = "k87tHFKjlsP";  // CL_EPI_Type_Origin
	IMPORTED_DE[ACL_COLUMN] = "KgntvjxDA5K"; // ACL_EPI_Type_Origin
	IMPORTED_DE[ZCL_COLUMN] = "PxDoizHyyrk"; // ZCL_EPI_Type_Origin

	var GENDER_DE = new Array(7);
	GENDER_DE[VL_COLUMN] = "CaF8iMJFfkg";  // VL_EPI_Type_Gender
	GENDER_DE[CL_COLUMN] = "tuHHLQp2GnJ";  // CL_EPI_Type_Gender
	GENDER_DE[ACL_COLUMN] = "FYhYVWmpweT"; // ACL_EPI_Type_Gender
	GENDER_DE[ZCL_COLUMN] = "mkmMnWroxMh"; // ZCL_EPI_Type_Gender
	GENDER_DE[PKDL_COLUMN] = "ipWXN3NeXac"; // PKDL_EPID_sex
	GENDER_DE[MCL_COLUMN] = "Ujpe40hXdvf"; // MCL_EPID_sex

	var AGE_DE = new Array(7);
	AGE_DE[VL_COLUMN] = "BF3faoNKOGH";  // VL_EPI_Type_Age
	AGE_DE[CL_COLUMN] = "OWKZMKxVCnh";  // CL_EPI_Type_Age
	AGE_DE[ACL_COLUMN] = "wKuJVK1ktpm"; // ACL_EPI_Type_Age
	AGE_DE[ZCL_COLUMN] = "DVKZOWyoaQs"; // ZCL_EPI_Type_Age
	AGE_DE[PKDL_COLUMN] = "rw4tu6PNGKO"; // PKDL_EPID_age
	AGE_DE[MCL_COLUMN] = "bOqGnEVdHsf"; // MCL_EPID_age

//
	/* Monthly distribution table constants */
	var VL_ROW = 0;
	var VL_PREVIOUS_YEAR_ROW = 1;
	var CL_ROW = 2;
	var CL_PREVIOUS_YEAR_ROW = 3;
	var ACL_ROW = 4;
	var ACL_PREVIOUS_YEAR_ROW = 5;
	var ZCL_ROW = 6;
	var ZCL_PREVIOUS_YEAR_ROW = 7;

	var MONTHLY_LABELS = new Array(8);
	MONTHLY_LABELS[VL_ROW] = "VL";
	MONTHLY_LABELS[VL_PREVIOUS_YEAR_ROW] = "VL (previous year)";
	MONTHLY_LABELS[CL_ROW] = "CL";
	MONTHLY_LABELS[CL_PREVIOUS_YEAR_ROW] = "CL (previous year)";
	MONTHLY_LABELS[ACL_ROW] = "ACL";
	MONTHLY_LABELS[ACL_PREVIOUS_YEAR_ROW] = "ACL (previous year)";
	MONTHLY_LABELS[ZCL_ROW] = "ZCL";
	MONTHLY_LABELS[ZCL_PREVIOUS_YEAR_ROW] = "ZCL (previous year)";

	var LINES_BELOW_LABELS_MONTHLY = [true,true,true,true,true,true,true,true];

	var monthlyArray = create_2_dim_array(MONTHLY_LABELS.length, MONTHLY_LABELS, LABELS_ON_COLUMNS);
	var YEARLY_MODE = 0;
	var MONTHLY_MODE = 1;

	/* Maps */
	var VL_INDEX = 0;
	var CL_INDEX = 1;
	var ACL_INDEX = 2;
	var ZCL_INDEX = 3; 
	var PKDL_INDEX = 4;
	var MCL_INDEX = 5;
	
	var MAP_CHECKBOXES_LABELS = new Array(4);
	MAP_CHECKBOXES_LABELS[VL_INDEX] = "VL incidence";
	MAP_CHECKBOXES_LABELS[CL_INDEX] = "CL incidence";
	MAP_CHECKBOXES_LABELS[ACL_INDEX] = "ACL incidence";
	MAP_CHECKBOXES_LABELS[ZCL_INDEX] = "ZCL incidence";

	var GOOGLE_STREETS = 0;
	var GOOGLE_HYBRID = 1;
	var OPEN_STREETS = 2;
	var OSM_LIGHT = 3;
	var FACILITY = 4;

	var MAP_STYLE = new Array(4);
	var MAP_STYLE_LABELS = new Array(4);

	MAP_STYLE [GOOGLE_STREETS] = "googleStreets";
	MAP_STYLE [GOOGLE_HYBRID] = "googleHybrid";
	MAP_STYLE [OPEN_STREETS] = "openStreetMap";
	MAP_STYLE [OSM_LIGHT] = "osmLight";
	MAP_STYLE [FACILITY] = "facility";
	
	MAP_STYLE_LABELS [GOOGLE_STREETS] = "Google Streets";
	MAP_STYLE_LABELS [GOOGLE_HYBRID] = "Google Hybrid";
	MAP_STYLE_LABELS [OPEN_STREETS] = "Open Street Map";
	MAP_STYLE_LABELS [OSM_LIGHT] = "OSM Light";
	MAP_STYLE_LABELS [FACILITY] = "Facility";

	var LEGENDS = []; 
	LEGENDS[VL_INDEX] =  "gUOjExXros1";
	LEGENDS[CL_INDEX] =  "TnU2O8YxH51";
	LEGENDS[ACL_INDEX] =  "clwSlrqvmMx";
	LEGENDS[ZCL_INDEX] =  "TbrqpLWzLS8";

	var initalMapDiv = new Array(4);
	var mapLegends = new Array(4);
	var map_levels = [NATIONAL_LEVEL + WIDP_OU_SHIFT, NATIONAL_LEVEL + WIDP_OU_SHIFT + SUBLEVEL1];
	var defaultSubnationalLevel = SUBLEVEL1;
	var map_opacity = 80;
	var map_height = 315;
	var map_width = 420;

	var TOP_LEFT = 0;
	var TOP_RIGHT = 1;
	var BOTTOM_LEFT = 2;
	var BOTTOM_RIGHT = 3;

	var LEGEND_TO_REPORT = 0;
	var LEGEND_TO_LEGEND_POOL = 1;

	var LEGEND_POSITION_LABELS = new Array(4);
	var LEGEND_POSITIONS = new Array(4);

	LEGEND_POSITION_LABELS[TOP_LEFT] = "Top left corner";
	LEGEND_POSITION_LABELS[TOP_RIGHT] = "Top right corner";
	LEGEND_POSITION_LABELS[BOTTOM_LEFT] = "Bottom left corner";
	LEGEND_POSITION_LABELS[BOTTOM_RIGHT] = "Bottom right corner";

	LEGEND_POSITIONS[TOP_LEFT] = ".leaflet-top.leaflet-left";
	LEGEND_POSITIONS[TOP_RIGHT] = ".leaflet-top.leaflet-right";
	LEGEND_POSITIONS[BOTTOM_LEFT] = ".leaflet-bottom.leaflet-left";
	LEGEND_POSITIONS[BOTTOM_RIGHT] = ".leaflet-bottom.leaflet-right";

	var editingLegend;
	var font_size_slider = $( "#font_size_slider" );
	var font_size_slider_handle = $( "#font_size_slider_handle" );


	/* Control and surveillance table */
	var CAS_ROW_LNCP = 0;
	var CAS_ROW_TYPE = 1;
	var CAS_ROW_PROGRAMME = 2;
	var CAS_ROW_IRS = 3;
	var CAS_ROW_GUIDELINES = 4;
	var CAS_ROW_NOTIF = 5;
	var CAS_ROW_RESER = 6;
	var CAS_ROW_FACIL = 7;
	
	var CAS_LABELS = [	"Year Leishmaniasis National Control<br>Programme (LNCP) was established:",
						"Type of surveillance (CL / VL):",
						"Is there a vector control programme?",
						"Type of insecticide used for Indoor residual Spraying (IRS):",
						"Year latest national guidelines (CL / VL):",
						"Is leishmaniasis notifiable (mandatory report)? (CL / VL):",
						"Is there a reservoir host control programme?",
						"Number of leishmaniasis health facilities (CL / VL):"
						];
	var LINES_BELOW_LABELS_CAS = [true,true,true,true,false,true,true,false,true,true];
	var controlArray = create_2_dim_array(CAS_LABELS.length, CAS_LABELS, LABELS_ON_COLUMNS);



	/* Diagnosis table */

	var SCREENED_ACTIVELY_ROW = 0;
	var SCREENED_PASSIVELY_ROW = 1;
	var VL_CASES_DIAGNOSED_ROW = 2;
	var POSITIVE_RDT_ROW = 3;
	var DIRECT_EXAM_DIAGNOSED_ROW = 4;
	var POSITIVE_DIRECT_EXAM_ROW = 5;
	var CLINICALLY_DIAGNOSED_ROW = 6;
	var HIV_COINFECTION_ROW = 7;

	var DIRECTEXAM_DE = new Array(5);
	DIRECTEXAM_DE[VL_COLUMN] = "RrKpXTbayoB";  // VL_Lab_parasito_tested_type
	DIRECTEXAM_DE[CL_COLUMN] = "Cj4t9M02Stv";  // CL_LAB_parasito_Suspects
	DIRECTEXAM_DE[ACL_COLUMN] = "VKWHFyDvZxg"; // ACL_Lab_Parasito_Suspects
	DIRECTEXAM_DE[ZCL_COLUMN] = "LvqN7RkPdc6"; // ZCL_Lab_Parasito_Suspects

	var POSITIVESLIDES_DE = new Array(5);
	POSITIVESLIDES_DE[VL_COLUMN] = "Qc7ujS567UL";  // VL_LAB_parasito_result_type
	POSITIVESLIDES_DE[CL_COLUMN] = "fXPoRfJbFsE";  // CL_LAB_Parasito_Results
	POSITIVESLIDES_DE[ACL_COLUMN] = "KSidYi6vKfR"; // ACL_Lab_Parasito_Results
	POSITIVESLIDES_DE[ZCL_COLUMN] = "wyfYiCFojPL"; // ZCL_Lab_Parasito_Results

	var LABCLINICAL_DE = new Array(5);
	LABCLINICAL_DE[VL_COLUMN] = "BAsexzzzJZC";  // VL_LAB_clinical
	LABCLINICAL_DE[CL_COLUMN] = "";  // 
	LABCLINICAL_DE[ACL_COLUMN] = ""; // 
	LABCLINICAL_DE[ZCL_COLUMN] = ""; // 

	var diagnosisLabels = [	"Number of people screened actively for:",
							"Number of people screened passively for:",
							"VL cases diagnosed by RDT<sup>*</sup><br>(%, RDT+ / new VL cases):",
							"Proportion of positive RDT<sup>*</sup><br>(%, RDT+ / total RDT):",
							"Cases diagnosed by direct exam<br>(parasitology) (%, # slides + / total cases):",
							"Proportion of positive slides<br>(%, # slides + / total slides):",
							"Cases diagnosed clinically<br>(%, # clinical cases / total cases): ",
							"Percentage of cases with HIV-VL coinfection:"
							];


	var DIAG_LEGEND_LABELS = [ 	"VL",
								"CL",
								"ACL",
								"ZCL",
								"PKDL",
								"MCL"
							];
	var DIAG_LEGEND_LABELS_DESC = [ "visceral leishmaniasis",
									"cutaneous leishmaniasis",
									"anthroponotic cutaneous leishmaniasis",
									"zoonotic cutaneous leishmaniasis",
									"post-kala-azar dermal leishmaniasis",
									"mucocutaneous leishmaniasis"
									];

	var DIAG_LEGEND_LABELS_2 = [	"RDT",
									"HIV"
									];

	var DIAG_LEGEND_LABELS_DESC_2 = [ 	"rapid diagnostic rest",
										"human immunodeficiency virus"
										];

	var DIAG_ASTERISK_RDT_COMMENT = "<span><sup>*</sup> These indicators apply only for primary VL cases</span>";
	var PUT_NA_TEXT = true;

	var LINES_BELOW_LABELS_DIAG = [false,true,false,true,false,false,true,true];

	var diagnosisArray = create_2_dim_array(diagnosisLabels.length, diagnosisLabels, LABELS_ON_COLUMNS);

	/* Treatment and medicines table*/
	var TAM_ROW_FREEOFCHARGE = 0;
	var TAM_ROW_EML = 1;
	var TAM_LABELS = [	"Is treatment provided for free in the public sector? (CL / VL):",
						"Antileishmanial medicines included in the National Medicine List:"
						];
	var LINES_BELOW_LABELS_TAM = [true,true];
	var tamArray = create_2_dim_array(TAM_LABELS.length, TAM_LABELS, LABELS_ON_COLUMNS);

	/* Treatment outcome table */

	var PROPORTION_TREATED_CASES_ROW = 0;
	var INITIAL_CURE_RATE_ROW = 1;
	var FAILURE_RATE_ROW = 2;
	var CASE_FATALITY_ROW = 3;

	var toutcomeLabels = new Array(4);
	toutcomeLabels[PROPORTION_TREATED_CASES_ROW] = "Proportion of cases treated (%, # treated cases/ new cases):";
	toutcomeLabels[INITIAL_CURE_RATE_ROW] = "Initial cure rate (%, # cases initially cured / new cases):";
	toutcomeLabels[FAILURE_RATE_ROW] = "Failure rate (%, # patients with treatment failure / new cases):";
	toutcomeLabels[CASE_FATALITY_ROW] = "Case fatality rate (%, # patients who died / new cases):";

	var LINES_BELOW_LABELS_TREAT = [true, false, false, true];
	var toutcomeArray = create_2_dim_array(toutcomeLabels.length, toutcomeLabels, LABELS_ON_COLUMNS);
	
	var historicLength = HISTORIC_DEFAULT_VALUE;
	var historicIncidenceChart = create_2_dim_array(5,"",LABELS_ON_ROWS);
	var historicNewCases = create_2_dim_array(5,"",LABELS_ON_ROWS);

	var ITxO_DRUG_DE = new Array(5);
	ITxO_DRUG_DE[VL_COLUMN] = "ossDxe1C4F2";  // VL_INIT_OUTCOME_Drug_Type
	ITxO_DRUG_DE[CL_COLUMN] = "OjY8uiHVetP";  // CL_ITxO_Tx-route
	ITxO_DRUG_DE[ACL_COLUMN] = "GXyfQMlaXEn"; // ACL_ITxO_Tx-drug
	ITxO_DRUG_DE[ZCL_COLUMN] = "GPG5qCJ65uO"; // ZCL_ITxO_Tx-drug

	var ITx_TREAT_DE = new Array(5);
	ITx_TREAT_DE[VL_COLUMN] = "PUD4SrCGSZE";  // VL_TREAT_completed
	ITx_TREAT_DE[CL_COLUMN] = "daJVc4WMhye";  // CL_TREAT_completed
	ITx_TREAT_DE[ACL_COLUMN] = "Msp9T50iUXO"; // ACL_TREAT_completed
	ITx_TREAT_DE[ZCL_COLUMN] = "KYuMdxHQTqQ"; // ZCL_TREAT_completed

	// stores all de assigned through DS or P
	var de_assigned = [];
	// stores all category option combinations assigned through DE assigned through DS 
	var coc_assigned = [];
	var dsinfo = new Array(8); // key: UID of dataset. Contains its name and whether the DS is assigned to the OU.
	var pinfo = new Array(4); // key: UID of program. Contains its name and whether the P is assigned to the OU.
	var NAME = 0;
	var ASSG = 1;
	var DE_IDX = 2;

	var SQL_COC_DS = "mejiVo59hWs";
	var SQL_DE_DS = "oQdIVqkVlxC";
	var SQL_DE_P = "IrawAndH02Y";
	
	var CL_DETAILED = "tnek2LjfuIm";
	var CL_SIMPLE = "zna8KfLMXn4";
	var VL_DETAILED = "fdBM4sWSuPR";
	var VL_SIMPLE = "SHw2zOysJ1R";
	var AZCL_DETAILED = "Uc3j0vpsfSB";
	var AZCL_SIMPLE = "Sn0dExPzQqW";
	var GI = "NKWbkXyfO5F";
	var GHO_NTDS = "p0NhuIUoeST";
	var CL_MONTHLY = "w9hSFsNr3Vh";
	var VL_MONTHLY = "i5JSf4ffFl2";
	var FOOTNOTES = "NVUlJzIakuO";
	var SUBN_ENDEMCTY = "Jd8gnEIt8uT";

	dsinfo[CL_DETAILED] = ["Cutaneous Leishmaniasis - Detailed - Annual", false];
	dsinfo[CL_SIMPLE] = ["CL - Simple - Annual", false];
	dsinfo[VL_DETAILED] = ["VL - Detailed - Annual", false];
	dsinfo[VL_SIMPLE] = ["VL - Simple - Annual", false];
	dsinfo[AZCL_DETAILED] = ["ACL/ZCL - Detailed - Annual", false];
	dsinfo[AZCL_SIMPLE] = ["ACL/ZCL - - Simple aggregated - Annual", false];
	dsinfo[GI] = ["General information", false];
	dsinfo[GHO_NTDS] = ["GHO indicators for NTDs", false];
	pinfo[CL_MONTHLY] = ["CL_cases_by provenance", false];
	pinfo[VL_MONTHLY] = ["VL_cases_by provenance", false];
	pinfo[FOOTNOTES] = ["Footnotes for Report Generator", false];
	pinfo[SUBN_ENDEMCTY] = ["Leishmaniasis endemicity", false];
	
	// DATA_ELEMENTS
	var DE = {
		CL_EPI_Type :   "EPw6gR9fDqt",
		VL_EPI_Type :	"IxbBQzytPgv",
		ACL_EPI_Type : 	"f1bBSpuIyzD",
		ZCL_EPI_Type : 	"Ta96pnXcAum",
		MCL_EPI_Type : 	"K8k1LRZagmc",
		VL_LAB_HIVstatus_Type : "NTo887FeHdI",
		PKDL_GEN_EPID_cases : "NdbsWSygpqz",
		MCL_GEN_EPID_cases : "K8k1LRZagmc",
		PKDL_LAB_HIV: "sxjZutF1AMx",
		UNS_USE_PREVIOUS_DATA : "ZjIDKHFwMUw",
		ACL_GEN_EPID_NEW_FOCUS : "TF0LMI2yPPZ",
		CL_GEN_EPID_NEW_FOCUS : "Euaxw5lULOI",
		VL_GEN_EPID_NEW_FOCUS : "ciPmHP0ghAZ",
		ZCL_GEN_EPID_NEW_FOCUS : "LRyb5NStabj",
		ACL_GEN_EPID_outbreak :  "fW73iTXOe8r",
		CL_GEN_EPID_outbreak :  "l0cmjII8aSl",
		VL_GEN_EPID_outbreak :  "kH8ZxF9Biwv",
		ZCL_GEN_EPID_outbreak :  "nfnq7idjj3Q"
	};

	var SUB_ENDEMICITY = {
		CL : "saLNr832Et0",
		ACL : "K827esuSG6T",
		ZCL: "XUr4C3Sw4Yx",
		VL : "S7sZbgQx4dM",
		ENDEMIC_OPTION_CODE : "1"
	};

		
	var COUNTRY_ENDEMICITY = new Array(6);
	COUNTRY_ENDEMICITY[VL_INDEX] = "LrpYf0oQmW0";
	COUNTRY_ENDEMICITY[CL_INDEX] = "KTXYAwYLdqB";
	COUNTRY_ENDEMICITY[ACL_INDEX] = "u4wrb4tx0vF";
	COUNTRY_ENDEMICITY[ZCL_INDEX] = "BBdfRkCsz7K";
	COUNTRY_ENDEMICITY[MCL_INDEX] = "UqwziKaKvqT";
	COUNTRY_ENDEMICITY[PKDL_INDEX] = "IZfAfkwNeAl";

	var ENDEMICITY_OS = {
		ENDEMIC_OPTION_CODE : "1",
		ENDEMIC_OPTION_NAME : "Endemic",
		PREVIOUSLY_REPORTED_OPTION_CODE : "3",
		PREVIOUSLY_REPORTED_OPTION_NAME : "Previously endemic",
		NO_ENDEMIC_OPTION_CODE : "5",
		NO_ENDEMIC_OPTION_NAME : "Non endemic"
	};

	var DE_SCREEN_ACTIVE = {};
	DE_SCREEN_ACTIVE[VL_COLUMN] = "g6yIwTl0sHx";
	DE_SCREEN_ACTIVE[CL_COLUMN] = "c5Zvvh9AWB4";
	DE_SCREEN_ACTIVE[ACL_COLUMN] = "hqgnicLioSz";
	DE_SCREEN_ACTIVE[ZCL_COLUMN] = "NDNcasRLz01";

	var DE_SCREEN_PASSIVE = {};
	DE_SCREEN_PASSIVE[VL_COLUMN] = "MRFflirvoj4";
	DE_SCREEN_PASSIVE[CL_COLUMN] = "jdQau4rlj73";
	DE_SCREEN_PASSIVE[ACL_COLUMN] = "gZuua8o0gNS";
	DE_SCREEN_PASSIVE[ZCL_COLUMN] = "yEmHARyqLIk";

	var DE_MONTHLY = {
		CL_CASES : "kyMxUQqI2ed",
		ACL_CASES : "lhxeWB8OiAG",
		ZCL_CASES : "PwHVQUj3WHw",
		VL_CASES : "n06IItYE45N"
	};

	var DE_CGI = {
		GEN_UN_WPP_LifeExpBirth : "xy0cDgvrg5W",
		GEN_WB_GDP_PPP_current : "w3XqypgTDEE",
		GEN_UN_WPP_Pop_Tot_AgeSex_1000 : "uLpIADOetw7",
		GEN_UN_WPP_LifeExpBirth_Female : "tvvwAxsuRme",
		GEN_UN_WPP_Pop_Tot_1000 : "WKJu1WytXzH",
		GEN_UN_WPP_LifeExpBirth_Male : "PVTbouvgSzJ",
		GEN_WB_IncomeGroup : "Oov1cYM9y6o"
	};

	var CGI_MALE = 0;
	var CGI_FEMALE = 1;
	var CGI_GENDER_UNKNOWN = 2;

	var Y_UNDER_5 = 0;
	var Y05_09 = 1;
	var Y10_14 = 2;
	var Y15_19 = 3;
	var Y20_24 = 4;
	var Y25_29 = 5;
	var Y30_34 = 6;
	var Y35_39 = 7;
	var Y40_44 = 8;
	var Y45_49 = 9;
	var Y50_54 = 10;
	var Y55_59 = 11;
	var Y60_64 = 12;
	var Y65_69 = 13;
	var Y70_74 = 14;
	var Y75_79 = 15;
	var Y80_84 = 16;
	var Y85_89 = 17;
	var Y90_94 = 18;
	var Y95_99 = 19;
	var Y100_AND_OVER = 20;

	var CC_CGI = create_2_dim_array(21, "", LABELS_ON_ROWS);
	CC_CGI[Y20_24][CGI_FEMALE] = "SobJ4FGuBRA";
	CC_CGI[Y10_14][CGI_FEMALE] = "oic7kU2uVtJ";
	CC_CGI[Y65_69][CGI_GENDER_UNKNOWN] = "K3xHNQJ7dfA";
	CC_CGI[Y90_94][CGI_FEMALE] = "kH3O17Sezfp";
	CC_CGI[Y100_AND_OVER][CGI_FEMALE] = "gkeN62eQlSA";
	CC_CGI[Y_UNDER_5][CGI_MALE] = "gWsMlGpOSzY";
	CC_CGI[Y45_49][CGI_FEMALE] = "irBgvZTT9zq";
	CC_CGI[Y80_84][CGI_FEMALE] = "BO8BiFA6WZo";
	CC_CGI[Y85_89][CGI_MALE] = "avCYQARWeei";
	CC_CGI[Y35_39][CGI_GENDER_UNKNOWN] = "JhZibEej5Ip";
	CC_CGI[Y30_34][CGI_GENDER_UNKNOWN] = "r9jCuRLjAyg";
	CC_CGI[Y15_19][CGI_GENDER_UNKNOWN] = "i0GLBPlRTrP";
	CC_CGI[Y65_69][CGI_MALE] = "a2dH289sMou";
	CC_CGI[Y70_74][CGI_GENDER_UNKNOWN] = "vq2MeIzidDv";
	CC_CGI[Y80_84][CGI_MALE] = "BpI46BM32FB";
	CC_CGI[Y85_89][CGI_FEMALE] = "hI8wdaiRHaS";
	CC_CGI[Y15_19][CGI_FEMALE] = "adEelGXyPIn";
	CC_CGI[Y05_09][CGI_GENDER_UNKNOWN] = "zsA0z1yxCyw";
	CC_CGI[Y40_44][CGI_MALE] = "XucrdYEMOE7";
	CC_CGI[Y60_64][CGI_MALE] = "Ss3gp5wAYOQ";
	CC_CGI[Y70_74][CGI_FEMALE] = "Gh29gSpSYPp";
	CC_CGI[Y_UNDER_5][CGI_FEMALE] = "o7NkWl5xFuS";
	CC_CGI[Y45_49][CGI_GENDER_UNKNOWN] = "mx2Vqi1H3Hb";
	CC_CGI[Y40_44][CGI_FEMALE] = "i6rBoDsk4LE";
	CC_CGI[Y85_89][CGI_GENDER_UNKNOWN] = "ZMMTWSNKy8h";
	CC_CGI[Y25_29][CGI_FEMALE] = "qdWOgC6bbBi";
	CC_CGI[Y25_29][CGI_MALE] = "AJkBK9XBytM";
	CC_CGI[Y45_49][CGI_MALE] = "BvCWyIwIqa8";
	CC_CGI[Y100_AND_OVER][CGI_MALE] = "ttAEJltz1yh";
	CC_CGI[Y15_19][CGI_MALE] = "xdAhLef7xG4";
	CC_CGI[Y70_74][CGI_MALE] = "C0VIpje6ADR";
	CC_CGI[Y60_64][CGI_GENDER_UNKNOWN] = "C9VfB7rurrS";
	CC_CGI[Y90_94][CGI_MALE] = "PKDfpYDkyoy";
	CC_CGI[Y05_09][CGI_MALE] = "lptUC1gVg8o";
	CC_CGI[Y60_64][CGI_FEMALE] = "RJDdLqVGxu8";
	CC_CGI[Y30_34][CGI_FEMALE] = "IVFKF7NzjJa";
	CC_CGI[Y20_24][CGI_GENDER_UNKNOWN] = "zUaD2dW8jgR";
	CC_CGI[Y35_39][CGI_FEMALE] = "Jkrg1KI25AV";
	CC_CGI[Y50_54][CGI_MALE] = "RwwDYedBcDl";
	CC_CGI[Y40_44][CGI_GENDER_UNKNOWN] = "qIa4UJxA58c";
	CC_CGI[Y55_59][CGI_MALE] = "xaMRyDOevEu";
	CC_CGI[Y95_99][CGI_GENDER_UNKNOWN] = "lRj2b3lwwiu";
	CC_CGI[Y75_79][CGI_FEMALE] = "zvECz1sg3sj";
	CC_CGI[Y65_69][CGI_FEMALE] = "ECle1XHoHZ2";
	CC_CGI[Y100_AND_OVER][CGI_GENDER_UNKNOWN] = "URAmCjBqRHW";
	CC_CGI[Y90_94][CGI_GENDER_UNKNOWN] = "eC3COFF4SAx";
	CC_CGI[Y25_29][CGI_GENDER_UNKNOWN] = "BPDXuG96jbx";
	CC_CGI[Y50_54][CGI_GENDER_UNKNOWN] = "VtRt5eBh10B";
	CC_CGI[Y55_59][CGI_FEMALE] = "nJEkgZS74Tt";
	CC_CGI[Y75_79][CGI_MALE] = "MKDYDGdryXB";
	CC_CGI[Y50_54][CGI_FEMALE] = "B2cV93OdJpI";
	CC_CGI[Y95_99][CGI_FEMALE] = "nHBTtdVMe7l";
	CC_CGI[Y05_09][CGI_FEMALE] = "xodN5e1QCp6";
	CC_CGI[Y10_14][CGI_MALE] = "o8dMMqNDCtr";
	CC_CGI[Y_UNDER_5][CGI_GENDER_UNKNOWN] = "Bmz5QDlUZbl";
	CC_CGI[Y80_84][CGI_GENDER_UNKNOWN] = "zx6ELNiPAq3";
	CC_CGI[Y30_34][CGI_MALE] = "xsUkVS0PK0u";
	CC_CGI[Y10_14][CGI_GENDER_UNKNOWN] = "YF8UKbqPrBb";
	CC_CGI[Y35_39][CGI_MALE] = "VwZsMBUBdR1";
	CC_CGI[Y75_79][CGI_GENDER_UNKNOWN] = "COVvK2lp01u";
	CC_CGI[Y55_59][CGI_GENDER_UNKNOWN] = "kmnHzx1ulIk";
	CC_CGI[Y95_99][CGI_MALE] = "kXo51Sydk1t";
	CC_CGI[Y20_24][CGI_MALE] = "ZYAx6PjJ2ZM";

	var CC_DEFAULT = "Xr12mI7VPn3";
	var TYPE_NEW_CASES = "psVSPLclyFj";
	var TYPE_RELAPSE = "KPn9RHNrd8R";
	var TYPE_UNSPECIFIED = "IRW4YrOtk5q";

	var NEW_MALE = "GpQZH8hC7jY";
	var NEW_FEMALE = "TtoYCIVcBA3";
	var NEW_UNKNOWN = "FaYhAlKLX16";
	var UNS_MALE = "aWWYWv6buzp";
	var UNS_FEMALE = "wGED4K5Bs37";
	var UNS_UNKNOWN = "zkKbIIarKWM";

	var FEMALE = "V2LdgcGgFQt";
	var MALE = "Z2hvpF7mhh7";
	var UNKNOWN_SEX = "jNbFhhnUsQv";

	var AGE_5 = "HDXcEOGT2s1";
	var AGE_5_14 = "moktBQGym51";
	var AGE_14 = "rN9ELJVdEpo";
	var AGE_UNKNOWN = "gPGNI7bWhDB";

	var NEW_UNDER_5 = "hKq5WASZw8q";
	var NEW_5_14 = "mTyLqDjpQ5b";
	var NEW_OVER_14 = "DDliBAHqwGV";
	var NEW_AGE_UNKNOWN = "dVuOzmU4xbI";
	var UNS_UNDER_5 = "rZwYGlqR8GG";
	var UNS_5_14 = "P6R9XEaqQbz";
	var UNS_OVER_14 = "UQMTeRPY2U0";
	var UNS_AGE_UNKNOWN = "nIbrdHllMKh";

	var ORIGIN_AUTOC_NEW = "WynvvdELtqm";
	var ORIGIN_AUTOC_REL = "LUVeZjOsibr";
	var ORIGIN_AUTOC_UNS = "wYB0E3USJ7L";
	var ORIGIN_IMPORT_NEW = "pWZT12mjhUC";
	var ORIGIN_IMPORT_REL = "QO2kKL8ySPc";
	var ORIGIN_IMPORT_UNS = "A5TSwm9Wivn";
	var ORIGIN_UNKNOWN_NEW = "Lx8tyhhseZZ";
	var ORIGIN_UNKNOWN_REL = "lGFgLYweSNS";
	var ORIGIN_UNKNOWN_UNS = "EGvT9lj2BOy";

	/* Diagnosis DataElements */
	var VL_Lab_RDT_tested_type = "rFy4bKMa977";
	var VL_Lab_RDT_results_type = "o1smtpQE1tm";
	var POSITIVE_NEW = "jRcT6HVKb2t";
	var POSITIVE_RELAPSE = "QKqVJ13mGZI";
	var POSITIVE_UNSP = "YXktM46YiXo";

	/* Treatment Category options*/

	// Outcome

	// CC for drugs Initial Cure Treatment outcome
	var IC_NEW_AMB = "MfebCxR7NDr"; // VL
	var IC_UNS_AMB = "Da9OoxaeVxn";
	var IC_NEW_GLU = "wuSFWEdQuZH"; // CL, ACL, ZCL
	var IC_UNS_GLU = "edJOdz8AWve";
	var IC_NEW_PEN = "iHN06Kmhvdx"; // VL
	var IC_UNS_PEN = "SmTniJtU9yc";
	var IC_NEW_SSG = "Akgp3RvT6l3"; // CL, ACL, ZCL
	var IC_UNS_SSG = "BjLReGCNxwk";
	var IC_NEW_SSG_PARO = "S4YOw3gkmFa"; // VL
	var IC_UNS_SSG_PARO = "zGPEo9L7srN";
	var VL_IC_NEW_OTH = "ODhB7M16KTG"; // VL
	var VL_IC_UNS_OTH = "T6LBaVMXq4E";
	var VL_IC_NEW_UNS = "kT60pxOR9DT"; // VL
	var VL_IC_UNS_UNS = "LAkANoW73LV";	
	var CL_IC_NEW_OTH = "OLyLq0AkHEQ"; // CL, ACL, ZCL
	var CL_IC_UNS_OTH = "EnhXnkfyLWa";
	var CL_IC_NEW_UNS = "eYp1LtWKuon"; // CL, ACL, ZCL
	var CL_IC_UNS_UNS = "FVAmnbEI6kn";

	// CC for drugs failure Initial Treatment outcome
	var FAIL_NEW_AMB = "T2MDkJzCKf7"; // VL
	var FAIL_UNS_AMB = "Pr6aEN8PC5M";
	var FAIL_NEW_GLU = "WJf6H2HVZKN"; // CL, ACL, ZCL
	var FAIL_UNS_GLU = "hggEQ5Xm0cN";
	var FAIL_NEW_PEN = "aeBFt3rX6NP"; // VL
	var FAIL_UNS_PEN = "BWqkFDITG0V";
	var FAIL_NEW_SSG = "dzqOoSKXPKL"; // CL, ACL, ZCL
	var FAIL_UNS_SSG = "jFmiZOTK9rc";
	var FAIL_NEW_SSG_PARO = "if1h2SRcku2"; // VL
	var FAIL_UNS_SSG_PARO = "azirNffjDgP";
	var VL_FAIL_NEW_OTH = "WUWQqRMnWDq"; // VL
	var VL_FAIL_UNS_OTH = "yaX1pqDkpQg";
	var VL_FAIL_NEW_UNS = "IDinKF2U3Ck"; // VL
	var VL_FAIL_UNS_UNS = "bmukoyyu4Pr";	
	var CL_FAIL_NEW_OTH = "Cl3ZokvTdwK"; // CL, ACL, ZCL
	var CL_FAIL_UNS_OTH = "EJDj412Rxso";
	var CL_FAIL_NEW_UNS = "SHKozECi3D8"; // CL, ACL, ZCL
	var CL_FAIL_UNS_UNS = "ZmlPKopCQ4C";

	// CC for drugs Death Treatment outcome
	var DEATH_NEW_AMB = "x4cgQg2AcY0"; // VL
	var DEATH_UNS_AMB = "YOmhC4PE87B";
	var DEATH_NEW_GLU = "FnJi3vH25Hu"; // CL, ACL, ZCL
	var DEATH_UNS_GLU = "WEZIdAT6iF7";
	var DEATH_NEW_PEN = "aA3lP8pEbeb"; // VL
	var DEATH_UNS_PEN = "KAetedUQTtU";
	var DEATH_NEW_SSG = "kbGdhqu16zE"; // CL, ACL, ZCL
	var DEATH_UNS_SSG = "v3bRDWs5P7s";
	var DEATH_NEW_SSG_PARO = "i7wr45ig4ho"; // VL
	var DEATH_UNS_SSG_PARO = "FIJebC73iWT";
	var VL_DEATH_NEW_OTH = "ZVVzyM4NTY2"; // VL
	var VL_DEATH_UNS_OTH = "mdtkHiVSZQP";
	var VL_DEATH_NEW_UNS = "TaxNA8fHbey"; // VL
	var VL_DEATH_UNS_UNS = "tpW0Oiuo0Sh";	
	var CL_DEATH_NEW_OTH = "kT7zue7yO7B"; // CL, ACL, ZCL
	var CL_DEATH_UNS_OTH = "oBUl8XZw0GT";
	var CL_DEATH_NEW_UNS = "DfIKXg8q1UM"; // CL, ACL, ZCL
	var CL_DEATH_UNS_UNS = "KpxWMjKWw1B";

	// CC for drugs Death Treatment outcome

	var VL_UNKNOWN_NEW_OTH = "MdTYGUtqXvy"; // VL
	var VL_UNKNOWN_UNS_OTH = "xTFEwFzg8e8";
	var VL_UNKNOWN_NEW_UNS = "SzuZ0zZuDYi"; // VL
	var VL_UNKNOWN_UNS_UNS = "X49CoAZyVYt";	
	var CL_UNKNOWN_NEW_OTH = "S4OvFzEe6SJ"; // CL, ACL, ZCL
	var CL_UNKNOWN_UNS_OTH = "ftIbkUE8cTg";
	var CL_UNKNOWN_NEW_UNS = "DcUvDhdVhsw"; // CL, ACL, ZCL
	var CL_UNKNOWN_UNS_UNS = "DwRc6xeV3LN";

	/* Indicators*/
	var NEW_AND_UNSP_CASES = new Array(4);
	NEW_AND_UNSP_CASES[VL_INDEX] = "TAi5pNjuxmq"; // NTD_LSH_VL_EPI_NewCases_I
	NEW_AND_UNSP_CASES[CL_INDEX] = "CeO5dTNMbPp"; // NTD_LSH_CL_EPI_NewCases_I
	NEW_AND_UNSP_CASES[ACL_INDEX] = "ZUL3QhfRZBT"; // NTD_LSH_ACL_EPI_NewCases_I
	NEW_AND_UNSP_CASES[ZCL_INDEX] = "LCa3hY8xkst"; // NTD_LSH_ZCL_EPI_NewCases_I

	var TREAT_COMPLETED = new Array(4);
	TREAT_COMPLETED[VL_INDEX] = "dUns9PpQ58C"; // NTD_LSH_VL_TREAT_completed_I
	TREAT_COMPLETED[CL_INDEX] = "foObvaWTV2q"; // NTD_LSH_CL_TREAT_completed_I
	TREAT_COMPLETED[ACL_INDEX] = "uSRDXhpcEjS"; // NTD_LSH_ACL_TREAT_completed_I
	TREAT_COMPLETED[ZCL_INDEX] = "ZtbetBov4Nk"; // NTD_LSH_ZCL_TREAT_completed_I

	var SCREEN_PASSIVE = new Array(4);
	SCREEN_PASSIVE[VL_INDEX] = "ECAJUz3nff5"; // NTD_LSH_VL_SCREEN_passive_I
	SCREEN_PASSIVE[CL_INDEX] = "zo5BQlapP45"; // NTD_LSH_CL_SCREEN_passive_I
	SCREEN_PASSIVE[ACL_INDEX] = "vq1FX8vBEi1"; // NTD_LSH_ACL_SCREEN_passive_I
	SCREEN_PASSIVE[ZCL_INDEX] = "kknHr7KtRTs"; // NTD_LSH_ZCL_SCREEN_passive_I

	var INCIDENCE_FOR_MAPS = new Array(4);
	INCIDENCE_FOR_MAPS[VL_INDEX] = "k8OBrohsSSg"; //  VL_EPI_INC_PopData_LSH_10000
	INCIDENCE_FOR_MAPS[CL_INDEX] = "Yw3FULKBFgt"; // CL_EPI_INC_PopData_LSH_10000
	INCIDENCE_FOR_MAPS[ACL_INDEX] = "wR0vjRjXpO8"; // ACL_EPI_INC_PopData_LSH_10000
	INCIDENCE_FOR_MAPS[ZCL_INDEX] = "bkNwROwt8lc"; // ZCL_EPI_INC_PopData_LSH_10000

	var INCIDENCE_FOR_CHARTS = new Array(4);
	INCIDENCE_FOR_CHARTS[VL_INDEX] = "R8mWrVeFBog";	 // VL_EPI_INC_PopUN_10000
	INCIDENCE_FOR_CHARTS[CL_INDEX] = "e16AVRh07kk";	 // CL_EPI_INC_PopUN_10000
	INCIDENCE_FOR_CHARTS[ACL_INDEX] = "VxWuCmDA1x8"; // ACL_EPI_INC_PopUN_10000
	INCIDENCE_FOR_CHARTS[ZCL_INDEX] = "hRzNpxG8Qg3"; // ZCL_EPI_INC_PopUN_10000

	var POP_AT_RISK = new Array(4);
	POP_AT_RISK[VL_INDEX] = "qZrDWm2KJOh";
	POP_AT_RISK[CL_INDEX] = "FwXQC7ARUBf";
	POP_AT_RISK[ACL_INDEX] = "NYzjVXzaod5";
	POP_AT_RISK[ZCL_INDEX] = "b4CaeIjuNqc";

	// Control & Surveillance

	var Leish_GEN_LNCP_year = "X628bzppb3C";

	// CL Surv Type applies also to ACL and ZCL
	var CL_GEN_Surv_Type = "MLBu7WOihjq";
 	var VL_GEN_Surv_Type = "dwTbQkNmLeN";

	var Leish_GEN_VectorControl = "Bwow2Lb2bG2";

	var Leish_GEN_VectorControl_Insecticide = "kGGckm5yhkI";
	
	var CL_GEN_Guidelines_year = "oNCY7n0S94E";
	var VL_GEN_Guidelines_year = "M8lRhrml0VN";

	var CL_GEN_Surv_Notif = "GQ7hSCfnCt9";
	var VL_GEN_Surv_Notif = "uuF031QMFkW";

	var Leish_GEN_ReservoirControl = "Kir30itliay";

	var CL_GEN_Surv_HF = "yTIKdvsDjHe";
	var VL_GEN_Surv_HF = "p7IL1FciQ7v";


	// Treatment & medicines

	var CL_GEN_TxFree = "TUt8fEPjgPB";
	var VL_GEN_TxFree = "CyR30L4QvB6";

	var EML = [];
	var EML_MIN = 0, EML_MAX = 6;
	var EML_LIST_SEPARATOR = ', ';
	var EML_NONE = '-';

	var AMPHOTERICINB = EML_MIN;
	var LIPOSOMALAMP = 1;
	var MEGLUMINE = 2;
	var MILTEFOSINE = 3;
	var PAROMOMYCIN = 4;
	var PENTAMIDINE = 5;
	var SSG = EML_MAX;

	EML[AMPHOTERICINB] = [];
	EML[LIPOSOMALAMP] = [];
	EML[MEGLUMINE] = [];
	EML[MILTEFOSINE] = [];
	EML[PAROMOMYCIN] = [];
	EML[PENTAMIDINE] = [];
	EML[SSG] = [];

	EML[AMPHOTERICINB].ID = "v9HkT2GJGZc";
	EML[LIPOSOMALAMP].ID = "hsOZ4rKMBlE";
	EML[MEGLUMINE].ID = "FZ0d8oYBDFD";
	EML[MILTEFOSINE].ID = "k7EuWr0KUPM";
	EML[PAROMOMYCIN].ID = "jQccvr2Adlb";
	EML[PENTAMIDINE].ID = "z8PUIRxPGB9";
	EML[SSG].ID = "ZzOK74NB4wN";

	EML[AMPHOTERICINB].NAME = "Amphotericin B deoxycholate";
	EML[LIPOSOMALAMP].NAME = "Liposomal amphotericin B";
	EML[MEGLUMINE].NAME = "Meglumine antimoniate";
	EML[MILTEFOSINE].NAME = "Miltefosine";
	EML[PAROMOMYCIN].NAME = "Paromomycin";
	EML[PENTAMIDINE].NAME = "Pentamidine";
	EML[SSG].NAME = "Sodium stibogluconate (SSG)";


	var RG_footnote_active = "GBOpGIZ0QDU";
	var RG_footnote_page = "SrHddMhflZZ";
	var RG_footnote_text = "rWAis0fAWw9";

	var builtUrl;

	var totalPopulation;
	var pop_at_risk_values = Array(6);
	var new_and_usnp_cases = Array(5);
	var total_treated = Array(5);
	var screen_passive = Array(5);

	var editingElement;

	var footNoteCounter = 0;

	var NULL_AGGR_TYPE = null;
	var NULL_FILTER = null;
	var NULL_VALUE = null;
	
	/* Classes */

	var CLASS_EDITABLE_ELEMENT = "editableElement";
	var CLASS_FOOTNOTABLE_ELEMENT = "footnotable";

	var SORTABLE_LIST_1_NAME = "sortable1";
	var SORTABLE_LIST_2_NAME = "sortable2";
	var SORTABLE_LIST_3_NAME = "sortable3";

	var newCLCasesChartID = "chart0";	
	var newAZCLCasesChartID = "chart1";
	var newVLCasesChartID = "chart2";

	var newCLAndHistoricIncidenceID = "chart3";
	var newAZCLAndHistoricIncidenceID = "chart4";
	var newVLAndHistoricIncidenceID = "chart5";

	/* HTML elements */

	var CGI_TABLE_NAME = "cgiTable";
	var EPI_TABLE_NAME = "epiTable";
	var MONTHLY_TABLE_NAME = "monthlyTable";
	var CAS_TABLE_NAME = "casTable";
	var TAM_TABLE_NAME = "tamTable";
	var DIAG_TABLE_NAME = "diagTable";
	var TOUTCOME_TABLE_NAME = "toutcomeTable";

	var BUTTON_PREFIX = '_BUTTON_';
	var CHART_PREFIX = "chart";
	var LEGENDSET_PREFIX = "legendSet";
	var LEGEND_PREFIX = "legend";
	var LEISH_COLUMN_DETAIL_PREFIX = "LeishDetail";
	var LEVEL_PREFIX = "level";
	var MAP_PREFIX = "map";	
	var MAP_STYLE_PREFIX = "mapStyle";
	var OPTION_PREFIX = '_OPTION_';
	var TEXT_UNDER_EPI = 'TEXT_UNDER_EPI';
	var TEXT_UNDER_DIAG1 = 'TEXT_UNDER_DIAG1';
	var TEXT_UNDER_DIAG2 = 'TEXT_UNDER_DIAG2';

	var generatedYears = [], organisationUnits = [];


	var dialog, editor;

	var ds = {};

	/****************************************************************************************************
 	 **********                    	     STATIC CONTENT FUNCTIONS         	           	       **********
	 ****************************************************************************************************/
	function fillTableHead(tableName, extName, firstColumn, headObjects){
		var html = '<th>'+firstColumn+'</th>';
		
		for (var i=0; i<headObjects.length;i++){
			html +='<th class="'+CLASS_EDITABLE_ELEMENT+'">'+headObjects[i]+'</th>';
		}
		document.getElementById(tableName + extName).innerHTML = html;
	}

	function generateCheckboxes(htmlObject, labels, title, prefix, newLineOn){
		var html = '<legend>'+title+'</legend>';
		for (var i=0; i<labels.length; i++){
			html+='<input id="' + prefix + BUTTON_PREFIX + i + '" type="checkbox" class="' + prefix + '" checked="checked" />';
			html+='<label for="' + prefix + BUTTON_PREFIX + i + '">' + labels[i] + '</label>';
			if(i===newLineOn){
				html+='<br>';
			}
		}
		    
		htmlObject.html(html);
	}

	function generateMapConfigurationList(htmlObject, labels, prefix){
		var html = '';
		
		for (var i=0; i<labels.length; i++){
			html+='<option id="' + prefix + OPTION_PREFIX + i + '" value="' + i + '" >';
			html+=labels[i];
			html+='</option>';
		}
		htmlObject.html(html);
	}

	function setTextUnderTables(elementId, idprefi, labels, labelsDesc, firstText){

		var html = '';

		if (firstText === true){
			html +='<span class="' + CLASS_EDITABLE_ELEMENT + '">N/A not applicable</span>';
		} else if (firstText === false){
			html +='';
		} else {
			html +=firstText;
		}
		for (var i = 0; i < labels.length; i++){
			html +='<span id="'  +idprefi + i + '" class="' + CLASS_EDITABLE_ELEMENT+'">' + labels[i] + ' = ' + labelsDesc[i] + '</span>';
		}

		$("#"+elementId).append(html);
	}




	/****************************************************************************************************
 	 **********                    	    FUNCTIONS CALLING THE API         	           	       **********
	 ****************************************************************************************************/

	function getFootnotes(subNationalLevel){

		if (subNationalLevel == NATIONAL_LEVEL){
			// means the app has been relaunched
			return;
		} else {
			var params = {
				skipPaging : true
			}; 
			return $.when(getParents(ds.countryID)).then(function(data){
				var orgUnits = "";
				if (typeof data.organisationUnits !== 'undefined' ) {
					orgUnits = data.organisationUnits[0].path.replace(/^\/|\/$/, "").replace(/\//g, ";");
				}
				storedFootnotes = [];
				activeFootnotesPage1 = [];
				activeFootnotesPage2 = [];
				
				var dimensions = [];
				dimensions.push([RG_footnote_page]);
				dimensions.push([RG_footnote_text]);
				dimensions.push([RG_footnote_active]);
				dimensions.push(["ou",orgUnits]);

				var filters = [];

				extraParams = "&ouMode=SELECTED&startDate=2010-01-01&endDate=2030-12-31&page=1&pageSize=10000";


				return getQueryEvents(FOOTNOTES, dimensions, filters, OUTPUT_TYPE.EVENT, extraParams);
			});
		}
	}

	function fillFootNotes(data){
		var pageIndex = getHeaderIndex(data.headers, RG_footnote_page);
		var fnIndex = getHeaderIndex(data.headers, RG_footnote_text);
		var activeIndex = getHeaderIndex(data.headers, RG_footnote_active);

		var page, active, fnText;
		for (var i = 0; i<data.rows.length; i++) {
			active = data.rows[i][activeIndex];
			fnText = data.rows[i][fnIndex];

			if (!!parseInt(active)){ // !! converts int to boolean
				page = data.rows[i][pageIndex];
				if (page.localeCompare("2")==0) {
					activeFootnotesPage2.push(fnText);
				} else {
					activeFootnotesPage1.push(fnText);
				}
			} else {
				storedFootnotes.push(fnText);
			}
		}
	}


	function getParents(id){
		var params = {
			fields: "path",
			paging: false
		};

		var builtUrl = buildAPIUrl(ORG_UNITS, params);
		builtUrl += "&filter=id:eq:"+id;
		return $.ajax({
			url: builtUrl
		}).then(function(data) {
			return data;
		}).fail(function(data) {
			console.log ("ERROR. getParents");
			console.log (data);
		});
	}

	function getEventsFor(program, orgUnit, params) {
		params.orgUnit = orgUnit;
		params.program = program;
		var builtUrl = buildAPIUrl(EVENTS, params);
		return $.ajax({
			url: builtUrl
		}).done(function(data) {
			return data;
		}).fail(function(data) {
			console.log ("ERROR. getEventsFor");
			console.log (data);
		});
	}

	function getLegendSet(index){
		var legendUrl = "../../legendSets/"+LEGENDS[index];

		return $.ajax({
			url: legendUrl
		}).then(function(data) {
			mapLegends[index] = [];
			var legendSetName = data.name;
			return $.ajax({
				url: legendUrl+"/legends/"
			}).then(function(data) {
				for (var i =0; i<data.legends.length; i++){

					mapLegends[index][i] = {};
					mapLegends[index][i].legendSetName = legendSetName;
					mapLegends[index][i].legendNames = data.legends[i].name;
					mapLegends[index][i].legendColors = data.legends[i].color;
					mapLegends[index][i].startValue = data.legends[i].startValue;
					mapLegends[index][i].endValue = data.legends[i].endValue;
				}
				mapLegends[index] =  reOrderLegendSet(mapLegends[index]);
			});
			
		});
	}

	function generateMap(index, dimentionType, levels, orgUnitId, year, thematic, mapStyle, opacityLevel){
		
		var base = "../../..";
		var idHtmlElement = MAP_PREFIX+(index);
		var dimension = INCIDENCE_FOR_MAPS[index];
		var legendSetID = 	LEGENDS[index];

		// Resizes the map contener
		$("#" + MAP_PREFIX + index).height(map_height);
		$("#" + MAP_PREFIX + index).width(map_width);
	
		// Move back the legend to the legendPool
		$("#legendPool").append($('#'+LEGENDSET_PREFIX+index));
		
		//restore map to its initial value
		$('#'+idHtmlElement).html(initalMapDiv[index]);
		

		var itemsOnRow = [];
		for(var i=0; i<levels.length; i++){
			itemsOnRow.push({id: "LEVEL-"+levels[i]});
		}
		itemsOnRow.push({id: orgUnitId});

		Ext.onReady(	function (){

			DHIS.getMap({
				url: base,
				el: idHtmlElement,
				basemap: mapStyle,
				mapViews: [{
					columns: [{dimension: "dx", items: [{id: dimension, dimensionItemType: dimentionType}]}],
					rows: [{dimension: "ou", items: itemsOnRow}],
					filters: [{
							dimension: "pe",
							items: [{id: year}]}],
					valueType: "in",
					layer: thematic,
 					legendSet: {id: legendSetID},
					labels: false, // labels of the regions
					opacity:opacityLevel/100
				}],
				onReady: function() {
                    console.log('map '+index +'is ready!');
					// Removes zoom and legend
					$('#'+idHtmlElement).find(".leaflet-control-zoom").remove();
					$('#'+idHtmlElement).find(".leaflet-control-legend").remove();
					
					// Removes openmaps signature
					$('#'+idHtmlElement).find(".leaflet-bottom.leaflet-right").empty();

					// Adds the legend
					//$('#'+idHtmlElement).find(".leaflet-bottom.leaflet-right").append($('#'+LEGENDSET_PREFIX+index));
					moveLegend(index, $('#'+idHtmlElement).find(LEGEND_POSITIONS[BOTTOM_RIGHT]), LEGEND_TO_REPORT);

                }
				
			});
		});
	}

	function getDEUsedByMetadata(){


		var promises = [];
		var ds_indexes = [];
		var p_indexes = [];
		for (var uid in dsinfo) {
			if (dsinfo[uid][ASSG]){
				promises.push(getDEusedByDataSet(uid));
				promises.push(getCOCusedByDataSet(uid));
				ds_indexes.push(uid);
			}
		}
		for (uid in pinfo) {
			if (pinfo[uid][ASSG]){
				promises.push(getDEusedByProgram(uid));
				p_indexes.push(uid);
			}
		}

		// so we can retrieve the order of requests once all promises are resolved
		promises.push(ds_indexes);
		promises.push(p_indexes);
		return Promise.all(promises)
		.then(function(result) {
			console.log("all promises");
			console.log(result);

			ds_indexes = result[result.length - 2];
			p_indexes = result[result.length - 1];

			for (var i = 0; i < ds_indexes.length; i++) {
				// *2 since we have generated two promises per dataset, first one for DE
				dsinfo[ds_indexes[i]][DE_IDX] = [...result[i*2].listGrid.rows];
				de_assigned = de_assigned.concat(result[i*2].listGrid.rows);
				// *2+1 since we have generated two promises per dataset, second one for COC
				coc_assigned = coc_assigned.concat(result[i*2+1].listGrid.rows);
			}

			var shift = ds_indexes.length;
			for (i = shift; i < shift + p_indexes.length; i++) {
				pinfo[p_indexes[i-shift]][DE_IDX] = [...result[i+shift].listGrid.rows];
				de_assigned = de_assigned.concat(result[i+shift].listGrid.rows);
			}
			return;
		});

	}

	function getCOCusedByDataSet(dsuid){
		var params = {
			var: "datasetuid:" + dsuid,
			paging: false
		};

		return $.when(getv3(SQLVIEWS + "/" + SQL_COC_DS + "/data", params))
		.done(function(result){
			// not interested in store COC in dsinfo array
			return;
		});
	}

	function getDEusedByDataSet(dsuid){
		var params = {
			var: "datasetuid:" + dsuid,
			paging: false
		};

		return $.when(getv3(SQLVIEWS + "/" + SQL_DE_DS + "/data", params))
		.done(function(result){
			dsinfo[dsuid][DE_IDX] = result.dataelements;
		});
	}

	function getDEusedByProgram(puid){
		var params = {
			var: "programuid:" + puid,
			paging: false
		};

		return $.when(getv3(SQLVIEWS + "/" +SQL_DE_P + "/data", params))
		.done(function(result){
			pinfo[puid][DE_IDX] = result.dataelements;
		});
	}

	/* getting country General Information from API */
	function get_cgi() {

		var params = {
			dataSet: GI,
			period: ds.year,
			orgUnit: ds.countryID
		};

		builtUrl = buildAPIUrl(DATAVALUESETS, params);
		return $.ajax({
			url: builtUrl
		}).then(function(data) {
				fillCountryGeneralInformation(data);
		});
	}

	function get_gho_ntds() {

		var params = {
			dataSet: GHO_NTDS,
			period: ds.year,
			orgUnit: ds.countryID
		};

		builtUrl = buildAPIUrl(DATAVALUESETS, params);
		return $.ajax({
			url: builtUrl
		}).then(function(data) {
				fillGHO(data);
		});
	}

	function get_subnational_endemicity_for(program, year, level, ind, column) {

		var dimensions = [];
		dimensions.push(["pe",year]);

		var filters = [];
		filters.push(["ou",ds.countryID+";"+LEVEL+subNationalLevelToAbs(level)]);
		filters.push([ind,"IN",SUB_ENDEMICITY.ENDEMIC_OPTION_CODE]);

		return $.when(getAggregateEvents(program, dimensions, NULL_VALUE, filters, NULL_AGGR_TYPE, SKIP_PAGING, SKIP_META, OUTPUT_TYPE.EVENT))
			.done(function(result){
				var data = getAnalyticValueForKey(result, YEARLY_MODE);
				array[THIRD_LEVEL_ROW][column] =  data[0] || WHEN_NO_DATA ;
			});
	}
	
	function get_monthly_cases_for(program, year, de, row) {
			var dimensions = [];
		//	var filters = [];

			var periods = generateMonthlyPeriodsForYear(year, ";");

			dimensions.push(["pe",periods]);
			dimensions.push(["ou",ds.countryID]);

			return $.when(getAggregateEvents(program, dimensions, de, NULL_FILTER, AGGR_TYPE.SUM, SKIP_PAGING, SKIP_META, OUTPUT_TYPE.EVENT))
				.done(function(result){
					var data = getAnalyticValueForKey(result, MONTHLY_MODE);
					fillMonthlyArray(row, data);
				});
	}


	/* getting cl cases from API */
	function get_cl_cases() {

		var params = {
			dataSet: CL_DETAILED,
			period: ds.year,
			orgUnit: ds.countryID
		};

		builtUrl = buildAPIUrl(DATAVALUESETS, params);
		return $.ajax({
			url: builtUrl
		}).then(function(data) {
			return data;
		});
	}


	/* getting cl cases from API */
	function get_azcl_cases() {
		var params = {
			dataSet: AZCL_DETAILED,
			period: ds.year,
			orgUnit: ds.countryID
		};

		builtUrl = buildAPIUrl(DATAVALUESETS, params);
		return $.ajax({
			url: builtUrl
		}).then(function(data) {
			return data;
		});
	}


	/* getting vl cases from API */
	function get_vl_cases() {
		var params = {
			dataSet: VL_DETAILED,
			period: ds.year,
			orgUnit: ds.countryID
		};

		builtUrl = buildAPIUrl(DATAVALUESETS, params);
		return $.ajax({
			url: builtUrl
		}).then(function(data) {
			return data;
		});
	}

	/**
	* gets analytics data from dx for pe ds.year
	* filter: ou: ds.countryID
	* yearsInThePast: number of previous years to include
	* thenFunction(data, thenFParams)
	*/
	function getAnalyticsDataForDX(dx_dimension, yearsInThePast, thenFunction, thenFParams){
		var dx_dimension_treated = "";
		if (Array.isArray(dx_dimension)){
			for (var i = 0; i<dx_dimension.length; i++){
				dx_dimension_treated = dx_dimension_treated + dx_dimension[i] + ";";
			}
			dx_dimension_treated = dx_dimension_treated.slice(0, -1);
		} else {
			dx_dimension_treated = dx_dimension;
		}

		var params = {
			dimension: ["dx:"+dx_dimension_treated,"pe:"+ds.year],
			filter: ["ou:"+ds.countryID],
			displayProperty : "NAME",
			skipMeta:"true"
		};

		for (var i=1; i<=yearsInThePast; i++){
			params.dimension[1] +=";"+(ds.year-i);
		}
		var builtUrl = buildAPIUrl(ANALYTICS, params);
		return $.ajax({
			url: builtUrl
		}).then(function(data) {
			thenFunction(data, thenFParams)
		});
	}

	function getPopulationAtRiskFor(indicator, column, subNationalLevel){

		var absolute_level =  WIDP_OU_SHIFT + subNationalLevel

		var params = {
			dimension: ["dx:"+indicator,"pe:"+ds.year, "ou:"+ds.countryID+";LEVEL-"+absolute_level], //TODO: adapt to each country
			displayProperty : "NAME",
			skipMeta:"true"
		};

		var builtUrl = buildAPIUrl(ANALYTICS, params);
		return $.ajax({
			url: builtUrl
		}).then(function(data) {
				fillPopulationAtRiskArray(data, column);
		});
	}


	/****************************************************************************************************
 	 **********                      FILLING LOGICAL STRUCTURES (ARRAYS)               	       **********
	 ****************************************************************************************************/

	 /***

	 */
	function fillMonthlyArray(row, data) {

		Object.keys(data).forEach(function (key) {
			monthlyArray[row][key] = parseInt(data[key]);
		});
		
	}	 

	function fillNewCasesArray(data, params){
		var column = params[0];
		historicNewCases[column] = getAnalyticValueForKey(data, YEARLY_MODE);
	}	
				
	function fillIndicatorArray(data, extraFParams){
		var arrayReference = extraFParams[0];
		var arrayName = extraFParams[1];
		var dx_header = getHeaderIndex(data.headers, "dx"); 
		var value_header = getHeaderIndex(data.headers, "value"); 

		for (var i = 0; i<data.rows.length; i++){
			var id = data.rows[i][dx_header];
			var index = arrayReference.indexOf(id);
			arrayName[index] = parseInt(data.rows[i][value_header]);
		}

	}


	function fillIncidenceChartArray(data, params){
		var column = params[0];
		historicIncidenceChart[column] = getAnalyticValueForKey(data, YEARLY_MODE);
	}

	function fillPopulationAtRiskArray(data, column){
		index = column - 1;
		headerIndex = getHeaderIndex(data.headers, "value");
		pop_at_risk_values[index] = parseInt(sumValueForHeader(data, headerIndex));
		percentage =  percentageText(pop_at_risk_values[index], totalPopulation, 0, true);

		array[RISK_ROW][column] = percentage + " " + pop_at_risk_values[index] + " / " + (totalPopulation || WHEN_NO_DATA);
	}

	function fillArray_IncidenceRow(){
		var incidence, incidence_text;
		for (var i = VL_INDEX; i<= ZCL_INDEX ; i++) {
			// array[row][col], col = index + 1
			incidence = percentageText(new_and_usnp_cases[i] * 100, pop_at_risk_values[i], 2, false); // incd = 10000 * cases / pop_at_risk. 2 decimal places
			incidence_text = (!isNaN(incidence) || typeof incidence === 'string' ) ? incidence : WHEN_NO_DATA; // shows No data if denominator = 0 or no data
			array[INCD_ROW][i+1] = incidence_text;
		}
		for (var i = PKDL_INDEX; i<= MCL_INDEX ; i++) {
			array[INCD_ROW][i+1] = WHEN_NON_APPLICABLE;
		}
	}

	/**
	 * fills country endemicity row
	 * */
	function fillGHO(data){

		var dataValues = data.dataValues;
		var endemicty_code, endemicity_text;

		for (var i = 0; i<COUNTRY_ENDEMICITY.length; i++){
			endemicty_code = getValueForKey(dataValues, DE_KEY, COUNTRY_ENDEMICITY[i], VALUE_KEY);
			switch (endemicty_code){
				case ENDEMICITY_OS.ENDEMIC_OPTION_CODE:
					endemicity_text = ENDEMICITY_OS.ENDEMIC_OPTION_NAME;
					break;				
				case ENDEMICITY_OS.PREVIOUSLY_REPORTED_OPTION_CODE:
					endemicity_text = ENDEMICITY_OS.PREVIOUSLY_REPORTED_OPTION_NAME;
					break;				
				case ENDEMICITY_OS.NO_ENDEMIC_OPTION_CODE:
					endemicity_text = ENDEMICITY_OS.NO_ENDEMIC_OPTION_NAME;
					break;
				case WHEN_NO_DATA:
					endemicity_text = WHEN_NO_DATA;
					break;
				case WHEN_NON_APPLICABLE:
					endemicity_text = WHEN_NON_APPLICABLE;
					break;
				default:
					endemicity_text = ERROR;
			}
			array[COUNTRY_ENDEMICITY_ROW][i+1] = endemicity_text;
		}
	}
	/*
		column :
		epiDE : Epidemiology Data getElement
	*/
	function fillArray(dataValues, column, epiDE, epiPKDLMCLCases) {
		/* Edidemiology table */
	
		// type of cases
		var new_cases = getValueForKey(dataValues,[CC_KEY, DE_KEY],[TYPE_NEW_CASES,epiDE], VALUE_KEY);
		var relapse = getValueForKey(dataValues,[CC_KEY, DE_KEY],[TYPE_RELAPSE,epiDE], VALUE_KEY);
		var unspecified = getValueForKey(dataValues,[CC_KEY, DE_KEY],[TYPE_UNSPECIFIED,epiDE], VALUE_KEY);
		var total_cases_type = add([new_cases, relapse, unspecified]);
		
		array[NEW_ROW][column] = new_cases;
		array[RELAPSE_ROW][column] = relapse;
		array[TOTAL_ROW][column] = total_cases_type;

		// sex distribution 
		var new_unknown = getValueForKey(dataValues, [CC_KEY, DE_KEY],[NEW_UNKNOWN, GENDER_DE[column]], VALUE_KEY);
		var uns_unknown = getValueForKey(dataValues, [CC_KEY, DE_KEY],[UNS_UNKNOWN, GENDER_DE[column]], VALUE_KEY);
		var unknown = add([new_unknown, uns_unknown]);

		var new_male = getValueForKey(dataValues, [CC_KEY, DE_KEY],[NEW_MALE, GENDER_DE[column]], VALUE_KEY);
		var uns_male = getValueForKey(dataValues, [CC_KEY, DE_KEY],[UNS_MALE, GENDER_DE[column]], VALUE_KEY);
		var male = add([new_male, uns_male]);

		var new_female = getValueForKey(dataValues, [CC_KEY, DE_KEY],[NEW_FEMALE, GENDER_DE[column]], VALUE_KEY);
		var uns_female = getValueForKey(dataValues, [CC_KEY, DE_KEY],[UNS_FEMALE, GENDER_DE[column]], VALUE_KEY);
		var female = add([new_female, uns_female]);

		array[SEX_ROW][column] = percentageText(female, add([male, female, unknown]), 0, false);
		
		//age distribution 
		var new_under_5 = getValueForKey(dataValues, [CC_KEY, DE_KEY],[NEW_UNDER_5, AGE_DE[column]], VALUE_KEY);
		var uns_under_5 = getValueForKey(dataValues, [CC_KEY, DE_KEY],[UNS_UNDER_5, AGE_DE[column]], VALUE_KEY);
		var under_5 =  add([new_under_5, uns_under_5]);

		var new_5_14 = getValueForKey(dataValues, [CC_KEY, DE_KEY],[NEW_5_14, AGE_DE[column]], VALUE_KEY);
		var uns_5_14 = getValueForKey(dataValues, [CC_KEY, DE_KEY],[UNS_5_14, AGE_DE[column]], VALUE_KEY);
		var _5_14 =  add([new_5_14, uns_5_14]);

		var new_over_14 = getValueForKey(dataValues, [CC_KEY, DE_KEY],[NEW_OVER_14, AGE_DE[column]], VALUE_KEY);
		var uns_over_14 = getValueForKey(dataValues, [CC_KEY, DE_KEY],[UNS_OVER_14, AGE_DE[column]], VALUE_KEY);
		var over_14 =  add([new_over_14, uns_over_14]);

		var new_age_unknown = getValueForKey(dataValues, [CC_KEY, DE_KEY],[NEW_AGE_UNKNOWN, AGE_DE[column]], VALUE_KEY);
		var uns_age_unknown = getValueForKey(dataValues, [CC_KEY, DE_KEY],[UNS_AGE_UNKNOWN, AGE_DE[column]], VALUE_KEY);
		var age_unknown =  add([new_age_unknown, uns_age_unknown]);

		var total_age_cases = add([under_5, _5_14, over_14, age_unknown]);

		array[AGE_ROW][column] = threePercentages(under_5, _5_14, over_14, total_age_cases);	

		//origin distribution
		var origin_autoc = add([
			getValueForKey(dataValues,[CC_KEY, DE_KEY],[ORIGIN_AUTOC_NEW, IMPORTED_DE[column]], VALUE_KEY),
			getValueForKey(dataValues,[CC_KEY, DE_KEY],[ORIGIN_AUTOC_REL, IMPORTED_DE[column]], VALUE_KEY),
			getValueForKey(dataValues,[CC_KEY, DE_KEY],[ORIGIN_AUTOC_UNS, IMPORTED_DE[column]], VALUE_KEY)
		]);
		var origin_imported = add([
			getValueForKey(dataValues,[CC_KEY, DE_KEY],[ORIGIN_IMPORT_NEW, IMPORTED_DE[column]], VALUE_KEY),
			getValueForKey(dataValues,[CC_KEY, DE_KEY],[ORIGIN_IMPORT_REL, IMPORTED_DE[column]], VALUE_KEY),
			getValueForKey(dataValues,[CC_KEY, DE_KEY],[ORIGIN_IMPORT_UNS, IMPORTED_DE[column]], VALUE_KEY)
		]);
		var origin_unknown = add([
			getValueForKey(dataValues,[CC_KEY, DE_KEY],[ORIGIN_UNKNOWN_NEW, IMPORTED_DE[column]], VALUE_KEY),
			getValueForKey(dataValues,[CC_KEY, DE_KEY],[ORIGIN_UNKNOWN_REL, IMPORTED_DE[column]], VALUE_KEY),
			getValueForKey(dataValues,[CC_KEY, DE_KEY],[ORIGIN_UNKNOWN_UNS, IMPORTED_DE[column]], VALUE_KEY)
		]);
		var total_origin_cases = add([origin_autoc, origin_imported, origin_unknown]);
		array[IMPORTED_ROW][column] = origin_imported +
									", " +
									percentageText(origin_imported, total_origin_cases, 0, false);

		// Data to retrive depending on Leish type
		switch(epiDE){
			case DE.CL_EPI_Type:
				array[FOCI_ROW][column] = getValueForKey(dataValues, DE_KEY, DE.CL_GEN_EPID_NEW_FOCUS, VALUE_KEY);
				array[OUTBK_ROW][column] = booleanToYesNo(getValueForKey(dataValues, DE_KEY, DE.CL_GEN_EPID_outbreak, VALUE_KEY));				
				break;
			case DE.ACL_EPI_Type:
				array[FOCI_ROW][column] = getValueForKey(dataValues, DE_KEY, DE.ACL_GEN_EPID_NEW_FOCUS, VALUE_KEY);
				array[OUTBK_ROW][column] = toBoolText_OpS_YNU_Numeric_129(getValueForKey(dataValues, DE_KEY, DE.ACL_GEN_EPID_outbreak, VALUE_KEY));				
				break;
			case DE.ZCL_EPI_Type:
				array[FOCI_ROW][column] = getValueForKey(dataValues, DE_KEY, DE.ZCL_GEN_EPID_NEW_FOCUS, VALUE_KEY);
				array[OUTBK_ROW][column] = toBoolText_OpS_YNU_Numeric_129(getValueForKey(dataValues, DE_KEY, DE.ZCL_GEN_EPID_outbreak, VALUE_KEY));				
				break;
			case DE.VL_EPI_Type:
				array[FOCI_ROW][column] = getValueForKey(dataValues, DE_KEY, DE.VL_GEN_EPID_NEW_FOCUS, VALUE_KEY);
				array[OUTBK_ROW][column] = booleanToYesNo(getValueForKey(dataValues, DE_KEY, DE.VL_GEN_EPID_outbreak, VALUE_KEY));				
				break;
		}

		
		/* only PKDL and MCL TODO: place that if that's true */

		if (column == PKDL_COLUMN || column == MCL_COLUMN){
			var cases = getValueForKey(dataValues, DE_KEY, epiPKDLMCLCases, VALUE_KEY);
			array[NEW_ROW][column] = cases;
			array[RELAPSE_ROW][column] = WHEN_NON_APPLICABLE;
			array[TOTAL_ROW][column] = cases;
			array[IMPORTED_ROW][column] = WHEN_NON_APPLICABLE; 

			var male = getValueForKey(dataValues, [CC_KEY, DE_KEY],[MALE, GENDER_DE[column]], VALUE_KEY);
			var female = getValueForKey(dataValues, [CC_KEY, DE_KEY],[FEMALE, GENDER_DE[column]], VALUE_KEY);
			var unknown_sex = getValueForKey(dataValues, [CC_KEY, DE_KEY],[UNKNOWN_SEX, GENDER_DE[column]], VALUE_KEY);
			var total_sex_cases = add([male, female, unknown_sex]);
			array[SEX_ROW][column] = percentageText(female, total_sex_cases, 0, false);

			var age_5 = getValueForKey(dataValues, [CC_KEY, DE_KEY],[AGE_5, AGE_DE[column]], VALUE_KEY);
			var age_5_14 = getValueForKey(dataValues, [CC_KEY, DE_KEY],[AGE_5_14, AGE_DE[column]], VALUE_KEY);
			var age_14 = getValueForKey(dataValues, [CC_KEY, DE_KEY],[AGE_14, AGE_DE[column]], VALUE_KEY);
			var age_unknown = getValueForKey(dataValues, [CC_KEY, DE_KEY],[AGE_UNKNOWN, AGE_DE[column]], VALUE_KEY);
			var total_age_cases = add([age_5, age_5_14, age_14, age_unknown]); //gPGNI7bWhDB

			array[AGE_ROW][column] = threePercentages(age_5, age_5_14, age_14, total_age_cases);	

			array[INCD_ROW][column] = WHEN_NON_APPLICABLE; 
			array[RISK_ROW][column] = WHEN_NON_APPLICABLE; 
			array[THIRD_LEVEL_ROW][column] = WHEN_NON_APPLICABLE; 
			array[OUTBK_ROW][column] = WHEN_NON_APPLICABLE; 
			array[FOCI_ROW][column] = WHEN_NON_APPLICABLE; 

		}


		/* Diagnosis table */
		
		// active and passive screening
		if (column == PKDL_COLUMN || column == MCL_COLUMN) {
			diagnosisArray[SCREENED_ACTIVELY_ROW][column] = WHEN_NON_APPLICABLE;
			diagnosisArray[SCREENED_PASSIVELY_ROW][column] = WHEN_NON_APPLICABLE;
		} else {
			var screen_active = getValueForKey(dataValues, DE_KEY, DE_SCREEN_ACTIVE[column] , VALUE_KEY);
			diagnosisArray[SCREENED_ACTIVELY_ROW][column] = screen_active;
			diagnosisArray[SCREENED_PASSIVELY_ROW][column] = screen_passive[column-1];
		}
		

		if (column == VL_COLUMN) {

			// cases diagnosed by RDT and %positive RDT
			var new_rdt = getValueForKey(dataValues,[CC_KEY, DE_KEY],[TYPE_NEW_CASES,VL_Lab_RDT_tested_type], VALUE_KEY);
			var unsp_rdt = getValueForKey(dataValues,[CC_KEY, DE_KEY],[TYPE_UNSPECIFIED, VL_Lab_RDT_tested_type], VALUE_KEY);
			var total_rdt = add([new_rdt, unsp_rdt]);

			var positive_new_rdt = getValueForKey(dataValues, [CC_KEY, DE_KEY], [POSITIVE_NEW,VL_Lab_RDT_results_type],  VALUE_KEY);
			var positive_unsp_rdt = getValueForKey(dataValues, [CC_KEY, DE_KEY], [POSITIVE_UNSP,VL_Lab_RDT_results_type],  VALUE_KEY);
			var total_positive_rdt = add([positive_new_rdt, positive_unsp_rdt]);
			
			diagnosisArray[VL_CASES_DIAGNOSED_ROW][column] = percentageCasesAndTotal(total_positive_rdt, new_and_usnp_cases[VL_INDEX], 0, true);
			diagnosisArray[POSITIVE_RDT_ROW][column] = percentageCasesAndTotal(total_positive_rdt, total_rdt, 0, true);

			// percentage of cases with HIV-VL coinfection
			var hiv_coinf_new = getValueForKey(dataValues,[CC_KEY, DE_KEY],[POSITIVE_NEW, DE.VL_LAB_HIVstatus_Type], VALUE_KEY); 
			var hiv_coinf_rel = getValueForKey(dataValues,[CC_KEY, DE_KEY],[POSITIVE_RELAPSE, DE.VL_LAB_HIVstatus_Type], VALUE_KEY); 
			var hiv_coinf_uns = getValueForKey(dataValues,[CC_KEY, DE_KEY],[POSITIVE_UNSP, DE.VL_LAB_HIVstatus_Type], VALUE_KEY); 
			var hiv_coinf_total = add([hiv_coinf_new, hiv_coinf_rel, hiv_coinf_uns]);

			diagnosisArray[HIV_COINFECTION_ROW][column] = percentageCasesAndTotal(hiv_coinf_total, total_cases_type, 0, true);
			
		} else {
			diagnosisArray[VL_CASES_DIAGNOSED_ROW][column] = WHEN_NON_APPLICABLE;
			diagnosisArray[POSITIVE_RDT_ROW][column] = WHEN_NON_APPLICABLE;
			diagnosisArray[HIV_COINFECTION_ROW][column] = WHEN_NON_APPLICABLE;
		}

		if (column == PKDL_COLUMN || column == MCL_COLUMN) {
			diagnosisArray[DIRECT_EXAM_DIAGNOSED_ROW][column] = WHEN_NON_APPLICABLE;
			diagnosisArray[POSITIVE_DIRECT_EXAM_ROW][column] = WHEN_NON_APPLICABLE;
			diagnosisArray[CLINICALLY_DIAGNOSED_ROW][column] = WHEN_NON_APPLICABLE;
		} 
		else {
		
			// Direct exam
			var direct_exam_new = getValueForKey(dataValues,[CC_KEY, DE_KEY],[TYPE_NEW_CASES, DIRECTEXAM_DE[column]], VALUE_KEY);
			var direct_exam_rel = getValueForKey(dataValues,[CC_KEY, DE_KEY],[TYPE_RELAPSE, DIRECTEXAM_DE[column]], VALUE_KEY);
			var direct_exam_uns = getValueForKey(dataValues,[CC_KEY, DE_KEY],[TYPE_UNSPECIFIED, DIRECTEXAM_DE[column]], VALUE_KEY);
			var direct_exam_total = add([direct_exam_new, direct_exam_rel, direct_exam_uns]);

			diagnosisArray[DIRECT_EXAM_DIAGNOSED_ROW][column] = percentageCasesAndTotal(direct_exam_total, total_cases_type, 0, true);

			//Positive slides
			var positive_slides_new = getValueForKey(dataValues,[CC_KEY, DE_KEY],[POSITIVE_NEW, POSITIVESLIDES_DE[column]], VALUE_KEY); 
			var positive_slides_rel = getValueForKey(dataValues,[CC_KEY, DE_KEY],[POSITIVE_RELAPSE, POSITIVESLIDES_DE[column]], VALUE_KEY); 
			var positive_slides_uns = getValueForKey(dataValues,[CC_KEY, DE_KEY],[POSITIVE_UNSP, POSITIVESLIDES_DE[column]], VALUE_KEY); 
			var positive_slides_total = add([positive_slides_new, positive_slides_rel, positive_slides_uns]);

			diagnosisArray[POSITIVE_DIRECT_EXAM_ROW][column] = percentageCasesAndTotal(positive_slides_total, direct_exam_total, 0, true);

			//Cases diagnosed clinically
			var clinical_cases_new = getValueForKey(dataValues,[CC_KEY, DE_KEY],[TYPE_NEW_CASES, LABCLINICAL_DE[column]], VALUE_KEY);
			var clinical_cases_rel = getValueForKey(dataValues,[CC_KEY, DE_KEY],[TYPE_RELAPSE, LABCLINICAL_DE[column]], VALUE_KEY);
			var clinical_cases_uns = getValueForKey(dataValues,[CC_KEY, DE_KEY],[TYPE_UNSPECIFIED, LABCLINICAL_DE[column]], VALUE_KEY);
			var clinical_cases_total = add([clinical_cases_new, clinical_cases_rel, clinical_cases_uns]);

			diagnosisArray[CLINICALLY_DIAGNOSED_ROW][column] = percentageCasesAndTotal(clinical_cases_total, total_cases_type, 0, true);
		}

		/* Treatment table */	

		if (column == VL_COLUMN || column == CL_COLUMN || column == ACL_COLUMN || column == ZCL_COLUMN){
			
			if (column == VL_COLUMN) {
				ic_new_oth =  VL_IC_NEW_OTH;
				ic_uns_oth =  VL_IC_UNS_OTH;
				ic_new_uns =  VL_IC_NEW_UNS;
				ic_uns_uns =  VL_IC_UNS_UNS;	
				fail_new_oth =  VL_FAIL_NEW_OTH;
				fail_uns_oth =  VL_FAIL_UNS_OTH;
				fail_new_uns =  VL_FAIL_NEW_UNS;
				fail_uns_uns =  VL_FAIL_UNS_UNS;	
				death_new_oth =  VL_DEATH_NEW_OTH;
				death_uns_oth =  VL_DEATH_UNS_OTH;
				death_new_uns =  VL_DEATH_NEW_UNS;
				death_uns_uns =  VL_DEATH_UNS_UNS;	
				unknown_new_oth =  VL_UNKNOWN_NEW_OTH;
				unknown_uns_oth =  VL_UNKNOWN_UNS_OTH;
				unknown_new_uns =  VL_UNKNOWN_NEW_UNS;
				unknown_uns_uns =  VL_UNKNOWN_UNS_UNS;	
			} else {
				// CL_COLUMN, ACL_COLUMN, ZCL_COLUMN
	 			ic_new_oth =  CL_IC_NEW_OTH;
				ic_uns_oth =  CL_IC_UNS_OTH;
				ic_new_uns =  CL_IC_NEW_UNS;
				ic_uns_uns =  CL_IC_UNS_UNS;	
				fail_new_oth =  CL_FAIL_NEW_OTH;
				fail_uns_oth =  CL_FAIL_UNS_OTH;
				fail_new_uns =  CL_FAIL_NEW_UNS;
				fail_uns_uns =  CL_FAIL_UNS_UNS;	
				death_new_oth =  CL_DEATH_NEW_OTH;
				death_uns_oth =  CL_DEATH_UNS_OTH;
				death_new_uns =  CL_DEATH_NEW_UNS;
				death_uns_uns =  CL_DEATH_UNS_UNS;
				unknown_new_oth =  CL_UNKNOWN_NEW_OTH;
				unknown_uns_oth =  CL_UNKNOWN_UNS_OTH;
				unknown_new_uns =  CL_UNKNOWN_NEW_UNS;
				unknown_uns_uns =  CL_UNKNOWN_UNS_UNS;	
			}


			var ic_new_amb = getValueForKey(dataValues,[CC_KEY, DE_KEY],[IC_NEW_AMB, ITxO_DRUG_DE[column]], VALUE_KEY);
            var ic_uns_amb = getValueForKey(dataValues,[CC_KEY, DE_KEY],[IC_UNS_AMB, ITxO_DRUG_DE[column]], VALUE_KEY);
			var ic_new_glu = getValueForKey(dataValues,[CC_KEY, DE_KEY],[IC_NEW_GLU, ITxO_DRUG_DE[column]], VALUE_KEY);
            var ic_uns_glu = getValueForKey(dataValues,[CC_KEY, DE_KEY],[IC_UNS_GLU, ITxO_DRUG_DE[column]], VALUE_KEY);
            var ic_new_pen = getValueForKey(dataValues,[CC_KEY, DE_KEY],[IC_NEW_PEN, ITxO_DRUG_DE[column]], VALUE_KEY);
            var ic_uns_pen = getValueForKey(dataValues,[CC_KEY, DE_KEY],[IC_UNS_PEN, ITxO_DRUG_DE[column]], VALUE_KEY);
			var ic_new_ssg = getValueForKey(dataValues,[CC_KEY, DE_KEY],[IC_NEW_SSG, ITxO_DRUG_DE[column]], VALUE_KEY);
            var ic_uns_ssg = getValueForKey(dataValues,[CC_KEY, DE_KEY],[IC_UNS_SSG, ITxO_DRUG_DE[column]], VALUE_KEY);
            var ic_new_ssg_paro = getValueForKey(dataValues,[CC_KEY, DE_KEY],[IC_NEW_SSG_PARO, ITxO_DRUG_DE[column]], VALUE_KEY);
            var ic_uns_ssg_paro = getValueForKey(dataValues,[CC_KEY, DE_KEY],[IC_UNS_SSG_PARO, ITxO_DRUG_DE[column]], VALUE_KEY);
            var ic_new_oth_t = getValueForKey(dataValues,[CC_KEY, DE_KEY],[ic_new_oth, ITxO_DRUG_DE[column]], VALUE_KEY);
            var ic_uns_oth_t = getValueForKey(dataValues,[CC_KEY, DE_KEY],[ic_uns_oth, ITxO_DRUG_DE[column]], VALUE_KEY);
            var ic_new_uns_t = getValueForKey(dataValues,[CC_KEY, DE_KEY],[ic_new_uns, ITxO_DRUG_DE[column]], VALUE_KEY);
			var ic_uns_uns_t = getValueForKey(dataValues,[CC_KEY, DE_KEY],[ic_uns_uns, ITxO_DRUG_DE[column]], VALUE_KEY);
		
			total_ic = add([ic_new_amb, ic_uns_amb,
								ic_new_glu, ic_uns_glu,
								ic_new_pen, ic_uns_pen,
								ic_new_ssg, ic_uns_ssg,
								ic_new_ssg_paro, ic_uns_ssg_paro,
								ic_new_oth_t, ic_uns_oth_t,
								ic_new_uns_t, ic_uns_uns_t]);


			var fail_new_amb = getValueForKey(dataValues,[CC_KEY, DE_KEY],[FAIL_NEW_AMB, ITxO_DRUG_DE[column]], VALUE_KEY);
            var fail_uns_amb = getValueForKey(dataValues,[CC_KEY, DE_KEY],[FAIL_UNS_AMB, ITxO_DRUG_DE[column]], VALUE_KEY);
			var fail_new_glu = getValueForKey(dataValues,[CC_KEY, DE_KEY],[FAIL_NEW_GLU, ITxO_DRUG_DE[column]], VALUE_KEY);
            var fail_uns_glu = getValueForKey(dataValues,[CC_KEY, DE_KEY],[FAIL_UNS_GLU, ITxO_DRUG_DE[column]], VALUE_KEY);
            var fail_new_pen = getValueForKey(dataValues,[CC_KEY, DE_KEY],[FAIL_NEW_PEN, ITxO_DRUG_DE[column]], VALUE_KEY);
            var fail_uns_pen = getValueForKey(dataValues,[CC_KEY, DE_KEY],[FAIL_UNS_PEN, ITxO_DRUG_DE[column]], VALUE_KEY);
			var fail_new_ssg = getValueForKey(dataValues,[CC_KEY, DE_KEY],[FAIL_NEW_SSG, ITxO_DRUG_DE[column]], VALUE_KEY);
            var fail_uns_ssg = getValueForKey(dataValues,[CC_KEY, DE_KEY],[FAIL_UNS_SSG, ITxO_DRUG_DE[column]], VALUE_KEY);
            var fail_new_ssg_paro = getValueForKey(dataValues,[CC_KEY, DE_KEY],[FAIL_NEW_SSG_PARO, ITxO_DRUG_DE[column]], VALUE_KEY);
            var fail_uns_ssg_paro = getValueForKey(dataValues,[CC_KEY, DE_KEY],[FAIL_UNS_SSG_PARO, ITxO_DRUG_DE[column]], VALUE_KEY);
            var fail_new_oth_t = getValueForKey(dataValues,[CC_KEY, DE_KEY],[fail_new_oth, ITxO_DRUG_DE[column]], VALUE_KEY);
            var fail_uns_oth_t = getValueForKey(dataValues,[CC_KEY, DE_KEY],[fail_uns_oth, ITxO_DRUG_DE[column]], VALUE_KEY);
            var fail_new_uns_t = getValueForKey(dataValues,[CC_KEY, DE_KEY],[fail_new_uns, ITxO_DRUG_DE[column]], VALUE_KEY);
            var fail_uns_uns_t = getValueForKey(dataValues,[CC_KEY, DE_KEY],[fail_uns_uns, ITxO_DRUG_DE[column]], VALUE_KEY);

			total_fail = add([fail_new_amb, fail_uns_amb,
								fail_new_glu, fail_uns_glu,
								fail_new_pen, fail_uns_pen,
								fail_new_ssg, fail_uns_ssg,
								fail_new_ssg_paro, fail_uns_ssg_paro,
								fail_new_oth_t, fail_uns_oth_t,
								fail_new_uns_t, fail_uns_uns_t]);


			var death_new_amb = getValueForKey(dataValues,[CC_KEY, DE_KEY],[DEATH_NEW_AMB, ITxO_DRUG_DE[column]], VALUE_KEY);
            var death_uns_amb = getValueForKey(dataValues,[CC_KEY, DE_KEY],[DEATH_UNS_AMB, ITxO_DRUG_DE[column]], VALUE_KEY);
			var death_new_glu = getValueForKey(dataValues,[CC_KEY, DE_KEY],[DEATH_NEW_GLU, ITxO_DRUG_DE[column]], VALUE_KEY);
            var death_uns_glu = getValueForKey(dataValues,[CC_KEY, DE_KEY],[DEATH_UNS_GLU, ITxO_DRUG_DE[column]], VALUE_KEY);
            var death_new_pen = getValueForKey(dataValues,[CC_KEY, DE_KEY],[DEATH_NEW_PEN, ITxO_DRUG_DE[column]], VALUE_KEY);
            var death_uns_pen = getValueForKey(dataValues,[CC_KEY, DE_KEY],[DEATH_UNS_PEN, ITxO_DRUG_DE[column]], VALUE_KEY);
			var death_new_ssg = getValueForKey(dataValues,[CC_KEY, DE_KEY],[DEATH_NEW_SSG, ITxO_DRUG_DE[column]], VALUE_KEY);
            var death_uns_ssg = getValueForKey(dataValues,[CC_KEY, DE_KEY],[DEATH_UNS_SSG, ITxO_DRUG_DE[column]], VALUE_KEY);
            var death_new_ssg_paro = getValueForKey(dataValues,[CC_KEY, DE_KEY],[DEATH_NEW_SSG_PARO, ITxO_DRUG_DE[column]], VALUE_KEY);
            var death_uns_ssg_paro = getValueForKey(dataValues,[CC_KEY, DE_KEY],[DEATH_UNS_SSG_PARO, ITxO_DRUG_DE[column]], VALUE_KEY);
            var death_new_oth_t = getValueForKey(dataValues,[CC_KEY, DE_KEY],[death_new_oth, ITxO_DRUG_DE[column]], VALUE_KEY);
            var death_uns_oth_t = getValueForKey(dataValues,[CC_KEY, DE_KEY],[death_uns_oth, ITxO_DRUG_DE[column]], VALUE_KEY);
            var death_new_uns_t = getValueForKey(dataValues,[CC_KEY, DE_KEY],[death_new_uns, ITxO_DRUG_DE[column]], VALUE_KEY);
            var death_uns_uns_t = getValueForKey(dataValues,[CC_KEY, DE_KEY],[death_uns_uns, ITxO_DRUG_DE[column]], VALUE_KEY);
			
			total_death = add([death_new_amb, death_uns_amb,
								death_new_glu, death_uns_glu,
								death_new_pen, death_uns_pen,
								death_new_ssg, death_uns_ssg,
								death_new_ssg_paro, death_uns_ssg_paro,
								death_new_oth_t, death_uns_oth_t,
								death_new_uns_t, death_uns_uns_t]);


			toutcomeArray[PROPORTION_TREATED_CASES_ROW][column] = percentageCasesAndTotal(total_treated[column-1], new_and_usnp_cases[column-1], 0, true);
			toutcomeArray[INITIAL_CURE_RATE_ROW][column] = percentageCasesAndTotal(total_ic, new_and_usnp_cases[column-1], 0, true);
			toutcomeArray[FAILURE_RATE_ROW][column] = percentageCasesAndTotal(total_fail, new_and_usnp_cases[column-1], 0, true);
			toutcomeArray[CASE_FATALITY_ROW][column] = percentageCasesAndTotal(total_death, new_and_usnp_cases[column-1], 0, true);

		}

	}

	function update_map_levels_var(min, max){

		map_levels = [];
		for(var i = min; i<=max; i++){
			map_levels.push(i);
		}
	}

	

	/****************************************************************************************************
 	 **********                     		 AUXILIARY FUNCTIONS          	    		       **********
	 ****************************************************************************************************/

	function fillControlAndSurveillance(dataValues){
		controlArray[CAS_ROW_LNCP][1] = getValueForKey(dataValues, DE_KEY, Leish_GEN_LNCP_year, VALUE_KEY); 
		controlArray[CAS_ROW_TYPE][1] =  toBoolText_OpS_Leish_SurvType(getValueForKey(dataValues, DE_KEY, CL_GEN_Surv_Type, VALUE_KEY)) +
											TWO_VALUES_SEPARATOR +
											toBoolText_OpS_Leish_SurvType(getValueForKey(dataValues, DE_KEY, VL_GEN_Surv_Type, VALUE_KEY)); 
		controlArray[CAS_ROW_PROGRAMME][1] = toBoolText_OpS_YNU_Numeric_129(getValueForKey(dataValues, DE_KEY, Leish_GEN_VectorControl, VALUE_KEY)); 
		controlArray[CAS_ROW_IRS][1] = getValueForKey(dataValues, DE_KEY, Leish_GEN_VectorControl_Insecticide, VALUE_KEY); 
		controlArray[CAS_ROW_NOTIF][1] = toBoolText_OpS_YNU_Numeric_129(getValueForKey(dataValues, DE_KEY, CL_GEN_Surv_Notif, VALUE_KEY)) +
											TWO_VALUES_SEPARATOR +
											toBoolText_OpS_YNU_Numeric_129(getValueForKey(dataValues, DE_KEY, VL_GEN_Surv_Notif, VALUE_KEY)); 
		controlArray[CAS_ROW_GUIDELINES][1] = getValueForKey(dataValues, DE_KEY, CL_GEN_Guidelines_year, VALUE_KEY) +
											TWO_VALUES_SEPARATOR +
											getValueForKey(dataValues, DE_KEY, VL_GEN_Guidelines_year, VALUE_KEY); 
		controlArray[CAS_ROW_RESER][1] = toBoolText_OpS_YNU_Numeric_129(getValueForKey(dataValues, DE_KEY, Leish_GEN_ReservoirControl, VALUE_KEY)); 
		controlArray[CAS_ROW_FACIL][1] = getValueForKey(dataValues, DE_KEY, CL_GEN_Surv_HF, VALUE_KEY) +
											TWO_VALUES_SEPARATOR +
											getValueForKey(dataValues, DE_KEY, VL_GEN_Surv_HF, VALUE_KEY);
	}
	
	function fillTreatmentAndMedicines(dataValues){
		tamArray[TAM_ROW_FREEOFCHARGE][1] =  toBoolText_OpS_YNU_Numeric_129(getValueForKey(dataValues, DE_KEY, CL_GEN_TxFree, VALUE_KEY)) +
											TWO_VALUES_SEPARATOR +
											toBoolText_OpS_YNU_Numeric_129(getValueForKey(dataValues, DE_KEY, VL_GEN_TxFree, VALUE_KEY));

		
		
		var eml_string = "";
		for (var i = EML_MIN; i<=EML_MAX; i++) {
			if ( booleanToTrueFalse(getValueForKey(dataValues, DE_KEY, EML[i].ID, VALUE_KEY), DEFAULT_FALSE)) {
				eml_string += EML[i].NAME + EML_LIST_SEPARATOR;
			}
		}
		if (eml_string.length > 0 ){
			eml_string = eml_string.slice(0, -2);
		} else {
			eml_string = EML_NONE;
		}

		tamArray[TAM_ROW_EML][1] = eml_string;

	}

	function fillCountryGeneralInformation(data){

		var dataValues = data.dataValues;

		// gets population in miles, transforms it in units and adds local separators
		var popIn1000 = getValueForKey(dataValues, [DE_KEY, CC_KEY], [DE_CGI.GEN_UN_WPP_Pop_Tot_1000, CC_DEFAULT], VALUE_KEY);
		totalPopulation = parseInt(popIn1000) * 1000 ;
		generalInformationArray[CIG_ROW_POP][1] = (totalPopulation || WHEN_NO_DATA).toLocaleString();

		// gets all population age slices and adds its by sex 
		var popm = 0, popf = 0;
		for (var i = Y_UNDER_5; i<= Y100_AND_OVER; i++ ) {
			popf = add([popf, getValueForKey(dataValues, [DE_KEY, CC_KEY], [DE_CGI.GEN_UN_WPP_Pop_Tot_AgeSex_1000, CC_CGI[i][CGI_FEMALE]], VALUE_KEY)]);
			popm = add([popm, getValueForKey(dataValues, [DE_KEY, CC_KEY], [DE_CGI.GEN_UN_WPP_Pop_Tot_AgeSex_1000, CC_CGI[i][CGI_MALE]], VALUE_KEY)]);
		}
		console.log( "popf " + popf);
		console.log( "popm " + popm);
		generalInformationArray[CIG_ROW_SEX][1] = (percentageText(popf, totalPopulation, 1, false) || WHEN_NO_DATA) + " / " + (percentageText(popm, totalPopulation, 1, false) || WHEN_NO_DATA);

		// gets GDP
		generalInformationArray[CIG_ROW_GDP][1] = getValueForKey(dataValues, [DE_KEY, CC_KEY], [DE_CGI.GEN_WB_GDP_PPP_current, CC_DEFAULT], VALUE_KEY);
		
		// gets income group codes to show code rather than a number
		var ressource = "dataElements/"+DE_CGI.GEN_WB_IncomeGroup;
		var fields = "optionSet[options[name,code]]";
		$.when(get(ressource,fields)).done(function(result){
			console.log(result);
			var incomeCode = getValueForKey(dataValues, [DE_KEY, CC_KEY], [DE_CGI.GEN_WB_IncomeGroup, CC_DEFAULT], VALUE_KEY);
			var incomeName = getValueForKey(result.optionSet.options, CODE_KEY, incomeCode, NAME_KEY);
			generalInformationArray[CIG_ROW_INCOME][1] = incomeName;
		});
		
		// calculates 
		var pop_under15 = 0, pop_over15 = 0;
		for (var i = Y_UNDER_5; i<= Y10_14; i++ ) {
			pop_under15 = add([pop_under15, 
					getValueForKey(dataValues, [DE_KEY, CC_KEY], [DE_CGI.GEN_UN_WPP_Pop_Tot_AgeSex_1000, CC_CGI[i][CGI_FEMALE]], VALUE_KEY),
					getValueForKey(dataValues, [DE_KEY, CC_KEY], [DE_CGI.GEN_UN_WPP_Pop_Tot_AgeSex_1000, CC_CGI[i][CGI_MALE]], VALUE_KEY),
					getValueForKey(dataValues, [DE_KEY, CC_KEY], [DE_CGI.GEN_UN_WPP_Pop_Tot_AgeSex_1000, CC_CGI[i][CGI_GENDER_UNKNOWN]], VALUE_KEY),
							]);
		}
		for (var i = Y15_19; i<= Y100_AND_OVER; i++ ) {
			pop_over15 = add([pop_over15, 
					getValueForKey(dataValues, [DE_KEY, CC_KEY], [DE_CGI.GEN_UN_WPP_Pop_Tot_AgeSex_1000, CC_CGI[i][CGI_FEMALE]], VALUE_KEY),
					getValueForKey(dataValues, [DE_KEY, CC_KEY], [DE_CGI.GEN_UN_WPP_Pop_Tot_AgeSex_1000, CC_CGI[i][CGI_MALE]], VALUE_KEY),
					getValueForKey(dataValues, [DE_KEY, CC_KEY], [DE_CGI.GEN_UN_WPP_Pop_Tot_AgeSex_1000, CC_CGI[i][CGI_GENDER_UNKNOWN]], VALUE_KEY),
							]);
		}
		console.log( "pop_under15 " + pop_under15);
		console.log( "pop_over15 " + pop_over15);
		generalInformationArray[CIG_ROW_AGEG][1] = (percentageText(pop_under15, totalPopulation, 1, false) || WHEN_NO_DATA) + " / " + (percentageText(pop_over15, totalPopulation, 1, false)  || WHEN_NO_DATA);

		generalInformationArray[CIG_ROW_LIFE][1] = getValueForKey(dataValues, [DE_KEY, CC_KEY], [DE_CGI.GEN_UN_WPP_LifeExpBirth_Female, CC_DEFAULT], VALUE_KEY) +  
													" / " +
													getValueForKey(dataValues, [DE_KEY, CC_KEY], [DE_CGI.GEN_UN_WPP_LifeExpBirth_Male, CC_DEFAULT], VALUE_KEY)	;

		setOptionSelectMenu("subnationalLevelSelector", defaultSubnationalLevel);
		return updateNumberOfDivisions(defaultSubnationalLevel); // so it waits to have the information
	}

	// updates 
	function updateNumberOfDivisions(subNationalLevel){

		return $.when(getNumberOfDivisionsFor(ds.countryID, (subNationalLevel), "name"),
					get_subnational_endemicity_for(SUBN_ENDEMCTY, ds.year, subNationalLevel, SUB_ENDEMICITY.ACL, ACL_COLUMN),
					get_subnational_endemicity_for(SUBN_ENDEMCTY, ds.year, subNationalLevel, SUB_ENDEMICITY.ZCL, ZCL_COLUMN),
					get_subnational_endemicity_for(SUBN_ENDEMCTY, ds.year, subNationalLevel, SUB_ENDEMICITY.CL, CL_COLUMN),
					get_subnational_endemicity_for(SUBN_ENDEMCTY, ds.year, subNationalLevel, SUB_ENDEMICITY.VL, VL_COLUMN))	
				.done(function(result){
					var numberOfDivisions = result.organisationUnits.length;
					var aDivisionName = result.organisationUnits[0].name;
					generalInformationArray[CIG_ROW_DIVIS][0] = LEVEL_REPORT_LABELS[subNationalLevel];
					generalInformationArray[CIG_ROW_DIVIS][1] = numberOfDivisions + ", " + aDivisionName;

					// updates endemicity text at epi table
					array[THIRD_LEVEL_ROW][0] = ENDEMIC_SUBN_LEVEL_LABELS[subNationalLevel];

				}).fail(function(result, aaaaa,bbbb,cccc,ddd,eee,ffff,ggg,hhh){
					console.log("ERRROR");
					console.log(result);
					return true;
				});

	}

		

	function reOrderLegendSet(legendSet) {
		if (legendSet.length <= 1) {
			return legendSet;
		} else {
			var temp;
			for(var i=1; i<legendSet.length; i++){
				if(legendSet[0].startValue + legendSet[0].endValue > legendSet[i].startValue + legendSet[i].endValue){
					temp = legendSet[i];
					legendSet[i] = legendSet[0];
					legendSet[0] = temp;
				}
			}
			return legendSet.slice(0,1).concat(reOrderLegendSet(legendSet.slice(1,legendSet.length)));
		}
	}

	/* return a text about publishing date with the current month and year*/
	function getDatePublished(){
		var d = new Date();
    	var thisMonth = d.getMonth();
		var thisYear = d.getFullYear();
		return PUBLISHED_TEXT+" "+MONTHS[thisMonth]+" "+thisYear;
	}
	/*
		linesOnRows : An array with the number of the rows which must have a line below
	*/
	function writeTable(tableName, extName, array, linesOnRows) {
		// declare html variable (a string holder):
		var html = '';
		var count = 0;

		var lineClass = "";
		for (var i = 0; i < array.length; i++) {
			if (linesOnRows[i]){
				lineClass = BOTTOM_LINE_CLASS;
			} else {
				lineClass ="";
			}
			// add opening <tr> tag to the string:
			html += '<tr id="'+tableName+i+'" class="'+lineClass+'">';
			for (var j = 0; j < array[i].length; j++) {
				// add <td> elements to the string:
				html += '<td>' + '<span class="'+CLASS_FOOTNOTABLE_ELEMENT+' '+CLASS_EDITABLE_ELEMENT+'" >' + array[i][j] + '</span>' + '</td>';
				count++;
			}
			// add closing </tr> tag to the string:
			html += '</tr>';
		}
		//append created html to the table body:
	
		document.getElementById(tableName + extName).innerHTML = html;

		// reset the count:
		count = 0;
	}


	/* Fills and ul list jquery html object with the elements of the array

		htmlObjectName: the name of the HTML object
		array: a one dimension javascript array
		classes: a string with the classes to add to li elemenets separated by spaces
	*/
    function fillHTMLListWithArray(htmlObjectName, array, classes){
        var html = '';
		for (var i=0; i<array.length; i++){
			html+='<li class="'+classes+'">'
			html+= array[i];
			html+= '</li>';
		}
		document.getElementById(htmlObjectName).innerHTML = html;

    }
	

	function makeElementsEditables(){
			// Avoid to show menu
		$(document).bind("contextmenu", "." + CLASS_EDITABLE_ELEMENT, function(e) {
			editingElement = e.target;
			editor.jqteVal(editingElement.outerHTML);
			dialog.dialog( "option", "position", { my: "left top", at: "center bottom+10%", of: editingElement } );	
			dialog.dialog( "open" );	

			return false;

		});
	}
   /**
	* removes all footnotes marks and footNotedElement class from parent
	* and restarts footNoteCounter
	*/
	function removeAllFootnotesMarks(){
		$('[id^="footNoteNumber"]').each(function (index, value) {
			$(this).parent().toggleClass('footNotedElement');
			$(this).remove();
		});
		footNoteCounter = 0;

	}
	
	function makeElementsFootnotables(){
		$(document).on("click", "." + CLASS_FOOTNOTABLE_ELEMENT, function(e) {
			if ($(this).hasClass('footNotedElement')) {
					var element = $('#footNoteNumber' + footNoteCounter ); // will return element
					if ($(this).children().attr("id")===element.attr("id")) {  // Check if trying to remove last element
						element[0].parentNode.removeChild(element[0]); // will remove the element from DOM
						footNoteCounter--;
						$(this).toggleClass('footNotedElement');
					}

				} else {
					footNoteCounter++;
					$(this).append("<span id='footNoteNumber"+footNoteCounter+"' class='superindex'>"+footNoteCounter+"</span>");
					$(this).toggleClass('footNotedElement');
				}

				event.preventDefault();
		});
	}

	function numberToTwoDigits( number){
		return ("0" + number).slice(-2);
	}

	 /**
     * dataObject is an object with arrays headers and rows.
	 * 	headers containing at least two objects with a "name" property having values "pe" and "value"
	 */
	function getAnalyticValueForKey(dataObject, mode){
		periodColumn = 0;
		valueColumn = 0;
		dxColumn = 0;

		for (var j=0;j<dataObject.headers.length;j++){
			if(dataObject.headers[j].name==="pe"){
				periodColumn = j;
			}
			if(dataObject.headers[j].name==="value"){
				valueColumn = j;
			}			
			if(dataObject.headers[j].name==="dx"){
				dxColumn = j;
			}
		}
		var returnValues = new Array(historicLength);

		switch(mode){
			case YEARLY_MODE:
				for (var i=0; i<dataObject.rows.length; i++){
					returnValues[ds.year-dataObject.rows[i][periodColumn]] = dataObject.rows[i][valueColumn];
				}
				break;
			case MONTHLY_MODE:
				for (var i=0; i<dataObject.rows.length; i++){
					returnValues[parseInt(dataObject.rows[i][periodColumn].slice(-2))] = dataObject.rows[i][valueColumn];
				}
				break;
		}
		return returnValues;
	}


	/* 	Searchs for a custom value for a customKey with a custom value through an array
			array : the array
			keyName : the name (or an array of) of the key to check
			keyValue : the target (or an array of) value of the keyName
			valueName : the name of the key of the value to return
	*/
	function getValueForKey(array, keyName, keyValue, valueName){
		var returnValue = WHEN_UNDEFINED;
		if (array === undefined){
			return returnValue;
		}
		if (typeof keyName === 'string') {
			// checks if DE or COD is assigned to one DS or P
			if ((keyName == DE_KEY && de_assigned.filter(obj => { return obj[0] === keyValue}).length == 0) ||
			 	(keyName == CC_KEY && coc_assigned.filter(obj => { return obj[0] === keyValue}).length == 0))
			{
				return WHEN_NON_APPLICABLE;
			} else {
				// one property check
				$.each( array, function( index, object ) {
					if(object[keyName]===keyValue){
						returnValue = object[valueName];
						return false;
					} 
				});
			}
		} else if (keyName.length > 1 && keyValue.length > 1) {
			// checks if DE is assigned
			if ((keyName[0] == DE_KEY && de_assigned.filter(obj => { return obj[0] === keyValue[0]}).length == 0) || 
				(keyName[1] == DE_KEY && de_assigned.filter(obj => { return obj[0] === keyValue[1]}).length == 0) || 
				(keyName[0] == CC_KEY && coc_assigned.filter(obj => { return obj[0] === keyValue[0]}).length == 0) || 
				(keyName[1] == CC_KEY && coc_assigned.filter(obj => { return obj[0] === keyValue[1]}).length == 0))
			{
				return WHEN_NON_APPLICABLE;
			} else {
				// two properties check  // not used
				$.each( array, function( index, object ) {
					if(object[keyName[0]]===keyValue[0] && object[keyName[1]]===keyValue[1]){
						returnValue = object[valueName];
						return false;
					} 
				});
			}
		} else {
			console.log('ERROR in ' + arguments.callee.name);
			return 'ERROR in ' + arguments.callee.name ;
		}
		
		return returnValue;
	}

		/* 	Searchs for a custom value for a customKey with a custom value through an array
			array : the array
			keyName : the name (or an array of) of the key to check
			keyValue : the target (or an array of) alue of the keyName
			valueName : the name of the key of the value to return
	*/
	function getValuesForKeyByMonth(array, keyName, keyValue, valueName){
		var returnValue =  new Array(12); // Void array of size 12
		if (array === undefined){
			return returnValue;
		}

		var index, period;
		if (typeof keyName === 'string') {
			// one property check
			$.each( array, function( index, object ) {
				if(object[keyName]===keyValue){
					period = object[PERIOD_KEY];
					index = Number(period.slice(period.length-2, period.length)) - 1;
					returnValue[index] = object[valueName];
				} 
			});
		} else if (keyName.length > 1 && keyValue.length > 1) {
			// two properties check
			$.each( array, function( index, object ) {
				if(object[keyName[0]]===keyValue[0] && object[keyName[1]]===keyValue[1]){
					period = object[PERIOD_KEY];
					index = Number(period.slice(period.length-2, period.length)) - 1;
					returnValue[index] = object[valueName];
				} 
			});
		} else {
			console.log('ERROR in ' + arguments.callee.name);
			return 'ERROR in ' + arguments.callee.name ;
		}
		return returnValue;
	}


	/*	Returns three percentages with no decimals, between parenthesis

	*/
	function threePercentages(cases1, cases2, cases3, total){
		cases1 = parseInt(cases1) || cases1; // converts to int if possible
		cases2 = parseInt(cases2) || cases2; // converts to int if possible
		cases3 = parseInt(cases3) || cases3; // converts to int if possible

		if (total === WHEN_UNDEFINED || total === WHEN_NON_APPLICABLE || total === undefined){
			return total || WHEN_UNDEFINED;
		} else {
			if ((cases1 === WHEN_UNDEFINED || cases1 === WHEN_NON_APPLICABLE || cases1 === undefined) &&
				(cases2 === WHEN_UNDEFINED || cases2 === WHEN_NON_APPLICABLE || cases2 === undefined) &&
				(cases3 === WHEN_UNDEFINED || cases3 === WHEN_NON_APPLICABLE || cases3 === undefined))
			{	
				return cases1 || cases2 || cases3 || WHEN_UNDEFINED;
			}
			else if (cases1 + cases2 + cases3 != total){
				return 	"(" + 
							percentageText(cases1, total, 0, false) + ", " +
							percentageText(cases2, total, 0, false) + ", " +
							percentageText(cases3, total, 0, false) + ")" + ". WARN. Original values do not add up to total.";
			}
			else {

				var dataset = [cases1/total*100, cases2/total*100, cases3/total*100];
				var percentages100 = largestRemainderRound(dataset, 100);
				
				return 	"(" + 
							percentageText(percentages100[0], 100, 0, false) + ", " +
							percentageText(percentages100[1], 100, 0, false) + ", " +
							percentageText(percentages100[2], 100, 0, false) + ")";

			}
		}
	}



	


	/*	Returns a percentage with no decimals, the #cases and the total between parenthesis

	*/
	function percentageCasesAndTotal(numerator, denominator, precision, percentageSymbol){

		if (numerator === WHEN_NON_APPLICABLE  ||
			denominator === WHEN_NON_APPLICABLE) {
			return WHEN_NON_APPLICABLE;
		}
		else if (numerator === WHEN_UNDEFINED || numerator === undefined ||
			denominator === WHEN_UNDEFINED || denominator === undefined) {
			return WHEN_UNDEFINED;
		}
		else {
			return 	percentageText(numerator, denominator, precision, percentageSymbol) + "  (" +
			numerator + " / " + denominator + ")";
		}
	}

	/*	Returns a percentage with no decimals 
			    or the numerator if cannot be converted to number. e.g. if it's a string
	*/
	function percentageText(numerator, denominator, precision, percentageSymbol){
		var multiplier = Math.pow(10, precision || 0);
		var prctgText = percentageSymbol ? "%" : "";

		if (isNaN(numerator)){
			return numerator; // It's not a number. Return numerator
		} else if (denominator === 0 || isNaN(denominator)){
			return WHEN_DIV_0;
		} else if (denominator === WHEN_UNDEFINED){
			return WHEN_UNDEFINED;
		}
		return Math.round((numerator / denominator) * 100 * multiplier) /  multiplier + prctgText;
	}

	/* Returns the addition of the elements of the array if they are not 
	*/
	function add(arrayOfNumbers){
		var addition = 0;
		var counter = 0;
		var error = "";
		for (var number of arrayOfNumbers) {
			if (typeof number !== "undefined" && number != WHEN_UNDEFINED && number != WHEN_NON_APPLICABLE){
				addition = addition + Number(number);
				counter++;
			} else {
				error = number || WHEN_UNDEFINED;
			}
		}
		if (error.length != 0 && counter == 0){
			return error;
		} else {
			return addition;
		}
	}

	/** Creates a 2 dimension array with labels.
		rowsNum: Length of first array dimension (number of rows)
		rowsTitles : labels for 
		mode : the place for labels in array. Options : LABELS_ON_COLUMNS or LABELS_ON_ROWS
	*/
	function  create_2_dim_array(rowsNum, rowsTitles, mode) {
		var array = [];
		
		if(mode === LABELS_ON_ROWS) {
			array[0] = [];
			for(var i = 0; i<rowsTitles.length; i++){
				array[0][i] = rowsTitles[i];
			}
			for(var i = 1; i<rowsNum; i++){
				array[i] = [];
			}
		} else {
			for(var i = 0; i<rowsNum; i++){
				array[i] = [];
				array[i][0] = rowsTitles[i];
			}
		}
		return array;
	}

	function hideNoRelevantContent(){
		// checked by default, trigger click for desactivate and for fire behaviour.

		// deactivates CL content if no CL dataset is assigned to the country
		if (!dsinfo[CL_DETAILED][ASSG] && !dsinfo[CL_DETAILED][ASSG]){
			$('#'+LEISH_COLUMN_DETAIL_PREFIX+BUTTON_PREFIX+(CL_COLUMN-1)).trigger('click');

			$('#'+MONTHLY_TABLE_NAME+BUTTON_PREFIX+CL_ROW).trigger('click');

			// CL charts
			$('#'+CHART_PREFIX+BUTTON_PREFIX+"0").trigger('click');
			$('#'+CHART_PREFIX+BUTTON_PREFIX+"3").trigger('click');
			$('#'+MAP_PREFIX+BUTTON_PREFIX+ CL_INDEX ).trigger('click');
		}

		// deactivates VL content if no VL dataset is assigned to the country
		if (!dsinfo[VL_DETAILED][ASSG] && !dsinfo[VL_SIMPLE][ASSG]){
			$('#'+LEISH_COLUMN_DETAIL_PREFIX+BUTTON_PREFIX+(VL_COLUMN-1)).trigger('click');

			$('#'+MONTHLY_TABLE_NAME+BUTTON_PREFIX+VL_ROW).trigger('click');//.prop('checked', false);
			$('#'+CHART_PREFIX+BUTTON_PREFIX+"2").trigger('click');
			$('#'+CHART_PREFIX+BUTTON_PREFIX+"5").trigger('click');
			$('#'+MAP_PREFIX+BUTTON_PREFIX+ VL_INDEX ).trigger('click');
		}

		// deactivates AZCL content if no AZCL dataset is assigned to the country
		if (!dsinfo[AZCL_DETAILED][ASSG] && !dsinfo[AZCL_SIMPLE][ASSG]){
			$('#'+LEISH_COLUMN_DETAIL_PREFIX+BUTTON_PREFIX+(ACL_COLUMN-1)).trigger('click');
			$('#'+LEISH_COLUMN_DETAIL_PREFIX+BUTTON_PREFIX+(ZCL_COLUMN-1)).trigger('click');

			$('#'+MONTHLY_TABLE_NAME+BUTTON_PREFIX+ACL_ROW).trigger('click');
			$('#'+MONTHLY_TABLE_NAME+BUTTON_PREFIX+ZCL_ROW).trigger('click');
			
			$('#'+CHART_PREFIX+BUTTON_PREFIX+"1").trigger('click');
			$('#'+CHART_PREFIX+BUTTON_PREFIX+"4").trigger('click');
			$('#'+MAP_PREFIX+BUTTON_PREFIX+ ACL_INDEX ).trigger('click');
			$('#'+MAP_PREFIX+BUTTON_PREFIX+ ZCL_INDEX ).trigger('click');

		}

		updateMapsTitle();

		// PKDL and MCL always deactivated
		$('#'+LEISH_COLUMN_DETAIL_PREFIX+BUTTON_PREFIX+(PKDL_COLUMN-1)).trigger('click');
		$('#'+LEISH_COLUMN_DETAIL_PREFIX+BUTTON_PREFIX+(MCL_COLUMN-1)).trigger('click');
		
		// Monthly previous year rows, always deactivated by default
		$('#'+MONTHLY_TABLE_NAME+BUTTON_PREFIX+VL_PREVIOUS_YEAR_ROW).trigger('click');//.prop('checked', false);
		$('#'+MONTHLY_TABLE_NAME+BUTTON_PREFIX+CL_PREVIOUS_YEAR_ROW).trigger('click');//.prop('checked', false);
		$('#'+MONTHLY_TABLE_NAME+BUTTON_PREFIX+ACL_PREVIOUS_YEAR_ROW).trigger('click');//.prop('checked', false);
		$('#'+MONTHLY_TABLE_NAME+BUTTON_PREFIX+ZCL_PREVIOUS_YEAR_ROW).trigger('click');//.prop('checked', false);

		$(':checkbox').button( "refresh" );

	}

	function updateMapsTitle(){
		var text = [];
		var separator = " and ";


		if ($('#'+MAP_PREFIX+BUTTON_PREFIX+ ZCL_INDEX ).prop( "checked")){
			text.push(COLUMNS_LABELS[ZCL_INDEX]);
			text.push(separator);
			separator = ", ";
		}
		if ($('#'+MAP_PREFIX+BUTTON_PREFIX+ ACL_INDEX ).prop( "checked")){
			text.push(COLUMNS_LABELS[ACL_INDEX]);
			text.push(separator);
			separator = ", ";
		}
		if ($('#'+MAP_PREFIX+BUTTON_PREFIX+ CL_INDEX ).prop( "checked")){
			text.push(COLUMNS_LABELS[CL_INDEX]);
			text.push(separator);
			separator = ", ";
		}
		if ($('#'+MAP_PREFIX+BUTTON_PREFIX+ VL_INDEX ).prop( "checked")){
			text.push(COLUMNS_LABELS[VL_INDEX]);
			text.push(separator);
			separator = ", ";
		}
		text.pop();
		text = text.reverse();

		$('#mapsTitle').html(text.join(""));
 
	}

	/* jQueryUI auxiliary functions */
	function setButtonDisabledTo(id, value){
		$( "#" + id ).prop('disabled', value);
		$( "#" + id ).button( "refresh" );
	}

	function setOptionSelectMenu(id, value){
		$( "#" + id ).val(value);
		$( "#" + id ).selectmenu("refresh");
	}

	function drawLegendSet(htmlElementID, index){
		var html = '<div class="'+CLASS_EDITABLE_ELEMENT+' legentSetTitle">' + mapLegends[index][0].legendSetName + '</div>';
		html+='<br>';
		
		
		for(var i=0; i<mapLegends[index].length; i++){
			html+='<div>';
			html+='<div class="legendRectangle sameLine" style="background:'+ mapLegends[index][i].legendColors +'"></div>';
			html+='<div class="legentSetElementText sameLine '+CLASS_EDITABLE_ELEMENT+'">  ' + mapLegends[index][i].legendNames + '</div>';
			html+='</div>';

		}

		$("#"+htmlElementID).html(html);
	}

	/****************************************************************************************************
	 **********                               CHARTS functions                                 **********
	 ****************************************************************************************************/

	/* Retrieves the data of vl and cl or acl/zcl, configures the monthly charts and generates them.
	*/
	function generate_cl_vl_new_monthly_charts (){
	
		var yearsText = (ds.year-1) + " and " + ds.year;
		var colors = [COLORS.blue, COLORS.blue, COLORS.green, COLORS.green];
		var labels = [ACL_CHART_LEGEND +ds.year, ACL_CHART_LEGEND +(ds.year-1), ZCL_CHART_LEGEND + ds.year, ZCL_CHART_LEGEND  + (ds.year-1)];
		
		var acl_current_year = monthlyArray[ACL_ROW].slice(1,monthlyArray[ACL_ROW].length);
		var zcl_current_year = monthlyArray[ZCL_ROW].slice(1,monthlyArray[ZCL_ROW].length);
		var acl_previous_year = monthlyArray[ACL_PREVIOUS_YEAR_ROW].slice(1,monthlyArray[ACL_PREVIOUS_YEAR_ROW].length);
		var zcl_previous_year = monthlyArray[ZCL_PREVIOUS_YEAR_ROW].slice(1,monthlyArray[ZCL_PREVIOUS_YEAR_ROW].length);
		var dataarrays = [acl_current_year, acl_previous_year, zcl_current_year, zcl_previous_year];
		lineChart(newAZCLCasesChartID, CL_CASES_CHART_TITLE + yearsText, MONTHS_ABBREV, CL_CASES_CHART_Y_TITLE, labels, dataarrays, colors, true);

		colors = [COLORS.blue, COLORS.blue];
		labels = [CL_CHART_LEGEND + ds.year, CL_CHART_LEGEND + (ds.year-1)];
		var cl_current_year = monthlyArray[CL_ROW].slice(1,monthlyArray[CL_ROW].length);
		var cl_previous_year = monthlyArray[CL_PREVIOUS_YEAR_ROW].slice(1,monthlyArray[CL_PREVIOUS_YEAR_ROW].length);
		var dataarrays = [cl_current_year, cl_previous_year];
		lineChart(newCLCasesChartID, CL_CASES_CHART_TITLE + yearsText, MONTHS_ABBREV, CL_CASES_CHART_Y_TITLE, labels, dataarrays, colors, true);

		var vl_current_year = monthlyArray[VL_ROW].slice(1,monthlyArray[VL_ROW].length);
		var vl_previous_year = monthlyArray[VL_PREVIOUS_YEAR_ROW].slice(1,monthlyArray[VL_PREVIOUS_YEAR_ROW].length);
		var vl_data_arrays = [vl_current_year, vl_previous_year];
		var vl_colors = [COLORS.violet, COLORS.violet];
		var vl_labels = [VL_CHART_LEGEND + ds.year, VL_CHART_LEGEND + (ds.year-1)];

		lineChart(newVLCasesChartID, VL_CASES_CHART_TITLE + yearsText, MONTHS_ABBREV, VL_CASES_CHART_Y_TITLE, vl_labels, vl_data_arrays, vl_colors, true);

	}

	/* Retrieves the data of vl and cl or acl/zcl, configures the yearly charts and generates them.
		*/
	function generate_cl_vl_new_and_incidence_yearly_charts(){

		var dataLabelArray = [ACL_CHART_INCIDENCE_LEGEND, ZCL_CHART_INCIDENCE_LEGEND, ACL_CHART_CASES_LEGEND, ZCL_CHART_CASES_LEGEND];
		var charType = ["line","line","bar","bar"];
		var dataArray = [historicIncidenceChart[ACL_COLUMN], historicIncidenceChart[ZCL_COLUMN], historicNewCases[ACL_COLUMN], historicNewCases[ZCL_COLUMN]];
		var colorArray = [COLORS.blue, COLORS.green, COLORS.soft_blue, COLORS.soft_green];
		var dataChartIDs= [DATASID.RIGHT, DATASID.RIGHT, DATASID.LEFT, DATASID.LEFT];
		lineBarChart(newAZCLAndHistoricIncidenceID, CL_INCIDENCE_CHART_TITLE, dataLabelArray, CL_INCIDENCE_CHART_Y1_TITLE, CL_INCIDENCE_CHART_Y2_TITLE, charType, dataArray, colorArray, dataChartIDs);



		dataLabelArray = [VL_CHART_INCIDENCE_LEGEND, VL_CHART_CASES_LEGEND];
		charType = ["line","bar"];
		dataArray = [historicIncidenceChart[VL_COLUMN], historicNewCases[VL_COLUMN]];
		colorArray = [COLORS.violet, COLORS.soft_violet];
		dataChartIDs= [DATASID.RIGHT, DATASID.LEFT];
		lineBarChart(newVLAndHistoricIncidenceID, VL_INCIDENCE_CHART_TITLE, dataLabelArray, VL_INCIDENCE_CHART_Y1_TITLE, VL_INCIDENCE_CHART_Y2_TITLE, charType, dataArray, colorArray, dataChartIDs);


		dataLabelArray = [CL_CHART_INCIDENCE_LEGEND, CL_CHART_CASES_LEGEND];
		charType = ["line","bar"];
		dataArray = [historicIncidenceChart[CL_COLUMN], historicNewCases[CL_COLUMN]];
		colorArray = [COLORS.blue, COLORS.green];
		dataChartIDs= [DATASID.RIGHT, DATASID.LEFT];
		lineBarChart(newCLAndHistoricIncidenceID, CL_INCIDENCE_CHART_TITLE, dataLabelArray, CL_INCIDENCE_CHART_Y1_TITLE, CL_INCIDENCE_CHART_Y2_TITLE, charType, dataArray, colorArray, dataChartIDs);

	}



	/* 	Generates an any-lines-number line Chart. 
		htmlElementID: the id of the canvas/html element where put the Chart
		x_labels: The labels for the x-axis  
		dataLabelArray: an array with the label of each data line
		dataArray: the data
		colorArray: an Array of rgba colors
		previousYearMode: true if wanted to put previous years in dotted colors.
						  currentYear data must be preceed the previousYear data
		Note: All the array must have same size !
	*/
	function lineChart(	htmlElementID, title, x_labels, yTitle, dataLabelArray, dataArray, colorArray, previousYearMode){

		
		var theDataSets = [];
		var aDataSet = {};
		for (var i = 0; i<dataLabelArray.length; i++){
			aDataSet = {};
			aDataSet.label = dataLabelArray[i];
			aDataSet.fill = false;
			aDataSet.data = dataArray[i];
			aDataSet.backgroundColor = colorArray[i];
			aDataSet.borderColor = colorArray[i];
			aDataSet.borderWidth = 2;
			aDataSet.lineTension = 0;
			aDataSet.pointRadius = 0;
			if (previousYearMode && i%2 == 1){
				// previousYearMode Enabled
				aDataSet.borderDash = [5];
				aDataSet.backgroundColor = aDataSet.backgroundColor.slice(0, -2)+"0.2)";
			}
			theDataSets[i] = aDataSet;
		}
		
		var ctx = document.getElementById(htmlElementID);
		var myChart = new Chart(ctx, {
		type: 'line',
		data: {
			labels: x_labels,
			datasets: theDataSets
			},
			options: {
				scales: {
					yAxes: [{
						ticks: {
							beginAtZero:true
						},
						scaleLabel:{
							display: true,
							labelString: yTitle
						}
					}]
				},
				title:{
					display: true,
					text: title
				},
				responsive: false
			}
		});
	}

	function lineBarChart(htmlElementID, title, dataLabelArray, y1Title, y2Title, charType, dataArray, colorArray, dataChartIDs){
		var theDataSets = [];
		var aDataSet = {};
		for (var i = 0; i<dataLabelArray.length; i++){
			aDataSet = {};
			aDataSet.label = dataLabelArray[i];
			aDataSet.fill = false;
			aDataSet.data = dataArray[i].reverse();
			aDataSet.backgroundColor = colorArray[i];
			aDataSet.borderColor = colorArray[i];
			aDataSet.borderWidth = 2;
			aDataSet.lineTension = 0;
			aDataSet.pointRadius = 0;
			aDataSet.type = charType[i];
			aDataSet.yAxisID = dataChartIDs[i];
			theDataSets[i] = aDataSet;
		}

		var yearLabels = [];
		for (var i=0; i<historicLength;i++){
			yearLabels[historicLength-i-1] = ds.year-i;
		}


		var ctx = document.getElementById(htmlElementID);
		var myChart = new Chart(ctx, {
			type: 'bar',
			data: {
				labels: yearLabels,
				datasets: theDataSets
			},
			options: {
				scales: {
					yAxes: [{
						id: DATASID.LEFT,
						stacked: true,
						type: 'linear',
						position: 'left',
						scaleLabel:{
							display: true,
							labelString: y1Title
						}
					},{
						id: DATASID.RIGHT,
						type: 'linear',
						position: 'right',
						ticks: {
							beginAtZero:true
						},
						scaleLabel:{
							display: true,
							labelString: y2Title
						}
					}]
				},
				title:{
						display: true,
						text: title
					},
				responsive: false
			}
		});
	}

	/****************************************************************************************************
	 **********                               MAPS functions                                 **********
	 ****************************************************************************************************/

	 function moveLegend(index, destination, destinationCode){
		var legendObject = $('#' + LEGENDSET_PREFIX + index);

		if (destinationCode == LEGEND_TO_REPORT){
			legendObject.resizable({ disabled: true });
			legendObject.removeClass("resizable");
		} else {
			editingLegend = legendObject;
			editingLegend.resizable( "enable" );
		}
		destination.append(legendObject);
	 }

	function updateLegend(event) {
		event.preventDefault();
		var legend_index =  $('#legendSelector').val();
		var position_index =  $('#positionLegendSelector').val();

		moveLegend(legend_index, $('#'+MAP_PREFIX+ legend_index).find(LEGEND_POSITIONS[position_index]), LEGEND_TO_REPORT);
		setButtonDisabledTo("updateLegendButton", true);
		setOptionSelectMenu("legendSelector", $("#legendSelector option:first").val());
		setOptionSelectMenu("positionLegendSelector", BOTTOM_RIGHT);
		font_size_slider.slider("value", 10 );
		font_size_slider_handle.text( 10 );
	}

	function updateMap(event) {
		event.preventDefault();
		var selected_map_index =  $('#mapSelector').val();
		var mapStyle = MAP_STYLE[$('#mapStyleSelector').val()];
		// TODO: adapt to Maps
		generateMap(selected_map_index, "INDICATOR", map_levels, ds.countryID, ds.year, "thematic1", mapStyle, map_opacity);
	}
	
	function generateMapAndLegend(index){

		return $.when(getLegendSet(index)).done(function(result){
			initalMapDiv[index] = $('#map'+index).html();
			var mapStyle = MAP_STYLE[$('#mapStyleSelector').val()];
			drawLegendSet("legendSet"+index, index);
			generateMap(index, "INDICATOR", map_levels, ds.countryID, ds.year, "thematic1", mapStyle, map_opacity);

		});

	}

	function fillNotaBene(){
		var text = "Data source: Ministry of Health, " +
					ds.countryName +
					"<br>WHO " + ds.year + ". All rights reserved.";
		$('#notaBene div').html(text);
		
	}

	function fillNotaBeneMaps(){
		var text = "The boundaries and names shown and the designations used on this map do not imply the expression of any opinion whatsoever " +
					"on the part of the World Health Organization concerning the legal status of any country, territory, city or area or of " +
					"its authorities, or concerning the delimitation of its frontiers or boundaries. Dotted and dashed lines on maps represent " +
					"approximate border lines for which there may not yet be full agreement. <br>Map production: WHO/HTM/NTD/IDM";
		$('#notaBeneMaps div').html(text);
		
	}


	/****************************************************************************************************
	 **********                               FOOTNOTES functions                                 **********
	 ****************************************************************************************************/

// TODO: move those vars up
  	var storedFootnotes = [];
    var activeFootnotesPage1 = [];
	var activeFootnotesPage2 = [];

	function addNewFootnote(){
		if($("#newFootnoteText").html()){
			var liClass = "ui-state-default";
			var html='';
			html+='<li class="'+liClass+' '+CLASS_EDITABLE_ELEMENT+'">';
			html+= $("#newFootnoteText").html();
			html+= '</li>';
			document.getElementById(SORTABLE_LIST_1_NAME).innerHTML += html;

		}
		deleteNewFootnote();
	}

	function deleteNewFootnote(){
		$("#newFootnoteText").html('');
	}


	function writeFootnotes(){
		var footnotesZone1 = $("#footnotes1");
		var footnotesZone2 = $("#footnotes2");

		footnotesZone1.html('');
		footnotesZone2.html('');

		var elements = $("#sortable2 li");
        var html = '';
		for (var i=0; i<elements.length; i++){
			html+='<div class="footnote"><span class="superindex">'+(i+1)+'</span><span class="'+CLASS_EDITABLE_ELEMENT+'">'
			html+= elements[i].innerHTML;
			html+= '</span></div>';
		}
		footnotesZone1.append(html);
		
		elements = $("#sortable3 li");
    	html = '';
		var base = i;
		for (var i=0; i<elements.length; i++){
			html+='<div class="footnote"><span class="superindex">'+(i+base+1)+'</span><span class="'+CLASS_EDITABLE_ELEMENT+'">'
			html+= elements[i].innerHTML;
			html+= '</span></div>';
		}
		footnotesZone2.append(html);
	}


	/****************************************************************************************************
	 **********                            COUNTRY-SELECTOR                                    **********
	****************************************************************************************************/	
	
	function country_selector_open(){
		document.getElementById("country-selector").style.display = "block";
	}

	function country_selector_close(){
		Pace.restart();
		document.getElementById("country-selector").style.display = "none";
	}
	
	function initializeDialogs (){

		/****************************************************************************************************
		 **********                               EDITOR                                           **********
		****************************************************************************************************/

		dialog = $( "#dialog-editor" ).dialog({
			autoOpen: false,
			height: 350,
			width: 650,
			modal: true,
			title: "Edit field",
			position: { my: "center", at: "center", collision: "none" },
			buttons: {
				"Save changes": saveChanges,
				"Save changes and close": saveChangesAndClose,
				Cancel: function() {
					deleteNewFootnote();
					dialog.dialog( "close" );
				}
			},
			close: function(event) {
				event.preventDefault();
				return false;
				//allFields.removeClass( "ui-state-error" );
			}
		});
	}

	function saveChanges(){
		editingElement.innerHTML = editor.jqteVal();
		addNewFootnote();
	}
	function saveChangesAndClose(){
		editingElement.innerHTML = editor.jqteVal();
		addNewFootnote();
		dialog.dialog( "close" );
	}


	/****************************************************************************************************
	 **********                               LISTENERS                                        **********
	 ****************************************************************************************************/

	 function refreshToggleStatus(){

		$(":checkbox."+LEISH_COLUMN_DETAIL_PREFIX).each(function(){
			if( !this.checked ) {
				$( this ).trigger('change');
				// selects appropiate footnote and hides it since that part of the two tables has no changed
				var id_num = $( this ).prop('id').split('_').pop(); // gets the X on LeishDetail_BUTTON_X
				$("#" + TEXT_UNDER_EPI + id_num).toggle();
				$("#" + TEXT_UNDER_DIAG1 + id_num).toggle();
			}
		});
		
	 }

	 function addListenersToCheckboxes(){
		// Listener ACL/ZCL PKDL buttons
		$(":checkbox."+LEISH_COLUMN_DETAIL_PREFIX).change(function() {
				var index = Number(this.id.slice(this.id.length-1, this.id.length));
				$('#epiTable tr, #diagTable tr, #toutcomeTable tr').each(function() {
					$(this).find("td,th").eq(index+1).toggle();
				});

				// text descriptions under tables
				$('#textUnderEpiTable').each(function() {
					$(this).find("span").eq(index+1).toggle();
				});
				$('#textUnderDiagTable1').each(function() {
					$(this).find("span").eq(index+1).toggle();
				});
			}
		);
		
		// Listener monthly buttons
		$(":checkbox."+MONTHLY_TABLE_NAME).change(function() {
			var index = Number(this.id.slice(this.id.length-1, this.id.length));
			var startingid = this.id.slice(0, -1-BUTTON_PREFIX.length);
			$("#"+startingid+index).toggle();
			
		});
		
		// Listener chart buttons
		$(":checkbox."+CHART_PREFIX).change(function() {
			var index = Number(this.id.slice(this.id.length-1, this.id.length));
			var startingid = this.id.slice(0, -1-BUTTON_PREFIX.length);
			var theCanvas = $('#'+startingid+index);
			theCanvas.toggleClass('sameLine');
			theCanvas.toggleClass('notShown');
			
		});

		//Listener for maps
		$(":checkbox."+MAP_PREFIX).change(function() {
			var index = Number(this.id.slice(this.id.length-1, this.id.length));
			var startingid = this.id.slice(0, -1-BUTTON_PREFIX.length);

			// enables or disables the options of the list
			$("#"+MAP_PREFIX+index).toggle();
			var changeOption = $('#' + startingid + OPTION_PREFIX + index);
			changeOption.prop('disabled', function(_, attr){ return !attr});
			$( "#mapSelector" ).selectmenu( 'refresh', true);

			// enables or disables the updatedMapButton
			var selected_map = $("#mapSelector").val();
			if(selected_map==index){
				var checked = $("#"+MAP_PREFIX+BUTTON_PREFIX+index).prop('checked');			
				setButtonDisabledTo("updateMapButton", !checked);
			}
			updateMapsTitle();

		});

		$(".radioButton").change(function() {

			switch($(this)[0].id){
				case "disableNBMaps":
						$("#notaBeneMaps").resizable({ disabled: true });
						break;
				case "enableNBMaps":
						$("#notaBeneMaps").resizable( "enable");
						break;
				case "disableNB":
						$("#notaBene").resizable({ disabled: true });
						break;
				case "enableNB":
						$("#notaBene").resizable( "enable");
						break;
			}
		});

		// enables the updatedMapButton
		 $('#mapSelector').on('selectmenuchange', function() {
			setButtonDisabledTo("updateMapButton", false);
		}).change();

		 $('#legendSelector').on('selectmenuchange', function() {
			var selected_legend = $("#legendSelector").val();
			setButtonDisabledTo("updateLegendButton", false);


			// move back the legend to it map
			var position_index =  $('#positionLegendSelector').val();
			for (var i=0; i<MAP_CHECKBOXES_LABELS.length; i++){
				if ( $("#legendPool").find('#' + LEGENDSET_PREFIX + i).length > 0) {
					moveLegend(i, $('#' + MAP_PREFIX + i).find(LEGEND_POSITIONS[position_index]), LEGEND_TO_REPORT);	
				}
			}

			lastLegendPosition = getLastPosition(selected_legend);
			setOptionSelectMenu("positionLegendSelector", lastLegendPosition);

			moveLegend(selected_legend, $("#legendPool"), LEGEND_TO_LEGEND_POOL);


		}).change();

		$("#subnationalLevelSelector").on('selectmenuchange', function() {
			var subNationaSelectedLevel = parseInt($("#subnationalLevelSelector").val());

			var get_pops_at_risk = $.when(
				getPopulationAtRiskFor(POP_AT_RISK[VL_INDEX], VL_COLUMN, subNationaSelectedLevel),
				getPopulationAtRiskFor(POP_AT_RISK[CL_INDEX], CL_COLUMN, subNationaSelectedLevel),
				getPopulationAtRiskFor(POP_AT_RISK[ACL_INDEX], ACL_COLUMN, subNationaSelectedLevel),
				getPopulationAtRiskFor(POP_AT_RISK[ZCL_INDEX], ZCL_COLUMN, subNationaSelectedLevel)
				)
			.then( function(){return fillArray_IncidenceRow();} ); // recalculates EPI table incidence

			var update_epi_and_cgi_tables = $.when(
					get_pops_at_risk,
					updateNumberOfDivisions(subNationaSelectedLevel)
			).done(function(result){
				writeTable(CGI_TABLE_NAME, "Body", generalInformationArray, LINES_BELOW_LABELS_CGI);
				writeTable(EPI_TABLE_NAME, "Body", array, LINES_BELOW_LABELS_EPI);
				// It writes the entire table data, so put also the headers
				fillTableHead(EPI_TABLE_NAME, "Head", '', COLUMNS_LABELS);

				// rewrites also DiagTable and Toutcome table since buttons are going to be clicked
				writeTable(DIAG_TABLE_NAME, "Body", diagnosisArray, LINES_BELOW_LABELS_DIAG);
				writeTable(TOUTCOME_TABLE_NAME, "Body", toutcomeArray, LINES_BELOW_LABELS_TREAT);
				fillTableHead(DIAG_TABLE_NAME, "Head", '', COLUMNS_LABELS);
				fillTableHead(TOUTCOME_TABLE_NAME, "Head", TOUTCOME_TABLE_FIRST_COLUMNS, COLUMNS_LABELS.slice(0,4));

				refreshToggleStatus();
			});


			var update_maps;
			// recalculates maps to selected subnational level
			if ($("#maps_to_selectedSubLevel").prop('checked')){
				update_map_levels_var(map_levels[0], WIDP_OU_SHIFT + subNationaSelectedLevel);
				var mapStyle = MAP_STYLE[$('#mapStyleSelector').val()];
				update_maps = $.when(
					generateMap(VL_INDEX, "INDICATOR", map_levels, ds.countryID, ds.year, "thematic1", mapStyle, map_opacity),
					generateMap(CL_INDEX, "INDICATOR", map_levels, ds.countryID, ds.year, "thematic1", mapStyle, map_opacity),
					generateMap(ACL_INDEX, "INDICATOR", map_levels, ds.countryID, ds.year, "thematic1", mapStyle, map_opacity),
					generateMap(ZCL_INDEX, "INDICATOR", map_levels, ds.countryID, ds.year, "thematic1", mapStyle, map_opacity)
				).done(function(result){
					console.log("maps updated");
				});
			}

			// removes all footnotes marks since refreshed elements will lost its footnote mark
			$.when(
					update_epi_and_cgi_tables,
					update_epi_and_cgi_tables,
					update_maps
				).done(function(result){
					removeAllFootnotesMarks();
			});

		}).change();

	 }

	 function getLastPosition(selectedlegend){
		for (var i=0; i<LEGEND_POSITIONS.length; i++){
			console.log("getLastPosition");
			console.log($('#' + MAP_PREFIX + selectedlegend));
			console.log($('#' + MAP_PREFIX + selectedlegend).find(LEGEND_POSITIONS[i]));
			console.log($('#' + MAP_PREFIX + selectedlegend).find(LEGEND_POSITIONS[i]).find('#'+LEGENDSET_PREFIX + selectedlegend));
			if ($('#' + MAP_PREFIX + selectedlegend).find(LEGEND_POSITIONS[i]).find('#'+LEGENDSET_PREFIX + selectedlegend).length > 0 ){
				return i;
			}
		}
	 }



	
    function fillOrgUnits(data, length, start){
        var orgUnit;
        for(var i=0;i<length;i++){
            orgUnit = {};
            orgUnit.value = data[i].id;
            orgUnit.label = data[i].displayName;
            organisationUnits.push(orgUnit);
        }
	}

	/**
	* Generates a list of years from next year until 1900 and stores in generatedYears
	*/
	function generateYears(){
		var year;
		for (i = new Date().getFullYear() + 1; i > 1900; i--)
		{
			year = {};
			year.value = i;
			year.label = i;
			generatedYears.push(year);
		}
	}

	/****************************************************************************************************
 	 **********                    	                  START HERE         	           	       **********
	 ****************************************************************************************************/

    $(document).ready(function(){

		document.getElementById("country_profile_and_panel").style.display = "none";


		editor = $("#editor");
		editor.jqte();	

		initializeDialogs();

		/* Listeners */
		// Editor for footnotes
		$("#newfootnote").click(function() {
			editingElement = $("#newFootnoteText")[0];
			editor.jqteVal(editingElement.innerHTML);

			dialog.dialog( "option", "position", { my: "left top", at: "center bottom+10%", of: this } );	
			dialog.dialog( "open" );	

		});
		
		$( "#updateLegendButton" ).on( 'click', event, updateLegend);
		$( "#updateMapButton" ).on( 'click', event, updateMap);

		// New footnote arrives 
		$( "#sortable2" ).on( "sortupdate", function( event, ui ) {
			writeFootnotes();
		} );	
		// New footnote arrives 
		$( "#sortable3" ).on( "sortupdate", function( event, ui ) {
			writeFootnotes();
		} );

		//TODO: fix contextmenu
		$(document).on("contextmenu",function(e){
			if(e.target.nodeName != "INPUT" && e.target.nodeName != "TEXTAREA")
				e.preventDefault();
				return false;
		});

		$.when(getNumberOfDivisions(3, "id,displayName"), generateYears())
			.done(function(nbOfDivisions){

				fillOrgUnits(nbOfDivisions.organisationUnits, nbOfDivisions.organisationUnits.length);
				
				autocompleteSearcher("yearField", generatedYears, doNothing, 1, 200);
				autocompleteSearcher("targetCountry", organisationUnits, doNothing, 2, 200);

				country_selector_open();
				//DEBUG_AutomaticallyfillInitialForm();

			});
		
	});

	function checkMetadataAssignedToThisCountry(){
		saveSelectedYearAndCountry();

		var datasets = [];
		datasets.push(CL_DETAILED, CL_SIMPLE, VL_DETAILED, VL_SIMPLE, 
						AZCL_DETAILED, AZCL_SIMPLE, GI, GHO_NTDS);

		var programs = [];
		programs.push(CL_MONTHLY, VL_MONTHLY, FOOTNOTES, SUBN_ENDEMCTY);

		var datasetFilter = "id:in:["+datasets+"]";
		var programFilter = "id:in:["+programs+"]";
		var ouFilter = "organisationUnits.id:in:["+ ds.countryID +"]";
		var FILTER = "&filter=";
		var ds_filters = FILTER + datasetFilter + FILTER + ouFilter;
		var p_filters = FILTER + programFilter + FILTER + ouFilter;
	
		var params = {
			fields: "id",
			paging: false
		}
	
		return $.when(getv3(DATASETS, params, ds_filters), getv3(PROGRAMS, params, p_filters))
		.done(function(dataSetResult, programResult){
			if (typeof  dataSetResult.dataSets != 'undefined') {
				var dsRes = dataSetResult.dataSets;
				for (var i=0; i < dsRes.length; i++){
					if (dsRes[i].id in dsinfo){
						dsinfo[dsRes[i].id][ASSG] = true;
					}
				}
			}
			if (typeof  programResult.programs != 'undefined') {
				var pRes = programResult.programs;
				for (var i=0; i < pRes.length; i++){
					if (pRes[i].id in pinfo){
						pinfo[pRes[i].id][ASSG] = true;
					}
				}
			}
			var notAssginedMtd = "";
			var IS_NOT_ASSG = " is not assigned to this country.</br>";
			if (!dsinfo[GI][ASSG] ){
				notAssginedMtd += dsinfo[GI][NAME] + IS_NOT_ASSG;
			}			
			if (!dsinfo[GHO_NTDS][ASSG] ){
				notAssginedMtd += dsinfo[GHO_NTDS][NAME] + IS_NOT_ASSG;
			}
			if (!pinfo[FOOTNOTES][ASSG] ){
				notAssginedMtd += pinfo[FOOTNOTES][NAME] + IS_NOT_ASSG;
			}
			if (!pinfo[SUBN_ENDEMCTY][ASSG] ){
				notAssginedMtd += pinfo[SUBN_ENDEMCTY][NAME] + IS_NOT_ASSG;
			}
			if (notAssginedMtd.length > 0){
				return showFeedbackToUser(notAssginedMtd);
			} else {
				return startPreparingReport();
			}




		});
	}

	function DEBUG_AutomaticallyfillInitialForm()
	{

		$( "#targetCountry" ).val("Algeria"); //val("Federal Democratic Republic of Nepal");//
		$( "#targetCountry" ).text("mNa42CHbkO7"); //text("pZZriU4sY0l");//
		$( "#yearField" ).val(2017); // val(2016);

		checkMetadataAssignedToThisCountry();

	}

	function showFeedbackToUser(text){
		$("#metadataFeedback").html(text);
	}

	function saveSelectedYearAndCountry() {
		// retrieves values from form
		ds.countryName =  $( "#targetCountry" ).val(); 
		ds.countryID =  $( "#targetCountry" ).text(); 
		ds.year = $( "#yearField" ).val(); 
	}

	function startPreparingReport() {
	
		country_selector_close();

		$( "#country_name" ).text(ds.countryName);
		$( "#year" ).text(ds.year);
		$( "#published_date").text(getDatePublished());

		generateCheckboxes($("#leish_detail_checkboxes"), COLUMNS_LABELS, "Leishmaniasis types to show:", LEISH_COLUMN_DETAIL_PREFIX, -1);
		generateCheckboxes($("#monthlyCheckboxes"), MONTHLY_LABELS, "Leishmaniasis types to show in monthly table:", MONTHLY_TABLE_NAME, -1);
		generateCheckboxes($("#chartCheckboxes"), CHART_CHECKBOXES_LABELS, "Charts to show", CHART_PREFIX, 2);
		generateCheckboxes($("#mapCheckboxes"), MAP_CHECKBOXES_LABELS, "Maps to show", MAP_PREFIX, -1);

		addListenersToCheckboxes();

		$( "#sortable1, #sortable2, #sortable3" ).sortable({
		connectWith: ".connectedSortable"
		}).disableSelection();
		$('input[type=checkbox]').checkboxradio();
		$( "#tabs" ).tabs({heightStyle: "content"});
		// corrects bug on checkboxes
		$( ".ui-state-hover" ).removeClass( "ui-state-hover" );


		// maps jqueryui    
		$( "#mapSelector" ).selectmenu();
		$( "#legendSelector" ).selectmenu();
		$( "#positionLegendSelector" ).selectmenu();
		$( "#subnationalLevelSelector" ).selectmenu();
		$( "#mapStyleSelector" ).selectmenu();
		$( "#updateMapButton").button();
		$( "#updateLegendButton").button();
		$( ".radioButton" ).checkboxradio();



		setButtonDisabledTo("updateMapButton", true);
		setButtonDisabledTo("updateLegendButton", true);
		setOptionSelectMenu("positionLegendSelector", BOTTOM_RIGHT);

		generateMapConfigurationList($("#mapSelector"), MAP_CHECKBOXES_LABELS, MAP_PREFIX);
		generateMapConfigurationList($("#legendSelector"), MAP_CHECKBOXES_LABELS, LEGENDSET_PREFIX);
		generateMapConfigurationList($("#positionLegendSelector"), LEGEND_POSITION_LABELS, LEGEND_PREFIX);
		generateMapConfigurationList($("#mapStyleSelector"), MAP_STYLE_LABELS, MAP_STYLE_PREFIX);

		// Disables Google options
		$('#' + MAP_STYLE_PREFIX + OPTION_PREFIX + GOOGLE_STREETS).prop('disabled', function(_, attr){ return !attr});
		$('#' + MAP_STYLE_PREFIX + OPTION_PREFIX + GOOGLE_HYBRID).prop('disabled', function(_, attr){ return !attr});
		$( "#mapStyleSelector" ).selectmenu( 'refresh', true);

		setOptionSelectMenu("mapStyleSelector", OSM_LIGHT);
		
		generateMapConfigurationList($("#subnationalLevelSelector"), LEVEL_CONFIG_LABELS, LEVEL_PREFIX);

		fillNotaBene();
		fillNotaBeneMaps();

		setTextUnderTables("textUnderEpiTable", TEXT_UNDER_EPI, COLUMNS_LABELS, COLUMNS_LABELS_DESC, PUT_NA_TEXT);
		setTextUnderTables("textUnderDiagTable1", TEXT_UNDER_DIAG1, 
								DIAG_LEGEND_LABELS, 
								DIAG_LEGEND_LABELS_DESC, 
								PUT_NA_TEXT);
		setTextUnderTables("textUnderDiagTable2", TEXT_UNDER_DIAG2, DIAG_LEGEND_LABELS_2, DIAG_LEGEND_LABELS_DESC_2, DIAG_ASTERISK_RDT_COMMENT);
		
		text_values = [
			"WHO Global",
			"WHO Regions",
			"WHO Member States",
			"Level 1",
			"Level 2",
			"Level 3",
			"Level 4"		
		];

		// Org unit level slider
		var sliderRange = $( "#slider_range" );
		sliderRange.slider({
			range: true,
			min: 1,
			max: 7,
			values: [ map_levels[0], map_levels[map_levels.length-1]], // values = [firstValue, lastValue]
			slide: function( event, ui ) {
				$( "#ou_level_slider" ).val( text_values[ui.values[ 0 ]-1] + " - " + text_values[ui.values[ 1 ]-1] );
				update_map_levels_var(ui.values[0], ui.values[1]);
			}

		});
		$( "#ou_level_slider" ).val( text_values[sliderRange.slider( "values", 0 )-1] + " - " + text_values[sliderRange.slider( "values", 1 )-1] );

		// Opacitity slider  
		var opacity_slider_handle = $( "#opacity_slider_handle" );
		$( "#opacity_slider" ).slider({
		min: 0,
		max: 100,
		value: map_opacity,
		create: function() {
			opacity_slider_handle.text( $( this ).slider( "value" ) );
		},
		slide: function( event, ui ) {
			opacity_slider_handle.text( ui.value );
			map_opacity = ui.value;
		}
		});
		
		// height slider  
		var height_slider_handle = $( "#height_slider_handle" );
		$( "#height_slider" ).slider({
		min: 100,
		max: 900,
		value: map_height,
		create: function() {
			height_slider_handle.text( $( this ).slider( "value" ) );
		},
		slide: function( event, ui ) {
			height_slider_handle.text( ui.value );
			map_height = ui.value;
		}
		});
		
		// width slider  
		var width_slider_handle = $( "#width_slider_handle" );
		$( "#width_slider" ).slider({
		min: 100,
		max: 900,
		value: map_width,
		create: function() {
			width_slider_handle.text( $( this ).slider( "value" ) );
		},
		slide: function( event, ui ) {
			width_slider_handle.text( ui.value );
			map_width = ui.value;
		}
		});

		// Font size slider  
		
		font_size_slider.slider({
		min: 6,
		max: 24,
		value: 10,
		create: function() {
			font_size_slider_handle.text( $( this ).slider( "value" ) );
		},
		slide: function( event, ui ) {
			font_size_slider_handle.text( ui.value );
			editingLegend.find(".legentSetElementText").css({ 'font-size': $( this ).slider( "value" ) });
			editingLegend.find(".legentSetTitle").css({ 'font-size': $( this ).slider( "value" )+2 });
		}
		});
		
		
		fillTableHead(EPI_TABLE_NAME, "Head", '', COLUMNS_LABELS);
		fillTableHead(MONTHLY_TABLE_NAME, "Head", '', MONTHS_ABBREV);
		fillTableHead(DIAG_TABLE_NAME, "Head", '', COLUMNS_LABELS);
		fillTableHead(TOUTCOME_TABLE_NAME, "Head", TOUTCOME_TABLE_FIRST_COLUMNS, COLUMNS_LABELS.slice(0,4));


		// Dragable activation
		$( ".draggable" ).draggable({ grid: [ 10, 10 ] });	
		$( ".resizable" ).resizable();


		// fillCountryGeneralInformation(LEVEL2); //TODO: Manage error when not level 2

		// Code to execute after API calls have been done.
		// $.when(ajax1(), ajax2(), ajax3(), ajax4()).done(function(a1, a2, a3, a4){
		// http://stackoverflow.com/questions/3709597/wait-until-all-jquery-ajax-requests-are-done
//        var async2 = $.when( a3() ).then(function(){ return a4(); });

		
		var getDEUsedByMetadataPromise = $.when(getDEUsedByMetadata()) // gets totalPopulation var who is neeeded for popAtRisk
			.then( function(){return;});
			
		var get_pops_at_risk = $.when(get_cgi(), getDEUsedByMetadataPromise) // gets totalPopulation var who is neeeded for popAtRisk
			.then( function(){return getPopulationAtRiskFor(POP_AT_RISK[VL_INDEX], VL_COLUMN, defaultSubnationalLevel);} )
			.then( function(){return getPopulationAtRiskFor(POP_AT_RISK[CL_INDEX], CL_COLUMN, defaultSubnationalLevel);} )
			.then( function(){return getPopulationAtRiskFor(POP_AT_RISK[ACL_INDEX], ACL_COLUMN, defaultSubnationalLevel);} )
			.then( function(){return getPopulationAtRiskFor(POP_AT_RISK[ZCL_INDEX], ZCL_COLUMN, defaultSubnationalLevel);} );

		var epi_incidence_async = $.when(
			getAnalyticsDataForDX(NEW_AND_UNSP_CASES, 0, fillIndicatorArray, [NEW_AND_UNSP_CASES, new_and_usnp_cases]),
			getAnalyticsDataForDX(SCREEN_PASSIVE, 0, fillIndicatorArray, [SCREEN_PASSIVE, screen_passive]),
			getAnalyticsDataForDX(TREAT_COMPLETED, 0, fillIndicatorArray, [TREAT_COMPLETED, total_treated]),
			get_cl_cases(), // gets cl cases who is needed for EPI incidence
			get_vl_cases(), 
			get_azcl_cases(),	
			get_pops_at_risk) // gets popAtRisks who is needed for EPI incidence
			//.then(function(){ return fillArray_IncidenceRow(VL_COLUMN); });
			.then( function(nc, sp, tc, data_cl, data_vl, data_azcl){
				fillArray(data_cl.dataValues, CL_COLUMN, DE.CL_EPI_Type); 
				fillArray(data_cl.dataValues, MCL_COLUMN, DE.MCL_EPI_Type, DE.MCL_GEN_EPID_cases); 

				fillArray(data_vl.dataValues, VL_COLUMN, DE.VL_EPI_Type, "");
				fillArray(data_vl.dataValues, PKDL_COLUMN, DE.VL_EPI_Type, DE.PKDL_GEN_EPID_cases);
				//TODO: move to a proper place
				fillControlAndSurveillance(data_vl.dataValues);
				fillTreatmentAndMedicines(data_vl.dataValues);

				fillArray(data_azcl.dataValues, ACL_COLUMN, DE.ACL_EPI_Type, ""); 
				fillArray(data_azcl.dataValues, ZCL_COLUMN, DE.ZCL_EPI_Type, ""); 

				return fillArray_IncidenceRow();
			
			} );
	
		$.when(
			epi_incidence_async,
			generateMapAndLegend(VL_INDEX),
			generateMapAndLegend(CL_INDEX),
			generateMapAndLegend(ACL_INDEX),
			generateMapAndLegend(ZCL_INDEX),
			get_gho_ntds(),
			getAnalyticsDataForDX(INCIDENCE_FOR_CHARTS[VL_INDEX], historicLength, fillIncidenceChartArray, [VL_COLUMN]),
			getAnalyticsDataForDX(INCIDENCE_FOR_CHARTS[CL_INDEX], historicLength, fillIncidenceChartArray, [CL_COLUMN]),
			getAnalyticsDataForDX(INCIDENCE_FOR_CHARTS[ACL_INDEX], historicLength, fillIncidenceChartArray, [ACL_COLUMN]),
			getAnalyticsDataForDX(INCIDENCE_FOR_CHARTS[ZCL_INDEX], historicLength, fillIncidenceChartArray, [ZCL_COLUMN]),
			getAnalyticsDataForDX(NEW_AND_UNSP_CASES[VL_INDEX], historicLength, fillNewCasesArray, [VL_COLUMN]),
			getAnalyticsDataForDX(NEW_AND_UNSP_CASES[CL_INDEX], historicLength, fillNewCasesArray, [CL_COLUMN]),
			getAnalyticsDataForDX(NEW_AND_UNSP_CASES[ACL_INDEX], historicLength, fillNewCasesArray, [ACL_COLUMN]),
			getAnalyticsDataForDX(NEW_AND_UNSP_CASES[ZCL_INDEX], historicLength, fillNewCasesArray, [ZCL_COLUMN]),
			get_monthly_cases_for(CL_MONTHLY, ds.year, DE_MONTHLY.CL_CASES, CL_ROW),
			get_monthly_cases_for(CL_MONTHLY, ds.year-1, DE_MONTHLY.CL_CASES, CL_PREVIOUS_YEAR_ROW),
			get_monthly_cases_for(VL_MONTHLY, ds.year, DE_MONTHLY.VL_CASES, VL_ROW),
			get_monthly_cases_for(VL_MONTHLY, ds.year-1, DE_MONTHLY.VL_CASES, VL_PREVIOUS_YEAR_ROW),
			get_monthly_cases_for(CL_MONTHLY, ds.year, DE_MONTHLY.ACL_CASES, ACL_ROW),
			get_monthly_cases_for(CL_MONTHLY, ds.year-1, DE_MONTHLY.ACL_CASES, ACL_PREVIOUS_YEAR_ROW),
			get_monthly_cases_for(CL_MONTHLY, ds.year, DE_MONTHLY.ZCL_CASES, ZCL_ROW),
			get_monthly_cases_for(CL_MONTHLY, ds.year-1, DE_MONTHLY.ZCL_CASES, ZCL_PREVIOUS_YEAR_ROW),
			getFootnotes(defaultSubnationalLevel)).done(function(epi,l1,l2,l3,l4,gho,dx1,dx2,dx3,dx4,dx5,dx6,dx7,dx8,
																m1,m2,m3,m4,m5,m6,m7,m8,fndata){
			// the code here will be executed when all four ajax requests resolve.
			// a1, a2, a3 and a4 are lists of length 3 containing the response text,
			// status, and jqXHR object for each of the four ajax calls respectively.


				writeTable(CGI_TABLE_NAME, "Body", generalInformationArray, LINES_BELOW_LABELS_CGI);
				writeTable(EPI_TABLE_NAME, "Body", array, LINES_BELOW_LABELS_EPI);
				writeTable(MONTHLY_TABLE_NAME, "Body", monthlyArray, LINES_BELOW_LABELS_MONTHLY);
				writeTable(CAS_TABLE_NAME, "Body", controlArray, LINES_BELOW_LABELS_CAS);
				writeTable(DIAG_TABLE_NAME, "Body", diagnosisArray, LINES_BELOW_LABELS_DIAG);
				writeTable(TOUTCOME_TABLE_NAME, "Body", toutcomeArray, LINES_BELOW_LABELS_TREAT);
				writeTable(TAM_TABLE_NAME, "Body", tamArray, LINES_BELOW_LABELS_TAM);

				generate_cl_vl_new_monthly_charts();
				generate_cl_vl_new_and_incidence_yearly_charts();

				fillFootNotes(fndata);
				fillHTMLListWithArray(SORTABLE_LIST_1_NAME, storedFootnotes, 'ui-state-default '+CLASS_EDITABLE_ELEMENT);
				fillHTMLListWithArray(SORTABLE_LIST_2_NAME, activeFootnotesPage1, 'ui-state-highlight '+CLASS_EDITABLE_ELEMENT);
				fillHTMLListWithArray(SORTABLE_LIST_3_NAME, activeFootnotesPage2, 'ui-state-highlight '+CLASS_EDITABLE_ELEMENT);
				writeFootnotes();

				hideNoRelevantContent();
				
				makeElementsEditables();
				makeElementsFootnotables();

				$("#disableNBMaps").prop('checked', true);
				$("#notaBeneMaps").resizable({ disabled: true });
				$("#disableNB").prop('checked', true);
				$("#notaBene").resizable({ disabled: true });
				$( ".radioButton" ).checkboxradio("refresh");

			//	$("#disableNBMaps").trigger('click');
				//$(".radioButton").change();
				document.getElementById("country_profile_and_panel").style.display = "block";

		}).fail(function(data) {

			if (defaultSubnationalLevel == 1){
				// try againg against level 0
				defaultSubnationalLevel = 0;
				startPreparingReport();
			} else {
	
				console.log ("ERROR. WHEN");
				console.log (data);
			}

		});

	}
		/****  **********  ******  ********  ******  ******   *****  *//***** ********  *****  *** *//****
	 ****  **                                TEST ZONE                                          **********
	 ** ********    ******** **** ********* ******* ************   *********** *********** ******* *******/


</script>

<!--
	/****************************************************************************************************
     **********		   																		   **********
 	 **********            	  		  	      3. HTML CODE              	    			   **********
 	**********		   																		   **********
	 ****************************************************************************************************/
	-->

	
<!DOCTYPE html>
<html>
<head>
	<link rel="stylesheet" href="css/pace_loading_bar.css" type="text/css" />
	<meta charset="UTF-8">
	<title>Leishmaniasis Country Profile Generator</title>
   <link rel="stylesheet" href="css/style.css" type="text/css" />
   <link rel="stylesheet" href="css/jquery-te-1.4.0.css" type="text/css" />
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.css" type="text/css" />
	<link rel="stylesheet" href="https://jqueryui.com/resources/demos/style.css" type="text/css" />
   <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto:400" />
   <!-- <link rel="stylesheet" href="../../../dhis-web-commons/javascripts/ext/resources/css/ext-plugin-gray.css" type="text/css" />-->
   <!---<link rel="stylesheet" href="../../../dhis-web-mapping/extjs/resources/css/ext-all-gray.css" type="text/css" />-->

</head>

<body>
	<div id="country_profile_and_panel">

		<div class="non-printable configuration-section section"><hr>

			<div class="comment">
				Configuration Area - Wont be printed<br>
				Instructions : Left click to add a footnote number.<br>
								Right click to edit an element.
			</div>
			<div id="tabs">
				<ul>
					<li><a href="#tabs-1">General</a></li>
					<li><a href="#tabs-2">Charts</a></li>
					<li><a href="#tabs-3">Maps</a></li>
					<li><a href="#tabs-4">Footnotes</a></li>
					<li><a href="#tabs-5">Manual</a></li>
				</ul>
				<div id="tabs-1">		
					<fieldset id="leish_detail_checkboxes"></fieldset>
					<fieldset id="monthlyCheckboxes"></fieldset>
					<p><select name="subnationalLevelSelector" id="subnationalLevelSelector"></select>
						<input id="maps_to_selectedSubLevel" type="checkbox" checked="checked" />
						<label for="maps_to_selectedSubLevel"> recalculate maps to this level</label>
					</p>
				</div>
				<div id="tabs-2">	
					<fieldset id="chartCheckboxes"></fieldset>
					<fieldset id="chartConfiguration"><legend>Configure chart</legend>
						<select disabled name="chartSelector" id="chartSelector">
							<option disabled selected value>Select a chart</option>
						</select>

						<button disabled id="updateChartButton" class="ui-button ui-widget ui-corner-all">Update Chart</button>
					</fieldset>
				</div>
				<div id="tabs-3">		
					<fieldset id="mapCheckboxes"></fieldset>
					<fieldset id="mapConfiguration"><legend>Configure map</legend>
						<div>
							<div class="col">
								<select name="mapSelector" id="mapSelector">
									<option disabled selected value>Select a Map</option>
								</select>
								<p>
									<label for="ou_level_slider">OrgUnit levels:</label>
									<input type="text" id="ou_level_slider" readonly style="border:0; color:#f6931f; font-weight:bold;  width:260px ">
									<div id="slider_range"></div>
								</p>
								<select name="mapStyleSelector" id="mapStyleSelector"></select>
								<p> Opacity:
									<div id="opacity_slider"><div id="opacity_slider_handle" class="ui-slider-handle"></div></div>
								</p>
								<p> Height:
									<div id="height_slider"><div id="height_slider_handle" class="ui-slider-handle"></div></div>
								</p>
								<p>	Width:
									<div id="width_slider"><div id="width_slider_handle" class="ui-slider-handle"></div></div>
								</p>
								<button id="updateMapButton" class="ui-button ui-widget ui-corner-all">Update Map</button>
							</div>
							<div class="col">
								<p>
									<select name="legendSelector" id="legendSelector">
									<option disabled selected value>Select a Legend</option>
									</select>
								</p>
								<p><select name="positionLegendSelector" id="positionLegendSelector"></select></p>
								<p> Font size :
									<div id="font_size_slider"><div id="font_size_slider_handle" class="ui-slider-handle"></div></div>
								</p>
								<p><button id="updateLegendButton" class="ui-button ui-widget ui-corner-all">Update Legend</button></p>
								<p>
									<fieldset>
										<legend>Resize Nota Bene for Maps: </legend>
										<label for="disableNBMaps">Disabled</label>
										<input type="radio" name="NBMaps" class="radioButton" id="disableNBMaps">
										<label for="enableNBMaps">Enabled</label>
										<input type="radio" name="NBMaps" class="radioButton" id="enableNBMaps">
									</fieldset>
								</p>
								<p>
									<fieldset>
										<legend>Resize Nota Bene: </legend>
										<label for="disableNB">Disabled</label>
										<input type="radio" name="NB" class="radioButton" id="disableNB">
										<label for="enableNB">Enabled</label>
										<input type="radio" name="NB" class="radioButton" id="enableNB">
									</fieldset>
								</p>
												
							</div>
							<div id="legendPool" class="col">
								<div id="legendSet0" class="legendSet" ></div>
								<div id="legendSet1" class="legendSet" ></div>
								<div id="legendSet2" class="legendSet" ></div>
								<div id="legendSet3" class="legendSet" ></div>	
							</div>

						</div>

					</fieldset>
				</div>
				<div id="tabs-4">
					<div class="FixedHeightContainer">
						<div class="Content">
							<h6 class="subHeader">Stored footnotes</h6>
							<ul id="sortable1" class="connectedSortable">
							</ul>
						</div>
						<div class="Content"> 
							<h6 class="subHeader">Footnotes page 1</h6>
							<ul id="sortable2" class="connectedSortable">
							</ul>
						</div>
						<div class="Content">
							<h6 class="subHeader">Footnotes page 2</h6>
							<ul id="sortable3" class="connectedSortable">
							</ul>
						</div>
					</div>
					<button id="newfootnote" class="ui-button ui-widget ui-corner-all">
						<span class="ui-icon ui-icon-document"></span> Add new footnote
					</button>
					<div id="newFootnoteText" style="display:none"></div>

				</div>
				<div id="tabs-5">
				Download here the LCPG manual: 
                        <a href="files/user_manual_2019_10_30.pdf" target="_blank"><img src="img/icons/pdf.png" border=0></a>
				</div>
			</div>
			<hr>
		</div>


		<div class="section">
			<img class="head_logo center" src="https://www.who.int/about/Logo-WHO.jpg" />

			<div class="head_container">	
				<div class="editableElement">Leishmaniasis</div>
				<div class="center_text editableElement" id="country_name"></div>
				<div class="align_to_right">
					<div class="editableElement" id="year"></div>
					<div class="editableElement comment" id="published_date"></div>
				</div>
			</div>
		</div>

		<div class="section">
			<h4 class="editableElement footnotable">COUNTRY GENERAL INFORMATION</h4>
			<div class="twoColumns"><table id="cgiTable" class="display" cellspacing="0" width="100%">
					<thead>
						<tr id ="cgiTableHead"></tr>
					</thead>
					<tbody id="cgiTableBody"></tbody>
			</table></div>
		</div>

		<div class="section">
			<h4 class="editableElement footnotable">EPIDEMIOLOGY</h4>

			<table id="epiTable" class="display" cellspacing="0" width="100%">
					<thead>
						<tr id ="epiTableHead"></tr>
					</thead>
					<tbody id="epiTableBody"></tbody>
			</table>
			<div id="textUnderEpiTable" class="textUnderTable"></div>
		</div>

		<div class="section">
			<h4 class="editableElement footnotable" >Monthly distribution of new cases January-December</h4>

			<table id="monthlyTable" class="display" cellspacing="0" width="100%">
					<thead>
						<tr id ="monthlyTableHead"></tr>
					</thead>
					<tbody id="monthlyTableBody"></tbody>
			</table>

		</div>

		<div>
			<canvas class="sameLine draggable chart" id="chart0" width="425" height="260" ></canvas>
			<canvas class="sameLine draggable chart" id="chart1" width="425" height="260" ></canvas>
			<canvas class="sameLine draggable chart" id="chart2" width="425" height="260" ></canvas>
		</div>
		<div>
			<canvas class="sameLine draggable chart" id="chart3" width="425" height="260" ></canvas>
			<canvas class="sameLine draggable chart" id="chart4" width="425" height="260" ></canvas>
			<canvas class="sameLine draggable chart" id="chart5" width="425" height="260" ></canvas>
		</div>

		<div class="section">
			<hr>
			<div id="footnotes1"></div>
		</div>

		<div class="pagebreak"></div>

		<div class="section">
			<h4 class="editableElement footnotable" >Distribution of <span style="color:red" id ="mapsTitle"></span> cases per 10 000 population</h4>
			<div class="sameLine map"> <div id="map0" class="sameLine draggable"></div></div>
			<div class="sameLine map"><div id="map1" class="sameLine draggable"></div></div>
			<div class="sameLine map"><div id="map2" class="sameLine draggable"></div></div>
			<div class="sameLine map"><div id="map3" class="sameLine draggable"></div></div>
			<div id="notaBeneMaps"  class="notasBene draggable"><div class="editableElement"></div></div>
		</div>


		<div class="section">
			<h4 id="casTitle" class="editableElement footnotable" >CONTROL AND SURVEILLANCE</h4>
			<div class="twoColumns"><table id="casTable" class="display" cellspacing="0" width="100%">
					<thead>
						<tr id ="casTableHead"></tr>
					</thead>
					<tbody id="casTableBody"></tbody>
			</table></div>

		</div>

		<div class="section">
			<h4 class="editableElement footnotable" >DIAGNOSIS</h4>

			<table id="diagTable" class="display" cellspacing="0" width="100%">
					<thead>
						<tr id ="diagTableHead"></tr>
					</thead>
					<tbody id="diagTableBody"></tbody>
			</table>
			<div id="textUnderDiagTable1" class="textUnderTable"></div>
			<div id="textUnderDiagTable2" class="textUnderTable"></div>


		</div>


		<div class="section">
			<h4 id="tamTitle" class="editableElement footnotable" >TREATMENT AND MEDICINES</h4>

			<table id="tamTable" class="display" cellspacing="0" width="100%">
					<thead>
						<tr id ="tamTableHead"></tr>
					</thead>
					<tbody id="tamTableBody"></tbody>
			</table>
			<br>
			<table id="toutcomeTable" class="display" cellspacing="0" width="100%">
					<thead>
						<tr id ="toutcomeTableHead"></tr>
					</thead>
					<tbody id="toutcomeTableBody"></tbody>
			</table>
		</div>

		<div class="section">
			<hr>
			<div id="footnotes2"></div>
			<div id="notaBene"  class="notasBene draggable"><div class="editableElement"></div></div>

		</div>
	</div>



	<div id="dialog-editor">
		<textarea id="editor"></textarea>
	</div>



	<div class="form-popup" id="country-selector">
		<form action="javascript:checkMetadataAssignedToThisCountry()" class="form-container">
	  
		  <h2><div class="formTitle">Generate <br> Country Profile </div></h2>
	  
	  
		  <label for="yearField"><b>Year</b></label>
		  <input id="yearField" type="text" placeholder="Enter and select country name" name="yearField" required>
	  
	  
		  <label for="targetCountry"><b>Country</b></label>
		  <input  id="targetCountry" type="text" placeholder="Enter and select country name" name="targetCountry" required>
							
		  <div id= "metadataFeedback"></div>
		  <button type="submit" class="btn">Start preparing CP</button>

		</form>
	</div>

	<!--
	<div id="dialog-country-selector" title="Select country and year">
		<div id="country-selector" ></div>
			Year: 
		<input id="yearField">
										
		<div class="ui-widget">
			<label for="targetCountry">Country: </label>
			<input id="targetCountry">
		</div>
								
	</div>
-->
</body>
</html>