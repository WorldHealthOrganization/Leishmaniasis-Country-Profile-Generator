<!--
	test git 
	/****************************************************************************************************
 	 **********		   																		   **********
 	 **********                      Report App for DHIS2 Leishmaniasis 2017               	   **********
 	 **********		   																		   **********
	 ****************************************************************************************************/


	 	* @author  Ramon Jose Jimenez Pomareta 
		* @email ramon@pomareta.ch
 		* @version 1.0 
		* @date 26/04/2017


		* Some comments
			Since this App has to be made in only one file, all is here.
			When needed external js plugins, i.e. jquery-te and jquery-ui, I have stored a version in 
			https://github.com/Rjjp/plugins
			In order to share raw files, I have used https://rawgit.com/


		* Sections of the code. 
		1. CSS styles
		2. JavaScript    
			JavaScript imports
			CSS imports
			CONSTANTS
			STATIC CONTENT FUNCTIONS
			FUNCTIONS CALLING THE API 
			FILLING LOGICAL STRUCTURES (ARRAYS)
			AUXILIARY FUNCTIONS
			CHARTS FUNCTIONS
			FOOTNOTES FUNCTIONS
			EDITOR
			LISTENER
			ENTRY POINT
		3. HTML Code

-->

<!-- 

/****************************************************************************************************
 **********		   																		   **********
 **********                            		2. JavaScript                                  **********
 **********		   																		   **********
 ****************************************************************************************************/
	
/****************************************************************************************************
 **********                             JavaScript imports                                 **********
 ****************************************************************************************************/
 -->
 <script
  src="https://code.jquery.com/jquery-2.2.4.min.js"
  integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44="
  crossorigin="anonymous"></script>
<script type="text/javascript" src ="js/jquery-te-1.4.0-oms.js"></script>
<script type="text/javascript" src ="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js">//TODO:use the cdn officiel</script>
<script type="text/javascript" src="../../../dhis-web-visualizer/chart.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.js"></script>
<script type="text/javascript" src="../../../dhis-web-commons/javascripts/ext/ext-all.js"></script>
<script type="text/javascript" src="../../../dhis-web-mapping/map.js"></script>
<script type="text/javascript" src="commons/api.js"></script>
<script type="text/javascript" src="commons/feedbacks.js"></script>
<script type="text/javascript" src="commons/inputControl.js"></script>
<script type="text/javascript" src="commons/progressBar.js"></script>
<script type="text/javascript" src="commons/tools.js"></script>



<!--
<script type="text/javascript" src="https://dhis2-cdn.org/v222/openlayers/OpenLayers.js"></script>
<script type="text/javascript" src="https://maps.google.com/maps/api/js?sensor=false"></script>
-->

<script type="text/javascript">

	
	/****************************************************************************************************
	 **********                               CSS imports    		                           **********
	 ****************************************************************************************************/

	/****************************************************************************************************
 	 **********                      	       CONSTANTS            	              	       **********
	 ****************************************************************************************************/
	var DATA_VALUE_SETS = "dataValueSets";

	var ANALYTICS = "analytics";
	var EVENTS = "events";
	var WHEN_UNDEFINED = "No data";
	var WHEN_NON_APPLICABLE = "N/A";
	var WHEN_DIV_0 = "-";
	var ERROR = "Error!";

	var HISTORIC_DEFAULT_VALUE = 15;

	var BOTTOM_LINE_CLASS = "bottom_line";

	var VALUE_KEY = "value";
	var CC_KEY = "categoryOptionCombo";
	var DE_KEY = "dataElement";
	var PERIOD_KEY = "period";

	var LABELS_ON_ROWS = 0;
	var LABELS_ON_COLUMNS = 1;

	/* config subnational level */

	var LEVEL1 = 0;
	var LEVEL2 = 1;
	var LEVEL3 = 2;
	var LEVEL_CONFIG_LABELS = new Array(3);
	var LEVEL_REPORT_LABELS = new Array(3);
	LEVEL_CONFIG_LABELS[LEVEL1] = "1st sub-national administrative level";
	LEVEL_CONFIG_LABELS[LEVEL2] = "2nd sub-national administrative level";
	LEVEL_CONFIG_LABELS[LEVEL3] = "3rd sub-national administrative level";
	LEVEL_REPORT_LABELS[LEVEL1] = "Number of 1st sub-national administrative level<br>divisions, name:";
	LEVEL_REPORT_LABELS[LEVEL2] = "Number of 2nd sub-national administrative level<br>divisions, name:";
	LEVEL_REPORT_LABELS[LEVEL3] = "Number of 3rd sub-national administrative level<br>divisions, name:";

	/* Texts on report */
	var PUBLISHED_TEXT = "Published in ";
	var VL_CHART_LEGEND = "VL ";
	var CL_CHART_LEGEND = "CL ";	
	var ACL_CHART_LEGEND = "ACL ";
	var ZCL_CHART_LEGEND = "ZCL ";
	var TOUTCOME_TABLE_FIRST_COLUMNS = "TREATMENT OUTCOME";

	var CHART_CHECKBOXES_LABELS = ["CL monthly", "AZCL monthly", "VL monthly", "CL yearly", "AZCL yearly", "VL yearly" ];


	var VL_CHART_CASES_LEGEND = "VL cases";
	var CL_CHART_CASES_LEGEND = "CL cases";
	var ACL_CHART_CASES_LEGEND = "ACL cases";
	var ZCL_CHART_CASES_LEGEND = "ZCL cases";
	var VL_CHART_INCIDENCE_LEGEND = "VL incidence rate";
	var CL_CHART_INCIDENCE_LEGEND = "CL incidence rate";
	var ACL_CHART_INCIDENCE_LEGEND = "ACL incidence rate";
	var ZCL_CHART_INCIDENCE_LEGEND = "ZCL incidence rate";

	var MONTHS = [	"January",
					"February",
					"March",
					"April",
					"May",
					"June",
					"July",
					"August",
					"September",
					"October",
					"November",
					"December" ];

	var MONTHS_ABBREV = [	"JAN",
							"FEB",
							"MAR",
							"APR",
							"MAY",
							"JUN",
							"JUL",
							"AUG",
							"SEP",
							"OCT",
							"NOV",
							"DEC"];

	var COLORS = {
		green : 'rgba(153, 204, 0, 1)',
		soft_green : 'rgba(153, 204, 0, 0.2)',
		blue: 'rgba(51, 153, 255, 1)',
		soft_blue: 'rgba(51, 153, 255, 0.2)',
		violet :'rgba(153, 0, 255, 1)',
		soft_violet :'rgba(153, 0, 255, 0.2)'
	}

	CL_CASES_CHART_TITLE = "Number of new CL cases reported by month in ";
	VL_CASES_CHART_TITLE = "Number of new (primary) VL cases reported by month in ";
	CL_CASES_CHART_Y_TITLE = "Number of new CL cases";
	VL_CASES_CHART_Y_TITLE = "Number of new (primary) VL cases";

	CL_INCIDENCE_CHART_TITLE = "Number of cases and incidence rate of CL";
	VL_INCIDENCE_CHART_TITLE = "Number of cases and incidence rate of VL";
	CL_INCIDENCE_CHART_Y1_TITLE = "Number of CL cases";
	VL_INCIDENCE_CHART_Y1_TITLE = "Number of VL cases";
	CL_INCIDENCE_CHART_Y2_TITLE = "Incidence rate (/10 000)";
	VL_INCIDENCE_CHART_Y2_TITLE = "Incidence rate (/10 000)";


	// For configure mixed charts
	var DATASID = {
			LEFT: "left",
			RIGHT: "right"
	}


	/* Country General Information Texts */
	
	var CIG_ROW_POP = 0;
	var CIG_ROW_SEX = 1;
	var CIG_ROW_GDP = 2;
	var CIG_ROW_INCOME = 3;
	var CIG_ROW_AGEG = 4;
	var CIG_ROW_LIFE = 5;
	var CIG_ROW_DIVIS = 6;

	var CGI_LABELS = [	"Total population:",
						"Gender (%, F/M):",
						"GDP (PPP int $):",
						"Income status:",
						"Age group <15/> 14 years, %: ",
						"Life expectancy at birth in years (F/M):",
						"Number of 2nd sub-national administrative level<br>divisions, name:"
						];

	var LINES_BELOW_LABELS_CGI = [true,true,true,false,true,true,true];
	var generalInformationArray = create_2_dim_array(CGI_LABELS.length, CGI_LABELS, LABELS_ON_COLUMNS);

	/* Epidemiology table constants */
	var FIRST_COLUMN = 0;
	var VL_COLUMN = 1;
	var CL_COLUMN = 2;
	var ACL_COLUMN = 3;
	var ZCL_COLUMN = 4;
	var PKDL_COLUMN = 5;
	var MCL_COLUMN = 6;

	var COLUMNS_LABELS = [ 	"VL",
							"CL",
							"ACL",
							"ZCL",
							"PKDL",
							"MCL"
							];
	var COLUMNS_LABELS_DESC = [ 	"visceral leishmaniasis",
									"cutaneous leishmaniasis",
									"anthroponotic cutaneous leishmaniasis",
									"zoonotic cutaneous leishmaniasis",
									"post-kala-azar dermal leishmaniasis",
									"mucocutaneous leishmaniasis"
									];


	var ENDEMICITY_ROW = 0;
	var NEW_ROW = 1;
	var RELAPSE_ROW = 2;
	var TOTAL_ROW = 3;
	var IMPORTED_ROW = 4;
	var SEX_ROW = 5;
	var AGE_ROW = 6;
	var INCD_ROW = 7;
	var THIRD_LEVEL_ROW = 8;
	var RISK_ROW = 9;
	var OUTBK_ROW = 10;
	var FOCI_ROW = 11;

	var rowTitles = [	"Endemicity status:",
						"Number of new cases (incidence):",
						"Number of relapse cases:",
						"Total number of cases:",
						"Imported cases (#, %):",
						"Gender distribution (%F):",
						"Age group distribution (%, <5/5-14/>14):",
						"Incidence rate (cases/10 000 population in endemic areas):",
						"Number of endemic 3rd sub-national administrative level divisions (n):",
						"Population at risk (%, n/total):",
						"Was there any outbreak?",
						"Number of new foci:"
						];
	var LINES_BELOW_LABELS_EPI = [true,false,false,true,true,false,true,false,false,true,false,true];
	var array = create_2_dim_array(rowTitles.length, rowTitles, LABELS_ON_COLUMNS);

	/* Monthly distribution table constants */
	var VL_ROW = 0;
	var CL_ROW = 1;
	var VL_PREVIOUS_YEAR_ROW = 2;
	var CL_PREVIOUS_YEAR_ROW = 3;
	var ACL_ROW = 4;
	var ZCL_ROW = 5;
	var ACL_PREVIOUS_YEAR_ROW = 6;
	var ZCL_PREVIOUS_YEAR_ROW = 7;

	var MONTHLY_LABELS = ["VL",
							"CL",
							"VL (previous year)",
							"CL (previous year)",
							"ACL",
							"ZCL",
							"ACL (previous year)",
							"ZCL (previous year)"
							];
	var LINES_BELOW_LABELS_MONTHLY = [true,true,true,true,true,true,true,true];

	var monthlyArray = create_2_dim_array(MONTHLY_LABELS.length, MONTHLY_LABELS, LABELS_ON_COLUMNS);

	/* Maps */
	var VL_INDEX = 0;
	var CL_INDEX = 1;
	var ACL_INDEX = 2;
	var ZCL_INDEX = 3;
	
	var MAP_CHECKBOXES_LABELS = new Array(4);
	MAP_CHECKBOXES_LABELS[VL_INDEX] = "VL incidence";
	MAP_CHECKBOXES_LABELS[CL_INDEX] = "CL incidence";
	MAP_CHECKBOXES_LABELS[ACL_INDEX] = "ACL incidence";
	MAP_CHECKBOXES_LABELS[ZCL_INDEX] = "ZCL incidence";

	var GOOGLE_STREETS = 0;
	var GOOGLE_HYBRID = 1;
	var OPEN_STREETS = 2;
	var OSM_LIGHT = 3;
	var FACILITY = 4;

	var MAP_STYLE = new Array(4);
	var MAP_STYLE_LABELS = new Array(4);

	MAP_STYLE [GOOGLE_STREETS] = "googleStreets";
	MAP_STYLE [GOOGLE_HYBRID] = "googleHybrid";
	MAP_STYLE [OPEN_STREETS] = "openStreetMap";
	MAP_STYLE [OSM_LIGHT] = "osmLight";
	MAP_STYLE [FACILITY] = "facility";
	
	MAP_STYLE_LABELS [GOOGLE_STREETS] = "Google Streets";
	MAP_STYLE_LABELS [GOOGLE_HYBRID] = "Google Hybrid";
	MAP_STYLE_LABELS [OPEN_STREETS] = "Open Street Map";
	MAP_STYLE_LABELS [OSM_LIGHT] = "OSM Light";
	MAP_STYLE_LABELS [FACILITY] = "Facility";

	var VL_LEGEND = "gUOjExXros1";
	var CL_LEGEND = "TnU2O8YxH51";
	var ACL_LEGEND = "clwSlrqvmMx";
	var ZCL_LEGEND = "TbrqpLWzLS8";

	var initalMapDiv = new Array(4);
	var mapLegends = new Array(4);
	var map_levels = [3, 4, 5];
	var map_opacity = 80;
	var map_height = 315;
	var map_width = 420;

	var TOP_LEFT = 0;
	var TOP_RIGHT = 1;
	var BOTTOM_LEFT = 2;
	var BOTTOM_RIGHT = 3;

	var LEGEND_TO_REPORT = 0;
	var LEGEND_TO_LEGEND_POOL = 1;

	var LEGEND_POSITION_LABELS = new Array(4);
	var LEGEND_POSITIONS = new Array(4);

	LEGEND_POSITION_LABELS[TOP_LEFT] = "Top left corner";
	LEGEND_POSITION_LABELS[TOP_RIGHT] = "Top right corner";
	LEGEND_POSITION_LABELS[BOTTOM_LEFT] = "Bottom left corner";
	LEGEND_POSITION_LABELS[BOTTOM_RIGHT] = "Bottom right corner";

	LEGEND_POSITIONS[TOP_LEFT] = ".leaflet-top.leaflet-left";
	LEGEND_POSITIONS[TOP_RIGHT] = ".leaflet-top.leaflet-right";
	LEGEND_POSITIONS[BOTTOM_LEFT] = ".leaflet-bottom.leaflet-left";
	LEGEND_POSITIONS[BOTTOM_RIGHT] = ".leaflet-bottom.leaflet-right";

	var editingLegend;
	var font_size_slider = $( "#font_size_slider" );
	var font_size_slider_handle = $( "#font_size_slider_handle" );


	/* Control and surveillance table */
	var CAS_ROW_LNCP = 0;
	var CAS_ROW_TYPE = 1;
	var CAS_ROW_PROGRAMME = 2;
	var CAS_ROW_IRS = 3;
	var CAS_ROW_GUIDELINES = 4;
	var CAS_ROW_NOTIF = 5;
	var CAS_ROW_RESER = 6;
	var CAS_ROW_FACIL_D = 7;
	var CAS_ROW_FACIL_T = 8;
	var CAS_ROW_FREE = 9;
	
	var CAS_LABELS = [	"Year Leishmaniasis National Control<br>Programme (LNCP) was established:",
						"Type of surveillance:",
						"Is there a vector control programme?",
						"Type of insecticide used for IRS:",
						"Year latest national guidelines were published:",
						"Is leishmaniasis notifiable (mandatory reporting)?",
						"Is there a reservoir host control programme?",
						"Number of leishmaniasis health facilities (diagnosis):",
						"Number of leishmaniasis health facilities (treatment):",
						"Is treatment provided for free in the public sector?"
						];
	var LINES_BELOW_LABELS_CAS = [true,true,true,true,false,true,true,false,true,true];
	var controlArray = create_2_dim_array(CAS_LABELS.length, CAS_LABELS, LABELS_ON_COLUMNS);



	/* Diagnosis table */

	var SCREENED_ACTIVELY_ROW = 0;
	var SCREENED_PASSIVELY_ROW = 1;
	var VL_CASES_DIAGNOSED_ROW = 2;
	var POSITIVE_RDT_ROW = 3;
	var DIRECT_EXAM_DIAGNOSED_ROW = 4;
	var POSITIVE_DIRECT_EXAM_ROW = 5;
	var CLINICALLY_DIAGNOSED_ROW = 6;
	var HIV_COINFECTION_ROW = 7;

	var diagnosisLabels = [	"Number of people screened actively for:",
							"Number of people screened passively for:",
							"VL cases diagnosed by RDT<sup>*</sup><br>(%, RDT+/total VL cases):",
							"Proportion of positive RDT<sup>*</sup><br>(%, RDT+/total RDT):",
							"Cases diagnosed by direct exam<br>(parasitology) (%, # slides +/total cases):",
							"Proportion of positive slides<br>(%, # slides +/total slides):",
							"Cases diagnosed clinically<br>(%, # clinical cases/total cases): ",
							"Percentage of cases with HIV-VL coinfection:"
							];


	var DIAG_LEGEND_LABELS = [ 	"VL",
								"CL",
								"ACL",
								"ZCL",
								"PKDL",
								"MCL"
							];
	var DIAG_LEGEND_LABELS_DESC = [ "visceral leishmaniasis",
									"cutaneous leishmaniasis",
									"anthroponotic cutaneous leishmaniasis",
									"zoonotic cutaneous leishmaniasis",
									"post-kala-azar dermal leishmaniasis",
									"mucocutaneous leishmaniasis"
									];

	var DIAG_LEGEND_LABELS_2 = [	"RDT",
									"HIV",
									"MCL"
									];

	var DIAG_LEGEND_LABELS_DESC_2 = [ 	"rapid diagnostic rest",
										"human immunodeficiency virus",
										"mucocutaneous leishmaniasis"
										];

	var DIAG_ASTERISK_RDT_COMMENT = "<span><sup>*</sup> These indicators apply only for primary VL cases</span>";
	var PUT_NA_TEXT = true;

	var LINES_BELOW_LABELS_DIAG = [false,true,false,true,false,false,true,true];

	var diagnosisArray = create_2_dim_array(diagnosisLabels.length, diagnosisLabels, LABELS_ON_COLUMNS);

	/* Treatment and medicines table*/
	var TAM_ROW_FREEOFCHARGE = 0;
	var TAM_ROW_ANTILEISHMANIAL = 1;
	var TAM_LABELS = [	"Is treatment provided free of charge in the public sector?",
						"Antileishmanial medicines included in the national List of Essential Medicines:"
						];
	var LINES_BELOW_LABELS_TAM = [true,true];
	var tamArray = create_2_dim_array(TAM_LABELS.length, TAM_LABELS, LABELS_ON_COLUMNS);

	/* Treatment outcome table */
	
	var RELAPSE_PROPORTION_ROW = 0;
	var INITIAL_CURE_RATE_ROW = 1;
	var FAILURE_RATE_ROW = 2;
	var CASE_FATALITY_ROW = 3;

	var toutcomeLabels = [ "Proportion of relapse cases:",
							"Initial cure rate:",
							"Failure rate:",				
							"Case-fatality rate:"
							];
	var LINES_BELOW_LABELS_TREAT = [true, false, false, true];
	var toutcomeArray = create_2_dim_array(toutcomeLabels.length, toutcomeLabels, LABELS_ON_COLUMNS);
	
	var historicLength = HISTORIC_DEFAULT_VALUE;
	var historicIncidence = create_2_dim_array(5,"",LABELS_ON_ROWS);
	var historicNewCases = create_2_dim_array(5,"",LABELS_ON_ROWS);


	var DATASET = {
		CL : "tnek2LjfuIm",
		VL : "fdBM4sWSuPR",
		AZCL : "Uc3j0vpsfSB", 
		CL_MONTHLY : "pWGPGaE6knJ",
		VL_MONTHLY : "GW4lVTTLWfW",
		AZCL_MONTHLY : "YfnF9NPpP4c",
		DAM : "qzlf5flidcm"

	};
	// DATA_ELEMENTS
	var DE = {
		CL_EPI_Type :   "EPw6gR9fDqt",
		VL_EPI_Type :	"IxbBQzytPgv",
		ACL_EPI_Type : 	"f1bBSpuIyzD",
		ZCL_EPI_Type : 	"Ta96pnXcAum",
		MCL_EPI_Type : 	"K8k1LRZagmc",
		VL_LAB_RDT_tested_type : "rFy4bKMa977",
		VL_LAB_parasito_tested_type : "RrKpXTbayoB",
		VL_LAB_parasito_result_type : "Qc7ujS567UL",
		VL_LAB_clinical : "BAsexzzzJZC",
		VL_LAB_HIVstatus_Type : "NTo887FeHdI",
		PKDL_GEN_EPID_cases : "NdbsWSygpqz",
		MCL_GEN_EPID_cases : "K8k1LRZagmc",
		PKDL_EPID_sex: "ipWXN3NeXac",
		PKDL_EPID_age : "rw4tu6PNGKO",
		PKDL_LAB_HIV: "sxjZutF1AMx",
		VL_TREATMENT_OUTCOME: "eh7Lbb7Rslc",
		UNS_ANTIL_LEM : "aPl9zoV5ZIV",
		UNS_FREE_TREATMENT : "Ycax41CQNec",
		UNS_USE_PREVIOUS_DATA : "ZjIDKHFwMUw"
	};

	var DE_SCREEN_ACTIVE = {};
	DE_SCREEN_ACTIVE[VL_COLUMN] = "g6yIwTl0sHx";
	DE_SCREEN_ACTIVE[CL_COLUMN] = "c5Zvvh9AWB4";
	DE_SCREEN_ACTIVE[ACL_COLUMN] = "hqgnicLioSz";
	DE_SCREEN_ACTIVE[ZCL_COLUMN] = "NDNcasRLz01";

	var DE_SCREEN_PASSIVE = {};
	DE_SCREEN_PASSIVE[VL_COLUMN] = "MRFflirvoj4";
	DE_SCREEN_PASSIVE[CL_COLUMN] = "jdQau4rlj73";
	DE_SCREEN_PASSIVE[ACL_COLUMN] = "gZuua8o0gNS";
	DE_SCREEN_PASSIVE[ZCL_COLUMN] = "yEmHARyqLIk";


	var CC_DEFAULT = "Xr12mI7VPn3";
	var TYPE_NEW_CASES = "psVSPLclyFj";
	var TYPE_RELAPSE = "KPn9RHNrd8R";
	var TYPE_UNSPECIFIED = "IRW4YrOtk5q";

	var NEW_MALE = "GpQZH8hC7jY";
	var NEW_FEMALE = "TtoYCIVcBA3";
	var NEW_UNKNOWN = "FaYhAlKLX16";
	var REL_MALE = "UG7PsogfDYz";
	var REL_FEMALE = "OmkgX8Kkurn";
	var REL_UNKNOWN = "Ng311XPZTbv";
	var UNS_MALE = "aWWYWv6buzp";
	var UNS_FEMALE = "wGED4K5Bs37";
	var UNS_UNKNOWN = "zkKbIIarKWM";

	var FEMALE = "V2LdgcGgFQt";
	var MALE = "Z2hvpF7mhh7";
	var UNKNOWN_SEX = "jNbFhhnUsQv";

	var AGE_5 = "HDXcEOGT2s1";
	var AGE_5_14 = "DOJartWGuff";
	var AGE_14 = "vJEPLhdauF7";
	var AGE_UNKNOWN = "kek1YXjDq70";

	var NEW_UNDER_5 = "hKq5WASZw8q";
	var NEW_5_14 = "mTyLqDjpQ5b";
	var NEW_OVER_14 = "DDliBAHqwGV";
	var NEW_AGE_UNKNOWN = "dVuOzmU4xbI";
	var REL_UNDER_5 = "NlAMTGlJ7b3";
	var REL_5_14 = "a1GEE4dBKZ8";
	var REL_OVER_14 = "xxrYh49wmnD";
	var REL_AGE_UNKNOWN = "zuuSkk9CiNB";
	var UNS_UNDER_5 = "rZwYGlqR8GG";
	var UNS_5_14 = "P6R9XEaqQbz";
	var UNS_OVER_14 = "UQMTeRPY2U0";
	var UNS_AGE_UNKNOWN = "nIbrdHllMKh";

	var ORIGIN_AUTOC_NEW = "WynvvdELtqm";
	var ORIGIN_AUTOC_REL = "LUVeZjOsibr";
	var ORIGIN_AUTOC_UNS = "wYB0E3USJ7L";
	var ORIGIN_IMPORT_NEW = "pWZT12mjhUC";
	var ORIGIN_IMPORT_REL = "QO2kKL8ySPc";
	var ORIGIN_IMPORT_UNS = "A5TSwm9Wivn";
	var ORIGIN_UNKNOWN_NEW = "Lx8tyhhseZZ";
	var ORIGIN_UNKNOWN_REL = "lGFgLYweSNS";
	var ORIGIN_UNKNOWN_UNS = "EGvT9lj2BOy";

	/* Diagnosis DataElements */
	//o1smtpQE1tm
	var POSITIVE_NEW = "jRcT6HVKb2t";
	var POSITIVE_RELAPSE = "QKqVJ13mGZI";
	var POSITIVE_UNSP = "YXktM46YiXo";

	/* Treatment Category options*/

	var NEW_CURED = "UnXwCSYnnvT";
	var NEW_RELOUT = "HjLmlc308bk";
	var NEW_DEAD = "SWQatS9z4sL";
	var REL_CURED = "a6I7BzjrnmJ";
	var REL_RELOUT = "j7RGAw4zpVi";
	var REL_DEAD = "iML4aJx17bq";
	var UNS_CURED = "SZiY6xiTgy6";
	var UNS_RELOUT = "D08F1WAa6x6";
	var UNS_DEAD = "qAneJjz2lLH";

	/* Indicators*/
	var INCIDENCE = new Array(4);
	INCIDENCE[VL_INDEX] = "znrCp1SsKA8";
	INCIDENCE[CL_INDEX] = "aZQ1Cmgvnnn";
	INCIDENCE[ACL_INDEX] = "J6grbcheses";
	INCIDENCE[ZCL_INDEX] = "nFdRbLa6cj6";

	/* Events Programs*/

	var PR_LEISHMANIASIS = "Cp9FLBrMK3z";
	var FOOTNOTE_PROGRAM = "NVUlJzIakuO";


	var Leish_PROG_outbreak_VL = "LAoaCOjm1Hh";
	var Leish_PROG_outbreak_CL = "CaIjvfbG8IX";
	var Leish_PROG_newfoci_VL = "IdqQo9DBLek";
	var Leish_PROG_newfoci_CL = "X5cOiCBAVwe";
	var Leish_PROG_notifiable = "hjKuzePrJxM";
	var Leish_PROG_surveillance = "fsrINvFJez6";
	var Leish_PROG_surveillance_private = "DuqsDgyQM1L";
	var Leish_PROG_vectorControl = "pZezLr9qAs6";
	var Leish_PROG_vectorControl_ITN = "xVElTlorOHs";
	var Leish_PROG_vectorControl_IRS = "b4RbLFKhbLG";
	var Leish_PROG_IRS_insecticide = "zw2eJWO7Jj7";
	var Leish_PROG_IRS_integrated = "mZ9qCbGp0fQ";
	var Leish_PROG_vectorControl_EnvM = "kTarSQJ3s78";
	var Leish_PROG_vectorControl_Other = "xbHi2a9Kozj";
	var Leish_PROG_reservoirControl = "fED4Gk3zMLd";
	var Leish_PROG_NbLeishHF_Dx = "DhDfyUo3Zc7";
	var Leish_PROG_NbLeishHF_Tx = "M4kwSPihMPd";
	var Leish_PROG_Tx_free = "HyuWmbIIhve";
	var Leish_PROG_MedList_AmphotB = "PY8IWZKCkVv";
	var Leish_PROG_MedAvail_AmphotB = "eNYVU0xHAVA";
	var Leish_PROG_MedList_LiposoB = "ivpC92bcEks";
	var Leish_PROG_MedAvail_LiposoB = "QabUgQwlLFA";
	var Leish_PROG_MedList_MegAntimo = "ZfvQnbMjt05";
	var Leish_PROG_MedAvail_MegAntimo = "uXSw8gECtG4";
	var Leish_PROG_MedList_Miltefo = "TLaxUgOnjB5";
	var Leish_PROG_MedAvail_Miltefo = "JRJqXJIrDJv";
	var Leish_PROG_MedList_SSG = "OsifTHIUDwH";
	var Leish_PROG_MedAvail_SSG = "nez8QCLHo47";
	var Leish_PROG_LNCP_Year = "POg6OTIF5cT";
	var Leish_PROG_guidelines_year = "LzpzN2lDa2J";
	var Leish_PROG_failure_VL = "QLua1huBl2j";
	var Leish_PROG_relapse_VL = "raOths7lqh1";
	var Leish_PROG_relapse_CL = "yOMQ6PsnoU4";
	var Leish_PROG_MedAvail_Paramo = "xGChEADcavt";
	var Leish_PROG_MedAvail_Penta = "tmkNB5FZdWx";
	var Leish_PROG_MedList_Paramo = "EQ2Vi7oIFSC";
	var Leish_PROG_MedList_Penta = "Wu6U3ASLTUl";
	var Leish_PROG_guidelines = "je5s4nR4uSM";


	var RG_footnote_active = "GBOpGIZ0QDU";
	var RG_footnote_page = "SrHddMhflZZ";
	var RG_footnote_text = "rWAis0fAWw9";

	var date, year, orgUnit, country_name, params;
	var builtUrl;

	var acl_and_zcl_activated = false;

	var editingElement;

	var footNoteCounter = 0;
	
	/* Classes */

	var CLASS_EDITABLE_ELEMENT = "editableElement";
	var CLASS_FOOTNOTABLE_ELEMENT = "footnotable";

	/* HTML elements */
	var cgiTable = 	$("#cgiTable");
	var cgiTableBody = 	$("#cgiTableBody");
	var cgiTableHead = 	$("#cgiTableHead");

	var epiTable = 	$("#epiTable");
	var epiTableBody = 	$("#epiTableBody");
	var epiTableHead = 	$("#epiTableHead");

	var monthlyDistributionTableBody = $("#monthlyDistributionTableBody");
	var monthlyDistributionTableHead = $("#monthlyDistributionTableHead");

	var casTable = 	$("#casTable");
	var casTableBody = 	$("#casTableBody");
	var casTableHead = 	$("#casTableHead");

	var diagTableBody = $("#diagTableBody");
	var diagTableHead = $("#diagTableHead");

	var tamTableBody = $("#tamTableBody");
	var tamTableHead = $("#tamTableHead");
	var toutcomeTableBody = $("#toutcomeTableBody");
	var toutcomeTableHead = $("#toutcomeTableHead");

	var editor = $("#editor");

	var sortableListNotSelected = $("#sortable1");
	var sortableListPage1 = $("#sortable2");
	var sortableListPage2 = $("#sortable3");

	var newCLCasesChartID = "chart0";	
	var newAZCLCasesChartID = "chart1";
	var newVLCasesChartID = "chart2";

	var newCLAndHistoricIncidenceID = "chart3";
	var newAZCLAndHistoricIncidenceID = "chart4";
	var newVLAndHistoricIncidenceID = "chart5";

	var CGI_TABLE_TD_ID_PREFIX = "cgiTable";
	var EPI_TABLE_TD_ID_PREFIX = "epiTable";
	var MONTHLY_TABLE_TD_ID_PREFIX = "monthlyTable";
	var CAS_TABLE_TD_ID_PREFIX = "casTable";
	var DIAG_TABLE_TD_ID_PREFIX = "diagTable";


	var BUTTON_PREFIX = '_BUTTON_';
	var CHART_PREFIX = "chart";
	var LEGENDSET_PREFIX = "legendSet";
	var LEGEND_PREFIX = "legend";
	var LEISH_COLUMN_DETAIL_PREFIX = "LeishDetail";
	var LEVEL_PREFIX = "level";
	var MAP_PREFIX = "map";	
	var MAP_STYLE_PREFIX = "mapStyle";
	var OPTION_PREFIX = '_OPTION_';
	var TEXT_UNDER_EPI = 'TEXT_UNDER_EPI';
	var TEXT_UNDER_DIAG1 = 'TEXT_UNDER_DIAG1';
	var TEXT_UNDER_DIAG2 = 'TEXT_UNDER_DIAG2';

	var generatedYears = [], organisationUnits = [];

    var FEEDBACK_FILL_ALL_FIELDS = "Please, fill all fields.";



	/****************************************************************************************************
 	 **********                    	     STATIC CONTENT FUNCTIONS         	           	       **********
	 ****************************************************************************************************/
	function fillTableHead(htmlObject, firstColumn, headObjects){
		var html = '<th>'+firstColumn+'</th>';
		
		for (var i=0; i<headObjects.length;i++){
			html +='<th class="'+CLASS_EDITABLE_ELEMENT+'">'+headObjects[i]+'</th>';
		}

		htmlObject.append(html);
	}

	function generateCheckboxes(htmlObject, labels, title, prefix, newLineOn){
		var html = '<legend>'+title+'</legend>';
		for (var i=0; i<labels.length; i++){
			html+='<input id="' + prefix + BUTTON_PREFIX + i + '" type="checkbox" class="' + prefix + '" checked="checked" />'
			html+='<label for="' + prefix + BUTTON_PREFIX + i + '">' + labels[i] + '</label>'
			if(i===newLineOn){
				html+='<br>';
			}
		}
		    
		htmlObject.append(html);
	}

	function generateMapConfigurationList(htmlObject, labels, prefix){
		var html = '';
		
		for (var i=0; i<labels.length; i++){
			html+='<option id="' + prefix + OPTION_PREFIX + i + '" value="' + i + '" >';
			html+=labels[i];
			html+='</option>';
		}
		htmlObject.append(html);
	}

	function setTextUnderTables(elementId, idprefi, labels, labelsDesc, firstText){

		var html = '';

		if (firstText === true){
			html +='<span class="' + CLASS_EDITABLE_ELEMENT + '">N/A not applicable</span>';
		} else if (firstText === false){
			html +='';
		} else {
			html +=firstText;
		}
		for (var i = 0; i < labels.length; i++){
			html +='<span id="'  +idprefi + i + '" class="' + CLASS_EDITABLE_ELEMENT+'">' + labels[i] + ' = ' + labelsDesc[i] + '</span>';
		}

		$("#"+elementId).append(html);
	}




	/****************************************************************************************************
 	 **********                    	    FUNCTIONS CALLING THE API         	           	       **********
	 ****************************************************************************************************/

	function getFootnotes(){
		var params = {
			skipPaging : true
		} 
		return $.when(getParents(orgUnit.id)).then(function(data){
			var orgUnitArray = [];
			if (typeof data.organisationUnits !== 'undefined' ) {
				var orgUnitArray = data.organisationUnits[0].path.replace(/^\/|\/$/, "").split("/");
			}
			return getAndFillEventsFor(FOOTNOTE_PROGRAM, orgUnitArray, params);
		});
	}

	function getAndFillEventsFor(FOOTNOTE_PROGRAM, orgUnitArray, params){
		return $.when(getEventsFor(FOOTNOTE_PROGRAM, orgUnitArray[0], params), orgUnitArray).then(function(eventRes, orgUnitArray){
					for (var i = 0; i<eventRes[0].events.length; i++) {
						var event = eventRes[0].events[i];
						var  footnote = getValueForKey(event.dataValues, DE_KEY, RG_footnote_text, VALUE_KEY);
						if (getValueForKey(event.dataValues, DE_KEY, RG_footnote_active, VALUE_KEY).localeCompare("true")==0) {
							var page = getValueForKey(event.dataValues, DE_KEY, RG_footnote_page, VALUE_KEY);
							if (page.localeCompare("2")==0) {
								activeFootnotesPage2.push(footnote);
							} else {
								activeFootnotesPage1.push(footnote);
							}
						} else {
							storedFootnotes.push(footnote);
						}
					}
					
					if (orgUnitArray.length <= 1) {
						return;
					} else {
						return getAndFillEventsFor(FOOTNOTE_PROGRAM, orgUnitArray.slice(1), params)
					}
				});
	}

	function getParents(id){
		var params = {
			fields: "path",
			paging: false
		}

		var builtUrl = buildAPIUrl(ORG_UNITS, params);
		builtUrl += "&filter=id:eq:"+id;
		return $.ajax({
			url: builtUrl
		}).then(function(data) {
			return data;
		}).fail(function(data) {
			console.log ("ERROR. getParents");
			console.log (data);
		});
	}

	function getEventsFor(program, orgUnit, params) {
		params.orgUnit = orgUnit;
		params.program = program;
		var builtUrl = buildAPIUrl(EVENTS, params);
		return $.ajax({
			url: builtUrl
		}).done(function(data) {
			return data;
		}).fail(function(data) {
			console.log ("ERROR. getEventsFor");
			console.log (data);
		});
	}


	function getLastEvent(theYear){

		var params = {
			period: theYear,
			orgUnit: orgUnit.id,
			program: PR_LEISHMANIASIS,
			pageSize:1,
			page: 1
		}

		builtUrl = buildAPIUrl(EVENTS, params);
		builtUrl += "&order=eventDate:desc";
		return $.ajax({
			url: builtUrl
		}).then(function(data) {
			console.log(data);
			if(data.events.length) {
				var dataValues = data.events[0].dataValues;
				var eventDate = data.events[0].eventDate;
				var eventYear = eventDate.slice(0,4);
				var yearText = "("+eventYear+")";

				if(eventYear >= year){
					yearText = "";
				}

				array[OUTBK_ROW][VL_COLUMN] = toBoolText(getValueForKey(dataValues, DE_KEY, Leish_PROG_outbreak_VL, VALUE_KEY));
				array[OUTBK_ROW][CL_COLUMN] = toBoolText(getValueForKey(dataValues, DE_KEY, Leish_PROG_outbreak_CL, VALUE_KEY)); 
				array[FOCI_ROW][VL_COLUMN] = getValueForKey(dataValues, DE_KEY, Leish_PROG_newfoci_VL, VALUE_KEY); 
				array[FOCI_ROW][CL_COLUMN] = getValueForKey(dataValues, DE_KEY, Leish_PROG_newfoci_CL, VALUE_KEY); 
				
				array[OUTBK_ROW][FIRST_COLUMN] = array[OUTBK_ROW][FIRST_COLUMN] + "<sup>"+yearText+"</sup>";
				array[FOCI_ROW][FIRST_COLUMN] = array[FOCI_ROW][FIRST_COLUMN] + "<sup>"+yearText+"</sup>";

				controlArray[CAS_ROW_NOTIF][1] = toBoolText(getValueForKey(dataValues, DE_KEY, Leish_PROG_notifiable, VALUE_KEY)); 
				controlArray[CAS_ROW_TYPE][1] = toBoolText(getValueForKey(dataValues, DE_KEY, Leish_PROG_surveillance, VALUE_KEY)); 
				controlArray[CAS_ROW_PROGRAMME][1] = toBoolText(getValueForKey(dataValues, DE_KEY, Leish_PROG_vectorControl, VALUE_KEY)); 
				controlArray[CAS_ROW_RESER][1] = toBoolText(getValueForKey(dataValues, DE_KEY, Leish_PROG_reservoirControl, VALUE_KEY)); 
				controlArray[CAS_ROW_FACIL_D][1] = getValueForKey(dataValues, DE_KEY, Leish_PROG_NbLeishHF_Dx, VALUE_KEY); 
				controlArray[CAS_ROW_FACIL_T][1] = getValueForKey(dataValues, DE_KEY, Leish_PROG_NbLeishHF_Dx, VALUE_KEY); 
				controlArray[CAS_ROW_GUIDELINES][1] = toBoolText(getValueForKey(dataValues, DE_KEY, Leish_PROG_guidelines, VALUE_KEY)); 
				controlArray[CAS_ROW_FREE][1] = toBoolText(getValueForKey(dataValues, DE_KEY, Leish_PROG_Tx_free, VALUE_KEY)); 
				controlArray[CAS_ROW_LNCP][1] = getValueForKey(dataValues, DE_KEY, Leish_PROG_LNCP_Year, VALUE_KEY); 
				controlArray[CAS_ROW_IRS][1] = getValueForKey(dataValues, DE_KEY, Leish_PROG_IRS_insecticide, VALUE_KEY); 

				$( "#casTitle" ).append("<sup>"+yearText+"</sup>");

			}
		});


	}

	function toBoolText(text){
		switch(text){
			case "0": 
				return "No";
				break;
			case "1":
				return "Yes";
				break;
			case "9":
				return "Unknown";
				break;
			case "8":
				return WHEN_NON_APPLICABLE;
				break;
			default:
				return text;
		}
	}

	function getTreatmentAndMedicines(theYear){
		var params = {
			dataSet : DATASET.DAM,
			period: theYear,
			orgUnit: orgUnit.id
		}
		
		builtUrl = buildAPIUrl(DATA_VALUE_SETS, params);
		
		return $.ajax({
			url: builtUrl
		}).then(function(data) {
			if(data.dataValues) {
				var usePreviousData = getValueForKey(data.dataValues, DE_KEY, DE.UNS_USE_PREVIOUS_DATA, VALUE_KEY);
				if (usePreviousData){
					return getTreatmentAndMedicines(theYear-1);
				} else {
					fillTreatmentAndMedicines(data.dataValues, theYear);
				}
			}
		});
	}
/*
	function getNumberOfDivisions(lvl, object){
		var params = {
			level : lvl,
			fields: "id"
		}
		builtUrl = buildAPIUrl(ORG_UNITS+"/"+orgUnit.id, params);

		
		return $.ajax({
			url: builtUrl//,

		}).then(function(data) {
			setNumberOfDivisions(object, data.organisationUnits.length);
		}).fail(function(data) {
			setNumberOfDivisions(object, WHEN_UNDEFINED);
		});;
	}*/
	function getLegendSet(legendSetId, mapId){
		console.log("getLegendSet");
		var legendUrl = "../api/legendSets/"+legendSetId;

		return $.ajax({
			url: legendUrl
		}).then(function(data) {
			mapLegends[mapId] = [];
			var legendSetName = data.name;
			return $.ajax({
				url: legendUrl+"/legends/"
			}).then(function(data) {
				for (var i =0; i<data.legends.length; i++){

					mapLegends[mapId][i] = {};
					mapLegends[mapId][i].legendSetName = legendSetName;
					mapLegends[mapId][i].legendNames = data.legends[i].name;
					mapLegends[mapId][i].legendColors = data.legends[i].color;
					mapLegends[mapId][i].startValue = data.legends[i].startValue;
					mapLegends[mapId][i].endValue = data.legends[i].endValue;
				}
				mapLegends[mapId] =  reOrderLegendSet(mapLegends[mapId]);
			});
			
		});
	}

	function generateMap(index, dimentionType, levels, orgUnitId, year, thematic, mapStyle, opacityLevel){
		
		var base = "..";
		var idHtmlElement = MAP_PREFIX+(index);
		var dimension = INCIDENCE[index];

		// Resizes the map contener
		$("#" + MAP_PREFIX + index).height(map_height);
		$("#" + MAP_PREFIX + index).width(map_width);
	
		// Move back the legend to the legendPool
		$("#legendPool").append($('#'+LEGENDSET_PREFIX+index));
		
		//restore map to its initial value
		$('#'+idHtmlElement).html(initalMapDiv[index]);
		

		var itemsOnRow = [];
		for(var i=0; i<levels.length; i++){$
			itemsOnRow.push({id: "LEVEL-"+levels[i]});
		}
		itemsOnRow.push({id: orgUnitId});

		Ext.onReady(	function (){

			GIS.plugin.getMap({
				url: base,
				el: idHtmlElement,
				basemap: mapStyle,
				mapViews: [{
					columns: [{dimension: "dx", items: [{id: dimension, dimensionItemType: dimentionType}]}],
					rows: [{dimension: "ou", items: itemsOnRow}],
					filters: [{
							dimension: "pe",
							items: [{id: year}]}],
					valueType: "in",
					layer: thematic,
 					legendSet: {id: "gUOjExXros1"},
					labels: true, // labels of the regions
					opacity:opacityLevel/100
				}],
				onReady: function() {
                    console.log('map '+index +'is ready!');
					// Removes zoom and legend
					$('#'+idHtmlElement).find(".leaflet-control-zoom").remove();
					$('#'+idHtmlElement).find(".leaflet-control-legend").remove();
					
					// Removes openmaps signature
					$('#'+idHtmlElement).find(".leaflet-bottom.leaflet-right").empty();

					// Adds the legend
					//$('#'+idHtmlElement).find(".leaflet-bottom.leaflet-right").append($('#'+LEGENDSET_PREFIX+index));
					moveLegend(index, $('#'+idHtmlElement).find(LEGEND_POSITIONS[BOTTOM_RIGHT]), LEGEND_TO_REPORT);

                }
				
			});
		});
	}

	function get_monthly_cases_for(dataset, row, year) {
		var params = {
			dataSet: dataset,
			period: [],
			orgUnit: orgUnit.id
		}

		for (var i=1;i<=12;i++){
			var monthNumber = numberToTwoDigits(i);
			params.period[i] = year + monthNumber;
		}

		builtUrl = buildAPIUrl(DATA_VALUE_SETS, params);
		return $.ajax({
			url: builtUrl
		}).then(function(data) {
			if(typeof row === 'number'){
				fillMonthlyArray(row, data.dataValues);
			} else if (row.length>1){
				fillMonthlyArrayACLZCL(row[0], row[1], data.dataValues);
			}
		});
	}

	function get_monthly_cases_for_cl_current_year() {
			return get_monthly_cases_for(DATASET.CL_MONTHLY, CL_ROW, year);
	}
	function get_monthly_cases_for_cl_previous_year() {
			return get_monthly_cases_for(DATASET.CL_MONTHLY, CL_PREVIOUS_YEAR_ROW, year-1);
	}
	function get_monthly_cases_for_vl_current_year() {
			return get_monthly_cases_for(DATASET.VL_MONTHLY, VL_ROW, year);
	}
	function get_monthly_cases_for_vl_previous_year() {
			return get_monthly_cases_for(DATASET.VL_MONTHLY, VL_PREVIOUS_YEAR_ROW, year-1);
	}
	function get_monthly_cases_for_azcl_current_year() {
			return get_monthly_cases_for(DATASET.AZCL_MONTHLY, [ACL_ROW, ZCL_ROW], year);
	}
	function get_monthly_cases_for_azcl_previous_year() {
			return get_monthly_cases_for(DATASET.AZCL_MONTHLY, [ACL_PREVIOUS_YEAR_ROW, ZCL_PREVIOUS_YEAR_ROW], year-1);
	}
	

	/* getting cl cases from API */
	function get_cl_cases() {

		params.dataSet = DATASET.CL;
		builtUrl = buildAPIUrl(DATA_VALUE_SETS, params);
		return $.ajax({
			url: builtUrl
		}).then(function(data) {
			//	decide_cl_or_aclzcl_mode(data.dataValues);
				fillArray(data.dataValues, CL_COLUMN, DE.CL_EPI_Type, ""); 
				fillArray(data.dataValues, MCL_COLUMN, DE.MCL_EPI_Type, "", DE.MCL_GEN_EPID_cases); 
		});
	}


	/* getting cl cases from API */
	function get_azcl_cases() {

		params.dataSet = DATASET.AZCL;
		builtUrl = buildAPIUrl(DATA_VALUE_SETS, params);
		return $.ajax({
			url: builtUrl
		}).then(function(data) {
				set_aclzcl_mode_to_true_if_data(data.dataValues);
				fillArray(data.dataValues, ACL_COLUMN, DE.ACL_EPI_Type, "", ""); 
				fillArray(data.dataValues, ZCL_COLUMN, DE.ZCL_EPI_Type, "", ""); 
		});
	}


	/* getting vl cases from API */
	function get_vl_cases() {
		params.dataSet = DATASET.VL;
		builtUrl = buildAPIUrl(DATA_VALUE_SETS, params);
		return $.ajax({
			url: builtUrl
		}).then(function(data) {
				fillArray(data.dataValues, VL_COLUMN, DE.VL_EPI_Type, DE.VL_LAB_RDT_tested_type, "");
				fillArray(data.dataValues, PKDL_COLUMN, DE.VL_EPI_Type, DE.VL_LAB_RDT_tested_type, DE.PKDL_GEN_EPID_cases);

		});
	}

	function getNewCases(dimension, column){
		var params = {
			dimension: ["dx:"+dimension,"pe:"+year, "B9bBfRcF6jb:aD1KD82UFB1"],
			filter: ["ou:"+orgUnit.id],
			displayProperty : "NAME",
			skipMeta:"true"
		}
		for (var i=1; i<historicLength; i++){
			params.dimension[1] +=";"+(year-i);
		}
		var builtUrl = buildAPIUrl(ANALYTICS, params);
		return $.ajax({
			url: builtUrl
		}).then(function(data) {
				fillNewCasesArray(data, column);
		});
	}
	function getIncidenceFor(indicator, column){


		var params = {
			dimension: ["dx:"+indicator,"pe:"+year],
			filter: ["ou:"+orgUnit.id],
			displayProperty : "NAME",
			skipMeta:"true"
		}
		for (var i=1; i<historicLength; i++){
			params.dimension[1] +=";"+(year-i);
		}
		var builtUrl = buildAPIUrl(ANALYTICS, params);
		return $.ajax({
			url: builtUrl
		}).then(function(data) {
				fillIncidenceArray(data, column);
		});
	}


	/****************************************************************************************************
 	 **********                      FILLING LOGICAL STRUCTURES (ARRAYS)               	       **********
	 ****************************************************************************************************/

	 /***

	 */
	function fillMonthlyArray(row, dataValues) {
		var new_cases_by_month = getValuesForKeyByMonth(dataValues,CC_KEY,TYPE_NEW_CASES, VALUE_KEY);
		var relapses_by_month = getValuesForKeyByMonth(dataValues,CC_KEY,TYPE_RELAPSE, VALUE_KEY);
		var unspecified_by_month = getValuesForKeyByMonth(dataValues,CC_KEY,TYPE_UNSPECIFIED, VALUE_KEY);

		var total_cases_by_month;
		var starting_column = monthlyArray[row].length;

		for (var i=starting_column; i<new_cases_by_month.length+starting_column; i++){
			total_cases_by_month = add([	new_cases_by_month[i-starting_column],
										relapses_by_month[i-starting_column],
										unspecified_by_month[i-starting_column] ]);
			monthlyArray[row][i] = total_cases_by_month;
		}
		
	}	 
	/***

	 */
	function fillMonthlyArrayACLZCL(aclRow, zclRow, dataValues) {
		var new_cases_by_month_acl = getValuesForKeyByMonth(dataValues,[CC_KEY, DE_KEY],[TYPE_NEW_CASES, DE.ACL_EPI_Type], VALUE_KEY);
		var relapses_by_month_acl = getValuesForKeyByMonth(dataValues,[CC_KEY, DE_KEY],[TYPE_RELAPSE, DE.ACL_EPI_Type], VALUE_KEY);
		var unspecified_by_month_acl = getValuesForKeyByMonth(dataValues,[CC_KEY, DE_KEY],[TYPE_UNSPECIFIED, DE.ACL_EPI_Type], VALUE_KEY);

		var new_cases_by_month_zcl = getValuesForKeyByMonth(dataValues,[CC_KEY, DE_KEY],[TYPE_NEW_CASES, DE.ZCL_EPI_Type], VALUE_KEY);
		var relapses_by_month_zcl = getValuesForKeyByMonth(dataValues,[CC_KEY, DE_KEY],[TYPE_RELAPSE, DE.ZCL_EPI_Type], VALUE_KEY);
		var unspecified_by_month_zcl = getValuesForKeyByMonth(dataValues,[CC_KEY, DE_KEY],[TYPE_UNSPECIFIED, DE.ZCL_EPI_Type], VALUE_KEY);

		var total_cases_by_month;
		var starting_column = monthlyArray[aclRow].length;

		for (var i=starting_column; i < new_cases_by_month_acl.length + starting_column; i++){
			total_cases_by_month = add([	new_cases_by_month_acl[i - starting_column],
										relapses_by_month_acl[i - starting_column],
										unspecified_by_month_acl[i - starting_column] ]);
			monthlyArray[aclRow][i] = total_cases_by_month;
		}
		for (var i=starting_column; i < new_cases_by_month_zcl.length + starting_column; i++){
			total_cases_by_month = add([	new_cases_by_month_zcl[i - starting_column],
										relapses_by_month_zcl[i - starting_column],
										unspecified_by_month_zcl[i - starting_column] ]);
			monthlyArray[zclRow][i] = total_cases_by_month;
		}
		
	}

	function fillNewCasesArray(data, column){
		historicNewCases[column] = getAnalyticValueForKey(data);
	}
	function fillIncidenceArray(data, column){
		historicIncidence[column] = getAnalyticValueForKey(data);
		array[INCD_ROW][column] = historicIncidence[column][0]; // 0 = this year
	}



	/*
		column :
		epiDE : Epidemiology Data getElement
		diagDE : diagnosis DataElement
	*/
	function fillArray(dataValues, column, epiDE, diagDE, epiPKDLMCLCases) {
		/* Edidemiology table */
	
		// type of cases
		var new_cases = getValueForKey(dataValues,[CC_KEY, DE_KEY],[TYPE_NEW_CASES,epiDE], VALUE_KEY);
		var relapse = getValueForKey(dataValues,[CC_KEY, DE_KEY],[TYPE_RELAPSE,epiDE], VALUE_KEY);
		var unspecified = getValueForKey(dataValues,[CC_KEY, DE_KEY],[TYPE_UNSPECIFIED,epiDE], VALUE_KEY);
		var total_cases_type = add([new_cases, relapse, unspecified]);
		
		array[NEW_ROW][column] = new_cases;
		array[RELAPSE_ROW][column] = relapse;
		array[TOTAL_ROW][column] = total_cases_type;

		// sex distribution 
		var new_unknown = getValueForKey(dataValues, CC_KEY, NEW_UNKNOWN, VALUE_KEY);
		var rel_unknown = getValueForKey(dataValues, CC_KEY, REL_UNKNOWN, VALUE_KEY);
		var uns_unknown = getValueForKey(dataValues, CC_KEY, UNS_UNKNOWN, VALUE_KEY);
		var unknown = add([new_unknown, rel_unknown, uns_unknown]);

		var new_male = getValueForKey(dataValues, CC_KEY, NEW_MALE, VALUE_KEY);
		var rel_male = getValueForKey(dataValues, CC_KEY, REL_MALE, VALUE_KEY);
		var uns_male = getValueForKey(dataValues, CC_KEY, UNS_MALE, VALUE_KEY);
		var male = add([new_male, rel_male, uns_male]);

		var new_female = getValueForKey(dataValues, CC_KEY, NEW_FEMALE, VALUE_KEY);
		var rel_female = getValueForKey(dataValues, CC_KEY, REL_FEMALE, VALUE_KEY);
		var uns_female = getValueForKey(dataValues, CC_KEY, UNS_FEMALE, VALUE_KEY);
		var female = add([new_female, rel_female, uns_female]);

		array[SEX_ROW][column] = percentageText(female, add([male, female, unknown]));
		
		//age distribution 
		var new_under_5 = getValueForKey(dataValues, CC_KEY, NEW_UNDER_5, VALUE_KEY);
		var rel_under_5 = getValueForKey(dataValues, CC_KEY, REL_UNDER_5, VALUE_KEY);
		var uns_under_5 = getValueForKey(dataValues, CC_KEY, UNS_UNDER_5, VALUE_KEY);
		var under_5 =  add([new_under_5, rel_under_5, uns_under_5]);

		var new_5_14 = getValueForKey(dataValues, CC_KEY, NEW_5_14, VALUE_KEY);
		var rel_5_14 = getValueForKey(dataValues, CC_KEY, REL_5_14, VALUE_KEY);
		var uns_5_14 = getValueForKey(dataValues, CC_KEY, UNS_5_14, VALUE_KEY);
		var _5_14 =  add([new_5_14, rel_5_14, uns_5_14]);

		var new_over_14 = getValueForKey(dataValues, CC_KEY, NEW_OVER_14, VALUE_KEY);
		var rel_over_14 = getValueForKey(dataValues, CC_KEY, REL_OVER_14, VALUE_KEY);
		var uns_over_14 = getValueForKey(dataValues, CC_KEY, UNS_OVER_14, VALUE_KEY);
		var over_14 =  add([new_over_14, rel_over_14, uns_over_14]);

		var new_age_unknown = getValueForKey(dataValues, CC_KEY, NEW_AGE_UNKNOWN, VALUE_KEY);
		var rel_age_unknown = getValueForKey(dataValues, CC_KEY, REL_AGE_UNKNOWN, VALUE_KEY);
		var uns_age_unknown = getValueForKey(dataValues, CC_KEY, UNS_AGE_UNKNOWN, VALUE_KEY);
		var age_unknown =  add([new_age_unknown, rel_age_unknown, uns_age_unknown]);

		var total_age_cases = add([under_5, _5_14, over_14, age_unknown]);

		array[AGE_ROW][column] = threePercentages(under_5, _5_14, over_14, total_age_cases);	

		//origin distribution
		var origin_autoc = add([
			getValueForKey(dataValues,CC_KEY, ORIGIN_AUTOC_NEW, VALUE_KEY),
			getValueForKey(dataValues,CC_KEY, ORIGIN_AUTOC_REL, VALUE_KEY),
			getValueForKey(dataValues,CC_KEY, ORIGIN_AUTOC_UNS, VALUE_KEY)
		]);
		var origin_imported = add([
			getValueForKey(dataValues,CC_KEY, ORIGIN_IMPORT_NEW, VALUE_KEY),
			getValueForKey(dataValues,CC_KEY, ORIGIN_IMPORT_REL, VALUE_KEY),
			getValueForKey(dataValues,CC_KEY, ORIGIN_IMPORT_UNS, VALUE_KEY)
		]);
		var origin_unknown = add([
			getValueForKey(dataValues,CC_KEY, ORIGIN_UNKNOWN_NEW, VALUE_KEY),
			getValueForKey(dataValues,CC_KEY, ORIGIN_UNKNOWN_REL, VALUE_KEY),
			getValueForKey(dataValues,CC_KEY, ORIGIN_UNKNOWN_UNS, VALUE_KEY)
		]);
		var total_origin_cases = add([origin_autoc, origin_imported, origin_unknown]);
		array[IMPORTED_ROW][column] = origin_imported 
									+ ", "
									+	percentageText(origin_imported, total_origin_cases);

		/* only PKDL and MCL TODO: place that if that's true */

		if (column === PKDL_COLUMN || column === MCL_COLUMN){
			var cases = getValueForKey(dataValues, DE_KEY, epiPKDLMCLCases, VALUE_KEY);
			array[NEW_ROW][column] = cases;
			array[RELAPSE_ROW][column] = WHEN_NON_APPLICABLE;
			array[TOTAL_ROW][column] = cases;
			array[IMPORTED_ROW][column] = WHEN_NON_APPLICABLE; 

			var male = getValueForKey(dataValues, CC_KEY, MALE, VALUE_KEY);
			var female = getValueForKey(dataValues, CC_KEY, FEMALE, VALUE_KEY);
			array[SEX_ROW][column] = percentageText(female, add([male, female]));

			var age_5 = getValueForKey(dataValues, CC_KEY, AGE_5, VALUE_KEY);
			var age_5_14 = getValueForKey(dataValues, CC_KEY, AGE_5_14, VALUE_KEY);
			var age_14 = getValueForKey(dataValues, CC_KEY, AGE_14, VALUE_KEY);
			var total_age_cases = add([age_5, age_5_14, age_14]);

			array[AGE_ROW][column] = threePercentages(age_5, age_5_14, age_14, total_age_cases);	

			array[INCD_ROW][column] = WHEN_NON_APPLICABLE; 
			array[RISK_ROW][column] = WHEN_NON_APPLICABLE; 
			array[THIRD_LEVEL_ROW][column] = WHEN_NON_APPLICABLE; 
			array[OUTBK_ROW][column] = WHEN_NON_APPLICABLE; 
			array[FOCI_ROW][column] = WHEN_NON_APPLICABLE; 

		}


		/* Diagnosis table */
		
		// active and passive screening
		if (column === PKDL_COLUMN || column === MCL_COLUMN) {
			diagnosisArray[SCREENED_ACTIVELY_ROW][column] = WHEN_NON_APPLICABLE;
			diagnosisArray[SCREENED_PASSIVELY_ROW][column] = WHEN_NON_APPLICABLE;
		} else {
			var screen_active = getValueForKey(dataValues, DE_KEY, DE_SCREEN_ACTIVE[column] , VALUE_KEY);
			var screen_passive = getValueForKey(dataValues, DE_KEY, DE_SCREEN_PASSIVE[column] , VALUE_KEY);
			diagnosisArray[SCREENED_ACTIVELY_ROW][column] = screen_active;
			diagnosisArray[SCREENED_PASSIVELY_ROW][column] = screen_passive;
		}
		

		if (column === VL_COLUMN) {
			// cases diagnosed by RDT and %positive RDT
			var new_rdt = getValueForKey(dataValues,[CC_KEY, DE_KEY],[TYPE_NEW_CASES,diagDE], VALUE_KEY);
			var unsp_rdt = getValueForKey(dataValues,[CC_KEY, DE_KEY],[TYPE_UNSPECIFIED,diagDE], VALUE_KEY);
			var total_rdt = add([new_rdt, unsp_rdt]);

			var positive_new_rdt = getValueForKey(dataValues, CC_KEY, POSITIVE_NEW,  VALUE_KEY);
			var positive_unsp_rdt = getValueForKey(dataValues, CC_KEY, POSITIVE_UNSP,  VALUE_KEY);
			var total_positive_rdt = add([positive_new_rdt, positive_unsp_rdt]);
			
			diagnosisArray[VL_CASES_DIAGNOSED_ROW][column] = percentageCasesAndTotal(total_positive_rdt, total_cases_type);
			diagnosisArray[POSITIVE_RDT_ROW][column] = percentageCasesAndTotal(total_positive_rdt, total_rdt);

			// percentage of cases with HIV-VL coinfection
			var hiv_coinf_new = getValueForKey(dataValues,[CC_KEY, DE_KEY],[POSITIVE_NEW, DE.VL_LAB_HIVstatus_Type], VALUE_KEY); 
			var hiv_coinf_rel = getValueForKey(dataValues,[CC_KEY, DE_KEY],[POSITIVE_RELAPSE, DE.VL_LAB_HIVstatus_Type], VALUE_KEY); 
			var hiv_coinf_uns = getValueForKey(dataValues,[CC_KEY, DE_KEY],[POSITIVE_UNSP, DE.VL_LAB_HIVstatus_Type], VALUE_KEY); 
			var hiv_coinf_total = add([hiv_coinf_new, hiv_coinf_rel, hiv_coinf_uns]);

			diagnosisArray[HIV_COINFECTION_ROW][column] = percentageCasesAndTotal(hiv_coinf_total, total_cases_type);
			
		} else {
			diagnosisArray[VL_CASES_DIAGNOSED_ROW][column] = WHEN_NON_APPLICABLE;
			diagnosisArray[POSITIVE_RDT_ROW][column] = WHEN_NON_APPLICABLE;
			diagnosisArray[HIV_COINFECTION_ROW][column] = WHEN_NON_APPLICABLE;
		}

		if (column === VL_COLUMN || column == CL_COLUMN){
			
			/* Treatment table */
		
			var new_cured = getValueForKey(dataValues, CC_KEY, NEW_CURED, VALUE_KEY);
			var rel_cured = getValueForKey(dataValues, CC_KEY, REL_CURED, VALUE_KEY);
			var uns_cured = getValueForKey(dataValues, CC_KEY, UNS_CURED, VALUE_KEY);
			var total_cured = add([new_cured, rel_cured, uns_cured]);

			var new_fail = getValueForKey(dataValues, CC_KEY, NEW_RELOUT, VALUE_KEY);
			var rel_fail = getValueForKey(dataValues, CC_KEY, REL_RELOUT, VALUE_KEY);
			var uns_fail = getValueForKey(dataValues, CC_KEY, UNS_RELOUT, VALUE_KEY);
			var total_fail = add([new_fail, rel_fail, uns_fail]);

			var new_dead = getValueForKey(dataValues, CC_KEY, NEW_DEAD, VALUE_KEY);
			var rel_dead = getValueForKey(dataValues, CC_KEY, REL_DEAD, VALUE_KEY);
			var uns_dead = getValueForKey(dataValues, CC_KEY, UNS_DEAD, VALUE_KEY);
			var total_dead = add([new_dead, rel_dead, uns_dead]);

			toutcomeArray[RELAPSE_PROPORTION_ROW][column] = percentageCasesAndTotal(relapse, total_cases_type);
			toutcomeArray[INITIAL_CURE_RATE_ROW][column] = percentageCasesAndTotal(total_cured, total_cases_type);
			toutcomeArray[FAILURE_RATE_ROW][column] = percentageCasesAndTotal(total_fail, total_cases_type);
			toutcomeArray[CASE_FATALITY_ROW][column] = percentageCasesAndTotal(total_dead, total_cases_type);
		}



		if (column === PKDL_COLUMN || column === MCL_COLUMN) {
			diagnosisArray[DIRECT_EXAM_DIAGNOSED_ROW][column] = WHEN_NON_APPLICABLE;
			diagnosisArray[POSITIVE_DIRECT_EXAM_ROW][column] = WHEN_NON_APPLICABLE;
			diagnosisArray[CLINICALLY_DIAGNOSED_ROW][column] = WHEN_NON_APPLICABLE;
		} 
		else {
		
			// Direct exam
			var direct_exam_new = getValueForKey(dataValues,[CC_KEY, DE_KEY],[TYPE_NEW_CASES, DE.VL_LAB_parasito_tested_type], VALUE_KEY);
			var direct_exam_rel = getValueForKey(dataValues,[CC_KEY, DE_KEY],[TYPE_RELAPSE, DE.VL_LAB_parasito_tested_type], VALUE_KEY);
			var direct_exam_uns = getValueForKey(dataValues,[CC_KEY, DE_KEY],[TYPE_UNSPECIFIED, DE.VL_LAB_parasito_tested_type], VALUE_KEY);
			var direct_exam_total = add([direct_exam_new, direct_exam_rel, direct_exam_uns]);

			diagnosisArray[DIRECT_EXAM_DIAGNOSED_ROW][column] = percentageCasesAndTotal(direct_exam_total, total_cases_type);

			//Positive slides
			var positive_slides_new = getValueForKey(dataValues,[CC_KEY, DE_KEY],[POSITIVE_NEW, DE.VL_LAB_parasito_result_type], VALUE_KEY); 
			var positive_slides_rel = getValueForKey(dataValues,[CC_KEY, DE_KEY],[POSITIVE_RELAPSE, DE.VL_LAB_parasito_result_type], VALUE_KEY); 
			var positive_slides_uns = getValueForKey(dataValues,[CC_KEY, DE_KEY],[POSITIVE_UNSP, DE.VL_LAB_parasito_result_type], VALUE_KEY); 
			var positive_slides_total = add([positive_slides_new, positive_slides_rel, positive_slides_uns]);

			diagnosisArray[POSITIVE_DIRECT_EXAM_ROW][column] = percentageCasesAndTotal(positive_slides_new, positive_slides_total);

			//Cases diagnosed clinically
			var clinical_cases_new = getValueForKey(dataValues,[CC_KEY, DE_KEY],[TYPE_NEW_CASES, DE.VL_LAB_clinical], VALUE_KEY);
			var clinical_cases_rel = getValueForKey(dataValues,[CC_KEY, DE_KEY],[TYPE_RELAPSE, DE.VL_LAB_clinical], VALUE_KEY);
			var clinical_cases_uns = getValueForKey(dataValues,[CC_KEY, DE_KEY],[TYPE_UNSPECIFIED, DE.VL_LAB_clinical], VALUE_KEY);
			var clinical_cases_total = add([clinical_cases_new, clinical_cases_rel, clinical_cases_uns]);

			diagnosisArray[CLINICALLY_DIAGNOSED_ROW][column] = percentageCasesAndTotal(clinical_cases_total, total_cases_type);
		}


	}
	

	/****************************************************************************************************
 	 **********                     		 AUXILIARY FUNCTIONS          	    		       **********
	 ****************************************************************************************************/

	function fillTreatmentAndMedicines(dataValues, yearInfo){
		tamArray[TAM_ROW_FREEOFCHARGE][1] = getValueForKey(dataValues, DE_KEY, DE.UNS_FREE_TREATMENT, VALUE_KEY);
		tamArray[TAM_ROW_ANTILEISHMANIAL][1] = getValueForKey(dataValues, DE_KEY, DE.UNS_ANTIL_LEM, VALUE_KEY);

		if (yearInfo < year){
			$("#tamTitle").append(" (" + yearInfo + ")");
		}
	}

	function fillCountryGeneralInformation(level){
		generalInformationArray[CIG_ROW_POP][1] = "96,101,000";
		generalInformationArray[CIG_ROW_SEX][1] = "49.95% / 50.1%";
		generalInformationArray[CIG_ROW_GDP][1] = "1350";
		generalInformationArray[CIG_ROW_INCOME][1] = "Low";
		generalInformationArray[CIG_ROW_AGEG][1] = "43% / 57%";
		generalInformationArray[CIG_ROW_LIFE][1] = "65 / 62";

		generalInformationArray[CIG_ROW_DIVIS][0] = LEVEL_REPORT_LABELS[level];
		setOptionSelectMenu("subnationalLevelSelector", level);
		return getNumberOfDivisions((level+1), generalInformationArray);
	}

	function setNumberOfDivisions(object, value){
		if (typeof object === 'string'){
			$("#"+object).html(value);
		} else {
			object[CIG_ROW_DIVIS][1] = value;
		}
	}

		

	function reOrderLegendSet(legendSet) {
		if (legendSet.length <= 1) {
			return legendSet;
		} else {
			var temp;
			for(var i=1; i<legendSet.length; i++){
				if(legendSet[0].startValue + legendSet[0].endValue > legendSet[i].startValue + legendSet[i].endValue){
					temp = legendSet[i];
					legendSet[i] = legendSet[0];
					legendSet[0] = temp;
				}
			}
			return legendSet.slice(0,1).concat(reOrderLegendSet(legendSet.slice(1,legendSet.length)));
		}
	}

	function set_aclzcl_mode_to_true_if_data(dataValues){
		if (dataValues !== undefined ){
			acl_and_zcl_activated = true;
		}
	}
	/* return a text about publishing date with the current month and year*/
	function getDatePublished(){
		var d = new Date();
    	var thisMonth = d.getMonth();
		var thisYear = d.getFullYear();
		return PUBLISHED_TEXT+" "+MONTHS[thisMonth]+" "+thisYear;
	}
	/*
		linesOnRows : An array with the number of the rows which must have a line below
	*/
	function writeTable(htmlObject, array, tdIdPrefix, linesOnRows) {
		// declare html variable (a string holder):
		var html = '';
		var count = 0;

		var lineClass = "";
		for (var i = 0; i < array.length; i++) {
			if (linesOnRows[i]){
				lineClass = BOTTOM_LINE_CLASS;
			} else {
				lineClass ="";
			}
			// add opening <tr> tag to the string:
			html += '<tr id="'+tdIdPrefix+i+'" class="'+lineClass+'">';
			for (var j = 0; j < array[i].length; j++) {
				// add <td> elements to the string:
				html += '<td>' + '<span class="'+CLASS_FOOTNOTABLE_ELEMENT+' '+CLASS_EDITABLE_ELEMENT+'" >' + array[i][j] + '</span>' + '</td>';
				count++;
			}
			// add closing </tr> tag to the string:
			html += '</tr>';
		}
		//append created html to the table body:
	
		htmlObject.append(html);
		// reset the count:
		count = 0;
	}


	/* Fills and ul list jquery html object with the elements of the array

		htmlObject: a jquery object
		array: a one dimension javascript array
		classes: a string with the classes to add to li elemenets separated by spaces
	*/
    function fillHTMLListWithArray(htmlObject, array, classes){
        var html = '';
		for (var i=0; i<array.length; i++){
			html+='<li class="'+classes+'">'
			html+= array[i];
			html+= '</li>';
		}
		    
		htmlObject.append(html);
    }

	

	function makeElementsEditables(){
			// Avoid to show menu
		$('.'+CLASS_EDITABLE_ELEMENT).contextmenu(function() {
			return false;
		});
	
		$('.'+CLASS_EDITABLE_ELEMENT).mousedown(function(event) {
			if (event.which === 3){
				//event.preventDefault();

				dialog.dialog( "open" );	
				var test = this.innerHTML;
				editingElement = this;
				editor.jqteVal(editingElement.innerHTML);

			}
		});
	}
	
	function makeElementsFootnotables(){
		$('.'+CLASS_FOOTNOTABLE_ELEMENT).mousedown(function(event) {
			if (event.which === 1){
				if ($(this).hasClass('footNotedElement')) {
					var element = $('#footNoteNumber' + footNoteCounter ); // will return element
					if ($(this).children().attr("id")===element.attr("id")) {  // Check if trying to remove last element
						element[0].parentNode.removeChild(element[0]); // will remove the element from DOM
						footNoteCounter--;
						$(this).toggleClass('footNotedElement');
					}

				} else {
					footNoteCounter++;
					$(this).append("<span id='footNoteNumber"+footNoteCounter+"' class='superindex'>"+footNoteCounter+"</span>");
					$(this).toggleClass('footNotedElement');
				}

				event.preventDefault();
				
			}
		});


	}
	/*	Returns a url for the API

	*/
	/*
	function buildAPIUrl(page, params){
		return API_URL+page+"?"+$.param(params, true);
	}
*/
	function numberToTwoDigits( number){
		return ("0" + number).slice(-2);
	}

	
	
	function getAnalyticValueForKey(array){
		yearColumn = 0;
		valueColumn = 0;

		for (var j=0;j<array.headers.length;j++){
			if(array.headers[j].name==="pe"){
				yearColumn = j;
			}
			if(array.headers[j].name==="value"){
				valueColumn = j;
			}
		}
		var returnValues = new Array(historicLength);
		for (var i=0; i<array.rows.length; i++){
			returnValues[year-array.rows[i][yearColumn]] = array.rows[i][valueColumn];
		}
		return returnValues;
	}

	/* 	Searchs for a custom value for a customKey with a custom value through an array
			array : the array
			keyName : the name (or an array of) of the key to check
			keyValue : the target (or an array of) value of the keyName
			valueName : the name of the key of the value to return
	*/
	function getValueForKey(array, keyName, keyValue, valueName){
		var returnValue = WHEN_UNDEFINED;
		if (array === undefined){
			return returnValue;
		}
		if (typeof keyName === 'string') {
			// one property check
			$.each( array, function( index, object ) {
				if(object[keyName]===keyValue){
					returnValue = object[valueName];
					return false;
				} 
			});
		} else if (keyName.length > 1 && keyValue.length > 1) {
			// two properties check  // not used
			$.each( array, function( index, object ) {
				if(object[keyName[0]]===keyValue[0] && object[keyName[1]]===keyValue[1]){
					returnValue = object[valueName];
					return false;
				} 
			});
		} else {
			console.log('ERROR in ' + arguments.callee.name);
			return 'ERROR in ' + arguments.callee.name ;
		}
		
		return returnValue;
	}

		/* 	Searchs for a custom value for a customKey with a custom value through an array
			array : the array
			keyName : the name (or an array of) of the key to check
			keyValue : the target (or an array of) alue of the keyName
			valueName : the name of the key of the value to return
	*/
	function getValuesForKeyByMonth(array, keyName, keyValue, valueName){
		var returnValue =  new Array(12); // Void array of size 12
		if (array === undefined){
			return returnValue;
		}

		var index, period;
		if (typeof keyName === 'string') {
			// one property check
			$.each( array, function( index, object ) {
				if(object[keyName]===keyValue){
					period = object[PERIOD_KEY];
					index = Number(period.slice(period.length-2, period.length)) - 1;
					returnValue[index] = object[valueName];
				} 
			});
		} else if (keyName.length > 1 && keyValue.length > 1) {
			// two properties check
			$.each( array, function( index, object ) {
				if(object[keyName[0]]===keyValue[0] && object[keyName[1]]===keyValue[1]){
					period = object[PERIOD_KEY];
					index = Number(period.slice(period.length-2, period.length)) - 1;
					returnValue[index] = object[valueName];
				} 
			});
		} else {
			console.log('ERROR in ' + arguments.callee.name);
			return 'ERROR in ' + arguments.callee.name ;
		}
		return returnValue;
	}


	/*	Returns three percentages with no decimals, between parenthesis

	*/
	function threePercentages(cases1, cases2, cases3, total){
		if (total === WHEN_UNDEFINED || total === undefined){
			return WHEN_UNDEFINED;
		} else {
			if ((cases1 === WHEN_UNDEFINED || cases1 === undefined) &&
				(cases2 === WHEN_UNDEFINED || cases2 === undefined) &&
				(cases3 === WHEN_UNDEFINED || cases3 === undefined))
			{	
				return WHEN_UNDEFINED;
			}
			else {
				
				return 	"(" + 
							percentageText(cases1, total) + ", " +
							percentageText(cases2, total) + ", " +
							percentageText(cases3, total) + ")";

			}
		}
	}

	/*	Returns a percentage with no decimals, the #cases and the total between parenthesis

	*/
	function percentageCasesAndTotal(numerator, denominator){

		if (numerator === WHEN_UNDEFINED || numerator === undefined ||
			denominator === WHEN_UNDEFINED || denominator === undefined) {
				return WHEN_UNDEFINED;
			}
			else {
				return 	percentageText(numerator, denominator) + "  (" +
				numerator + " / " + denominator + ")";
			}
	}

	/*	Returns a percentage with no decimals 

	*/
	function percentageText(numerator, denominator){
		if (denominator === 0 && numerator === 0){
			return WHEN_DIV_0;
		} else if (denominator === WHEN_UNDEFINED){
			return WHEN_UNDEFINED;
		} else if (denominator === 0){
			return ERROR;
		}
		return Math.round((numerator / (denominator))*100) + "%";
	}

	/* Returns the addition of the elements of the array if they are not 
	*/
	function add(arrayOfNumbers){
		var addition = 0;
		var counter = 0;
		for (var number of arrayOfNumbers) {
			if (typeof number !== "undefined" && number != WHEN_UNDEFINED){
				addition = addition + +number;
				counter++;
			} 
		}
		if (counter === 0){
			return WHEN_UNDEFINED;
		} else {
			return addition;
		}
	}

	/** Creates a 2 dimension array with labels.
		rowsNum: Length of first array dimension (number of rows)
		rowsTitles : labels for 
		mode : the place for labels in array. Options : LABELS_ON_COLUMNS or LABELS_ON_ROWS
	*/
	function  create_2_dim_array(rowsNum, rowsTitles, mode) {
		var array = []
		
		if(mode === LABELS_ON_ROWS) {
			array[0] = [];
			for(var i = 0; i<rowsTitles.length; i++){
				array[0][i] = rowsTitles[i];
			}
			for(var i = 1; i<rowsNum; i++){
				array[i] = [];
			}
		} else {
			for(var i = 0; i<rowsNum; i++){
				array[i] = [];
				array[i][0] = rowsTitles[i];
			}
		}
		return array;
	}

	function setMonthlyCheckboxes(){
		// checked by default, trigger click for desactivate and for fire behaviour.
		$('#'+MONTHLY_TABLE_TD_ID_PREFIX+BUTTON_PREFIX+VL_PREVIOUS_YEAR_ROW).trigger('click');//.prop('checked', false);
		$('#'+MONTHLY_TABLE_TD_ID_PREFIX+BUTTON_PREFIX+CL_PREVIOUS_YEAR_ROW).trigger('click');//.prop('checked', false);
		$('#'+MONTHLY_TABLE_TD_ID_PREFIX+BUTTON_PREFIX+ACL_PREVIOUS_YEAR_ROW).trigger('click');//.prop('checked', false);
		$('#'+MONTHLY_TABLE_TD_ID_PREFIX+BUTTON_PREFIX+ZCL_PREVIOUS_YEAR_ROW).trigger('click');//.prop('checked', false);

		//$('#'+LEISH_COLUMN_DETAIL_PREFIX+BUTTON_PREFIX+VL_COLUMN).trigger('click');
		//$('#'+LEISH_COLUMN_DETAIL_PREFIX+BUTTON_PREFIX+MCL_COLUMN).trigger('click');

		if(acl_and_zcl_activated){
			
			$('#'+MONTHLY_TABLE_TD_ID_PREFIX+BUTTON_PREFIX+CL_ROW).trigger('click');

			$('#'+LEISH_COLUMN_DETAIL_PREFIX+BUTTON_PREFIX+(CL_COLUMN-1)).trigger('click');
			$('#'+LEISH_COLUMN_DETAIL_PREFIX+BUTTON_PREFIX+(PKDL_COLUMN-1)).trigger('click');

		
			$('#'+CHART_PREFIX+BUTTON_PREFIX+"0").trigger('click');
			$('#'+CHART_PREFIX+BUTTON_PREFIX+"3").trigger('click');

			$('#'+MAP_PREFIX+BUTTON_PREFIX+"1").trigger('click');
		} else {
			$('#'+MONTHLY_TABLE_TD_ID_PREFIX+BUTTON_PREFIX+ACL_ROW).trigger('click');
			$('#'+MONTHLY_TABLE_TD_ID_PREFIX+BUTTON_PREFIX+ZCL_ROW).trigger('click');

			$('#'+LEISH_COLUMN_DETAIL_PREFIX+BUTTON_PREFIX+(ACL_COLUMN-1)).trigger('click');
			$('#'+LEISH_COLUMN_DETAIL_PREFIX+BUTTON_PREFIX+(ZCL_COLUMN-1)).trigger('click');

			$('#'+CHART_PREFIX+BUTTON_PREFIX+"1").trigger('click');
			$('#'+CHART_PREFIX+BUTTON_PREFIX+"4").trigger('click');

			$('#'+MAP_PREFIX+BUTTON_PREFIX+"2").trigger('click');
			$('#'+MAP_PREFIX+BUTTON_PREFIX+"3").trigger('click');

		}

		$(':checkbox').button( "refresh" );

	}

	/* jQueryUI auxiliary functions */
	function setButtonDisabledTo(id, value){
		$( "#" + id ).prop('disabled', value);
		$( "#" + id ).button( "refresh" );
	}

	function setOptionSelectMenu(id, value){
		$( "#" + id ).val(value);
		$( "#" + id ).selectmenu("refresh");
	}

	function drawLegendSet(htmlElementID, index){
		var html = '<div class="'+CLASS_EDITABLE_ELEMENT+' legentSetTitle">' + mapLegends[index][0].legendSetName + '</div>';
		html+='<br>';
		
		
		for(var i=0; i<mapLegends[index].length; i++){
			html+='<div>';
			html+='<div class="legendRectangle sameLine" style="background:'+ mapLegends[index][i].legendColors +'"></div>';
			html+='<div class="legentSetElementText sameLine '+CLASS_EDITABLE_ELEMENT+'">  ' + mapLegends[index][i].legendNames + '</div>';
			html+='</div>';

		}

		$("#"+htmlElementID).append(html);
	}

	/****************************************************************************************************
	 **********                               CHARTS functions                                 **********
	 ****************************************************************************************************/

	/* Retrieves the data of vl and cl or acl/zcl, configures the monthly charts and generates them.
	*/
	function generate_cl_vl_new_monthly_charts (){
	
		var yearsText = (year-1) + " and " + year;
		var colors = [COLORS.blue, COLORS.blue, COLORS.green, COLORS.green];
		var labels = [ACL_CHART_LEGEND +year, ACL_CHART_LEGEND +(year-1), ZCL_CHART_LEGEND + year, ZCL_CHART_LEGEND  + (year-1)];
		
		var acl_current_year = monthlyArray[ACL_ROW].slice(1,monthlyArray[ACL_ROW].length);
		var zcl_current_year = monthlyArray[ZCL_ROW].slice(1,monthlyArray[ZCL_ROW].length);
		var acl_previous_year = monthlyArray[ACL_PREVIOUS_YEAR_ROW].slice(1,monthlyArray[ACL_PREVIOUS_YEAR_ROW].length);
		var zcl_previous_year = monthlyArray[ZCL_PREVIOUS_YEAR_ROW].slice(1,monthlyArray[ZCL_PREVIOUS_YEAR_ROW].length);
		var dataarrays = [acl_current_year, acl_previous_year, zcl_current_year, zcl_previous_year];
		lineChart(newAZCLCasesChartID, CL_CASES_CHART_TITLE + yearsText, MONTHS_ABBREV, CL_CASES_CHART_Y_TITLE, labels, dataarrays, colors, true);

		colors = [COLORS.blue, COLORS.blue];
		labels = [CL_CHART_LEGEND + year, CL_CHART_LEGEND + (year-1)];
		var cl_current_year = monthlyArray[CL_ROW].slice(1,monthlyArray[CL_ROW].length);
		var cl_previous_year = monthlyArray[CL_PREVIOUS_YEAR_ROW].slice(1,monthlyArray[CL_PREVIOUS_YEAR_ROW].length);
		var dataarrays = [cl_current_year, cl_previous_year];
		lineChart(newCLCasesChartID, CL_CASES_CHART_TITLE + yearsText, MONTHS_ABBREV, CL_CASES_CHART_Y_TITLE, labels, dataarrays, colors, true);

		var vl_current_year = monthlyArray[VL_ROW].slice(1,monthlyArray[VL_ROW].length);
		var vl_previous_year = monthlyArray[VL_PREVIOUS_YEAR_ROW].slice(1,monthlyArray[VL_PREVIOUS_YEAR_ROW].length);
		var vl_data_arrays = [vl_current_year, vl_previous_year];
		var vl_colors = [COLORS.violet, COLORS.violet];
		var vl_labels = [VL_CHART_LEGEND + year, VL_CHART_LEGEND + (year-1)];

		lineChart(newVLCasesChartID, VL_CASES_CHART_TITLE + yearsText, MONTHS_ABBREV, VL_CASES_CHART_Y_TITLE, vl_labels, vl_data_arrays, vl_colors, true);

	}

	/* Retrieves the data of vl and cl or acl/zcl, configures the yearly charts and generates them.
		*/
	function generate_cl_vl_new_and_incidence_yearly_charts(){

		var dataLabelArray = [ACL_CHART_INCIDENCE_LEGEND, ZCL_CHART_INCIDENCE_LEGEND, ACL_CHART_CASES_LEGEND, ZCL_CHART_CASES_LEGEND];
		var charType = ["line","line","bar","bar"];
		var dataArray = [historicIncidence[ACL_COLUMN], historicIncidence[ZCL_COLUMN], historicNewCases[ACL_COLUMN], historicNewCases[ZCL_COLUMN]];
		var colorArray = [COLORS.blue, COLORS.green, COLORS.soft_blue, COLORS.soft_green];
		var dataChartIDs= [DATASID.RIGHT, DATASID.RIGHT, DATASID.LEFT, DATASID.LEFT];
		lineBarChart(newAZCLAndHistoricIncidenceID, CL_INCIDENCE_CHART_TITLE, dataLabelArray, CL_INCIDENCE_CHART_Y1_TITLE, CL_INCIDENCE_CHART_Y2_TITLE, charType, dataArray, colorArray, dataChartIDs);



		dataLabelArray = [VL_CHART_INCIDENCE_LEGEND, VL_CHART_CASES_LEGEND];
		charType = ["line","bar"];
		dataArray = [historicIncidence[VL_COLUMN], historicNewCases[VL_COLUMN]];
		colorArray = [COLORS.violet, COLORS.soft_violet];
		dataChartIDs= [DATASID.RIGHT, DATASID.LEFT];
		lineBarChart(newVLAndHistoricIncidenceID, VL_INCIDENCE_CHART_TITLE, dataLabelArray, VL_INCIDENCE_CHART_Y1_TITLE, VL_INCIDENCE_CHART_Y2_TITLE, charType, dataArray, colorArray, dataChartIDs);


		dataLabelArray = [CL_CHART_INCIDENCE_LEGEND, CL_CHART_CASES_LEGEND];
		charType = ["line","bar"];
		dataArray = [historicIncidence[CL_COLUMN], historicNewCases[CL_COLUMN]];
		colorArray = [COLORS.blue, COLORS.green];
		dataChartIDs= [DATASID.RIGHT, DATASID.LEFT];
		lineBarChart(newCLAndHistoricIncidenceID, CL_INCIDENCE_CHART_TITLE, dataLabelArray, CL_INCIDENCE_CHART_Y1_TITLE, CL_INCIDENCE_CHART_Y2_TITLE, charType, dataArray, colorArray, dataChartIDs);

	}



	/* 	Generates an any-lines-number line graph. 
		htmlElementID: the id of the canvas/html element where put the graph
		x_labels: The labels for the x-axis  
		dataLabelArray: an array with the label of each data line
		dataArray: the data
		colorArray: an Array of rgba colors
		previousYearMode: true if wanted to put previous years in dotted colors.
						  currentYear data must be preceed the previousYear data
		Note: All the array must have same size !
	*/
	function lineChart(	htmlElementID, title, x_labels, yTitle, dataLabelArray, dataArray, colorArray, previousYearMode){

		
		var theDataSets = [];
		var aDataSet = {};
		for (var i = 0; i<dataLabelArray.length; i++){
			aDataSet = {};
			aDataSet.label = dataLabelArray[i];
			aDataSet.fill = false;
			aDataSet.data = dataArray[i];
			aDataSet.backgroundColor = colorArray[i];
			aDataSet.borderColor = colorArray[i];
			aDataSet.borderWidth = 2;
			if (previousYearMode && i%2 == 1){
				// previousYearMode Enabled
				aDataSet.borderDash = [5];
				aDataSet.backgroundColor = aDataSet.backgroundColor.slice(0, -2)+"0.2)";
			}
			theDataSets[i] = aDataSet;
		}
		
		var ctx = document.getElementById(htmlElementID);
		var myChart = new Chart(ctx, {
		type: 'line',
		data: {
			labels: x_labels,
			datasets: theDataSets
			},
			options: {
				scales: {
					yAxes: [{
						ticks: {
							beginAtZero:true
						},
						scaleLabel:{
							display: true,
							labelString: yTitle
						}
					}]
				},
				title:{
					display: true,
					text: title
				},
				responsive: false
			}
		});
	}

	function lineBarChart(htmlElementID, title, dataLabelArray, y1Title, y2Title, charType, dataArray, colorArray, dataChartIDs){
		var theDataSets = [];
		var aDataSet = {};
		for (var i = 0; i<dataLabelArray.length; i++){
			aDataSet = {};
			aDataSet.label = dataLabelArray[i];
			aDataSet.fill = false;
			aDataSet.data = dataArray[i].reverse();
			aDataSet.backgroundColor = colorArray[i];
			aDataSet.borderColor = colorArray[i];
			aDataSet.borderWidth = 2;
			aDataSet.type = charType[i];
			aDataSet.yAxisID = dataChartIDs[i];
			theDataSets[i] = aDataSet;
		}

		var yearLabels = [];
		for (var i=0; i<historicLength;i++){
			yearLabels[historicLength-i-1] = year-i;
		}


		var ctx = document.getElementById(htmlElementID);
		var myChart = new Chart(ctx, {
			type: 'bar',
			data: {
				labels: yearLabels,
				datasets: theDataSets
			},
			options: {
				scales: {
					yAxes: [{
						id: DATASID.LEFT,
						stacked: true,
						type: 'linear',
						position: 'left',
						scaleLabel:{
							display: true,
							labelString: y1Title
						}
					},{
						id: DATASID.RIGHT,
						type: 'linear',
						position: 'right',
						ticks: {
							max: 2,
							min: 0
						},
						scaleLabel:{
							display: true,
							labelString: y2Title
						}
					}]
				},
				title:{
						display: true,
						text: title
					},
				responsive: false
			}
		});
	}

	/****************************************************************************************************
	 **********                               MAPS functions                                 **********
	 ****************************************************************************************************/

	 function moveLegend(index, destination, destinationCode){
		var legendObject = $('#' + LEGENDSET_PREFIX + index);

		if (destinationCode == LEGEND_TO_REPORT){
			legendObject.resizable({ disabled: true });
			legendObject.removeClass("resizable");
		} else {
			editingLegend = legendObject;
			editingLegend.resizable( "enable" );
		}
		destination.append(legendObject);
	 }



	$( "#updateLegendButton" ).click( function( event ) {
		event.preventDefault();
		var legend_index =  $('#legendSelector').val();
		var position_index =  $('#positionLegendSelector').val();

		moveLegend(legend_index, $('#'+MAP_PREFIX+ legend_index).find(LEGEND_POSITIONS[position_index]), LEGEND_TO_REPORT);
		setButtonDisabledTo("updateLegendButton", true);
		setOptionSelectMenu("legendSelector", $("#legendSelector option:first").val());
		setOptionSelectMenu("positionLegendSelector", BOTTOM_RIGHT);
		font_size_slider.slider("value", 10 );
		font_size_slider_handle.text( 10 );

	} );

	$( "#updateMapButton" ).click( function( event ) {
		event.preventDefault();
		var selected_map_index =  $('#mapSelector').val();
		var mapStyle = MAP_STYLE[$('#mapStyleSelector').val()];

		generateMap(selected_map_index, "INDICATOR", map_levels, orgUnit.id, year, "thematic1", mapStyle, map_opacity);

	} );

	

	
	function generateMaps(){
		var levels = [3,4,5];
		initalMapDiv[VL_INDEX] = $('#map0').html();
		initalMapDiv[CL_INDEX] = $('#map1').html();
		initalMapDiv[ACL_INDEX] = $('#map2').html();
		initalMapDiv[ZCL_INDEX] = $('#map3').html();

		var mapStyle = MAP_STYLE[$('#mapStyleSelector').val()];
		generateMap(VL_INDEX, "INDICATOR", levels, orgUnit.id, year, "thematic1", mapStyle, map_opacity);
		generateMap(CL_INDEX, "INDICATOR", levels, orgUnit.id, year, "thematic1", mapStyle, map_opacity);
		generateMap(ACL_INDEX, "INDICATOR", levels, orgUnit.id, year, "thematic1", mapStyle, map_opacity);
		generateMap(ZCL_INDEX, "INDICATOR", levels, orgUnit.id, year, "thematic1", mapStyle, map_opacity);
		drawLegendSet("legendSet0", VL_INDEX);
		drawLegendSet("legendSet1", CL_INDEX);
		drawLegendSet("legendSet2", ACL_INDEX);
		drawLegendSet("legendSet3", ZCL_INDEX);
	}

	function fillNotaBene(){
		var text = "Data source: Ministry of Health, "
					+ country_name +
					"<br>WHO " + year + ". All rights reserved.";
		$('#notaBene div').html(text);
		
	}

	function fillNotaBeneMaps(){
		var text = "The boundaries and names shown and the designations used on this map do not imply the expression of any opinion whatsoever "
					+ "on the part of the World Health Organization concerning the legal status of any country, territory, city or area or of "
					+ "its authorities, or concerning the delimitation of its frontiers or boundaries. Dotted and dashed lines on maps represent "
					+ "approximate border lines for which there may not yet be full agreement. <br>Map production: WHO/HTM/NTD/IDM";
		$('#notaBeneMaps div').html(text);
		
	}


	/****************************************************************************************************
	 **********                               FOOTNOTES functions                                 **********
	 ****************************************************************************************************/


  	var storedFootnotes = [];
    var activeFootnotesPage1 = [];
	var activeFootnotesPage2 = [];

	function addNewFootnote(){
		if($("#newFootnoteText").html()){
			var liClass = "ui-state-default";
			var html='';
			html+='<li class="'+liClass+' '+CLASS_EDITABLE_ELEMENT+'">'
			html+= $("#newFootnoteText").html();
			html+= '</li>';
			sortableListNotSelected.append(html);
		}
		deleteNewFootnote();
	}

	function deleteNewFootnote(){
		$("#newFootnoteText").html('');
	}


	function fillFootnotes(){
		var footnotesZone1 = $("#footnotes1");
		var footnotesZone2 = $("#footnotes2");

		footnotesZone1.html('');
		footnotesZone2.html('');

		var elements = $("#sortable2 li");
        var html = '';
		for (var i=0; i<elements.length; i++){
		//	zone = getFootnotesZoneObject("#footNoteNumber"+(i+1));
			html+='<div class="footnote"><span class="superindex">'+(i+1)+'</span><span class="'+CLASS_EDITABLE_ELEMENT+'">'
			html+= elements[i].innerHTML;
			html+= '</span></div>';
		}
		footnotesZone1.append(html);
		
		elements = $("#sortable3 li");
    	html = '';
		var base = i;
		for (var i=0; i<elements.length; i++){
		//	zone = getFootnotesZoneObject("#footNoteNumber"+(i+1));
			html+='<div class="footnote"><span class="superindex">'+(i+base+1)+'</span><span class="'+CLASS_EDITABLE_ELEMENT+'">'
			html+= elements[i].innerHTML;
			html+= '</span></div>';
		}
		footnotesZone2.append(html);
	}

	function getFootnotesZoneObject(footNote){
		if ($(footNote).length<=0){
			return 1;
		}

		console.log("footNote.offset().top"+$(footNote).offset().top);
		console.log("$(footnotes1).offset().top"+$("#footnotes1").offset().top);

		if($(".page-break").length){
			console.log($(".page-break"));
		} else {
			console.log("no pages breaks");

		}

		if($(footNote).offset().top<$("#footnotes1").offset().top){
			return 0;
		} else {
			return 1;
		}

	}

	/****************************************************************************************************
	 **********                               EDITOR                                           **********
	 ****************************************************************************************************/
	editor.jqte();	

	var dialog = $( "#dialog-editor" ).dialog({
		autoOpen: false,
		height: 350,
		width: 650,
		modal: true,
		title: "Edit field",
		buttons: {
			"Save changes": saveChanges,
			"Save changes and close": saveChangesAndClose,
			Cancel: function() {
				deleteNewFootnote();
				dialog.dialog( "close" );
			}
		},
		close: function(event) {
			event.preventDefault();
			return false;
			//allFields.removeClass( "ui-state-error" );
		}
	});

	function saveChanges(){
		editingElement.innerHTML = editor.jqteVal();
		addNewFootnote();
	}
	function saveChangesAndClose(){
		editingElement.innerHTML = editor.jqteVal();
		addNewFootnote();
		dialog.dialog( "close" );
	}

	/****************************************************************************************************
	 **********                            COUNTRY-SELECTOR                                    **********
	 ****************************************************************************************************/	
	
	// country_selector.jqte();

	var dialog_cs = $( "#dialog-country-selector" ).dialog({
		autoOpen: false,
		height: 350,
		width: 650,
		modal: true,
		title: "title",
		buttons: {
			"Start preparing report": startPreparingReport
		},
		close: function(event) {
			event.preventDefault();
			return false;
			//allFields.removeClass( "ui-state-error" );
		}
	});

	/****************************************************************************************************
	 **********                               LISTENERS                                        **********
	 ****************************************************************************************************/

	 function addListenersToCheckboxes(){
		// Listener ACL/ZCL PKDL buttons
		$(":checkbox."+LEISH_COLUMN_DETAIL_PREFIX).change(function() {
			var index = Number(this.id.slice(this.id.length-1, this.id.length));
			$('#epiTable tr, #diagTable tr').each(function() {
				$(this).find("td,th").eq(index+1).toggle();
			});

			// text descriptions under tables
			$('#textUnderEpiTable').each(function() {
				$(this).find("span").eq(index+1).toggle();
			});
			$('#textUnderDiagTable1').each(function() {
				$(this).find("span").eq(index).toggle();
			});

		});
		
		// Listener monthly buttons
		$(":checkbox."+MONTHLY_TABLE_TD_ID_PREFIX).change(function() {
			var index = Number(this.id.slice(this.id.length-1, this.id.length));
			var startingid = this.id.slice(0, -1-BUTTON_PREFIX.length);
			$("#"+startingid+index).toggle();
			
		});
		
		// Listener graph buttons
		$(":checkbox."+CHART_PREFIX).change(function() {
			var index = Number(this.id.slice(this.id.length-1, this.id.length));
			var startingid = this.id.slice(0, -1-BUTTON_PREFIX.length);
			var theCanvas = $('#'+startingid+index);
			theCanvas.toggleClass('sameLine');
			theCanvas.toggleClass('notShown');
			
		});

		//Listener for maps
		$(":checkbox."+MAP_PREFIX).change(function() {
			var index = Number(this.id.slice(this.id.length-1, this.id.length));
			var startingid = this.id.slice(0, -1-BUTTON_PREFIX.length);

			// enables or disables the options of the list
			$("#"+MAP_PREFIX+index).toggle();
			var changeOption = $('#' + startingid + OPTION_PREFIX + index);
			changeOption.prop('disabled', function(_, attr){ return !attr});
			$( "#mapSelector" ).selectmenu( 'refresh', true);

			// enables or disables the updatedMapButton
			var selected_map = $("#mapSelector").val();
			if(selected_map==index){
				var checked = $("#"+MAP_PREFIX+BUTTON_PREFIX+index).prop('checked');			
				setButtonDisabledTo("updateMapButton", !checked);
			}

		});

		$(".radioButton").change(function() {

			switch($(this)[0].id){
				case "disableNBMaps":
						$("#notaBeneMaps").resizable({ disabled: true });
						break;
				case "enableNBMaps":
						$("#notaBeneMaps").resizable( "enable");
						break;
				case "disableNB":
						$("#notaBene").resizable({ disabled: true });
						break;
				case "enableNB":
						$("#notaBene").resizable( "enable");
						break;
			}
		});

		// enables the updatedMapButton
		 $('#mapSelector').on('selectmenuchange', function() {
			setButtonDisabledTo("updateMapButton", false);
		}).change();

		 $('#legendSelector').on('selectmenuchange', function() {
			var selected_legend = $("#legendSelector").val();
			setButtonDisabledTo("updateLegendButton", false);


			// move back the legend to it map
			var position_index =  $('#positionLegendSelector').val();
			for (var i=0; i<MAP_CHECKBOXES_LABELS.length; i++){
				if ( $("#legendPool").find('#' + LEGENDSET_PREFIX + i).length > 0) {
					moveLegend(i, $('#' + MAP_PREFIX + i).find(LEGEND_POSITIONS[position_index]), LEGEND_TO_REPORT);	
				}
			}

			lastLegendPosition = getLastPosition(selected_legend);
			setOptionSelectMenu("positionLegendSelector", lastLegendPosition);

			moveLegend(selected_legend, $("#legendPool"), LEGEND_TO_LEGEND_POOL);


		}).change();

		$("#subnationalLevelSelector").on('selectmenuchange', function() {
			var selected_level = $("#subnationalLevelSelector").val();
			getNumberOfDivisions(parseInt(selected_level)+1, CGI_TABLE_TD_ID_PREFIX+6+" td:nth-child(2) span");
			$("#"+CGI_TABLE_TD_ID_PREFIX+6+" td:nth-child(1) span").html(LEVEL_REPORT_LABELS[selected_level]);
			//$("#"+CGI_TABLE_TD_ID_PREFIX+6+" td:nth-child(2) span").html(nbdiv);


		}).change();

	 }

	 function getLastPosition(selectedlegend){
		for (var i=0; i<LEGEND_POSITIONS.length; i++){
			console.log("getLastPosition");
			console.log($('#' + MAP_PREFIX + selectedlegend));
			console.log($('#' + MAP_PREFIX + selectedlegend).find(LEGEND_POSITIONS[i]));
			console.log($('#' + MAP_PREFIX + selectedlegend).find(LEGEND_POSITIONS[i]).find('#'+LEGENDSET_PREFIX + selectedlegend));
			if ($('#' + MAP_PREFIX + selectedlegend).find(LEGEND_POSITIONS[i]).find('#'+LEGENDSET_PREFIX + selectedlegend).length > 0 ){
				return i;
			}
		}
	 }

	// Editor for footnotes
	$("#newfootnote").click(function() {
 		 dialog.dialog( "open" );	
		editingElement = $("#newFootnoteText")[0];
		editor.jqteVal(editingElement.innerHTML);
	});

	// New footnote arrives 
	$( "#sortable2" ).on( "sortupdate", function( event, ui ) {
		fillFootnotes();
	} );	
	// New footnote arrives 
	$( "#sortable3" ).on( "sortupdate", function( event, ui ) {
		fillFootnotes();
	} );

	//TODO: fix contextmenu
 	$(document).on("contextmenu",function(e){
        if(e.target.nodeName != "INPUT" && e.target.nodeName != "TEXTAREA")
             e.preventDefault();
			 return false;
     });


	/****************************************************************************************************
	 **********                            ENTRY POINT                                         **********
	 ****************************************************************************************************/

	
    function fillOrgUnits(data, length, start){
        var orgUnit;
        for(var i=0;i<length;i++){
            orgUnit = new Object();
            orgUnit.value = data[i].id;
            orgUnit.label = data[i].displayName;
            organisationUnits.push(orgUnit);
        }
	}

	/**
	* Generates a list of years from next year until 1900 and stores in generatedYears
	*/
	function generateYears(){
		var years = [];
		var year;
		for (i = new Date().getFullYear() + 1; i > 1900; i--)
		{
			year = new Object();
			year.value = i;
			year.label = i;
			generatedYears.push(year);
		}
	}

	
	$(function() {
		initializeProgressBar("progressbar", "dialog");


		openProgressBar(INDETERMINATE);


		var thisYear = parseInt(getCurrentDate(true, false, false));


		$.when(getNumberOfDivisions(3, "id,displayName"), generateYears())
			.done(function(nbOfDivisions){

				fillOrgUnits(nbOfDivisions.organisationUnits, nbOfDivisions.organisationUnits.length);
				
				autocompleteSearcher("yearField", generatedYears, doNothing, 1, 200);
				autocompleteSearcher("destinationCountry", organisationUnits, doNothing, 2, 200);

				closeProgressBar();
				dialog_cs.dialog( "open" );

			});
			// generate dialog and wait

			/*
				var date = dhis2.report.date;
			var year = date.slice(0,4);
			var orgUnit = dhis2.report.organisationUnit;
			var country_name =orgUnit.name;
			var params = {
				dataSet: "", //i.e. DATASET.CL,
				period: year,
				orgUnit: orgUnit.id
				
				};
				*/
	});


	function startPreparingReport() {
	
	
		// check if fields are filled
		if (!$( "#destinationCountry").val() || !$( "#yearField").val() ){

			updateFeedback(FEEDBACK_INFO, "dialog-country-selector-check-message", FEEDBACK_FILL_ALL_FIELDS);
		} else {
			updateFeedback(FEEDBACK_HIDE, "dialog-country-selector-check-message", "");

			var countryName =  $( "#destinationCountry" ).val(); 
            var countryID =  $( "#destinationCountry" ).text(); 
			var year = $( "#yearField" ).val(); 
            var date = year + "-01-02";

			$( "#country_name" ).text(countryName);
			$( "#year" ).text(year);
			$( "#published_date").text(getDatePublished());



			generateCheckboxes($("#leish_detail_checkboxes"), COLUMNS_LABELS, "Leishmaniasis types to show:", LEISH_COLUMN_DETAIL_PREFIX, -1);
			generateCheckboxes($("#monthlyCheckboxes"), MONTHLY_LABELS, "Leishmaniasis types to show in monthly table:", MONTHLY_TABLE_TD_ID_PREFIX, -1);
			generateCheckboxes($("#chartCheckboxes"), CHART_CHECKBOXES_LABELS, "Graphs to show", CHART_PREFIX, 2);
			generateCheckboxes($("#mapCheckboxes"), MAP_CHECKBOXES_LABELS, "Maps to show", MAP_PREFIX, -1);

			addListenersToCheckboxes();

			$( "#sortable1, #sortable2, #sortable3" ).sortable({
			connectWith: ".connectedSortable"
			}).disableSelection();
			$('input[type=checkbox]').checkboxradio();
			$( "#tabs" ).tabs({heightStyle: "content"});
			// corrects bug on checkboxes
			$( ".ui-state-hover" ).removeClass( "ui-state-hover" );


			// maps jqueryui    
			$( "#mapSelector" ).selectmenu();
			$( "#legendSelector" ).selectmenu();
			$( "#positionLegendSelector" ).selectmenu();
			$( "#subnationalLevelSelector" ).selectmenu();
			$( "#mapStyleSelector" ).selectmenu();
			$( "#updateMapButton").button();
			$( "#updateLegendButton").button();
			$( ".radioButton" ).checkboxradio();



			setButtonDisabledTo("updateMapButton", true);
			setButtonDisabledTo("updateLegendButton", true);
			setOptionSelectMenu("positionLegendSelector", BOTTOM_RIGHT);

			generateMapConfigurationList($("#mapSelector"), MAP_CHECKBOXES_LABELS, MAP_PREFIX);
			generateMapConfigurationList($("#legendSelector"), MAP_CHECKBOXES_LABELS, LEGENDSET_PREFIX);
			generateMapConfigurationList($("#positionLegendSelector"), LEGEND_POSITION_LABELS, LEGEND_PREFIX);
			generateMapConfigurationList($("#mapStyleSelector"), MAP_STYLE_LABELS, MAP_STYLE_PREFIX);

			// Disables Google options
			$('#' + MAP_STYLE_PREFIX + OPTION_PREFIX + GOOGLE_STREETS).prop('disabled', function(_, attr){ return !attr});
			$('#' + MAP_STYLE_PREFIX + OPTION_PREFIX + GOOGLE_HYBRID).prop('disabled', function(_, attr){ return !attr});
			$( "#mapStyleSelector" ).selectmenu( 'refresh', true);

			setOptionSelectMenu("mapStyleSelector", OSM_LIGHT);
			
			generateMapConfigurationList($("#subnationalLevelSelector"), LEVEL_CONFIG_LABELS, LEVEL_PREFIX);

			fillNotaBene();
			fillNotaBeneMaps();

			/*
			DIAG_LEGEND_LABELS_DESC_2
				var DIAG_ASTERISK_RDT_COMMENT = "<sup>*</sup> These indicators apply only for primary VL cases";
			var PUT_NA_TEXT = true;
			*/


			setTextUnderTables("textUnderEpiTable", TEXT_UNDER_EPI, COLUMNS_LABELS, COLUMNS_LABELS_DESC, PUT_NA_TEXT);
			setTextUnderTables("textUnderDiagTable1", TEXT_UNDER_DIAG1, 
									DIAG_LEGEND_LABELS.slice(0, DIAG_LEGEND_LABELS.length-1), 
									DIAG_LEGEND_LABELS_DESC.slice(0, DIAG_LEGEND_LABELS_DESC.length-1), 
									DIAG_ASTERISK_RDT_COMMENT);
			setTextUnderTables("textUnderDiagTable2", TEXT_UNDER_DIAG2, DIAG_LEGEND_LABELS_2, DIAG_LEGEND_LABELS_DESC_2, PUT_NA_TEXT);
			
			text_values = [
				"WHO Global",
				"WHO Regions",
				"WHO Member States",
				"Level 1",
				"Level 2",
				"Level 3",
				"Level 4"		
			];

			// Org unit level slider
			var sliderRange = $( "#slider_range" );
			sliderRange.slider({
				range: true,
				min: 1,
				max: 7,
				values: [ map_levels[0], map_levels[map_levels.length-1]], // values = [firstValue, lastValue]
				slide: function( event, ui ) {
					$( "#ou_level_slider" ).val( text_values[ui.values[ 0 ]-1] + " - " + text_values[ui.values[ 1 ]-1] );
					map_levels = [];
					for(var i = ui.values[0]; i<=ui.values[1]; i++){
						map_levels.push(i);
					}
				}

			});
			$( "#ou_level_slider" ).val( text_values[sliderRange.slider( "values", 0 )-1] + " - " + text_values[sliderRange.slider( "values", 1 )-1] );

			// Opacitity slider  
			var opacity_slider_handle = $( "#opacity_slider_handle" );
			$( "#opacity_slider" ).slider({
			min: 0,
			max: 100,
			value: map_opacity,
			create: function() {
				opacity_slider_handle.text( $( this ).slider( "value" ) );
			},
			slide: function( event, ui ) {
				opacity_slider_handle.text( ui.value );
				map_opacity = ui.value;
			}
			});
			
			// height slider  
			var height_slider_handle = $( "#height_slider_handle" );
			$( "#height_slider" ).slider({
			min: 100,
			max: 900,
			value: map_height,
			create: function() {
				height_slider_handle.text( $( this ).slider( "value" ) );
			},
			slide: function( event, ui ) {
				height_slider_handle.text( ui.value );
				map_height = ui.value;
			}
			});
			
			// width slider  
			var width_slider_handle = $( "#width_slider_handle" );
			$( "#width_slider" ).slider({
			min: 100,
			max: 900,
			value: map_width,
			create: function() {
				width_slider_handle.text( $( this ).slider( "value" ) );
			},
			slide: function( event, ui ) {
				width_slider_handle.text( ui.value );
				map_width = ui.value;
			}
			});

			// Font size slider  
			
			font_size_slider.slider({
			min: 6,
			max: 24,
			value: 10,
			create: function() {
				font_size_slider_handle.text( $( this ).slider( "value" ) );
			},
			slide: function( event, ui ) {
				font_size_slider_handle.text( ui.value );
				editingLegend.find(".legentSetElementText").css({ 'font-size': $( this ).slider( "value" ) });
				editingLegend.find(".legentSetTitle").css({ 'font-size': $( this ).slider( "value" )+2 });
			}
			});
			

			fillTableHead(epiTableHead, '', COLUMNS_LABELS);
			fillTableHead(monthlyDistributionTableHead, '', MONTHS_ABBREV);
			fillTableHead(diagTableHead, '', COLUMNS_LABELS);
			fillTableHead(toutcomeTableHead, TOUTCOME_TABLE_FIRST_COLUMNS, COLUMNS_LABELS.slice(0,2));

			// Dragable activation
			$( ".draggable" ).draggable({ grid: [ 10, 10 ] });	
			$( ".resizable" ).resizable();


			fillCountryGeneralInformation(LEVEL2); //TODO: Manage error when not level 2

			// Code to execute after API calls have been done.
			// $.when(ajax1(), ajax2(), ajax3(), ajax4()).done(function(a1, a2, a3, a4){
			// http://stackoverflow.com/questions/3709597/wait-until-all-jquery-ajax-requests-are-done
			$.when(get_cl_cases(), get_vl_cases(), get_azcl_cases(),
				getIncidenceFor(INCIDENCE[VL_INDEX], VL_COLUMN),
				getIncidenceFor(INCIDENCE[CL_INDEX], CL_COLUMN),
				getIncidenceFor(INCIDENCE[ACL_INDEX], ACL_COLUMN),
				getIncidenceFor(INCIDENCE[ZCL_INDEX], ZCL_COLUMN),
				getNewCases(DE.VL_EPI_Type, VL_COLUMN),
				getNewCases(DE.CL_EPI_Type, CL_COLUMN),
				getNewCases(DE.ACL_EPI_Type, ACL_COLUMN),
				getNewCases(DE.ZCL_EPI_Type, ZCL_COLUMN),
				get_monthly_cases_for_cl_current_year(),
				get_monthly_cases_for_cl_previous_year(),
				get_monthly_cases_for_vl_current_year(),
				get_monthly_cases_for_vl_previous_year(),
				get_monthly_cases_for_azcl_current_year(),
				get_monthly_cases_for_azcl_previous_year(),
				getLegendSet(VL_LEGEND, VL_INDEX),
				getLegendSet(CL_LEGEND, CL_INDEX),
				getLegendSet(ACL_LEGEND, ACL_INDEX),
				getLegendSet(ZCL_LEGEND, ZCL_INDEX),
				getTreatmentAndMedicines(year),
				getLastEvent(year),
				getFootnotes()).done(function(i1,i2,i3,i4,nc1,nc2,nc3,nc4,m1,m2,m3,m4,m5,m6,ls1,ls2,ls3,ls4,f1,tm1,le1,ft1){
				// the code here will be executed when all four ajax requests resolve.
				// a1, a2, a3 and a4 are lists of length 3 containing the response text,
				// status, and jqXHR object for each of the four ajax calls respectively.
					writeTable(cgiTableBody, generalInformationArray, CGI_TABLE_TD_ID_PREFIX, LINES_BELOW_LABELS_CGI);
					writeTable(epiTableBody, array, EPI_TABLE_TD_ID_PREFIX, LINES_BELOW_LABELS_EPI);
					writeTable(monthlyDistributionTableBody, monthlyArray, MONTHLY_TABLE_TD_ID_PREFIX, LINES_BELOW_LABELS_MONTHLY);
					writeTable(casTableBody, controlArray, CAS_TABLE_TD_ID_PREFIX, LINES_BELOW_LABELS_CAS);
					writeTable(diagTableBody, diagnosisArray, DIAG_TABLE_TD_ID_PREFIX, LINES_BELOW_LABELS_DIAG);
					writeTable(toutcomeTableBody, toutcomeArray, "", LINES_BELOW_LABELS_TREAT);
					writeTable(tamTableBody, tamArray, "", LINES_BELOW_LABELS_TAM);

					generate_cl_vl_new_monthly_charts();
					generate_cl_vl_new_and_incidence_yearly_charts();

					fillHTMLListWithArray(sortableListNotSelected, storedFootnotes, 'ui-state-default '+CLASS_EDITABLE_ELEMENT);
					fillHTMLListWithArray(sortableListPage1, activeFootnotesPage1, 'ui-state-highlight '+CLASS_EDITABLE_ELEMENT);
					fillHTMLListWithArray(sortableListPage2, activeFootnotesPage2, 'ui-state-highlight '+CLASS_EDITABLE_ELEMENT);
					fillFootnotes();

					fillTreatmentAndMedicines();

					setMonthlyCheckboxes();
					generateMaps();
					
					makeElementsEditables();
					makeElementsFootnotables();

					$("#disableNBMaps").prop('checked', true);
					$("#notaBeneMaps").resizable({ disabled: true });
					$("#disableNB").prop('checked', true);
					$("#notaBene").resizable({ disabled: true });
					$( ".radioButton" ).checkboxradio("refresh");

				//	$("#disableNBMaps").trigger('click');
					//$(".radioButton").change();

			}).fail(function(data) {
				console.log ("ERROR. WHEN");
				console.log (data);
			});

		}
	}
		/****  **********  ******  ********  ******  ******   *****  *//***** ********  *****  *** *//****
	 ****  **                                TEST ZONE                                          **********
	 ** ********    ******** **** ********* ******* ************   *********** *********** ******* *******/



</script>

<!--
	/****************************************************************************************************
     **********		   																		   **********
 	 **********            	  		  	      3. HTML CODE              	    			   **********
 	**********		   																		   **********
	 ****************************************************************************************************/
	-->


<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Leishmaniasis Report Generator</title>
		<meta charset="utf-8">	
		

		<link rel="stylesheet" href="css/style.css" type="text/css" />
		<link rel="stylesheet" href="css/jquery-te-1.4.0.css" type="text/css" />
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.css" type="text/css" />
		<link rel="stylesheet" href="https://jqueryui.com/resources/demos/style.css" type="text/css" />

		<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto:400" />
		<link rel="stylesheet" href="../../../dhis-web-commons/javascripts/ext/resources/css/ext-plugin-gray.css" type="text/css" />

		<link rel="stylesheet" href="commons/feedbacks.css">
			
	</head>
	<body>

	<div class="non-printable configuration-section section"><hr>

		<div class="comment">
			Configuration Area - Wont be printed<br>
			Instructions : Left click to add a footnote number.<br>
							Right click to edit an element.
		</div>
		<div id="tabs">
			<ul>
				<li><a href="#tabs-1">General</a></li>
				<li><a href="#tabs-2">Maps</a></li>
				<li><a href="#tabs-3">Footnotes</a></li>
			</ul>
			<div id="tabs-1">		
				<fieldset id="leish_detail_checkboxes"></fieldset>
				<fieldset id="monthlyCheckboxes"></fieldset>
				<fieldset id="chartCheckboxes"></fieldset>
				<p><select name="subnationalLevelSelector" id="subnationalLevelSelector"></select></p>
			</div>
			<div id="tabs-2">		
				<fieldset id="mapCheckboxes"></fieldset>
				<fieldset id="mapConfiguration"><legend>Configure map</legend>
					<div>
						<div class="col">
							<select name="mapSelector" id="mapSelector">
								<option disabled selected value>Select a Map</option>
							</select>
							<p>
								<label for="ou_level_slider">OrgUnit levels:</label>
								<input type="text" id="ou_level_slider" readonly style="border:0; color:#f6931f; font-weight:bold;  width:260px ">
								<div id="slider_range"></div>
							</p>
							<select name="mapStyleSelector" id="mapStyleSelector"></select>
							<p> Opacity:
								<div id="opacity_slider"><div id="opacity_slider_handle" class="ui-slider-handle"></div></div>
							</p>
							<p> Height:
								<div id="height_slider"><div id="height_slider_handle" class="ui-slider-handle"></div></div>
							</p>
							<p>	Width:
								<div id="width_slider"><div id="width_slider_handle" class="ui-slider-handle"></div></div>
							</p>
							<button id="updateMapButton" class="ui-button ui-widget ui-corner-all">Update Map</button>
						</div>
						<div class="col">
							<p>
								<select name="legendSelector" id="legendSelector">
								<option disabled selected value>Select a Legend</option>
								</select>
							</p>
							<p><select name="positionLegendSelector" id="positionLegendSelector"></select></p>
							<p> Font size :
								<div id="font_size_slider"><div id="font_size_slider_handle" class="ui-slider-handle"></div></div>
							</p>
							<p><button id="updateLegendButton" class="ui-button ui-widget ui-corner-all">Update Legend</button></p>
							<p>
								<fieldset>
									<legend>Resize Nota Bene for Maps: </legend>
									<label for="disableNBMaps">Disabled</label>
									<input type="radio" name="NBMaps" class="radioButton" id="disableNBMaps">
									<label for="enableNBMaps">Enabled</label>
									<input type="radio" name="NBMaps" class="radioButton" id="enableNBMaps">
								</fieldset>
							</p>
							<p>
								<fieldset>
									<legend>Resize Nota Bene: </legend>
									<label for="disableNB">Disabled</label>
									<input type="radio" name="NB" class="radioButton" id="disableNB">
									<label for="enableNB">Enabled</label>
									<input type="radio" name="NB" class="radioButton" id="enableNB">
								</fieldset>
							</p>
											
						</div>
						<div id="legendPool" class="col">
							<div id="legendSet0" class="legendSet" ></div>
							<div id="legendSet1" class="legendSet" ></div>
							<div id="legendSet2" class="legendSet" ></div>
							<div id="legendSet3" class="legendSet" ></div>	
						</div>

					</div>

				</fieldset>
			</div>
			<div id="tabs-3">
				<div class="FixedHeightContainer">
					<div class="Content">
						<h6 class="subHeader">Stored footnotes</h6>
						<ul id="sortable1" class="connectedSortable">
						</ul>
					</div>
					<div class="Content"> 
						<h6 class="subHeader">Footnotes page 1</h6>
						<ul id="sortable2" class="connectedSortable">
						</ul>
					</div>
					<div class="Content">
						<h6 class="subHeader">Footnotes page 2</h6>
						<ul id="sortable3" class="connectedSortable">
						</ul>
					</div>
				</div>
				<button id="newfootnote" class="ui-button ui-widget ui-corner-all">
					<span class="ui-icon ui-icon-document"></span> Add new footnote
				</button>
				<div id="newFootnoteText" style="display:none"></div>

			</div>
		</div>
		<hr>
	</div>

	<div class="section">
		<img class="head_logo center" src="http://www.who.int/about/Logo-WHO.jpg" />

		<div class="head_container">	
			<div class="editableElement">Leishmaniasis</div>
			<div class="center_text editableElement" id="country_name"></div>
			<div class="align_to_right">
				<div class="editableElement" id="year"></div>
				<div class="editableElement comment" id="published_date"></div>
			</div>
		</div>
	</div>

	<div class="section">
		<h4 class="editableElement footnotable">Country General Information</h4>
		<div class="twoColumns"><table id="cgiTable" class="display" cellspacing="0" width="100%">
				<thead>
					<tr id ="cgiTableHead"></tr>
				</thead>
				<tbody id="cgiTableBody"></tbody>
		</table></div>
	</div>

	<div class="section">
		<h4 class="editableElement footnotable">Epidemiology</h4>

		<table id="epiTable" class="display" cellspacing="0" width="100%">
				<thead>
					<tr id ="epiTableHead"></tr>
				</thead>
				<tbody id="epiTableBody"></tbody>
		</table>
		<div id="textUnderEpiTable" class="textUnderTable"></div>
	</div>


	<div class="section">
		<h4 class="editableElement footnotable" >Monthly distribution of new cases January-December</h4>

		<table id="monthlyDistributionTable" class="display" cellspacing="0" width="100%">
				<thead>
					<tr id ="monthlyDistributionTableHead"></tr>
				</thead>
				<tbody id="monthlyDistributionTableBody"></tbody>
		</table>

	</div>

	<div>
		<canvas class="sameLine draggable chart" id="chart0" width="425" height="260" ></canvas>
		<canvas class="sameLine draggable chart" id="chart1" width="425" height="260" ></canvas>
		<canvas class="sameLine draggable chart" id="chart2" width="425" height="260" ></canvas>
	</div>
	<div>
		<canvas class="sameLine draggable chart" id="chart3" width="425" height="260" ></canvas>
		<canvas class="sameLine draggable chart" id="chart4" width="425" height="260" ></canvas>
		<canvas class="sameLine draggable chart" id="chart5" width="425" height="260" ></canvas>
	</div>

	<div class="section">
		<hr>
		<div id="footnotes1"></div>
	</div>

	<div class="section">
		<h4 class="editableElement footnotable" >Distribution of new CL (left) and new (primary) VL (right) cases per 10 000 population</h4>
		<div class="sameLine map"> <div id="map0" class="sameLine draggable"></div></div>
		<div class="sameLine map"><div id="map1" class="sameLine draggable"></div></div>
		<div class="sameLine map"><div id="map2" class="sameLine draggable"></div></div>
		<div class="sameLine map"><div id="map3" class="sameLine draggable"></div></div>
		<div id="notaBeneMaps"  class="notasBene draggable"><div class="editableElement"></div></div>
	</div>


	<div class="section">
		<h4 id="casTitle" class="editableElement footnotable" >Control and Surveillance</h4>
		<div class="twoColumns"><table id="casTable" class="display" cellspacing="0" width="100%">
				<thead>
					<tr id ="casTableHead"></tr>
				</thead>
				<tbody id="casTableBody"></tbody>
		</table></div>

	</div>

	<div class="section">
		<h4 class="editableElement footnotable" >Diagnosis</h4>

		<table id="diagTable" class="display" cellspacing="0" width="100%">
				<thead>
					<tr id ="diagTableHead"></tr>
				</thead>
				<tbody id="diagTableBody"></tbody>
		</table>
		<div id="textUnderDiagTable1" class="textUnderTable"></div>
		<div id="textUnderDiagTable2" class="textUnderTable"></div>


	</div>


	<div class="section">
		<h4 id="tamTitle" class="editableElement footnotable" >Treatment and medicines</h4>

		<table id="tamTable" class="display" cellspacing="0" width="100%">
				<thead>
					<tr id ="tamTableHead"></tr>
				</thead>
				<tbody id="tamTableBody"></tbody>
		</table>
		<br>
		<table id="toutcomeTable" class="display" cellspacing="0" width="100%">
				<thead>
					<tr id ="toutcomeTableHead"></tr>
				</thead>
				<tbody id="toutcomeTableBody"></tbody>
		</table>
	</div>



	<div class="section">
		<hr>
		<div id="footnotes2"></div>
		<div id="notaBene"  class="notasBene draggable"><div class="editableElement"></div></div>

	</div>


	<div id="dialog-editor">
		<textarea id="editor"></textarea>
	</div>

	<div id="dialog-country-selector" title="Select country and year">
		<div id="country-selector" ></div>
			Year: 
		<input id="yearField">
										
		<div class="ui-widget">
			<label for="destinationCountry">Country: </label>
			<input id="destinationCountry">
		</div>
		<div id="dialog-country-selector-check-message" class="">
			<i class="fa "></i>
			<div></div>
		</div>
								
	</div>

	<div id="dialog" title="Please wait">
		<div class="progress-label">Loading countries...</div>
		<div id="progressbar"></div>
	</div>


	<div class="non-printable">
		<div id="footer"> Leishmaniasis Report Generator 0.1</div>
	</div>

	</body>
</html>
